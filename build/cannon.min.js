(function(){var e=e||{};this.Int32Array||(this.Int32Array=Array,this.Float32Array=Array),e.Mat3=function(t){this.elements=t?t:[0,0,0,0,0,0,0,0,0]},e.Mat3.prototype.identity=function(){this.elements[0]=1,this.elements[1]=0,this.elements[2]=0,this.elements[3]=0,this.elements[4]=1,this.elements[5]=0,this.elements[6]=0,this.elements[7]=0,this.elements[8]=1},e.Mat3.prototype.setZero=function(){var t=this.elements;t[0]=0,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=0,t[6]=0,t[7]=0,t[8]=0},e.Mat3.prototype.setTrace=function(t){var e=this.elements;e[0]=t.x,e[4]=t.y,e[8]=t.z},e.Mat3.prototype.vmult=function(t,i){i=i||new e.Vec3;var n=this.elements,o=t.x,a=t.y,r=t.z;return i.x=n[0]*o+n[1]*a+n[2]*r,i.y=n[3]*o+n[4]*a+n[5]*r,i.z=n[6]*o+n[7]*a+n[8]*r,i},e.Mat3.prototype.smult=function(t){for(var e=0;this.elements.length>e;e++)this.elements[e]*=t},e.Mat3.prototype.mmult=function(t){for(var i=new e.Mat3,n=0;3>n;n++)for(var o=0;3>o;o++){for(var a=0,r=0;3>r;r++)a+=t.elements[n+3*r]*this.elements[r+3*o];i.elements[n+3*o]=a}return i},e.Mat3.prototype.solve=function(t,i){i=i||new e.Vec3;for(var n=3,o=4,a=[],r=0;n*o>r;r++)a.push(0);var r,s;for(r=0;3>r;r++)for(s=0;3>s;s++)a[r+o*s]=this.elements[r+3*s];a[3]=t.x,a[7]=t.y,a[11]=t.z;var h,c,l=3,u=l,p=4;do{if(r=u-l,0===a[r+o*r])for(s=r+1;u>s;s++)if(0!==a[r+o*s]){h=p;do c=p-h,a[c+o*r]+=a[c+o*s];while(--h);break}if(0!==a[r+o*r])for(s=r+1;u>s;s++){var v=a[r+o*s]/a[r+o*r];h=p;do c=p-h,a[c+o*s]=r>=c?0:a[c+o*s]-a[c+o*r]*v;while(--h)}}while(--l);if(i.z=a[2*o+3]/a[2*o+2],i.y=(a[1*o+3]-a[1*o+2]*i.z)/a[1*o+1],i.x=(a[0*o+3]-a[0*o+2]*i.z-a[0*o+1]*i.y)/a[0*o+0],isNaN(i.x)||isNaN(i.y)||isNaN(i.z)||1/0===i.x||1/0===i.y||1/0===i.z)throw"Could not solve equation! Got x=["+(""+i)+"], b=["+(""+t)+"], A=["+(""+this)+"]";return i},e.Mat3.prototype.e=function(t,e,i){return void 0===i?this.elements[e+3*t]:(this.elements[e+3*t]=i,void 0)},e.Mat3.prototype.copy=function(t){t=t||new e.Mat3;for(var i=0;this.elements.length>i;i++)t.elements[i]=this.elements[i];return t},e.Mat3.prototype.toString=function(){for(var t="",e=",",i=0;9>i;i++)t+=this.elements[i]+e;return t},e.Mat3.prototype.reverse=function(t){t=t||new e.Mat3;for(var i=3,n=6,o=[],a=0;i*n>a;a++)o.push(0);var a,r;for(a=0;3>a;a++)for(r=0;3>r;r++)o[a+n*r]=this.elements[a+3*r];o[3]=1,o[9]=0,o[15]=0,o[4]=0,o[10]=1,o[16]=0,o[5]=0,o[11]=0,o[17]=1;var s,h,c=3,l=c,u=n;do{if(a=l-c,0===o[a+n*a])for(r=a+1;l>r;r++)if(0!==o[a+n*r]){s=u;do h=u-s,o[h+n*a]+=o[h+n*r];while(--s);break}if(0!==o[a+n*a])for(r=a+1;l>r;r++){var p=o[a+n*r]/o[a+n*a];s=u;do h=u-s,o[h+n*r]=a>=h?0:o[h+n*r]-o[h+n*a]*p;while(--s)}}while(--c);a=2;do{r=a-1;do{var p=o[a+n*r]/o[a+n*a];s=n;do h=n-s,o[h+n*r]=o[h+n*r]-o[h+n*a]*p;while(--s)}while(r--)}while(--a);a=2;do{var p=1/o[a+n*a];s=n;do h=n-s,o[h+n*a]=o[h+n*a]*p;while(--s)}while(a--);a=2;do{r=2;do{if(h=o[i+r+n*a],isNaN(h)||1/0===h)throw"Could not reverse! A=["+(""+this)+"]";t.e(a,r,h)}while(r--)}while(a--);return t},e.Vec3=function(t,e,i){this.x=t||0,this.y=e||0,this.z=i||0},e.Vec3.prototype.cross=function(t,i){var n=t.x,o=t.y,a=t.z,r=this.x,s=this.y,h=this.z;return i=i||new e.Vec3,i.x=s*a-h*o,i.y=h*n-r*a,i.z=r*o-s*n,i},e.Vec3.prototype.set=function(t,e,i){return this.x=t,this.y=e,this.z=i,this},e.Vec3.prototype.vadd=function(t,i){return i?(i.x=t.x+this.x,i.y=t.y+this.y,i.z=t.z+this.z,void 0):new e.Vec3(this.x+t.x,this.y+t.y,this.z+t.z)},e.Vec3.prototype.vsub=function(t,i){return i?(i.x=this.x-t.x,i.y=this.y-t.y,i.z=this.z-t.z,void 0):new e.Vec3(this.x-t.x,this.y-t.y,this.z-t.z)},e.Vec3.prototype.crossmat=function(){return new e.Mat3([0,-this.z,this.y,this.z,0,-this.x,-this.y,this.x,0])},e.Vec3.prototype.normalize=function(){var t=this.x,e=this.y,i=this.z,n=Math.sqrt(t*t+e*e+i*i);if(n>0){var o=1/n;this.x*=o,this.y*=o,this.z*=o}else this.x=0,this.y=0,this.z=0;return n},e.Vec3.prototype.unit=function(t){t=t||new e.Vec3;var i=this.x,n=this.y,o=this.z,a=Math.sqrt(i*i+n*n+o*o);return a>0?(a=1/a,t.x=i*a,t.y=n*a,t.z=o*a):(t.x=1,t.y=0,t.z=0),t},e.Vec3.prototype.norm=function(){var t=this.x,e=this.y,i=this.z;return Math.sqrt(t*t+e*e+i*i)},e.Vec3.prototype.norm2=function(){return this.dot(this)},e.Vec3.prototype.distanceTo=function(t){var e=this.x,i=this.y,n=this.z,o=t.x,a=t.y,r=t.z;return Math.sqrt((o-e)*(o-e)+(a-i)*(a-i)+(r-n)*(r-n))},e.Vec3.prototype.mult=function(t,i){i=i||new e.Vec3;var n=this.x,o=this.y,a=this.z;return i.x=t*n,i.y=t*o,i.z=t*a,i},e.Vec3.prototype.dot=function(t){return this.x*t.x+this.y*t.y+this.z*t.z},e.Vec3.prototype.isZero=function(){return 0===this.x&&0===this.y&&0===this.z},e.Vec3.prototype.negate=function(t){return t=t||new e.Vec3,t.x=-this.x,t.y=-this.y,t.z=-this.z,t};var i=new e.Vec3,n=new e.Vec3;e.Vec3.prototype.tangents=function(t,e){var o=this.norm();if(o>0){var a=i,r=1/o;a.set(this.x*r,this.y*r,this.z*r);var s=n;.9>Math.abs(a.x)?(s.set(1,0,0),a.cross(s,t)):(s.set(0,1,0),a.cross(s,t)),a.cross(t,e)}else t.set(1,0,0).normalize(),e.set(0,1,0).normalize()},e.Vec3.prototype.toString=function(){return this.x+","+this.y+","+this.z},e.Vec3.prototype.copy=function(t){return t=t||new e.Vec3,t.x=this.x,t.y=this.y,t.z=this.z,t},e.Vec3.prototype.lerp=function(t,e,i){var n=this.x,o=this.y,a=this.z;i.x=n+(t.x-n)*e,i.y=o+(t.y-o)*e,i.z=a+(t.z-a)*e},e.Vec3.prototype.almostEquals=function(t,e){return void 0===e&&(e=1e-6),Math.abs(this.x-t.x)>e||Math.abs(this.y-t.y)>e||Math.abs(this.z-t.z)>e?!1:!0},e.Vec3.prototype.almostZero=function(t){return void 0===t&&(t=1e-6),Math.abs(this.x)>t||Math.abs(this.y)>t||Math.abs(this.z)>t?!1:!0},e.Quaternion=function(t,e,i,n){this.x=void 0!==t?t:0,this.y=void 0!==e?e:0,this.z=void 0!==i?i:0,this.w=void 0!==n?n:1},e.Quaternion.prototype.set=function(t,e,i,n){this.x=t,this.y=e,this.z=i,this.w=n},e.Quaternion.prototype.toString=function(){return this.x+","+this.y+","+this.z+","+this.w},e.Quaternion.prototype.setFromAxisAngle=function(t,e){var i=Math.sin(.5*e);this.x=t.x*i,this.y=t.y*i,this.z=t.z*i,this.w=Math.cos(.5*e)},e.Quaternion.prototype.toAxisAngle=function(t){t=t||new e.Vec3,this.normalize();var i=2*Math.acos(this.w),n=Math.sqrt(1-this.w*this.w);return.001>n?(t.x=this.x,t.y=this.y,t.z=this.z):(t.x=this.x/n,t.y=this.y/n,t.z=this.z/n),[t,i]},e.Quaternion.prototype.setFromVectors=function(t,e){var i=t.cross(e);this.x=i.x,this.y=i.y,this.z=i.z,this.w=Math.sqrt(Math.pow(t.norm(),2)*Math.pow(e.norm(),2))+t.dot(e),this.normalize()};var o=new e.Vec3,a=new e.Vec3,r=new e.Vec3;e.Quaternion.prototype.mult=function(t,i){i=i||new e.Quaternion;var n=this.w,s=o,h=a,c=r;return s.set(this.x,this.y,this.z),h.set(t.x,t.y,t.z),i.w=n*t.w-s.dot(h),s.cross(h,c),i.x=n*h.x+t.w*s.x+c.x,i.y=n*h.y+t.w*s.y+c.y,i.z=n*h.z+t.w*s.z+c.z,i},e.Quaternion.prototype.inverse=function(t){var i=this.x,n=this.y,o=this.z,a=this.w;t=t||new e.Quaternion,this.conjugate(t);var r=1/(i*i+n*n+o*o+a*a);return t.x*=r,t.y*=r,t.z*=r,t.w*=r,t},e.Quaternion.prototype.conjugate=function(t){return t=t||new e.Quaternion,t.x=-this.x,t.y=-this.y,t.z=-this.z,t.w=this.w,t},e.Quaternion.prototype.normalize=function(){var t=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);0===t?(this.x=0,this.y=0,this.z=0,this.w=0):(t=1/t,this.x*=t,this.y*=t,this.z*=t,this.w*=t)},e.Quaternion.prototype.normalizeFast=function(){var t=(3-(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w))/2;0===t?(this.x=0,this.y=0,this.z=0,this.w=0):(this.x*=t,this.y*=t,this.z*=t,this.w*=t)},e.Quaternion.prototype.vmult=function(t,i){if(i=i||new e.Vec3,0===this.w)i.x=t.x,i.y=t.y,i.z=t.z;else{var n=t.x,o=t.y,a=t.z,r=this.x,s=this.y,h=this.z,c=this.w,l=c*n+s*a-h*o,u=c*o+h*n-r*a,p=c*a+r*o-s*n,v=-r*n-s*o-h*a;i.x=l*c+v*-r+u*-h-p*-s,i.y=u*c+v*-s+p*-r-l*-h,i.z=p*c+v*-h+l*-s-u*-r}return i},e.Quaternion.prototype.copy=function(t){t.x=this.x,t.y=this.y,t.z=this.z,t.w=this.w},e.Quaternion.prototype.toEuler=function(t,e){e=e||"YZX";var i,n,o,a=this.x,r=this.y,s=this.z,h=this.w;switch(e){case"YZX":var c=a*r+s*h;if(c>.499&&(i=2*Math.atan2(a,h),n=Math.PI/2,o=0),-.499>c&&(i=-2*Math.atan2(a,h),n=-Math.PI/2,o=0),isNaN(i)){var l=a*a,u=r*r,p=s*s;i=Math.atan2(2*r*h-2*a*s,1-2*u-2*p),n=Math.asin(2*c),o=Math.atan2(2*a*h-2*r*s,1-2*l-2*p)}break;default:throw Error("Euler order "+e+" not supported yet.")}t.y=i,t.z=n,t.x=o},e.EventTarget=function(){var t={};this.addEventListener=function(e,i){void 0===t[e]&&(t[e]=[]),-1===t[e].indexOf(i)&&t[e].push(i)},this.dispatchEvent=function(e){for(var i in t[e.type])t[e.type][i](e)},this.removeEventListener=function(e,i){var n=t[e].indexOf(i);-1!==n&&t[e].splice(n,1)}},e.ObjectPool=function(){this.objects=[],this.type=Object},e.ObjectPool.prototype.release=function(){for(var t=arguments.length,e=0;e!==t;e++)this.objects.push(arguments[e])},e.ObjectPool.prototype.get=function(){return 0===this.objects.length?this.constructObject():this.objects.pop()},e.ObjectPool.prototype.constructObject=function(){throw Error("constructObject() not implemented in this ObjectPool subclass yet!")},e.Vec3Pool=function(){e.ObjectPool.call(this),this.type=e.Vec3},e.Vec3Pool.prototype=new e.ObjectPool,e.Vec3Pool.prototype.constructObject=function(){return new e.Vec3},e.Shape=function(){this.type=0,this.aabbmin=new e.Vec3,this.aabbmax=new e.Vec3,this.boundingSphereRadius=0,this.boundingSphereRadiusNeedsUpdate=!0},e.Shape.prototype.constructor=e.Shape,e.Shape.prototype.computeBoundingSphereRadius=function(){throw"computeBoundingSphereRadius() not implemented for shape type "+this.type},e.Shape.prototype.getBoundingSphereRadius=function(){return this.boundingSphereRadiusNeedsUpdate&&this.computeBoundingSphereRadius(),this.boundingSphereRadius},e.Shape.prototype.volume=function(){throw"volume() not implemented for shape type "+this.type},e.Shape.prototype.calculateLocalInertia=function(){throw"calculateLocalInertia() not implemented for shape type "+this.type};var s=new e.Vec3,h=new e.Vec3;e.Shape.prototype.calculateTransformedInertia=function(t,i,n){n=n||new e.Vec3;var o=s,a=h;return this.calculateLocalInertia(t,o),i.vmult(o,a),n.x=Math.abs(a.x),n.y=Math.abs(a.y),n.z=Math.abs(a.z),n},e.Shape.calculateLocalAABB=function(){throw Error(".calculateLocalAABB is not implemented for this Shape yet!")},e.Shape.types={SPHERE:1,PLANE:2,BOX:4,COMPOUND:8,CONVEXPOLYHEDRON:16},e.Body=function(t){e.EventTarget.apply(this),this.type=t,this.world=null,this.preStep=null,this.postStep=null,this.vlambda=new e.Vec3,this.collisionFilterGroup=1,this.collisionFilterMask=1},e.Body.DYNAMIC=1,e.Body.STATIC=2,e.Body.KINEMATIC=4,e.Particle=function(t,i){if("number"!=typeof t)throw Error("Argument 1 (mass) must be a number.");if(i!==void 0&&!(i instanceof e.Material))throw Error("Argument 3 (material) must be an instance of CANNON.Material.");e.Body.call(this,"particle"),this.position=new e.Vec3,this.initPosition=new e.Vec3,this.velocity=new e.Vec3,this.initVelocity=new e.Vec3,this.force=new e.Vec3,this.mass=t,this.invMass=t>0?1/t:0,this.material=i,this.linearDamping=.01,this.motionstate=0>=t?e.Body.STATIC:e.Body.DYNAMIC,this.allowSleep=!0,this.sleepState=0,this.sleepSpeedLimit=.1,this.sleepTimeLimit=1,this.timeLastSleepy=0},e.Particle.prototype=new e.Body,e.Particle.prototype.constructor=e.Particle,e.Particle.prototype.isAwake=function(){return 0===this.sleepState},e.Particle.prototype.isSleepy=function(){return 1===this.sleepState},e.Particle.prototype.isSleeping=function(){return 2===this.sleepState},e.Particle.prototype.wakeUp=function(){var t=this.sleepState;this.sleepState=0,2===t&&this.dispatchEvent({type:"wakeup"})},e.Particle.prototype.sleep=function(){this.sleepState=2},e.Particle.prototype.sleepTick=function(t){if(this.allowSleep){var e=this.sleepState,i=this.velocity.norm2(),n=Math.pow(this.sleepSpeedLimit,2);0===e&&n>i?(this.sleepState=1,this.timeLastSleepy=t,this.dispatchEvent({type:"sleepy"})):1===e&&i>n?this.wakeUp():1===e&&t-this.timeLastSleepy>this.sleepTimeLimit&&(this.sleepState=2,this.dispatchEvent({type:"sleep"}))}},e.RigidBody=function(t,i,n){if("number"!=typeof t)throw Error("Argument 1 (mass) must be a number.");if(n!==void 0&&!(n instanceof e.Material))throw Error("Argument 3 (material) must be an instance of CANNON.Material.");e.Particle.call(this,t,n),this.tau=new e.Vec3,this.quaternion=new e.Quaternion,this.initQuaternion=new e.Quaternion,this.angularVelocity=new e.Vec3,this.initAngularVelocity=new e.Vec3,this.shape=i,this.inertia=new e.Vec3,i.calculateLocalInertia(t,this.inertia),this.inertiaWorld=new e.Vec3,this.inertia.copy(this.inertiaWorld),this.inertiaWorldAutoUpdate=!1,this.invInertia=new e.Vec3(this.inertia.x>0?1/this.inertia.x:0,this.inertia.y>0?1/this.inertia.y:0,this.inertia.z>0?1/this.inertia.z:0),this.invInertiaWorld=new e.Vec3,this.invInertia.copy(this.invInertiaWorld),this.invInertiaWorldAutoUpdate=!1,this.angularDamping=.01,this.aabbmin=new e.Vec3,this.aabbmax=new e.Vec3,this.aabbNeedsUpdate=!0,this.wlambda=new e.Vec3},e.RigidBody.prototype=new e.Particle(0),e.RigidBody.prototype.constructor=e.RigidBody,e.RigidBody.prototype.computeAABB=function(){this.shape.calculateWorldAABB(this.position,this.quaternion,this.aabbmin,this.aabbmax),this.aabbNeedsUpdate=!1},e.RigidBody.prototype.applyImpulse=function(t,i,n){n=n||1/60;var o=new e.Vec3,a=new e.Vec3;t.vsub(this.position,o),o.cross(i,a),this.velocity.vadd(i.mult(n),this.velocity),this.angularVelocity.vadd(a.mult(n),this.angularVelocity)},e.Sphere=function(t){e.Shape.call(this),this.radius=void 0!==t?Number(t):1,this.type=e.Shape.types.SPHERE},e.Sphere.prototype=new e.Shape,e.Sphere.prototype.constructor=e.Sphere,e.Sphere.prototype.calculateLocalInertia=function(t,i){i=i||new e.Vec3;var n=2*t*this.radius*this.radius/5;return i.x=n,i.y=n,i.z=n,i},e.Sphere.prototype.volume=function(){return 4*Math.PI*this.radius/3},e.Sphere.prototype.computeBoundingSphereRadius=function(){this.boundingSphereRadiusNeedsUpdate=!1,this.boundingSphereRadius=this.radius},e.Sphere.prototype.calculateWorldAABB=function(t,e,i,n){for(var o=this.radius,a=["x","y","z"],r=0;a.length>r;r++){var s=a[r];i[s]=t[s]-o,n[s]=t[s]+o}},e.Box=function(t){e.Shape.call(this),this.halfExtents=t,this.type=e.Shape.types.BOX,this.convexPolyhedronRepresentation=null,this.updateConvexPolyhedronRepresentation()},e.Box.prototype=new e.Shape,e.Box.prototype.constructor=e.Box,e.Box.prototype.updateConvexPolyhedronRepresentation=function(){var t=this.halfExtents.x,i=this.halfExtents.y,n=this.halfExtents.z,o=e.Vec3,a=new e.ConvexPolyhedron([new o(-t,-i,-n),new o(t,-i,-n),new o(t,i,-n),new o(-t,i,-n),new o(-t,-i,n),new o(t,-i,n),new o(t,i,n),new o(-t,i,n)],[[3,2,1,0],[4,5,6,7],[5,4,1,0],[2,3,6,7],[0,4,7,3],[1,2,5,6]],[new o(0,0,-1),new o(0,0,1),new o(0,-1,0),new o(0,1,0),new o(-1,0,0),new o(1,0,0)]);this.convexPolyhedronRepresentation=a},e.Box.prototype.calculateLocalInertia=function(t,i){i=i||new e.Vec3;var n=this.halfExtents;return i.x=1/12*t*(2*2*n.y*n.y+2*2*n.z*n.z),i.y=1/12*t*(2*2*n.x*n.x+2*2*n.z*n.z),i.z=1/12*t*(2*2*n.y*n.y+2*2*n.x*n.x),i},e.Box.prototype.getSideNormals=function(t,e){var i=t,n=this.halfExtents;if(i[0].set(n.x,0,0),i[1].set(0,n.y,0),i[2].set(0,0,n.z),i[3].set(-n.x,0,0),i[4].set(0,-n.y,0),i[5].set(0,0,-n.z),void 0!==e)for(var o=0;o!==i.length;o++)e.vmult(i[o],i[o]);return i},e.Box.prototype.volume=function(){return 8*this.halfExtents.x*this.halfExtents.y*this.halfExtents.z},e.Box.prototype.computeBoundingSphereRadius=function(){this.boundingSphereRadius=this.halfExtents.norm(),this.boundingSphereRadiusNeedsUpdate=!1};var c=new e.Vec3;new e.Vec3,e.Box.prototype.forEachWorldCorner=function(t,e,i){for(var n=this.halfExtents,o=[[n.x,n.y,n.z],[-n.x,n.y,n.z],[-n.x,-n.y,n.z],[-n.x,-n.y,-n.z],[n.x,-n.y,-n.z],[n.x,n.y,-n.z],[-n.x,n.y,-n.z],[n.x,-n.y,n.z]],a=0;o.length>a;a++)c.set(o[a][0],o[a][1],o[a][2]),e.vmult(c,c),t.vadd(c,c),i(c.x,c.y,c.z)},e.Box.prototype.calculateWorldAABB=function(t,e,i,n){i.set(1/0,1/0,1/0),n.set(-1/0,-1/0,-1/0),this.forEachWorldCorner(t,e,function(t,e,o){t>n.x&&(n.x=t),e>n.y&&(n.y=e),o>n.z&&(n.z=o),i.x>t&&(i.x=t),i.y>e&&(i.y=e),i.z>o&&(i.z=o)})},e.Plane=function(){e.Shape.call(this),this.type=e.Shape.types.PLANE,this.worldNormal=new e.Vec3,this.worldNormalNeedsUpdate=!0},e.Plane.prototype=new e.Shape,e.Plane.prototype.constructor=e.Plane,e.Plane.prototype.computeWorldNormal=function(t){var e=this.worldNormal;e.set(0,0,1),t.vmult(e,e),this.worldNormalNeedsUpdate=!1},e.Plane.prototype.calculateLocalInertia=function(t,i){return i=i||new e.Vec3},e.Plane.prototype.volume=function(){return 1/0};var l=new e.Vec3;e.Plane.prototype.calculateWorldAABB=function(t,e,i,n){l.set(0,0,1),e.vmult(l,l),i.set(-1/0,-1/0,-1/0),n.set(1/0,1/0,1/0),1===l.x&&(n.x=t.x),1===l.y&&(n.y=t.y),1===l.z&&(n.z=t.z),-1===l.x&&(i.x=t.x),-1===l.y&&(i.y=t.y),-1===l.z&&(i.z=t.z)},e.Compound=function(){e.Shape.call(this),this.type=e.Shape.types.COMPOUND,this.childShapes=[],this.childOffsets=[],this.childOrientations=[]},e.Compound.prototype=new e.Shape,e.Compound.prototype.constructor=e.Compound,e.Compound.prototype.addChild=function(t,i,n){i=i||new e.Vec3,n=n||new e.Quaternion,this.childShapes.push(t),this.childOffsets.push(i),this.childOrientations.push(n)},e.Compound.prototype.volume=function(){for(var t=0,e=this.childShapes.length,i=0;i!==e;i++)t+=this.childShapes[i].volume();return t};var u=new e.Vec3,p=new e.Vec3;e.Compound.prototype.calculateLocalInertia=function(t,i){i=i||new e.Vec3;for(var n=this.volume(),o=p,a=0,r=this.childShapes.length;a!==r;a++){var s=this.childShapes[a],h=this.childOffsets[a];this.childOrientations[a];var c=s.volume()/n*t;s.calculateLocalInertia(c,o),i.vadd(o,i);var l=u;l.set(c*h.x*h.x,c*h.y*h.y,c*h.z*h.z),i.vadd(l,i)}return i},e.Compound.prototype.computeBoundingSphereRadius=function(){for(var t=0,e=0;this.childShapes.length>e;e++){var i=this.childShapes[e];i.boundingSphereRadiusNeedsUpdate&&i.computeBoundingSphereRadius();var n=this.childOffsets[e].norm()+i.boundingSphereRadius;n>t&&(t=n)}this.boundingSphereRadius=t,this.boundingSphereRadiusNeedsUpdate=!1};var v=new e.Vec3,d=new e.Vec3,f=new e.Vec3,y=new e.Quaternion;e.Compound.prototype.calculateWorldAABB=function(t,e,i,n){var o=this.childShapes.length;i.set(1/0,1/0,1/0),n.set(-1/0,-1/0,-1/0);for(var a=0;a!==o;a++)this.childOffsets[a].copy(f),e.vmult(f,f),t.vadd(f,f),e.mult(this.childOrientations[a],y),this.childShapes[a].calculateWorldAABB(f,y,d,v),d.x<i.x&&(i.x=d.x),d.y<i.y&&(i.y=d.y),d.z<i.z&&(i.z=d.z),v.x>n.x&&(n.x=v.x),v.y>n.y&&(n.y=v.y),v.z>n.z&&(n.z=v.z)},e.ConvexPolyhedron=function(t,i){function n(t,e,i,n){e.vsub(t,c),i.vsub(e,h),h.cross(c,n),n.isZero()||n.normalize()}function o(t,e,i,n,o){for(var a=t.vertices.length,r=null,s=null,h=t.vertices,c=0;a>c;c++){h[c].copy(V),n.vmult(V,V),V.vadd(i,V);var l=V.dot(e);(null===r||l>r)&&(r=l),(null===s||s>l)&&(s=l)}if(s>r){var u=s;s=r,r=u}o[0]=r,o[1]=s}function a(t,e){var i=s.faces[t],o=s.vertices[i[0]],a=s.vertices[i[1]],r=s.vertices[i[2]];return n(o,a,r,e)}function r(t){var e=s.faces[t],i=s.faceNormals[t],n=s.vertices[e[0]],o=-i.dot(n);return o}var s=this;e.Shape.call(this),this.type=e.Shape.types.CONVEXPOLYHEDRON;var h=new e.Vec3,c=new e.Vec3;this.vertices=t||[],this.worldVertices=[],this.worldVerticesNeedsUpdate=!0,this.faces=i||[],this.faceNormals=[];for(var l=0;this.faces.length>l;l++){for(var u=0;this.faces[l].length>u;u++)if(!this.vertices[this.faces[l][u]])throw Error("Vertex "+this.faces[l][u]+" not found!");var p=new e.Vec3;a(l,p),p.negate(p),this.faceNormals.push(p);var v=this.vertices[this.faces[l][0]];if(0>p.dot(v)){console.warn("Face normal "+l+" ("+(""+p)+") looks like it points into the shape? The vertices follow. Make sure they are ordered CCW around the normal, using the right hand rule.");for(var u=0;this.faces[l].length>u;u++)console.warn("Vertex "+this.faces[l][u]+": ("+(""+this.vertices[i[l][u]])+")")}}this.worldFaceNormalsNeedsUpdate=!0,this.worldFaceNormals=[],this.uniqueEdges=[];for(var d=this.vertices.length,f=0;d>f;f++){var y=this.vertices[f];if(!(y instanceof e.Vec3))throw"Argument 1 must be instance of CANNON.Vec3";this.uniqueEdges.push(y)}for(var l=0;this.faces.length>l;l++)for(var m=this.faces[l].length,w=m,u=0;w>u;u++){var b=(u+1)%m,x=new e.Vec3;this.vertices[this.faces[l][u]].vsub(this.vertices[this.faces[l][b]],x),x.normalize();for(var g=!1,y=0;this.uniqueEdges.length>y;y++)if(this.uniqueEdges[y].almostEquals(x)||this.uniqueEdges[y].almostEquals(x)){g=!0;break}g||this.uniqueEdges.push(x),x&&(x.face1=l)}var V=new e.Vec3;this.testSepAxis=function(t,e,i,n,a,r){var s=[],h=[],c=this;o(c,t,i,n,s),o(e,t,a,r,h);var l=s[0],u=s[1],p=h[0],v=h[1];if(v>l||u>p)return!1;var d=l-v,f=p-u,y=f>d?d:f;return y};var z=new e.Vec3,E=new e.Vec3,N=new e.Vec3,S=new e.Vec3,j=new e.Vec3,M=new e.Vec3;this.findSeparatingAxis=function(t,e,i,n,o,a){for(var r=1/0,s=this,h=0,c=s.faces.length,l=0;c>l;l++){s.faceNormals[l].copy(z),i.vmult(z,z);var u=s.testSepAxis(z,t,e,i,n,o);if(u===!1)return!1;r>u&&(r=u,z.copy(a))}for(var p=t.faces.length,l=0;p>l;l++){t.faceNormals[l].copy(E),o.vmult(E,E),h++;var u=s.testSepAxis(E,t,e,i,n,o);if(u===!1)return!1;r>u&&(r=u,E.copy(a))}for(var v=0,d=0;s.uniqueEdges.length>d;d++){s.uniqueEdges[d].copy(S),i.vmult(S,S);for(var f=0;t.uniqueEdges.length>f;f++)if(t.uniqueEdges[f].copy(j),o.vmult(j,j),S.cross(j,M),v++,!M.almostZero()){M.normalize();var y=s.testSepAxis(M,t,e,i,n,o);if(y===!1)return!1;r>y&&(r=y,M.copy(a))}}return n.vsub(e,N),N.dot(a)>0&&a.negate(a),!0};var q=new e.Vec3;this.clipAgainstHull=function(t,i,n,o,a,r,s,h,c){if(!(t instanceof e.Vec3))throw Error("posA must be Vec3");if(!(i instanceof e.Quaternion))throw Error("quatA must be Quaternion");for(var l=-1,u=-1/0,p=0;n.faces.length>p;p++){n.faceNormals[p].copy(q),a.vmult(q,q);var v=q.dot(r);v>u&&(u=v,l=p)}for(var d=[],f=n.faces[l],y=f.length,m=0;y>m;m++){var w=n.vertices[f[m]],b=new e.Vec3;w.copy(b),a.vmult(b,b),o.vadd(b,b),d.push(b)}l>=0&&this.clipFaceAgainstHull(r,t,i,d,s,h,c)};var P=new e.Vec3,C=new e.Vec3,I=new e.Vec3,B=new e.Vec3,O=new e.Vec3,R=new e.Vec3,A=new e.Vec3,T=new e.Vec3;this.clipFaceAgainstHull=function(t,i,n,o,a,s,h){if(!(t instanceof e.Vec3))throw Error("sep normal must be vector");if(!(o instanceof Array))throw Error("world verts must be array");a=Number(a),s=Number(s);for(var c=this,l=[],u=o,p=l,v=-1,d=1/0,f=0;c.faces.length>f;f++){c.faceNormals[f].copy(P),n.vmult(P,P);var y=P.dot(t);d>y&&(d=y,v=f)}if(0>v)return console.log("--- did not find any closest face... ---"),void 0;var m=c.faces[v];m.connectedFaces=[];for(var w=0;c.faces.length>w;w++)for(var b=0;c.faces[w].length>b;b++)-1!==m.indexOf(c.faces[w][b])&&w!==v&&-1===m.connectedFaces.indexOf(w)&&m.connectedFaces.push(w);u.length;for(var x=m.length,g=0;x>g;g++){var V=c.vertices[m[g]],z=c.vertices[m[(g+1)%x]];V.vsub(z,C),C.copy(I),n.vmult(I,I),i.vadd(I,I),this.faceNormals[v].copy(B),n.vmult(B,B),i.vadd(B,B),I.cross(B,O),O.negate(O),V.copy(R),n.vmult(R,R),i.vadd(R,R);var E,N=(-R.dot(O),m.connectedFaces[g]);this.faceNormals[N].copy(A);var S=r(N);A.copy(T),n.vmult(T,T);var E=S-T.dot(i);for(this.clipFaceAgainstPlane(u,p,T,E);u.length;)u.shift();for(;p.length;)u.push(p.shift())}this.faceNormals[v].copy(A);var S=r(v);A.copy(T),n.vmult(T,T);for(var E=S-T.dot(i),w=0;u.length>w;w++){var j=T.dot(u[w])+E;if(a>=j&&(console.log("clamped: depth="+j+" to minDist="+(a+"")),j=a),s>=j){var M=u[w];if(0>=j){var q={point:M,normal:T,depth:j};h.push(q)}}}},this.clipFaceAgainstPlane=function(t,i,n,o){if(!(n instanceof e.Vec3))throw Error("planeNormal must be Vec3, "+n+" given");if(!(t instanceof Array))throw Error("invertices must be Array, "+t+" given");if(!(i instanceof Array))throw Error("outvertices must be Array, "+i+" given");var a,r,s=t.length;if(2>s)return i;var h=t[t.length-1],c=t[0];a=n.dot(h)+o;for(var l=0;s>l;l++){if(c=t[l],r=n.dot(c)+o,0>a)if(0>r){var u=new e.Vec3;c.copy(u),i.push(u)}else{var u=new e.Vec3;h.lerp(c,a/(a-r),u),i.push(u)}else if(0>r){var u=new e.Vec3;h.lerp(c,a/(a-r),u),i.push(u),i.push(c)}h=c,a=r}return i};var s=this;this.calculateLocalInertia=function(t,e){s.computeAABB();var i=this.aabbmax.x-this.aabbmin.x,n=this.aabbmax.y-this.aabbmin.y,o=this.aabbmax.z-this.aabbmin.z;e.x=1/12*t*(2*2*n*n+2*2*o*o),e.y=1/12*t*(2*2*i*i+2*2*o*o),e.z=1/12*t*(2*2*n*n+2*2*i*i)},new e.Vec3,this.computeAABB=function(){var t=this.vertices.length,e=this.aabbmin,i=this.aabbmax,n=this.vertices;e.set(1/0,1/0,1/0),i.set(-1/0,-1/0,-1/0);for(var o=0;t>o;o++){var a=n[o];a.x<e.x?e.x=a.x:a.x>i.x&&(i.x=a.x),a.y<e.y?e.y=a.y:a.y>i.y&&(i.y=a.y),a.z<e.z?e.z=a.z:a.z>i.z&&(i.z=a.z)}}},e.ConvexPolyhedron.prototype=new e.Shape,e.ConvexPolyhedron.prototype.constructor=e.ConvexPolyhedron,e.ConvexPolyhedron.prototype.computeWorldVertices=function(t,i){for(var n=this.vertices.length;n>this.worldVertices.length;)this.worldVertices.push(new e.Vec3);for(var o=this.vertices,a=this.worldVertices,r=0;r!==n;r++)i.vmult(o[r],a[r]),t.vadd(a[r],a[r]);this.worldVerticesNeedsUpdate=!1},e.ConvexPolyhedron.prototype.computeWorldFaceNormals=function(t){for(var i=this.faceNormals.length;i>this.worldFaceNormals.length;)this.worldFaceNormals.push(new e.Vec3);for(var n=this.faceNormals,o=this.worldFaceNormals,a=0;a!==i;a++)t.vmult(n[a],o[a]);this.worldFaceNormalsNeedsUpdate=!1},e.ConvexPolyhedron.prototype.computeBoundingSphereRadius=function(){for(var t=0,e=this.vertices,i=0,n=e.length;i!==n;i++){var o=e[i].norm2();o>t&&(t=o)}this.boundingSphereRadius=Math.sqrt(t),this.boundingSphereRadiusNeedsUpdate=!1};var m=new e.Vec3;e.ConvexPolyhedron.prototype.calculateWorldAABB=function(t,e,i,n){for(var o,a,r,s,h,c,l=this.vertices.length,u=this.vertices,p=0;l>p;p++){u[p].copy(m),e.vmult(m,m),t.vadd(m,m);var v=m;o>v.x||void 0===o?o=v.x:(v.x>s||void 0===s)&&(s=v.x),a>v.y||void 0===a?a=v.y:(v.y>h||void 0===h)&&(h=v.y),r>v.z||void 0===r?r=v.z:(v.z>c||void 0===c)&&(c=v.z)}i.set(o,a,r),n.set(s,h,c)},e.ConvexPolyhedron.prototype.volume=function(){return this.boundingSphereRadiusNeedsUpdate&&this.computeBoundingSphereRadius(),4*Math.PI*this.boundingSphereRadius/3},e.ConvexPolyhedron.prototype.getAveragePointLocal=function(t){t=t||new e.Vec3;for(var i=this.vertices.length,n=this.vertices,o=0;i>o;o++)t.vadd(n[o],t);return t.mult(1/i,t),t},e.ConvexPolyhedron.prototype.transformAllPoints=function(t,e){var i=this.vertices.length,n=this.vertices;if(e){for(var o=0;i>o;o++){var a=n[o];e.vmult(a,a)}for(var o=0;this.faceNormals.length>o;o++){var a=this.faceNormals[o];e.vmult(a,a)}}if(t)for(var o=0;i>o;o++){var a=n[o];a.vadd(t,a)}};var w=new e.Vec3,b=new e.Vec3,x=new e.Vec3;e.ConvexPolyhedron.prototype.pointIsInside=function(t){var e=this.vertices.length,i=this.vertices,n=this.faces,o=this.faceNormals,a=null,r=this.faces.length,s=w;this.getAveragePointLocal(s);for(var h=0;r>h;h++){this.faces[h].length;var e=o[h],c=i[n[h][0]],l=b;t.vsub(c,l);var u=e.dot(l),p=x;s.vsub(c,p);var v=e.dot(p);if(0>u&&v>0||u>0&&0>v)return!1}return a?1:-1},e.Cylinder=function(t,i,n,o){var a=o,r=[],s=[],h=[],c=[],l=[],u=Math.cos,p=Math.sin;r.push(new e.Vec3(i*u(0),i*p(0),.5*-n)),c.push(0),r.push(new e.Vec3(t*u(0),t*p(0),.5*n)),l.push(1);for(var v=0;a>v;v++){var d=2*Math.PI/a*(v+1),f=2*Math.PI/a*(v+.5);a-1>v?(r.push(new e.Vec3(i*u(d),i*p(d),.5*-n)),c.push(2*v+2),r.push(new e.Vec3(t*u(d),t*p(d),.5*n)),l.push(2*v+3),s.push(new e.Vec3(u(f),p(f),0)),h.push([2*v+2,2*v+3,2*v+1,2*v])):(h.push([0,1,2*v+1,2*v]),s.push(new e.Vec3(u(f),p(f),0)))}h.push(l),s.push(new e.Vec3(0,0,1));for(var y=[],v=0;c.length>v;v++)y.push(c[c.length-v-1]);h.push(y),s.push(new e.Vec3(0,0,-1)),this.type=e.Shape.types.CONVEXPOLYHEDRON,e.ConvexPolyhedron.call(this,r,h,s)},e.Cylinder.prototype=new e.ConvexPolyhedron,e.Broadphase=function(){this.world=null,this.useBoundingBoxes=!1},e.Broadphase.prototype.constructor=e.BroadPhase,e.Broadphase.prototype.collisionPairs=function(){throw Error("collisionPairs not implemented for this BroadPhase class!")};var g=e.Body.STATIC|e.Body.KINEMATIC;e.Broadphase.prototype.needBroadphaseCollision=function(t,i){return 0===(t.collisionFilterGroup&i.collisionFilterMask)||0===(i.collisionFilterGroup&t.collisionFilterMask)?!1:0===(t.motionstate&g)&&!t.isSleeping()||0===(i.motionstate&g)&&!i.isSleeping()?t.shape||i.shape?t.shape instanceof e.Plane&&i.shape instanceof e.Plane?!1:!0:!1:!1},e.Broadphase.prototype.intersectionTest=function(t,e,i,n){this.useBoundingBoxes?this.doBoundingBoxBroadphase(t,e,i,n):this.doBoundingSphereBroadphase(t,e,i,n)};var V=new e.Vec3,z=new e.Vec3,E=(new e.Quaternion,new e.Vec3);e.Broadphase.prototype.doBoundingSphereBroadphase=function(t,i,n,o){var a=e.Shape.types,r=a.SPHERE|a.BOX|a.COMPOUND|a.CONVEXPOLYHEDRON,s=a.PLANE;e.Body.STATIC|e.Body.KINEMATIC;var h=V,c=z,l=E,u=t.shape,p=i.shape;if(u&&p){var v=u.type,d=p.type;if(v&r&&d&r){i.position.vsub(t.position,h),u.boundingSphereRadiusNeedsUpdate&&u.computeBoundingSphereRadius(),p.boundingSphereRadiusNeedsUpdate&&p.computeBoundingSphereRadius();var f=u.boundingSphereRadius+p.boundingSphereRadius;f*f>h.norm2()&&(n.push(t),o.push(i))}else if(v&r&&d&a.PLANE||d&r&&v&a.PLANE){var y=v===s?t:i,m=v!==s?t:i,w=m.shape,b=y.shape;m.position.vsub(y.position,h),b.worldNormalNeedsUpdate&&b.computeWorldNormal(y.quaternion),c=b.worldNormal,w.boundingSphereRadiusNeedsUpdate&&w.computeBoundingSphereRadius();var x=h.dot(c)-w.boundingSphereRadius;0>x&&(n.push(t),o.push(i))}}else if(u||p){var g=u?i:t,N=u?t:i,w=N.shape,S=w.type;if(S&r){if(S===a.SPHERE)g.position.vsub(N.position,l),w.radius*w.radius>=l.norm2()&&(n.push(g),o.push(N));else if(S===a.CONVEXPOLYHEDRON||S===a.BOX||S===a.COMPOUND){w.boundingSphereRadiusNeedsUpdate&&w.computeBoundingSphereRadius();var j=w.boundingSphereRadius;g.position.vsub(N.position,l),j*j>=l.norm2()&&(n.push(g),o.push(N))}}else if(S===a.PLANE){var M=N;c.set(0,0,1),M.quaternion.vmult(c,c),g.position.vsub(M.position,l),0>=c.dot(l)&&(n.push(g),o.push(N))}}else;},e.Broadphase.prototype.doBoundingBoxBroadphase=function(t,i,n,o){var a=t.shape,r=i.shape;if(t.aabbNeedsUpdate&&t.computeAABB(),i.aabbNeedsUpdate&&i.computeAABB(),a&&r)t.aabbmax.x<i.aabbmin.x||t.aabbmax.y<i.aabbmin.y||t.aabbmax.z<i.aabbmin.z||t.aabbmin.x>i.aabbmax.x||t.aabbmin.y>i.aabbmax.y||t.aabbmin.z>i.aabbmax.z||(n.push(t),o.push(i));else if(a||r){var s=a?i:t,h=a?t:i;h.shape instanceof e.Plane,s.position.x<h.aabbmin.x||s.position.y<h.aabbmin.y||s.position.z<h.aabbmin.z||s.position.x>h.aabbmax.x||s.position.y>h.aabbmax.y||s.position.z>h.aabbmax.z||(n.push(t),o.push(i))}else;};var N={},S=[],j=[];e.Broadphase.prototype.makePairsUnique=function(t,e){for(var i=N,n=S,o=j,a=t.length,r=0;r!==a;r++)n[r]=t[r],o[r]=e[r];t.length=0,e.length=0;for(var r=0;r!==a;r++){var s=n[r].id,h=o[r].id,c=h>s?s+","+h:h+","+s;i[c]=r}for(var c in i){var r=i[c];t.push(n[r]),e.push(o[r]),delete i[c]}},e.NaiveBroadphase=function(){e.Broadphase.apply(this)},e.NaiveBroadphase.prototype=new e.Broadphase,e.NaiveBroadphase.prototype.constructor=e.NaiveBroadphase,e.NaiveBroadphase.prototype.collisionPairs=function(t,e,i){var n,o,a,r,s=t.bodies,h=s.length;for(n=0;n!==h;n++)for(o=0;o!==n;o++)a=s[n],r=s[o],this.needBroadphaseCollision(a,r)&&this.intersectionTest(a,r,e,i)},e.GridBroadphase=function(t,i,n,o,a){e.Broadphase.apply(this),this.nx=n||10,this.ny=o||10,this.nz=a||10,this.aabbMin=t||new e.Vec3(100,100,100),this.aabbMax=i||new e.Vec3(-100,-100,-100),this.bins=[]},e.GridBroadphase.prototype=new e.Broadphase,e.GridBroadphase.prototype.constructor=e.GridBroadphase;var M=new e.Vec3,q=new e.Vec3;e.GridBroadphase.prototype.collisionPairs=function(t,i,n){var o=t.numObjects(),a=t.bodies,r=this.aabbMax,s=this.aabbMin,h=this.nx,c=this.ny,l=this.nz,u=r.x,p=r.y,v=r.z,d=s.x,f=s.y,y=s.z,m=h/(u-d),w=c/(p-f),b=l/(v-y),x=(u-d)/h,g=(p-f)/c,V=(v-y)/l,z=e.Shape.types,E=z.SPHERE,N=z.PLANE;z.BOX,z.COMPOUND,z.CONVEXPOLYHEDRON;for(var S=this.bins,j=h*c*l,P=S.length-1;P!==j;P++)S.push([]);for(var P=0;P!==j;P++)S[P].length=0;for(var C=Math.floor,P=0;P!==o;P++){var I=a[P],B=I.shape;switch(B.type){case E:for(var O=I.position.x,R=I.position.y,A=I.position.z,T=B.radius,F=C(m*(O-T-d)),k=C(w*(R-T-f)),U=C(b*(A-T-y)),W=C(m*(O+T-d)),L=C(w*(R+T-f)),D=C(b*(A+T-y)),Q=F;Q!==W+1;Q++)for(var H=k;H!==L+1;H++)for(var X=U;X!==D+1;X++){var G=Q,_=H,Y=X,Z=G*(c-1)*(l-1)+_*(l-1)+Y;Z>=0&&j>Z&&S[Z].push(I)}break;case N:var K=M,J=q,$=.25*(x*x+g*g+V*V),te=B.worldNormal;
B.worldNormalNeedsUpdate&&B.computeWorldNormal(I.quaternion);for(var Q=0;Q!==h;Q++)for(var H=0;H!==c;H++)for(var X=0;X!==l;X++){var G=Q,_=H,Y=X;if(J.set(G*x+d,_*g+f,Y*V+y),J.vsub(I.position,K),$>K.dot(te)){var Z=G*(c-1)*(l-1)+_*(l-1)+Y;S[Z].push(I)}}break;default:console.warn("Shape "+B.type+" not supported in GridBroadphase!")}}for(var P=0;P!==j;P++)for(var ee=S[P],Q=0,ie=ee.length;Q!==ie;Q++)for(var I=ee[Q],H=0;H!==Q;H++){var ne=ee[H];this.needBroadphaseCollision(I,ne)&&this.intersectionTest(I,ne,i,n)}this.makePairsUnique(i,n)},e.Solver=function(){this.equations=[]},e.Solver.prototype.solve=function(){return 0},e.Solver.prototype.addEquation=function(t){this.equations.push(t)},e.Solver.prototype.removeEquation=function(t){var e=this.equations,i=e.indexOf(t);-1!==i&&e.splice(i,1)},e.Solver.prototype.removeAllEquations=function(){this.equations.length=0},e.GSSolver=function(){e.Solver.call(this),this.iterations=10,this.tolerance=0},e.GSSolver.prototype=new e.Solver;var P=[],C=[],I=[];e.GSSolver.prototype.solve=function(t,e){var i,n,o,a,r,s,h=(this.d,this.k,this.iterations),c=this.tolerance*this.tolerance,l=(this.a,this.b),u=this.equations,p=u.length,v=e.bodies,d=v.length,f=t,y=C,m=I,w=P;y.length=0,m.length=0,w.length=0;for(var b=0;b!==p;b++){var x=u[b];x.spookParamsNeedsUpdate&&(x.updateSpookParams(f),x.spookParamsNeedsUpdate=!1),w[b]=0,m[b]=x.computeB(f),y[b]=1/x.computeC()}if(0!==p){for(var b=0;b!==d;b++){var l=v[b],g=l.vlambda,V=l.wlambda;g.set(0,0,0),V&&V.set(0,0,0)}for(var z=0;z!==h;z++){a=0;for(var E=0;E!==p;E++){var x=u[E];i=m[E],n=y[E],s=w[E],r=x.computeGWlambda(),o=n*(i-r-x.eps*s),x.minForce>s+o?o=x.minForce-s:s+o>x.maxForce&&(o=x.maxForce-s),w[E]+=o,a+=o>0?o:-o,x.addToWlambda(o)}if(c>a*a)break}for(var b=0;b!==d;b++){var l=v[b],N=l.velocity,S=l.angularVelocity;N.vadd(l.vlambda,N),S&&S.vadd(l.wlambda,S)}}return z},e.SplitSolver=function(t){e.Solver.call(this),this.subsolver=t},e.SplitSolver.prototype=new e.Solver;var B=[],O=[],R=[],A={bodies:null};e.SplitSolver.prototype.solve=function(t,i){function n(t){for(var e=t.length,i=0;i!==e;i++){var n=t[i];if(!(n.visited||n.body.motionstate&x))return n}return!1}function o(t,e){var i=[];for(i.push(t),t.visited=!0,e(t);i.length;)for(var o,a=i.pop();o=n(a.children);)o.visited=!0,e(o),i.push(o)}function a(t){z.push(t.body);for(var e=t.eqs.length,i=0;i!==e;i++){var n=t.eqs[i];-1===V.indexOf(n)&&V.push(n)}}for(var r=B,s=i.bodies,h=this.equations,c=h.length,l=s.length,u=this.subsolver,p=r.length;p!==l;p++)r.push({body:s[p],children:[],eqs:[],visited:!1});for(var p=0;p!==l;p++){var v=r[p];v.body=s[p],v.children.length=0,v.eqs.length=0,v.visited=!1}for(var d=0;d!==c;d++){var f=h[d],p=s.indexOf(f.bi),y=s.indexOf(f.bj),m=r[p],w=r[y];m.children.push(w),m.eqs.push(f),w.children.push(m),w.eqs.push(f)}for(var b,x=e.Body.STATIC,g=0,V=O,z=R,E=A;b=n(r);){V.length=0,z.length=0,o(b,a);for(var N=V.length,p=0;p!==N;p++)u.addEquation(V[p]);E.bodies=z,u.solve(t,E),u.removeAllEquations(),g++}return g},e.Material=function(t){this.name=t,this.id=-1},e.ContactMaterial=function(t,e,i,n){this.id=-1,this.materials=[t,e],this.friction=void 0!==i?Number(i):.3,this.restitution=void 0!==n?Number(n):.3,this.contactEquationStiffness=1e7,this.contactEquationRegularizationTime=3,this.frictionEquationStiffness=1e7,this.frictionEquationRegularizationTime=3},e.World=function(){e.EventTarget.apply(this),this.allowSleep=!1,this.contacts=[],this.frictionEquations=[],this.quatNormalizeSkip=0,this.quatNormalizeFast=!1,this.time=0,this.stepnumber=0,this.default_dt=1/60,this.last_dt=this.default_dt,this.nextId=0,this.gravity=new e.Vec3,this.broadphase=null,this.bodies=[],this.solver=new e.GSSolver,this.constraints=[],this.contactgen=new e.ContactGenerator,this.collision_matrix=[],this.materials=[],this.contactmaterials=[],this.mats2cmat=[],this.defaultMaterial=new e.Material("default"),this.defaultContactMaterial=new e.ContactMaterial(this.defaultMaterial,this.defaultMaterial,.3,0),this.doProfiling=!1,this.profile={solve:0,makeContactConstraints:0,broadphase:0,integrate:0,nearphase:0}},e.World.prototype.getContactMaterial=function(t,i){if(t instanceof e.Material&&i instanceof e.Material){var n=t.id,o=i.id;if(o>n){var a=n;n=o,o=a}return this.contactmaterials[this.mats2cmat[n+o*this.materials.length]]}},e.World.prototype.numObjects=function(){return this.bodies.length},e.World.prototype.collisionMatrixGet=function(t,e,i){var n=this.bodies.length;if(void 0===i&&(i=!0),i&&e>t||!i&&t>e){var o=e;e=t,t=o}return this.collision_matrix[t+e*n]},e.World.prototype.collisionMatrixSet=function(t,e,i,n){var o=this.bodies.length;if(void 0===n&&(n=!0),n&&e>t||!n&&t>e){var a=e;e=t,t=a}this.collision_matrix[t+e*o]=i},e.World.prototype.collisionMatrixTick=function(){var t,e,i,n=this.bodies.length;for(e=0;e!==n;e++)for(i=0;i!==e;i++)t=this.collisionMatrixGet(e,i,!0),this.collisionMatrixSet(e,i,t,!1),this.collisionMatrixSet(e,i,0,!0)},e.World.prototype.add=function(t){var i=this.numObjects();this.bodies.push(t),t.id=this.id(),t.world=this,t.position.copy(t.initPosition),t.velocity.copy(t.initVelocity),t.timeLastSleepy=this.time,t instanceof e.RigidBody&&(t.angularVelocity.copy(t.initAngularVelocity),t.quaternion.copy(t.initQuaternion));for(var n=0;2*i+1>n;n++)this.collision_matrix.push(0)},e.World.prototype.addConstraint=function(t){this.constraints.push(t),t.id=this.id()},e.World.prototype.removeConstraint=function(t){var e=this.constraints.indexOf(t);-1!==e&&this.constraints.splice(e,1)},e.World.prototype.id=function(){return this.nextId++},e.World.prototype.remove=function(t){t.world=null;var e,i=this.numObjects(),n=this.bodies;for(e=0;e!==n.length;e++)if(n[e].id===t.id){n.splice(e,1);break}for(e=0;e!==2*i-1;e++)this.collision_matrix.pop()},e.World.prototype.addMaterial=function(t){if(-1===t.id){var e=this.materials.length;this.materials.push(t),t.id=this.materials.length-1;for(var i=0;i!==2*e+1;i++)this.mats2cmat.push(-1)}},e.World.prototype.addContactMaterial=function(t){this.addMaterial(t.materials[0]),this.addMaterial(t.materials[1]);var e,i;t.materials[0].id>t.materials[1].id?(e=t.materials[0].id,i=t.materials[1].id):(i=t.materials[0].id,e=t.materials[1].id),this.contactmaterials.push(t),t.id=this.contactmaterials.length-1,this.mats2cmat[e+this.materials.length*i]=t.id},e.World.prototype._now=function(){return window.performance.webkitNow?window.performance.webkitNow():Date.now()};var T={type:"postStep"},F={type:"collide","with":null,contact:null},k=[],U=[],W=[],L=[],D=new e.Vec3,Q=(new e.Vec3,new e.Vec3,new e.Vec3,new e.Vec3,new e.Vec3,new e.Vec3,new e.Vec3,new e.Vec3,new e.Quaternion,new e.Quaternion),H=new e.Quaternion;e.World.prototype.step=function(t){var i,n=this.contacts,o=W,a=L,r=this.numObjects(),s=this.bodies,h=this.solver,c=this.gravity,l=this.doProfiling,u=this.profile,p=e.Body.DYNAMIC,v=this._now,d=this.collision_matrix,f=this.constraints,y=e.FrictionEquation,m=U,w=c.norm(),b=c.x,x=c.y,g=c.z,V=0;for(l&&(i=v()),void 0===t&&(t=this.last_dt||this.default_dt),V=0;V!==r;V++){var z=s[V];if(z.motionstate&p){var E=z.force,N=z.mass;E.x+=N*b,E.y+=N*x,E.z+=N*g}}l&&(i=v()),o.length=0,a.length=0,this.broadphase.collisionPairs(this,o,a),l&&(u.broadphase=v()-i),this.collisionMatrixTick(),l&&(i=v());var S=k,j=n.length;for(V=0;V!==j;V++)S.push(n[V]);n.length=0,this.contactgen.getContacts(o,a,this,n,S),l&&(u.nearphase=v()-i),l&&(i=v());var M=n.length,q=this.frictionEquations.length;for(V=0;V!==q;V++)m.push(this.frictionEquations[V]);this.frictionEquations.length=0;for(var P=0;P!==M;P++){var C=n[P],z=C.bi,I=C.bj,V=s.indexOf(z),B=s.indexOf(I),d=this.getContactMaterial(z.material,I.material)||this.defaultContactMaterial,O=d.friction;d.restitution;var R=D;R.set(I.position.x+C.rj.x-z.position.x-C.ri.x,I.position.y+C.rj.y-z.position.y-C.ri.y,I.position.z+C.rj.z-z.position.z-C.ri.z);var A=R.dot(C.ni);if(0>A){if(C.restitution=d.restitution,C.penetration=A,C.stiffness=d.contactEquationStiffness,C.regularizationTime=d.contactEquationRegularizationTime,h.addEquation(C),O>0){var X=O*w,G=z.invMass+I.invMass;G>0&&(G=1/G);var _=m,Y=_.length?_.pop():new y(z,I,X*G),Z=_.length?_.pop():new y(z,I,X*G);this.frictionEquations.push(Y),this.frictionEquations.push(Z),Y.bi=Z.bi=z,Y.bj=Z.bj=I,Y.minForce=Z.minForce=-X*G,Y.maxForce=Z.maxForce=X*G,C.ri.copy(Y.ri),C.rj.copy(Y.rj),C.ri.copy(Z.ri),C.rj.copy(Z.rj),C.ni.tangents(Y.t,Z.t),h.addEquation(Y),h.addEquation(Z)}this.collisionMatrixSet(V,B,1,!0),this.collisionMatrixGet(V,B,!0)!==this.collisionMatrixGet(V,B,!1)&&(F.with=I,F.contact=C,z.dispatchEvent(F),F.with=z,I.dispatchEvent(F),z.wakeUp(),I.wakeUp())}}l&&(u.makeContactConstraints=v()-i),l&&(i=v());var K=f.length;for(V=0;V!==K;V++){var C=f[V];C.update();for(var B=0,J=C.equations.length;B!==J;B++){var $=C.equations[B];h.addEquation($)}}h.solve(t,this),l&&(u.solve=v()-i),h.removeAllEquations();var te=Math.pow;for(V=0;V!==r;V++){var z=s[V];if(z.motionstate&p){var ee=te(1-z.linearDamping,t),ie=z.velocity;ie.mult(ee,ie);var ne=z.angularVelocity;if(ne){var oe=te(1-z.angularDamping,t);ne.mult(oe,ne)}}}for(this.dispatchEvent(T),V=0;V!==r;V++){var z=s[V];z.preStep&&z.preStep.call(z)}l&&(i=v());var ae=Q,re=H,se=this.stepnumber,he=e.Body.DYNAMIC|e.Body.KINEMATIC,ce=0===se%(this.quatNormalizeSkip+1),le=this.quatNormalizeFast,ue=.5*t,pe=e.Shape.types.PLANE,ve=e.Shape.types.CONVEXPOLYHEDRON;for(V=0;V!==r;V++){var de=s[V],fe=de.shape,ye=de.force,me=de.tau;if(de.motionstate&he){var we=de.velocity,be=de.angularVelocity,xe=de.position,ge=de.quaternion,Ve=de.invMass,ze=de.invInertia;if(we.x+=ye.x*Ve*t,we.y+=ye.y*Ve*t,we.z+=ye.z*Ve*t,de.angularVelocity&&(be.x+=me.x*ze.x*t,be.y+=me.y*ze.y*t,be.z+=me.z*ze.z*t),de.isSleeping()||(xe.x+=we.x*t,xe.y+=we.y*t,xe.z+=we.z*t,de.angularVelocity&&(ae.set(be.x,be.y,be.z,0),ae.mult(ge,re),ge.x+=ue*re.x,ge.y+=ue*re.y,ge.z+=ue*re.z,ge.w+=ue*re.w,ce&&(le?ge.normalizeFast():ge.normalize())),de.aabbmin&&(de.aabbNeedsUpdate=!0)),fe)switch(fe.type){case pe:fe.worldNormalNeedsUpdate=!0;break;case ve:fe.worldFaceNormalsNeedsUpdate=!0,fe.worldVerticesNeedsUpdate=!0}}de.force.set(0,0,0),de.tau&&de.tau.set(0,0,0)}for(l&&(u.integrate=v()-i),this.time+=t,this.stepnumber+=1,this.dispatchEvent(T),V=0;V!==r;V++){var z=s[V],Ee=z.postStep;Ee&&Ee.call(z)}for(V=0;V!==r;V++){var de=s[V];de.inertiaWorldAutoUpdate&&de.quaternion.vmult(de.inertia,de.inertiaWorld),de.invInertiaWorldAutoUpdate&&de.quaternion.vmult(de.invInertia,de.invInertiaWorld)}if(this.allowSleep)for(V=0;V!==r;V++)s[V].sleepTick(this.time)},e.ContactGenerator=function(){function t(t,i){if(y.length){var n=y.pop();return n.bi=t,n.bj=i,n}return new e.ContactEquation(t,i)}function i(t){var e;e=t.ri,t.ri=t.rj,t.rj=e,t.ni.negate(t.ni),e=t.bi,t.bi=t.bj,t.bj=e}function n(e,i,n,o,a,r,s,h,c){var l=t(h,c);c.position.vsub(o,l.ni),l.ni.normalize(),l.ni.copy(l.ri),l.ni.copy(l.rj),l.ri.mult(i.radius,l.ri),l.rj.mult(-n.radius,l.rj),e.push(l)}function o(e,i,n,o,a,r,s,h,c){var l=t(h,c);l.ni.set(0,0,1),s.vmult(l.ni,l.ni),l.ni.negate(l.ni),l.ni.normalize(),l.ni.mult(i.radius,l.ri),o.vsub(a,w),l.ni.mult(l.ni.dot(w),b),w.vsub(b,l.rj),b.norm2()<=i.radius*i.radius&&e.push(l)}function a(t,e,i){for(var n=null,o=t.length,a=0;a!==o;a++){var r=t[a],s=x;t[(a+1)%o].vsub(r,s);var h=g;s.cross(e,h);var c=V;i.vsub(r,c);var l=h.dot(c);if(!(null===n||l>0&&n===!0||0>=l&&n===!1))return!1;null===n&&(n=l>0)}return!0}function r(e,i,n,o,a,r,s,h,c){var l=j;o.vsub(a,z),n.getSideNormals(l,s);for(var u=i.radius,p=!1,v=q,d=P,f=C,y=null,w=0,b=0,x=0,g=null,V=0,I=l.length;V!==I&&p===!1;V++){var B=E;l[V].copy(B);var O=B.norm();B.normalize();var R=z.dot(B);if(O+u>R&&R>0){var A=N,T=S;l[(V+1)%3].copy(A),l[(V+2)%3].copy(T);var F=A.norm(),k=T.norm();A.normalize(),T.normalize();var U=z.dot(A),W=z.dot(T);if(F>U&&U>-F&&k>W&&W>-k){var L=Math.abs(R-O-u);(null===g||g>L)&&(g=L,b=U,x=W,y=O,B.copy(v),A.copy(d),T.copy(f),w++)}}}if(w){p=!0;var D=t(h,c);v.mult(-u,D.ri),v.copy(D.ni),D.ni.negate(D.ni),v.mult(y,v),d.mult(b,d),v.vadd(d,v),f.mult(x,f),v.vadd(f,D.rj),e.push(D)}for(var Q=m.get(),H=M,X=0;2!==X&&!p;X++)for(var G=0;2!==G&&!p;G++)for(var _=0;2!==_&&!p;_++)if(Q.set(0,0,0),X?Q.vadd(l[0],Q):Q.vsub(l[0],Q),G?Q.vadd(l[1],Q):Q.vsub(l[1],Q),_?Q.vadd(l[2],Q):Q.vsub(l[2],Q),a.vadd(Q,H),H.vsub(o,H),u*u>H.norm2()){p=!0;var D=t(h,c);H.copy(D.ri),D.ri.normalize(),D.ri.copy(D.ni),D.ri.mult(u,D.ri),Q.copy(D.rj),e.push(D)}m.release(Q),Q=null;for(var Y=m.get(),Z=m.get(),D=m.get(),K=m.get(),L=m.get(),J=l.length,X=0;X!==J&&!p;X++)for(var G=0;G!==J&&!p;G++)if(X%3!==G%3){l[G].cross(l[X],Y),Y.normalize(),l[X].vadd(l[G],Z),o.copy(D),D.vsub(Z,D),D.vsub(a,D);var $=D.dot(Y);Y.mult($,K);for(var _=0;_===X%3||_===G%3;)_++;o.copy(L),L.vsub(K,L),L.vsub(Z,L),L.vsub(a,L);var te=Math.abs($),ee=L.norm();if(l[_].norm()>te&&u>ee){p=!0;var ie=t(h,c);Z.vadd(K,ie.rj),ie.rj.copy(ie.rj),L.negate(ie.ni),ie.ni.normalize(),ie.rj.copy(ie.ri),ie.ri.vadd(a,ie.ri),ie.ri.vsub(o,ie.ri),ie.ri.normalize(),ie.ri.mult(u,ie.ri),e.push(ie)}}m.release(Y,Z,D,K,L)}function s(e,i,n,o,r,s,h,c,l){o.vsub(r,I);for(var u=n.faceNormals,p=n.faces,v=n.vertices,d=i.radius,f=0;f!==v.length;f++){var y=v[f],w=A;h.vmult(y,w),r.vadd(w,w);var b=R;if(w.vsub(o,b),d*d>b.norm2()){g=!0;var x=t(c,l);return b.copy(x.ri),x.ri.normalize(),x.ri.copy(x.ni),x.ri.mult(d,x.ri),w.vsub(r,x.rj),e.push(x),void 0}}for(var g=!1,f=0,V=p.length;f!==V&&g===!1;f++){var z=u[f],E=p[f],N=T;h.vmult(z,N);var S=F;h.vmult(v[E[0]],S),S.vadd(r,S);var j=k;N.mult(-d,j),o.vadd(j,j);var M=U;j.vsub(S,M);var q=M.dot(N),P=W;if(o.vsub(S,P),0>q&&P.dot(N)>0){for(var C=[],L=0,D=E.length;L!==D;L++){var Q=m.get();h.vmult(v[E[L]],Q),r.vadd(Q,Q),C.push(Q)}if(a(C,N,o)){g=!0;var x=t(c,l);N.mult(-d,x.ri),N.negate(x.ni);var H=m.get();N.mult(-q,H);var X=m.get();N.mult(-d,X),o.vsub(r,x.rj),x.rj.vadd(X,x.rj),x.rj.vadd(H,x.rj),m.release(H),m.release(X),e.push(x);for(var L=0,G=C.length;L!==G;L++)m.release(C[L]);return}for(var L=0;L!==E.length;L++){var _=m.get(),Y=m.get();h.vmult(v[E[(L+1)%E.length]],_),h.vmult(v[E[(L+2)%E.length]],Y),r.vadd(_,_),r.vadd(Y,Y);var Z=B;Y.vsub(_,Z);var K=O;Z.unit(K);var J=m.get(),$=m.get();o.vsub(_,$);var te=$.dot(K);K.mult(te,J),J.vadd(_,J);var ee=m.get();if(J.vsub(o,ee),te>0&&Z.norm2()>te*te&&d*d>ee.norm2()){var x=t(c,l);J.vsub(r,x.rj),J.vsub(o,x.ni),x.ni.normalize(),x.ni.mult(d,x.ri),e.push(x);for(var L=0,G=C.length;L!==G;L++)m.release(C[L]);return m.release(_),m.release(Y),m.release(J),m.release(ee),m.release($),void 0}m.release(_),m.release(Y),m.release(J),m.release(ee),m.release($)}for(var L=0,G=C.length;L!==G;L++)m.release(C[L])}}}function h(t,e,i,n,o,a,r,s,h){l(t,e,i.convexPolyhedronRepresentation,n,o,a,r,s,h)}function c(t,i,n,o,a,r,s,h,c){for(var l=L,u=D,p=0,v=0,d=n.childShapes.length;v!==d;v++){var y=[],m=u.pop()||new e.Quaternion,w=l.pop()||new e.Vec3;s.mult(n.childOrientations[v],m),m.normalize(),s.vmult(n.childOffsets[v],w),a.vadd(w,w),f(y,i,n.childShapes[v],o,w,r,m,h,c),u.push(m);var b=w;i||(p+=y.length);for(var x=0;x!==y.length;x++)s.vmult(n.childOffsets[v],b),y[x].rj.vadd(b,y[x].rj),t.push(y[x]);l.push(w)}}function l(e,i,n,o,a,r,s,h,c){var l=Q,u=H;u.set(0,0,1),r.vmult(u,u);for(var p=X,v=0;v!==n.vertices.length;v++){n.vertices[v].copy(l),s.vmult(l,l),a.vadd(l,l),l.vsub(o,p);var d=u.dot(p);if(0>=d){var f=G;u.mult(u.dot(l),f),l.vsub(f,f);var y=t(h,c);u.copy(y.ni),f.copy(y.ri),l.vsub(a,y.rj),e.push(y)}}}function u(e,i,n,o,a,r,s,h,c){var l=_;if(i.findSeparatingAxis(n,o,r,a,s,l)){var u=[],p=Y;i.clipAgainstHull(o,r,n,a,s,l,-100,100,u);for(var v=0;v!==u.length;v++){var d=t(h,c);l.negate(d.ni),u[v].normal.negate(p),p.mult(u[v].depth,p),u[v].point.vadd(p,d.ri),u[v].point.copy(d.rj),d.rj.vsub(a,d.rj),d.ri.vsub(o,d.ri),e.push(d)}}}function p(e,i,n,o,a,r,s,h,c){var l=Z;l.set(0,0,1),c.quaternion.vmult(l,l);var u=K;o.vsub(c.position,u);var p=l.dot(u);if(0>=p){var v=t(h,c);l.copy(v.ni),v.ni.negate(v.ni),v.ri.set(0,0,0);var d=J;l.mult(l.dot(o),d),o.vsub(d,d),d.copy(v.rj),e.push(v)}}function v(e,i,n,o,a,r,s,h,c){var l=$;l.set(0,0,1),o.vsub(a,l);var u=l.norm2();if(n.radius*n.radius>=u){var p=t(h,c);l.normalize(),l.copy(p.rj),p.rj.mult(n.radius,p.rj),l.copy(p.ni),p.ni.negate(p.ni),p.ri.set(0,0,0),e.push(p)}}function d(e,i,n,o,a,r,s,h,c){var l=-1,u=ie,p=oe,v=null,d=0,f=ee;if(o.copy(f),f.vsub(a,f),s.conjugate(te),te.vmult(f,f),n.pointIsInside(f)){n.worldVerticesNeedsUpdate&&n.computeWorldVertices(a,s),n.worldFaceNormalsNeedsUpdate&&n.computeWorldFaceNormals(s);for(var y=0,m=n.faces.length;y!==m;y++){var w=[n.worldVertices[n.faces[y][0]]],b=n.worldFaceNormals[y];o.vsub(w[0],ne);var x=-b.dot(ne);(null===v||Math.abs(x)<Math.abs(v))&&(v=x,l=y,b.copy(u),d++)}if(-1!==l){var g=t(h,c);u.mult(v,p),p.vadd(o,p),p.vsub(a,p),p.copy(g.rj),u.negate(g.ni),g.ri.set(0,0,0),e.push(g)}else console.warn("Point found inside convex, but did not find penetrating face!")}}function f(t,a,y,m,w,b,x,g,V){var z=!1,E=e.Shape.types,N=E.SPHERE,S=E.PLANE,j=E.BOX,M=E.COMPOUND,q=E.CONVEXPOLYHEDRON;if(a&&y){if(a.type>y.type){var P;P=y,y=a,a=P,P=w,w=m,m=P,P=x,x=b,b=P,P=V,V=g,g=P,z=!0}}else if(a&&!y){var P;P=y,y=a,a=P,P=w,w=m,m=P,P=x,x=b,b=P,P=V,V=g,g=P,z=!0}if(a&&y){if(a.type===N)switch(y.type){case N:n(t,a,y,m,w,b,x,g,V);break;case S:o(t,a,y,m,w,b,x,g,V);break;case j:r(t,a,y,m,w,b,x,g,V);break;case M:c(t,a,y,m,w,b,x,g,V);break;case q:s(t,a,y,m,w,b,x,g,V);break;default:console.warn("Collision between CANNON.Shape.types.SPHERE and "+y.type+" not implemented yet.")}else if(a.type===E.PLANE)switch(y.type){case E.PLANE:throw Error("Plane-plane collision... wait, you did WHAT?");case E.BOX:h(t,a,y,m,w,b,x,g,V);break;case E.COMPOUND:c(t,a,y,m,w,b,x,g,V);break;case E.CONVEXPOLYHEDRON:l(t,a,y,m,w,b,x,g,V);break;default:console.warn("Collision between CANNON.Shape.types.PLANE and "+y.type+" not implemented yet.")}else if(a.type===E.BOX)switch(y.type){case E.BOX:f(t,a.convexPolyhedronRepresentation,y.convexPolyhedronRepresentation,m,w,b,x,g,V);break;case E.COMPOUND:c(t,a,y,m,w,b,x,g,V);break;case E.CONVEXPOLYHEDRON:f(t,a.convexPolyhedronRepresentation,y,m,w,b,x,g,V);break;default:console.warn("Collision between CANNON.Shape.types.BOX and "+y.type+" not implemented yet.")}else if(a.type===E.COMPOUND)switch(y.type){case E.COMPOUND:c(t,a,y,m,w,b,x,g,V);break;case E.CONVEXPOLYHEDRON:var C=[];c(C,y,a,w,m,x,b,V,g);for(var I=0;I!==C.length;I++)i(C[I]),t.push(C[I]);break;default:console.warn("Collision between CANNON.Shape.types.COMPOUND and "+y.type+" not implemented yet.")}else if(a.type===E.CONVEXPOLYHEDRON)switch(y.type){case E.CONVEXPOLYHEDRON:u(t,a,y,m,w,b,x,g,V);break;default:console.warn("Collision between CANNON.Shape.types.CONVEXPOLYHEDRON and "+y.type+" not implemented yet.")}}else switch(y.type){case E.PLANE:p(t,a,y,m,w,b,x,g,V);break;case E.SPHERE:v(t,a,y,m,w,b,x,g,V);break;case E.BOX:d(t,a,y.convexPolyhedronRepresentation,m,w,b,x,g,V);break;case E.CONVEXPOLYHEDRON:d(t,a,y,m,w,b,x,g,V);break;case E.COMPOUND:c(t,a,y,m,w,b,x,g,V);break;default:console.warn("Collision between CANNON.Particle and "+y.type+" not implemented yet.")}for(var B=0,O=t.length;z&&B!==O;B++)i(t[B])}this.contactReduction=!1;var y=[],m=new e.Vec3Pool,w=new e.Vec3,b=new e.Vec3,x=new e.Vec3,g=new e.Vec3,V=new e.Vec3,z=new e.Vec3,E=new e.Vec3,N=new e.Vec3,S=new e.Vec3,j=[new e.Vec3,new e.Vec3,new e.Vec3,new e.Vec3,new e.Vec3,new e.Vec3],M=new e.Vec3,q=new e.Vec3,P=new e.Vec3,C=new e.Vec3,I=new e.Vec3,B=new e.Vec3,O=new e.Vec3,R=new e.Vec3,A=new e.Vec3,T=new e.Vec3,F=new e.Vec3,k=new e.Vec3,U=new e.Vec3,W=new e.Vec3;new e.Vec3,new e.Vec3;var L=[],D=[],Q=new e.Vec3,H=new e.Vec3,X=new e.Vec3,G=new e.Vec3,_=new e.Vec3,Y=new e.Vec3,Z=new e.Vec3,K=new e.Vec3,J=new e.Vec3,$=new e.Vec3,te=new e.Quaternion,ee=new e.Vec3;new e.Vec3;var ie=new e.Vec3,ne=new e.Vec3,oe=new e.Vec3;this.reduceContacts=function(){},this.getContacts=function(t,e,i,n,o){y=o;for(var a=0,r=t.length;a!==r;a++){var s=t[a],h=e[a];f(n,s.shape,h.shape,s.position,h.position,s.quaternion,h.quaternion,s,h)}}},e.Equation=function(t,e,i,n){this.id=-1,this.minForce=i===void 0?-1e6:i,this.maxForce=n===void 0?1e6:n,this.bi=t,this.bj=e,this.stiffness=1e7,this.regularizationTime=5,this.a=0,this.b=0,this.eps=0,this.spookParamsNeedsUpdate=!0},e.Equation.prototype.constructor=e.Equation,e.Equation.prototype.updateSpookParams=function(t){var e=this.regularizationTime,i=this.stiffness;this.a=4/(t*(1+4*e)),this.b=4*e/(1+4*e),this.eps=4/(t*t*i*(1+4*e))},e.ContactEquation=function(t,i){e.Equation.call(this,t,i,0,1e6),this.restitution=0,this.ri=new e.Vec3,this.penetrationVec=new e.Vec3,this.rj=new e.Vec3,this.ni=new e.Vec3,this.rixn=new e.Vec3,this.rjxn=new e.Vec3,this.invIi=new e.Mat3,this.invIj=new e.Mat3,this.biInvInertiaTimesRixn=new e.Vec3,this.bjInvInertiaTimesRjxn=new e.Vec3},e.ContactEquation.prototype=new e.Equation,e.ContactEquation.prototype.constructor=e.ContactEquation,e.ContactEquation.prototype.reset=function(){this.invInertiaTimesRxnNeedsUpdate=!0};var X=new e.Vec3,G=new e.Vec3,_=new e.Vec3;e.ContactEquation.prototype.computeB=function(t){var e=this.a,i=this.b,n=this.bi,o=this.bj,a=this.ri,r=this.rj,s=this.rixn,h=this.rjxn,c=_,l=n.velocity,u=n.angularVelocity?n.angularVelocity:c,p=n.force,v=n.tau?n.tau:c,d=o.velocity,f=o.angularVelocity?o.angularVelocity:c,y=o.force,m=o.tau?o.tau:c,w=this.penetrationVec,b=n.invMass,x=o.invMass,g=this.invIi,V=this.invIj;n.invInertia?g.setTrace(n.invInertia):g.identity(),o.invInertia?V.setTrace(o.invInertia):V.identity();var z=this.ni;a.cross(z,s),r.cross(z,h);var w=this.penetrationVec;w.set(0,0,0),w.vadd(o.position,w),w.vadd(r,w),w.vsub(n.position,w),w.vsub(a,w);var E=z.dot(w),N=X,S=G;g.vmult(v,N),V.vmult(m,S);var j=this.restitution+1,M=j*d.dot(z)-j*l.dot(z)+f.dot(h)-u.dot(s),q=y.dot(z)*x-p.dot(z)*b+h.dot(S)-s.dot(N),P=-E*e-M*i-t*q;return P},new e.Vec3,new e.Vec3,e.ContactEquation.prototype.computeC=function(){var t=this.bi,e=this.bj,i=this.rixn,n=this.rjxn,o=t.invMass,a=e.invMass,r=o+a+this.eps,s=this.invIi,h=this.invIj;return s.vmult(i,this.biInvInertiaTimesRixn),h.vmult(n,this.bjInvInertiaTimesRjxn),r+=this.biInvInertiaTimesRixn.dot(i),r+=this.bjInvInertiaTimesRjxn.dot(n)};var Y=new e.Vec3;e.ContactEquation.prototype.computeGWlambda=function(){var t=this.bi,e=this.bj,i=Y,n=0;return e.vlambda.vsub(t.vlambda,i),n+=i.dot(this.ni),t.wlambda&&(n-=t.wlambda.dot(this.rixn)),e.wlambda&&(n+=e.wlambda.dot(this.rjxn)),n};var Z=new e.Vec3,K=new e.Vec3;e.ContactEquation.prototype.addToWlambda=function(t){var e=this.bi,i=this.bj,n=(this.rixn,this.rjxn,e.invMass),o=i.invMass,a=this.ni,r=Z,s=K;a.mult(n*t,s),e.vlambda.vsub(s,e.vlambda),a.mult(o*t,s),i.vlambda.vadd(s,i.vlambda),void 0!==e.wlambda&&(this.biInvInertiaTimesRixn.mult(t,r),e.wlambda.vsub(r,e.wlambda)),void 0!==i.wlambda&&(this.bjInvInertiaTimesRjxn.mult(t,r),i.wlambda.vadd(r,i.wlambda))},e.FrictionEquation=function(t,i,n){e.Equation.call(this,t,i,-n,n),this.ri=new e.Vec3,this.rj=new e.Vec3,this.t=new e.Vec3,this.rixt=new e.Vec3,this.rjxt=new e.Vec3,this.wixri=new e.Vec3,this.wjxrj=new e.Vec3,this.invIi=new e.Mat3,this.invIj=new e.Mat3,this.relVel=new e.Vec3,this.relForce=new e.Vec3,this.biInvInertiaTimesRixt=new e.Vec3,this.bjInvInertiaTimesRjxt=new e.Vec3},e.FrictionEquation.prototype=new e.Equation,e.FrictionEquation.prototype.constructor=e.FrictionEquation;var J=new e.Vec3,$=new e.Vec3,te=new e.Vec3;e.FrictionEquation.prototype.computeB=function(e){var i=this.a,n=this.b,o=this.bi,a=this.bj,r=this.ri,s=this.rj,h=this.rixt,c=this.rjxt,l=this.wixri,u=this.wjxrj,p=te;vi=o.velocity,wi=o.angularVelocity?o.angularVelocity:p,fi=o.force,taui=o.tau?o.tau:p,vj=a.velocity,wj=a.angularVelocity?a.angularVelocity:p,fj=a.force,tauj=a.tau?a.tau:p,relVel=this.relVel,relForce=this.relForce,invMassi=o.invMass,invMassj=a.invMass,invIi=this.invIi,invIj=this.invIj,t=this.t,invIi_vmult_taui=J,invIj_vmult_tauj=$,o.invInertia&&invIi.setTrace(o.invInertia),a.invInertia&&invIj.setTrace(a.invInertia),r.cross(t,h),s.cross(t,c),wi.cross(r,l),wj.cross(s,u),invIi.vmult(taui,invIi_vmult_taui),invIj.vmult(tauj,invIj_vmult_tauj);var v=0,d=vj.dot(t)-vi.dot(t)+u.dot(t)-l.dot(t),f=fj.dot(t)*invMassj-fi.dot(t)*invMassi+c.dot(invIj_vmult_tauj)-h.dot(invIi_vmult_taui),y=-v*i-d*n-e*f;return y},e.FrictionEquation.prototype.computeC=function(){var t=this.bi,e=this.bj,i=this.rixt,n=this.rjxt,o=t.invMass,a=e.invMass,r=o+a+this.eps,s=this.invIi,h=this.invIj;return s.vmult(i,this.biInvInertiaTimesRixt),h.vmult(n,this.bjInvInertiaTimesRjxt),r+=this.biInvInertiaTimesRixt.dot(i),r+=this.bjInvInertiaTimesRjxt.dot(n)};var ee=new e.Vec3;e.FrictionEquation.prototype.computeGWlambda=function(){var t=this.bi,e=this.bj,i=0,n=ee;return e.vlambda.vsub(t.vlambda,n),i+=n.dot(this.t),t.wlambda&&(i-=t.wlambda.dot(this.rixt)),e.wlambda&&(i+=e.wlambda.dot(this.rjxt)),i};var ie=new e.Vec3;e.FrictionEquation.prototype.addToWlambda=function(t){var e=this.bi,i=this.bj,n=(this.rixt,this.rjxt,e.invMass),o=i.invMass,a=this.t,r=ie,s=e.wlambda,h=i.wlambda;a.mult(n*t,r),e.vlambda.vsub(r,e.vlambda),a.mult(o*t,r),i.vlambda.vadd(r,i.vlambda),s&&(this.biInvInertiaTimesRixt.mult(t,r),s.vsub(r,s)),h&&(this.bjInvInertiaTimesRjxt.mult(t,r),h.vadd(r,h))},e.RotationalEquation=function(t,i){e.Equation.call(this,t,i,-1e6,1e6),this.ni=new e.Vec3,this.nj=new e.Vec3,this.nixnj=new e.Vec3,this.njxni=new e.Vec3,this.invIi=new e.Mat3,this.invIj=new e.Mat3,this.relVel=new e.Vec3,this.relForce=new e.Vec3},e.RotationalEquation.prototype=new e.Equation,e.RotationalEquation.prototype.constructor=e.RotationalEquation,e.RotationalEquation.prototype.computeB=function(t){var i=this.a,n=this.b,o=this.bi,a=this.bj,r=this.ni,s=this.nj,h=this.nixnj,c=this.njxni;o.velocity;var l=o.angularVelocity?o.angularVelocity:new e.Vec3;o.force,o.tau?o.tau:new e.Vec3,a.velocity;var u=a.angularVelocity?a.angularVelocity:new e.Vec3;a.force,a.tau?a.tau:new e.Vec3,o.invMass,a.invMass;var p=this.invIi,v=this.invIj;o.invInertia?p.setTrace(o.invInertia):p.identity(),a.invInertia?v.setTrace(a.invInertia):v.identity(),r.cross(s,h),s.cross(r,c);var d=-r.dot(s),f=c.dot(l)+h.dot(u),y=0,m=-d*i-f*n-t*y;return m},e.RotationalEquation.prototype.computeC=function(){var t=this.bi,e=this.bj,i=this.nixnj,n=this.njxni;t.invMass,e.invMass;var o=this.eps,a=this.invIi,r=this.invIj;return t.invInertia?a.setTrace(t.invInertia):a.identity(),e.invInertia?r.setTrace(e.invInertia):r.identity(),o+=a.vmult(n).dot(n),o+=r.vmult(i).dot(i)};var Y=new e.Vec3;e.RotationalEquation.prototype.computeGWlambda=function(){var t=this.bi,e=this.bj,i=0;return t.wlambda&&(i+=t.wlambda.dot(this.njxni)),e.wlambda&&(i+=e.wlambda.dot(this.nixnj)),i},e.RotationalEquation.prototype.addToWlambda=function(t){var e=this.bi,i=this.bj,n=this.nixnj;if(this.njxni,e.invMass,i.invMass,e.wlambda){var o=this.invIi;e.wlambda.vsub(o.vmult(n).mult(t),e.wlambda)}if(i.wlambda){var o=this.invIj;i.wlambda.vadd(o.vmult(n).mult(t),i.wlambda)}},e.Constraint=function(t,e){this.equations=[],this.bodyA=t,this.bodyB=e},e.Constraint.prototype.update=function(){throw Error("method update() not implmemented in this Constraint subclass!")},e.DistanceConstraint=function(t,i,n,o){e.Constraint.call(this,t,i),o===void 0&&(o=1e6);var a=this.equations=[new e.ContactEquation(t,i)],r=a[0];r.minForce=-o,r.maxForce=o,this.update=function(){i.position.vsub(t.position,r.ni),r.ni.normalize(),r.ni.mult(.5*n,r.ri),r.ni.mult(.5*-n,r.rj)}},e.DistanceConstraint.prototype=new e.Constraint,e.RotationalMotorEquation=function(t,i,n){n=n||1e6,e.Equation.call(this,t,i,-n,n),this.axisA=new e.Vec3,this.axisB=new e.Vec3,this.invIi=new e.Mat3,this.invIj=new e.Mat3,this.targetVelocity=0},e.RotationalMotorEquation.prototype=new e.Equation,e.RotationalMotorEquation.prototype.constructor=e.RotationalMotorEquation,e.RotationalMotorEquation.prototype.computeB=function(t){var i=this.a,n=this.b,o=this.bi,a=this.bj,r=this.axisA,s=this.axisB;o.velocity;var h=o.angularVelocity?o.angularVelocity:new e.Vec3;o.force,o.tau?o.tau:new e.Vec3,a.velocity;var c=a.angularVelocity?a.angularVelocity:new e.Vec3;a.force,a.tau?a.tau:new e.Vec3,o.invMass,a.invMass;var l=this.invIi,u=this.invIj;o.invInertia?l.setTrace(o.invInertia):l.identity(),a.invInertia?u.setTrace(a.invInertia):u.identity();var p=0,v=r.dot(h)+s.dot(c)+this.targetVelocity,d=0,f=-p*i-v*n-t*d;return f},e.RotationalMotorEquation.prototype.computeC=function(){var t=this.bi,e=this.bj,i=this.axisA,n=this.axisB;t.invMass,e.invMass;var o=this.eps,a=this.invIi,r=this.invIj;return t.invInertia?a.setTrace(t.invInertia):a.identity(),e.invInertia?r.setTrace(e.invInertia):r.identity(),o+=a.vmult(i).dot(n),o+=r.vmult(n).dot(n)};var Y=new e.Vec3;e.RotationalMotorEquation.prototype.computeGWlambda=function(){var t=this.bi,e=this.bj,i=this.axisA,n=this.axisB,o=0;return t.wlambda&&(o+=t.wlambda.dot(i)),e.wlambda&&(o+=e.wlambda.dot(n)),o},e.RotationalMotorEquation.prototype.addToWlambda=function(t){var e=this.bi,i=this.bj,n=this.axisA,o=this.axisB;if(e.invMass,i.invMass,e.wlambda){var a=this.invIi;e.wlambda.vsub(a.vmult(n).mult(t),e.wlambda)}if(i.wlambda){var a=this.invIj;i.wlambda.vadd(a.vmult(o).mult(t),i.wlambda)}},e.HingeConstraint=function(t,i,n,o,a,r,s){e.Constraint.call(this,t,o),s=s||1e6;var h=this,c=this.equations=[new e.RotationalEquation(t,o),new e.RotationalEquation(t,o),new e.ContactEquation(t,o),new e.ContactEquation(t,o),new e.ContactEquation(t,o)];this.getRotationalEquation1=function(){return c[0]},this.getRotationalEquation2=function(){return c[1]},this.getPointToPointEquation1=function(){return c[2]},this.getPointToPointEquation2=function(){return c[3]},this.getPointToPointEquation3=function(){return c[4]};var l,u=this.getRotationalEquation1(),p=this.getRotationalEquation2(),v=this.getPointToPointEquation1(),d=this.getPointToPointEquation2(),f=this.getPointToPointEquation3();d.minForce=f.minForce=v.minForce=-s,d.maxForce=f.maxForce=v.maxForce=s;var y=i.unit(),m=a.unit(),w=n.cross(y),b=n.cross(w),x=r.cross(m);w.normalize(),x.normalize();var g=!1;this.motorTargetVelocity=0,this.motorMinForce=-s,this.motorMaxForce=s,this.enableMotor=function(){g||(l=new e.RotationalMotorEquation(t,o,s),c.push(l),g=!0)},this.disableMotor=function(){g&&(g=!1,l=null,c.pop())},this.update=function(){v.ni.set(1,0,0),d.ni.set(0,1,0),f.ni.set(0,0,1),t.quaternion.vmult(i,v.ri),o.quaternion.vmult(a,v.rj),v.ri.copy(d.ri),v.rj.copy(d.rj),v.ri.copy(f.ri),v.rj.copy(f.rj),t.quaternion.vmult(w,u.ni),o.quaternion.vmult(r,u.nj),t.quaternion.vmult(b,p.ni),o.quaternion.vmult(r,p.nj),g&&(t.quaternion.vmult(n,l.axisA),o.quaternion.vmult(r,l.axisB),l.targetVelocity=h.motorTargetVelocity,l.maxForce=h.motorMaxForce,l.minForce=h.motorMinForce)}},e.HingeConstraint.prototype=new e.Constraint,e.PointToPointConstraint=function(t,i,n,o,a){e.Constraint.call(this,t,n);var r=this.equations=[new e.ContactEquation(t,n),new e.ContactEquation(t,n),new e.ContactEquation(t,n)],s=r[0],h=r[1],c=r[2];h.minForce=c.minForce=s.minForce=-a,h.maxForce=c.maxForce=s.maxForce=a,this.update=function(){n.position.vsub(t.position,s.ni),s.ni.normalize(),t.quaternion.vmult(i,s.ri),n.quaternion.vmult(o,s.rj),s.ni.tangents(h.ni,c.ni),s.ri.copy(h.ri),s.rj.copy(h.rj),s.ri.copy(c.ri),s.rj.copy(c.rj)}},e.PointToPointConstraint.prototype=new e.Constraint,"undefined"!=typeof module?module.exports=e:this.CANNON=e}).apply(this);