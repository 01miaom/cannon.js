(function(){var t=t||{};this.Int32Array||(this.Int32Array=Array,this.Float32Array=Array),t.Mat3=function(t){this.elements=t?t:[0,0,0,0,0,0,0,0,0]},t.Mat3.prototype.identity=function(){this.elements[0]=1,this.elements[1]=0,this.elements[2]=0,this.elements[3]=0,this.elements[4]=1,this.elements[5]=0,this.elements[6]=0,this.elements[7]=0,this.elements[8]=1},t.Mat3.prototype.setZero=function(){var t=this.elements;t[0]=0,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=0,t[6]=0,t[7]=0,t[8]=0},t.Mat3.prototype.setTrace=function(t){var e=this.elements;e[0]=t.x,e[4]=t.y,e[8]=t.z},mat3.setTrace=function(t,e){t[0]=e[0],t[4]=e[1],t[8]=e[2]},t.Mat3.prototype.vmult=function(e,i){i=i||new t.Vec3;var a=this.elements,r=e.x,o=e.y,s=e.z;return i.x=a[0]*r+a[1]*o+a[2]*s,i.y=a[3]*r+a[4]*o+a[5]*s,i.z=a[6]*r+a[7]*o+a[8]*s,i},t.Mat3.prototype.smult=function(t){for(var e=0;this.elements.length>e;e++)this.elements[e]*=t},t.Mat3.prototype.mmult=function(e){for(var i=new t.Mat3,a=0;3>a;a++)for(var r=0;3>r;r++){for(var o=0,s=0;3>s;s++)o+=e.elements[a+3*s]*this.elements[s+3*r];i.elements[a+3*r]=o}return i},t.Mat3.prototype.solve=function(e,i){i=i||new t.Vec3;for(var a=3,r=4,o=[],s=0;a*r>s;s++)o.push(0);var s,n;for(s=0;3>s;s++)for(n=0;3>n;n++)o[s+r*n]=this.elements[s+3*n];o[3]=e.x,o[7]=e.y,o[11]=e.z;var c,h,v=3,l=v,u=4;do{if(s=l-v,0===o[s+r*s])for(n=s+1;l>n;n++)if(0!==o[s+r*n]){c=u;do h=u-c,o[h+r*s]+=o[h+r*n];while(--c);break}if(0!==o[s+r*s])for(n=s+1;l>n;n++){var p=o[s+r*n]/o[s+r*s];c=u;do h=u-c,o[h+r*n]=s>=h?0:o[h+r*n]-o[h+r*s]*p;while(--c)}}while(--v);if(i.z=o[2*r+3]/o[2*r+2],i.y=(o[1*r+3]-o[1*r+2]*i.z)/o[1*r+1],i.x=(o[0*r+3]-o[0*r+2]*i.z-o[0*r+1]*i.y)/o[0*r+0],isNaN(i.x)||isNaN(i.y)||isNaN(i.z)||1/0===i.x||1/0===i.y||1/0===i.z)throw"Could not solve equation! Got x=["+(""+i)+"], b=["+(""+e)+"], A=["+(""+this)+"]";return i},t.Mat3.prototype.e=function(t,e,i){return void 0===i?this.elements[e+3*t]:(this.elements[e+3*t]=i,void 0)},t.Mat3.prototype.copy=function(e){e=e||new t.Mat3;for(var i=0;this.elements.length>i;i++)e.elements[i]=this.elements[i];return e},t.Mat3.prototype.toString=function(){for(var t="",e=",",i=0;9>i;i++)t+=this.elements[i]+e;return t},t.Mat3.prototype.reverse=function(e){e=e||new t.Mat3;for(var i=3,a=6,r=[],o=0;i*a>o;o++)r.push(0);var o,s;for(o=0;3>o;o++)for(s=0;3>s;s++)r[o+a*s]=this.elements[o+3*s];r[3]=1,r[9]=0,r[15]=0,r[4]=0,r[10]=1,r[16]=0,r[5]=0,r[11]=0,r[17]=1;var n,c,h=3,v=h,l=a;do{if(o=v-h,0===r[o+a*o])for(s=o+1;v>s;s++)if(0!==r[o+a*s]){n=l;do c=l-n,r[c+a*o]+=r[c+a*s];while(--n);break}if(0!==r[o+a*o])for(s=o+1;v>s;s++){var u=r[o+a*s]/r[o+a*o];n=l;do c=l-n,r[c+a*s]=o>=c?0:r[c+a*s]-r[c+a*o]*u;while(--n)}}while(--h);o=2;do{s=o-1;do{var u=r[o+a*s]/r[o+a*o];n=a;do c=a-n,r[c+a*s]=r[c+a*s]-r[c+a*o]*u;while(--n)}while(s--)}while(--o);o=2;do{var u=1/r[o+a*o];n=a;do c=a-n,r[c+a*o]=r[c+a*o]*u;while(--n)}while(o--);o=2;do{s=2;do{if(c=r[i+s+a*o],isNaN(c)||1/0===c)throw"Could not reverse! A=["+(""+this)+"]";e.e(o,s,c)}while(s--)}while(o--);return e},t.Vec3=function(t,e,i){this.x=t||0,this.y=e||0,this.z=i||0},t.Vec3.prototype.cross=function(e,i){var a=e.x,r=e.y,o=e.z,s=this.x,n=this.y,c=this.z;return i=i||new t.Vec3,i.x=n*o-c*r,i.y=c*a-s*o,i.z=s*r-n*a,i},t.Vec3.prototype.set=function(t,e,i){return this.x=t,this.y=e,this.z=i,this},t.Vec3.prototype.vadd=function(e,i){return i?(i.x=e.x+this.x,i.y=e.y+this.y,i.z=e.z+this.z,void 0):new t.Vec3(this.x+e.x,this.y+e.y,this.z+e.z)},t.Vec3.prototype.vsub=function(e,i){return i?(i.x=this.x-e.x,i.y=this.y-e.y,i.z=this.z-e.z,void 0):new t.Vec3(this.x-e.x,this.y-e.y,this.z-e.z)},t.Vec3.prototype.crossmat=function(){return new t.Mat3([0,-this.z,this.y,this.z,0,-this.x,-this.y,this.x,0])},t.Vec3.prototype.normalize=function(){var t=this.x,e=this.y,i=this.z,a=Math.sqrt(t*t+e*e+i*i);if(a>0){var r=1/a;this.x*=r,this.y*=r,this.z*=r}else this.x=0,this.y=0,this.z=0;return a},t.Vec3.prototype.unit=function(e){e=e||new t.Vec3;var i=this.x,a=this.y,r=this.z,o=Math.sqrt(i*i+a*a+r*r);return o>0?(o=1/o,e.x=i*o,e.y=a*o,e.z=r*o):(e.x=1,e.y=0,e.z=0),e},t.Vec3.prototype.norm=function(){var t=this.x,e=this.y,i=this.z;return Math.sqrt(t*t+e*e+i*i)},t.Vec3.prototype.norm2=function(){return this.dot(this)},t.Vec3.prototype.distanceTo=function(t){var e=this.x,i=this.y,a=this.z,r=t.x,o=t.y,s=t.z;return Math.sqrt((r-e)*(r-e)+(o-i)*(o-i)+(s-a)*(s-a))},t.Vec3.prototype.mult=function(e,i){i=i||new t.Vec3;var a=this.x,r=this.y,o=this.z;return i.x=e*a,i.y=e*r,i.z=e*o,i},t.Vec3.prototype.dot=function(t){return this.x*t.x+this.y*t.y+this.z*t.z},t.Vec3.prototype.isZero=function(){return 0===this.x&&0===this.y&&0===this.z},t.Vec3.prototype.negate=function(e){return e=e||new t.Vec3,e.x=-this.x,e.y=-this.y,e.z=-this.z,e};var e=new t.Vec3,i=new t.Vec3;t.Vec3.prototype.tangents=function(t,a){var r=this.norm();if(r>0){var o=e,s=1/r;o.set(this.x*s,this.y*s,this.z*s);var n=i;.9>Math.abs(o.x)?(n.set(1,0,0),o.cross(n,t)):(n.set(0,1,0),o.cross(n,t)),o.cross(t,a)}else t.set(1,0,0).normalize(),a.set(0,1,0).normalize()};var a=vec3.create(),r=vec3.create();vec3.tangents=function(t,e,i){var o=vec3.length(i);if(o>0){var s=a,n=1/o;vec3.set(s,i[0]*n,i[1]*n,i[2]*n);var c=r;.9>Math.abs(s[0])?(vec3.set(c,1,0,0),vec3.cross(t,s,c)):(vec3.set(c,0,1,0),vec3.cross(t,s,c)),vec3.cross(e,s,t)}else vec3.set(t,1,0,0),vec3.set(e,0,1,0)},t.Vec3.prototype.toString=function(){return this.x+","+this.y+","+this.z},t.Vec3.prototype.copy=function(e){return e=e||new t.Vec3,e.x=this.x,e.y=this.y,e.z=this.z,e},t.Vec3.prototype.lerp=function(t,e,i){var a=this.x,r=this.y,o=this.z;i.x=a+(t.x-a)*e,i.y=r+(t.y-r)*e,i.z=o+(t.z-o)*e},t.Vec3.prototype.almostEquals=function(t,e){return void 0===e&&(e=1e-6),Math.abs(this.x-t.x)>e||Math.abs(this.y-t.y)>e||Math.abs(this.z-t.z)>e?!1:!0},vec3.almostEquals=function(t,e,i){return void 0===i&&(i=1e-6),Math.abs(t[0]-e[0])>i||Math.abs(t[1]-e[1])>i||Math.abs(t[2]-e[2])>i?!1:!0},t.Vec3.prototype.almostZero=function(t){return void 0===t&&(t=1e-6),Math.abs(this.x)>t||Math.abs(this.y)>t||Math.abs(this.z)>t?!1:!0},vec3.clamp=function(t,e,i,a){return vec3.copy(t,e),e[0]<i[0]&&(t[0]=i[0]),e[1]<i[1]&&(t[1]=i[1]),e[2]<i[2]&&(t[2]=i[2]),e[0]>a[0]&&(t[0]=a[0]),e[1]>a[1]&&(t[1]=a[1]),e[2]>a[2]&&(t[2]=a[2]),t},t.Quaternion=function(t,e,i,a){this.x=void 0!==t?t:0,this.y=void 0!==e?e:0,this.z=void 0!==i?i:0,this.w=void 0!==a?a:1},t.Quaternion.prototype.set=function(t,e,i,a){this.x=t,this.y=e,this.z=i,this.w=a},t.Quaternion.prototype.toString=function(){return this.x+","+this.y+","+this.z+","+this.w},t.Quaternion.prototype.setFromAxisAngle=function(t,e){var i=Math.sin(.5*e);this.x=t.x*i,this.y=t.y*i,this.z=t.z*i,this.w=Math.cos(.5*e)},t.Quaternion.prototype.toAxisAngle=function(e){e=e||new t.Vec3,this.normalize();var i=2*Math.acos(this.w),a=Math.sqrt(1-this.w*this.w);return.001>a?(e.x=this.x,e.y=this.y,e.z=this.z):(e.x=this.x/a,e.y=this.y/a,e.z=this.z/a),[e,i]},t.Quaternion.prototype.setFromVectors=function(t,e){var i=t.cross(e);this.x=i.x,this.y=i.y,this.z=i.z,this.w=Math.sqrt(Math.pow(t.norm(),2)*Math.pow(e.norm(),2))+t.dot(e),this.normalize()};var o=new t.Vec3,s=new t.Vec3,n=new t.Vec3;t.Quaternion.prototype.mult=function(e,i){i=i||new t.Quaternion;var a=this.w,r=o,c=s,h=n;return r.set(this.x,this.y,this.z),c.set(e.x,e.y,e.z),i.w=a*e.w-r.dot(c),r.cross(c,h),i.x=a*c.x+e.w*r.x+h.x,i.y=a*c.y+e.w*r.y+h.y,i.z=a*c.z+e.w*r.z+h.z,i},t.Quaternion.prototype.inverse=function(e){var i=this.x,a=this.y,r=this.z,o=this.w;e=e||new t.Quaternion,this.conjugate(e);var s=1/(i*i+a*a+r*r+o*o);return e.x*=s,e.y*=s,e.z*=s,e.w*=s,e},t.Quaternion.prototype.conjugate=function(e){return e=e||new t.Quaternion,e.x=-this.x,e.y=-this.y,e.z=-this.z,e.w=this.w,e},t.Quaternion.prototype.normalize=function(){var t=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);0===t?(this.x=0,this.y=0,this.z=0,this.w=0):(t=1/t,this.x*=t,this.y*=t,this.z*=t,this.w*=t)},t.Quaternion.prototype.normalizeFast=function(){var t=(3-(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w))/2;0===t?(this.x=0,this.y=0,this.z=0,this.w=0):(this.x*=t,this.y*=t,this.z*=t,this.w*=t)},t.Quaternion.prototype.vmult=function(e,i){if(i=i||new t.Vec3,0===this.w)i.x=e.x,i.y=e.y,i.z=e.z;else{var a=e.x,r=e.y,o=e.z,s=this.x,n=this.y,c=this.z,h=this.w,v=h*a+n*o-c*r,l=h*r+c*a-s*o,u=h*o+s*r-n*a,p=-s*a-n*r-c*o;i.x=v*h+p*-s+l*-c-u*-n,i.y=l*h+p*-n+u*-s-v*-c,i.z=u*h+p*-c+v*-n-l*-s}return i},t.Quaternion.prototype.copy=function(t){t.x=this.x,t.y=this.y,t.z=this.z,t.w=this.w},t.Quaternion.prototype.toEuler=function(t,e){e=e||"YZX";var i,a,r,o=this.x,s=this.y,n=this.z,c=this.w;switch(e){case"YZX":var h=o*s+n*c;if(h>.499&&(i=2*Math.atan2(o,c),a=Math.PI/2,r=0),-.499>h&&(i=-2*Math.atan2(o,c),a=-Math.PI/2,r=0),isNaN(i)){var v=o*o,l=s*s,u=n*n;i=Math.atan2(2*s*c-2*o*n,1-2*l-2*u),a=Math.asin(2*h),r=Math.atan2(2*o*c-2*s*n,1-2*v-2*u)}break;default:throw Error("Euler order "+e+" not supported yet.")}t.y=i,t.z=a,t.x=r},t.EventTarget=function(){var t={};this.addEventListener=function(e,i){void 0===t[e]&&(t[e]=[]),-1===t[e].indexOf(i)&&t[e].push(i)},this.dispatchEvent=function(e){for(var i in t[e.type])t[e.type][i](e)},this.removeEventListener=function(e,i){var a=t[e].indexOf(i);-1!==a&&t[e].splice(a,1)}},t.ObjectPool=function(){this.objects=[],this.type=Object},t.ObjectPool.prototype.release=function(){for(var t=arguments.length,e=0;e!==t;e++)this.objects.push(arguments[e])},t.ObjectPool.prototype.get=function(){return 0===this.objects.length?this.constructObject():this.objects.pop()},t.ObjectPool.prototype.constructObject=function(){throw Error("constructObject() not implemented in this ObjectPool subclass yet!")},t.Vec3Pool=function(){t.ObjectPool.call(this),this.type=vec3},t.Vec3Pool.prototype=new t.ObjectPool,t.Vec3Pool.prototype.constructObject=function(){return vec3.create()},t.Shape=function(){this.type=0,this.aabbmin=vec3.create(),this.aabbmax=vec3.create(),this.boundingSphereRadius=0,this.boundingSphereRadiusNeedsUpdate=!0},t.Shape.prototype.constructor=t.Shape,t.Shape.prototype.computeBoundingSphereRadius=function(){throw"computeBoundingSphereRadius() not implemented for shape type "+this.type},t.Shape.prototype.getBoundingSphereRadius=function(){return this.boundingSphereRadiusNeedsUpdate&&this.computeBoundingSphereRadius(),this.boundingSphereRadius},t.Shape.prototype.volume=function(){throw"volume() not implemented for shape type "+this.type},t.Shape.prototype.calculateLocalInertia=function(){throw"calculateLocalInertia() not implemented for shape type "+this.type};var c=vec3.create(),h=vec3.create();t.Shape.prototype.calculateTransformedInertia=function(t,e,i){i=i||vec3.create();var a=c,r=h;return this.calculateLocalInertia(t,a),e.vmult(a,r),i.x=Math.abs(r.x),i.y=Math.abs(r.y),i.z=Math.abs(r.z),i},t.Shape.calculateLocalAABB=function(){throw Error(".calculateLocalAABB is not implemented for this Shape yet!")},t.Shape.types={SPHERE:1,PLANE:2,BOX:4,COMPOUND:8,CONVEXPOLYHEDRON:16},t.Body=function(e){t.EventTarget.apply(this),this.type=e,this.world=null,this.preStep=null,this.postStep=null,this.vlambda=vec3.create(),this.collisionFilterGroup=1,this.collisionFilterMask=1},t.Body.DYNAMIC=1,t.Body.STATIC=2,t.Body.KINEMATIC=4,t.Particle=function(e,i){if("number"!=typeof e)throw Error("Argument 1 (mass) must be a number.");if(i!==void 0&&!(i instanceof t.Material))throw Error("Argument 3 (material) must be an instance of CANNON.Material.");t.Body.call(this,"particle"),this.position=vec3.create(),this.initPosition=vec3.create(),this.velocity=vec3.create(),this.initVelocity=vec3.create(),this.force=vec3.create(),this.mass=e,this.invMass=e>0?1/e:0,this.material=i,this.linearDamping=.01,this.motionstate=0>=e?t.Body.STATIC:t.Body.DYNAMIC,this.allowSleep=!0,this.sleepState=0,this.sleepSpeedLimit=.1,this.sleepTimeLimit=1,this.timeLastSleepy=0},t.Particle.prototype=new t.Body,t.Particle.prototype.constructor=t.Particle,t.Particle.prototype.isAwake=function(){return 0===this.sleepState},t.Particle.prototype.isSleepy=function(){return 1===this.sleepState},t.Particle.prototype.isSleeping=function(){return 2===this.sleepState},t.Particle.prototype.wakeUp=function(){var t=this.sleepState;this.sleepState=0,2===t&&this.dispatchEvent({type:"wakeup"})},t.Particle.prototype.sleep=function(){this.sleepState=2},t.Particle.prototype.sleepTick=function(t){if(this.allowSleep){var e=this.sleepState,i=vec3.squaredLength(this.velocity),a=Math.pow(this.sleepSpeedLimit,2);0===e&&a>i?(this.sleepState=1,this.timeLastSleepy=t,this.dispatchEvent({type:"sleepy"})):1===e&&i>a?this.wakeUp():1===e&&t-this.timeLastSleepy>this.sleepTimeLimit&&(this.sleepState=2,this.dispatchEvent({type:"sleep"}))}},t.RigidBody=function(e,i,a){if("number"!=typeof e)throw Error("Argument 1 (mass) must be a number.");if(a!==void 0&&!(a instanceof t.Material))throw Error("Argument 3 (material) must be an instance of CANNON.Material.");t.Particle.call(this,e,a),this.tau=vec3.create(),this.quaternion=quat.create(),this.initQuaternion=quat.create(),this.angularVelocity=vec3.create(),this.initAngularVelocity=vec3.create(),this.shape=i,this.inertia=vec3.create(),i.calculateLocalInertia(e,this.inertia),this.inertiaWorld=vec3.create(),vec3.copy(this.inertiaWorld,this.inertia),this.inertiaWorldAutoUpdate=!1,this.invInertia=vec3.fromValues(this.inertia[0]>0?1/this.inertia[0]:0,this.inertia[1]>0?1/this.inertia[1]:0,this.inertia[2]>0?1/this.inertia[2]:0),this.invInertiaWorld=vec3.create(),vec3.copy(this.invInertiaWorld,this.invInertia),this.invInertiaWorldAutoUpdate=!1,this.angularDamping=.01,this.aabbmin=vec3.create(),this.aabbmax=vec3.create(),this.aabbNeedsUpdate=!0,this.wlambda=vec3.create()},t.RigidBody.prototype=new t.Particle(0),t.RigidBody.prototype.constructor=t.RigidBody,t.RigidBody.prototype.computeAABB=function(){this.shape.calculateWorldAABB(this.position,this.quaternion,this.aabbmin,this.aabbmax),this.aabbNeedsUpdate=!1};var v=vec3.create(),l=vec3.create();t.RigidBody.prototype.applyForce=function(t,e){var i=v;e.vsub(this.position,i);var a=l;i.cross(t,a),this.force.vadd(t,this.force),this.tau.vadd(a,this.tau)};var u=vec3.create(),p=vec3.create(),d=vec3.create();t.RigidBody.prototype.applyImpulse=function(t,e){var i=u;e.vsub(this.position,i);var a=p;t.copy(a),a.mult(this.invMass,a),this.velocity.vadd(a,this.velocity);var r=d;i.cross(t,r),r.x*=this.invInertia.x,r.y*=this.invInertia.y,r.z*=this.invInertia.z,this.angularVelocity.vadd(r,this.angularVelocity)},t.Sphere=function(e){t.Shape.call(this),this.radius=void 0!==e?Number(e):1,this.type=t.Shape.types.SPHERE},t.Sphere.prototype=new t.Shape,t.Sphere.prototype.constructor=t.Sphere,t.Sphere.prototype.calculateLocalInertia=function(t,e){e=e||vec3.create();var i=2*t*this.radius*this.radius/5;return vec3.set(e,i,i,i),e},t.Sphere.prototype.volume=function(){return 4*Math.PI*this.radius/3},t.Sphere.prototype.computeBoundingSphereRadius=function(){this.boundingSphereRadiusNeedsUpdate=!1,this.boundingSphereRadius=this.radius},t.Sphere.prototype.calculateWorldAABB=function(t,e,i,a){for(var r=this.radius,o=["x","y","z"],s=0;o.length>s;s++){var n=o[s];i[n]=t[n]-r,a[n]=t[n]+r}},t.SPHSystem=function(){this.particles=[],this.density=1,this.smoothingRadius=1,this.speedOfSound=1,this.viscosity=.01,this.eps=1e-6,this.pressures=[],this.densities=[],this.neighbors=[]},t.SPHSystem.prototype.add=function(t){this.particles.push(t),this.neighbors.length<this.particles.length&&this.neighbors.push([])},t.SPHSystem.prototype.remove=function(t){var e=this.particles.indexOf(t);-1!==e&&(this.particles.splice(e,1),this.neighbors.length>this.particles.length&&this.neighbors.pop())};var f=vec3.create();t.SPHSystem.prototype.getNeighbors=function(t,e){for(var i=this.particles.length,a=t.id,r=this.smoothingRadius*this.smoothingRadius,o=f,s=0;s!==i;s++){var n=this.particles[s];n.position.vsub(t.position,o),a!==n.id&&r>o.norm2()&&e.push(n)}};var m=vec3.create(),y=vec3.create(),b=vec3.create(),g=vec3.create(),x=vec3.create(),w=vec3.create();t.SPHSystem.prototype.update=function(){for(var t=this.particles.length,e=m,i=this.speedOfSound,a=this.eps,r=0;r!==t;r++){var o=this.particles[r],s=this.neighbors[r];s.length=0,this.getNeighbors(o,s),s.push(this.particles[r]);for(var n=s.length,c=0,h=0;h!==n;h++){o.position.vsub(s[h].position,e);var v=e.norm(),l=this.w(v);c+=s[h].mass*l}this.densities[r]=c,this.pressures[r]=i*i*(this.densities[r]-this.density)}for(var u=y,p=b,d=g,f=x,E=w,r=0;r!==t;r++){var S=this.particles[r];u.set(0,0,0),p.set(0,0,0);for(var M,N,s=this.neighbors[r],n=s.length,h=0;h!==n;h++){var q=s[h];S.position.vsub(q.position,f);var V=f.norm();M=-q.mass*(this.pressures[r]/(this.densities[r]*this.densities[r]+a)+this.pressures[h]/(this.densities[h]*this.densities[h]+a)),this.gradw(f,d),d.mult(M,d),u.vadd(d,u),q.velocity.vsub(S.velocity,E),E.mult(1/(1e-4+this.densities[r]*this.densities[h])*this.viscosity*q.mass,E),N=this.nablaw(V),E.mult(N,E),p.vadd(E,p)}p.mult(S.mass,p),u.mult(S.mass,u),S.force.vadd(p,S.force),S.force.vadd(u,S.force)}},t.SPHSystem.prototype.w=function(t){var e=this.smoothingRadius;return 315/(64*Math.PI*Math.pow(e,9))*Math.pow(e*e-t*t,3)},t.SPHSystem.prototype.gradw=function(t,e){var i=t.norm(),a=this.smoothingRadius;t.mult(945/(32*Math.PI*Math.pow(a,9))*Math.pow(a*a-i*i,2),e)},t.SPHSystem.prototype.nablaw=function(t){var e=this.smoothingRadius,i=945/(32*Math.PI*Math.pow(e,9))*(e*e-t*t)*(7*t*t-3*e*e);return i},t.Box=function(e){t.Shape.call(this),this.halfExtents=e,this.type=t.Shape.types.BOX,this.convexPolyhedronRepresentation=null,this.updateConvexPolyhedronRepresentation()},t.Box.prototype=new t.Shape,t.Box.prototype.constructor=t.Box,t.Box.prototype.updateConvexPolyhedronRepresentation=function(){var e=this.halfExtents[0],i=this.halfExtents[1],a=this.halfExtents[2],r=new t.ConvexPolyhedron([vec3.fromValues(-e,-i,-a),vec3.fromValues(e,-i,-a),vec3.fromValues(e,i,-a),vec3.fromValues(-e,i,-a),vec3.fromValues(-e,-i,a),vec3.fromValues(e,-i,a),vec3.fromValues(e,i,a),vec3.fromValues(-e,i,a)],[[3,2,1,0],[4,5,6,7],[5,4,1,0],[2,3,6,7],[0,4,7,3],[1,2,5,6]],[vec3.fromValues(0,0,-1),vec3.fromValues(0,0,1),vec3.fromValues(0,-1,0),vec3.fromValues(0,1,0),vec3.fromValues(-1,0,0),vec3.fromValues(1,0,0)]);this.convexPolyhedronRepresentation=r},t.Box.prototype.calculateLocalInertia=function(t,e){e=e||vec3.create();var i=this.halfExtents;return vec3.set(e,1/12*t*(2*2*i[1]*i[1]+2*2*i[2]*i[2]),1/12*t*(2*2*i[0]*i[0]+2*2*i[2]*i[2]),1/12*t*(2*2*i[1]*i[1]+2*2*i[0]*i[0])),e},t.Box.prototype.getSideNormals=function(t,e){var i=t,a=this.halfExtents;if(vec3.set(i[0],a[0],0,0),vec3.set(i[1],0,a[1],0),vec3.set(i[2],0,0,a[2]),vec3.set(i[3],-a[0],0,0),vec3.set(i[4],0,-a[1],0),vec3.set(i[5],0,0,-a[2]),void 0!==e)for(var r=0;r!==i.length;r++)vec3.transformQuat(i[r],i[r],e);return i},t.Box.prototype.volume=function(){return 8*this.halfExtents[0]*this.halfExtents[1]*this.halfExtents[2]},t.Box.prototype.computeBoundingSphereRadius=function(){this.boundingSphereRadius=vec3.length(this.halfExtents),this.boundingSphereRadiusNeedsUpdate=!1};var E=vec3.create();vec3.create(),t.Box.prototype.forEachWorldCorner=function(t,e,i){for(var a=this.halfExtents,r=[[a[0],a[1],a[2]],[-a[0],a[1],a[2]],[-a[0],-a[1],a[2]],[-a[0],-a[1],-a[2]],[a[0],-a[1],-a[2]],[a[0],a[1],-a[2]],[-a[0],a[1],-a[2]],[a[0],-a[1],a[2]]],o=0;r.length>o;o++)E.set(r[o][0],r[o][1],r[o][2]),e.vmult(E,E),t.vadd(E,E),i(E[0],E[1],E[2])},t.Box.prototype.calculateWorldAABB=function(t,e,i,a){i.set(1/0,1/0,1/0),a.set(-1/0,-1/0,-1/0),this.forEachWorldCorner(t,e,function(t,e,r){t>a[0]&&(a[0]=t),e>a[1]&&(a[1]=e),r>a[2]&&(a[2]=r),i[0]>t&&(i[0]=t),i[1]>e&&(i[1]=e),i[2]>r&&(i[2]=r)})},t.Plane=function(){t.Shape.call(this),this.type=t.Shape.types.PLANE,this.worldNormal=vec3.create(),this.worldNormalNeedsUpdate=!0},t.Plane.prototype=new t.Shape,t.Plane.prototype.constructor=t.Plane,t.Plane.prototype.computeWorldNormal=function(t){var e=this.worldNormal;vec3.set(e,0,0,1),vec3.transformQuat(e,e,t),this.worldNormalNeedsUpdate=!1},t.Plane.prototype.calculateLocalInertia=function(t,e){return e=e||vec3.create()},t.Plane.prototype.volume=function(){return 1/0};var S=vec3.create();t.Plane.prototype.calculateWorldAABB=function(t,e,i,a){vec3.set(S,0,0,1),vec3.transformQuat(S,S,e),vec3.set(i,-1/0,-1/0,-1/0),vec3.set(a,1/0,1/0,1/0),1===S[0]&&(a[0]=t[0]),1===S[1]&&(a[1]=t[1]),1===S[2]&&(a[2]=t[2]),-1===S[0]&&(i[0]=t[0]),-1===S[1]&&(i[1]=t[1]),-1===S[2]&&(i[2]=t[2])},t.Compound=function(){t.Shape.call(this),this.type=t.Shape.types.COMPOUND,this.childShapes=[],this.childOffsets=[],this.childOrientations=[]},t.Compound.prototype=new t.Shape,t.Compound.prototype.constructor=t.Compound,t.Compound.prototype.addChild=function(t,e,i){e=e||vec3.create(),i=i||quat.create(),this.childShapes.push(t),this.childOffsets.push(e),this.childOrientations.push(i)},t.Compound.prototype.volume=function(){for(var t=0,e=this.childShapes.length,i=0;i!==e;i++)t+=this.childShapes[i].volume();return t};var M=vec3.create(),N=vec3.create();t.Compound.prototype.calculateLocalInertia=function(t,e){e=e||vec3.create();for(var i=this.volume(),a=N,r=0,o=this.childShapes.length;r!==o;r++){var s=this.childShapes[r],n=this.childOffsets[r];this.childOrientations[r];var c=s.volume()/i*t;s.calculateLocalInertia(c,a),vec3.add(e,e,a);var h=M;vec3.set(h,c*n[0]*n[0],c*n[1]*n[1],c*n[2]*n[2]),vec3.add(e,e,h)}return e},t.Compound.prototype.computeBoundingSphereRadius=function(){for(var t=0,e=0;this.childShapes.length>e;e++){var i=this.childShapes[e];i.boundingSphereRadiusNeedsUpdate&&i.computeBoundingSphereRadius();var a=vec3.length(this.childOffsets[e])+i.boundingSphereRadius;a>t&&(t=a)}this.boundingSphereRadius=t,this.boundingSphereRadiusNeedsUpdate=!1};var q=vec3.create(),V=vec3.create(),P=vec3.create(),z=new t.Quaternion;t.Compound.prototype.calculateWorldAABB=function(t,e,i,a){var r=this.childShapes.length;vec3.set(i,1/0,1/0,1/0),vec3.set(a,-1/0,-1/0,-1/0);for(var o=0;o!==r;o++)vec3.copy(P,this.childOffsets[o]),vec3.transformQuaternion(P,P,e),vec3.add(P,P,t),vec3.transformQuaternion(z,this.childOrientations[o],e),this.childShapes[o].calculateWorldAABB(P,z,V,q),V[0]<i[0]&&(i[0]=V[0]),V[1]<i[1]&&(i[1]=V[1]),V[2]<i[2]&&(i[2]=V[2]),q[0]>a[0]&&(a[0]=q[0]),q[1]>a[1]&&(a[1]=q[1]),q[2]>a[2]&&(a[2]=q[2])},t.ConvexPolyhedron=function(e,i){function a(t,e,i,a){vec3.subtract(h,e,t),vec3.subtract(c,i,e),vec3.cross(a,c,h),vec3.normalize(a,a)}function r(t,e,i,a,r){for(var o=t.vertices.length,s=null,n=null,c=t.vertices,h=0;o>h;h++){vec3.copy(E,c[h]),vec3.transformQuat(E,E,a),vec3.add(E,E,i);var v=vec3.dot(E,e);(null===s||v>s)&&(s=v),(null===n||n>v)&&(n=v)}if(n>s){var l=n;n=s,s=l}r[0]=s,r[1]=n}function o(t,e){var i=n.faces[t],r=n.vertices[i[0]],o=n.vertices[i[1]],s=n.vertices[i[2]];return a(r,o,s,e)}function s(t){var e=n.faces[t],i=n.faceNormals[t],a=n.vertices[e[0]],r=-vec3.dot(i,a);return r}var n=this;t.Shape.call(this),this.type=t.Shape.types.CONVEXPOLYHEDRON;var c=vec3.create(),h=vec3.create();this.vertices=e||[],this.worldVertices=[],this.worldVerticesNeedsUpdate=!0,this.faces=i||[],this.faceNormals=[];for(var v=0;this.faces.length>v;v++){for(var l=0;this.faces[v].length>l;l++)if(!this.vertices[this.faces[v][l]])throw Error("Vertex "+this.faces[v][l]+" not found!");var u=vec3.create();o(v,u),vec3.negate(u,u),this.faceNormals.push(u);var p=this.vertices[this.faces[v][0]];if(0>vec3.dot(u,p)){console.warn("Face normal "+v+" ("+(""+u)+") looks like it points into the shape? The vertices follow. Make sure they are ordered CCW around the normal, using the right hand rule.");for(var l=0;this.faces[v].length>l;l++)console.warn("Vertex "+this.faces[v][l]+": ("+(""+this.vertices[i[v][l]])+")")}}this.worldFaceNormalsNeedsUpdate=!0,this.worldFaceNormals=[],this.uniqueEdges=[];for(var d=this.vertices.length,f=0;d>f;f++){var m=this.vertices[f];this.uniqueEdges.push(m)}for(var v=0;this.faces.length>v;v++)for(var y=this.faces[v].length,b=y,l=0;b>l;l++){var g=(l+1)%y,x=vec3.create();vec3.subtract(x,this.vertices[this.faces[v][l]],this.vertices[this.faces[v][g]]),vec3.normalize(x,x);for(var w=!1,m=0;this.uniqueEdges.length>m;m++)if(vec3.almostEquals(this.uniqueEdges[m],x)||vec3.almostEquals(this.uniqueEdges[m],x)){w=!0;break}w||this.uniqueEdges.push(x),x&&(x.face1=v)}var E=vec3.create();this.testSepAxis=function(t,e,i,a,o,s){var n=[],c=[],h=this;r(h,t,i,a,n),r(e,t,o,s,c);var v=n[0],l=n[1],u=c[0],p=c[1];if(p>v||l>u)return!1;var d=v-p,f=u-l,m=f>d?d:f;return m};var S=vec3.create(),M=vec3.create(),N=vec3.create(),q=vec3.create(),V=vec3.create(),P=vec3.create();this.findSeparatingAxis=function(t,e,i,a,r,o){for(var s=1/0,n=this,c=0,h=n.faces.length,v=0;h>v;v++){vec3.copy(S,n.faceNormals[v]),vec3.transformQuat(S,S,i);var l=n.testSepAxis(S,t,e,i,a,r);if(l===!1)return!1;s>l&&(s=l,vec3.copy(o,S))}for(var u=t.faces.length,v=0;u>v;v++){vec3.copy(M,t.faceNormals[v]),r.vmult(M,M),c++;var l=n.testSepAxis(M,t,e,i,a,r);if(l===!1)return!1;s>l&&(s=l,vec3.copy(o,M))}for(var p=0,d=0;n.uniqueEdges.length>d;d++){vec3.copy(q,n.uniqueEdges[d]),i.vmult(q,q);for(var f=0;t.uniqueEdges.length>f;f++)if(vec3.copy(V,t.uniqueEdges[f]),r.vmult(V,V),vec3.cross(P,q,V),p++,!P.almostZero()){vec3.normalize(P,P);var m=n.testSepAxis(P,t,e,i,a,r);if(m===!1)return!1;s>m&&(s=m,vec3.copy(o,P))}}return vec3.subtract(N,a,e),vec3.dot(N,o)>0&&vec3.negate(o,o),!0};var z=vec3.create();this.clipAgainstHull=function(e,i,a,r,o,s,n,c,h){if(!(e instanceof t.Vec3))throw Error("posA must be Vec3");if(!(i instanceof t.Quaternion))throw Error("quatA must be Quaternion");for(var v=-1,l=-1/0,u=0;a.faces.length>u;u++){vec3.copy(z,a.faceNormals[u]),o.vmult(z,z);var p=vec3.dot(z,s);p>l&&(l=p,v=u)}for(var d=[],f=a.faces[v],m=f.length,y=0;m>y;y++){var b=a.vertices[f[y]],g=vec3.create();vec3.copy(g,b),o.vmult(g,g),vec3.add(g,r,g),d.push(g)}v>=0&&this.clipFaceAgainstHull(s,e,i,d,n,c,h)};var j=vec3.create(),C=vec3.create(),I=vec3.create(),B=vec3.create(),R=vec3.create(),O=vec3.create(),A=vec3.create(),T=vec3.create();this.clipFaceAgainstHull=function(e,i,a,r,o,n,c){if(!(e instanceof t.Vec3))throw Error("sep normal must be vector");if(!(r instanceof Array))throw Error("world verts must be array");o=Number(o),n=Number(n);for(var h=this,v=[],l=r,u=v,p=-1,d=1/0,f=0;h.faces.length>f;f++){vec3.copy(j,h.faceNormals[f]),vec3.transformQuat(j,j,a);var m=vec3.dot(j,e);d>m&&(d=m,p=f)}if(0>p)return console.log("--- did not find any closest face... ---"),void 0;var y=h.faces[p];y.connectedFaces=[];for(var b=0;h.faces.length>b;b++)for(var g=0;h.faces[b].length>g;g++)-1!==y.indexOf(h.faces[b][g])&&b!==p&&-1===y.connectedFaces.indexOf(b)&&y.connectedFaces.push(b);l.length;for(var x=y.length,w=0;x>w;w++){var E=h.vertices[y[w]],S=h.vertices[y[(w+1)%x]];vec3.subtract(C,E,S),vec3.copy(I,C),a.vmult(I,I),vec3.add(I,i,I),vec3.copy(B,this.faceNormals[p]),a.vmult(B,B),vec3.add(B,i,B),vec3.cross(R,I,B),vec3.negate(R,R),vec3.copy(O,E),a.vmult(O,O),vec3.add(O,i,O);var M,N=(-vec3.dot(O,R),y.connectedFaces[w]);vec3.copy(A,this.faceNormals[N]);var q=s(N);vec3.copy(T,A),a.vmult(T,T);var M=q-vec3.dot(T,i);for(this.clipFaceAgainstPlane(l,u,T,M);l.length;)l.shift();for(;u.length;)l.push(u.shift())}vec3.copy(A,this.faceNormals[p]);var q=s(p);vec3.copy(T,A),a.vmult(T,T);for(var M=q-vec3.dot(T,i),b=0;l.length>b;b++){var V=T.dot(l[b])+M;if(o>=V&&(console.log("clamped: depth="+V+" to minDist="+(o+"")),V=o),n>=V){var P=l[b];if(0>=V){var z={point:P,normal:T,depth:V};c.push(z)}}}},this.clipFaceAgainstPlane=function(e,i,a,r){if(!(a instanceof t.Vec3))throw Error("planeNormal must be Vec3, "+a+" given");if(!(e instanceof Array))throw Error("invertices must be Array, "+e+" given");if(!(i instanceof Array))throw Error("outvertices must be Array, "+i+" given");var o,s,n=e.length;if(2>n)return i;var c=e[e.length-1],h=e[0];o=vec3.dot(a,c)+r;for(var v=0;n>v;v++){if(h=e[v],s=vec3.dot(a,h)+r,0>o)if(0>s){var l=vec3.create();vec3.copy(l,h),i.push(l)}else{var l=vec3.create();c.lerp(h,o/(o-s),l),i.push(l)}else if(0>s){var l=vec3.create();c.lerp(h,o/(o-s),l),i.push(l),i.push(h)}c=h,o=s}return i};var n=this;this.calculateLocalInertia=function(t,e){n.computeAABB();var i=this.aabbmax.x-this.aabbmin.x,a=this.aabbmax.y-this.aabbmin.y,r=this.aabbmax.z-this.aabbmin.z;e.x=1/12*t*(2*2*a*a+2*2*r*r),e.y=1/12*t*(2*2*i*i+2*2*r*r),e.z=1/12*t*(2*2*a*a+2*2*i*i)},vec3.create(),this.computeAABB=function(){var t=this.vertices.length,e=this.aabbmin,i=this.aabbmax,a=this.vertices;vec3.set(e,1/0,1/0,1/0),vec3.set(i,-1/0,-1/0,-1/0);for(var r=0;t>r;r++){var o=a[r];o.x<e.x?e.x=o.x:o.x>i.x&&(i.x=o.x),o.y<e.y?e.y=o.y:o.y>i.y&&(i.y=o.y),o.z<e.z?e.z=o.z:o.z>i.z&&(i.z=o.z)}}},t.ConvexPolyhedron.prototype=new t.Shape,t.ConvexPolyhedron.prototype.constructor=t.ConvexPolyhedron,t.ConvexPolyhedron.prototype.computeWorldVertices=function(t,e){for(var i=this.vertices.length;i>this.worldVertices.length;)this.worldVertices.push(vec3.create());for(var a=this.vertices,r=this.worldVertices,o=0;o!==i;o++)e.vmult(a[o],r[o]),vec3.add(r[o],t,r[o]);this.worldVerticesNeedsUpdate=!1},t.ConvexPolyhedron.prototype.computeWorldFaceNormals=function(t){for(var e=this.faceNormals.length;e>this.worldFaceNormals.length;)this.worldFaceNormals.push(vec3.create());for(var i=this.faceNormals,a=this.worldFaceNormals,r=0;r!==e;r++)t.vmult(i[r],a[r]);this.worldFaceNormalsNeedsUpdate=!1},t.ConvexPolyhedron.prototype.computeBoundingSphereRadius=function(){for(var t=0,e=this.vertices,i=0,a=e.length;i!==a;i++){var r=vec3.squaredLength(e[i]);r>t&&(t=r)}this.boundingSphereRadius=Math.sqrt(t),this.boundingSphereRadiusNeedsUpdate=!1};var j=vec3.create();t.ConvexPolyhedron.prototype.calculateWorldAABB=function(t,e,i,a){for(var r,o,s,n,c,h,v=this.vertices.length,l=this.vertices,u=0;v>u;u++){vec3.copy(j,l[u]),e.vmult(j,j),vec3.add(j,t,j);var p=j;r>p.x||void 0===r?r=p.x:(p.x>n||void 0===n)&&(n=p.x),o>p.y||void 0===o?o=p.y:(p.y>c||void 0===c)&&(c=p.y),s>p.z||void 0===s?s=p.z:(p.z>h||void 0===h)&&(h=p.z)}vec3.set(i,r,o,s),vec3.set(a,n,c,h)},t.ConvexPolyhedron.prototype.volume=function(){return this.boundingSphereRadiusNeedsUpdate&&this.computeBoundingSphereRadius(),4*Math.PI*this.boundingSphereRadius/3},t.ConvexPolyhedron.prototype.getAveragePointLocal=function(t){t=t||vec3.create();for(var e=this.vertices.length,i=this.vertices,a=0;e>a;a++)vec3.add(t,t,i[a]);return t.mult(1/e,t),t},t.ConvexPolyhedron.prototype.transformAllPoints=function(t,e){var i=this.vertices.length,a=this.vertices;if(e){for(var r=0;i>r;r++){var o=a[r];e.vmult(o,o)}for(var r=0;this.faceNormals.length>r;r++){var o=this.faceNormals[r];e.vmult(o,o)}}if(t)for(var r=0;i>r;r++){var o=a[r];vec3.add(o,o,t)}};var C=vec3.create(),I=vec3.create(),B=vec3.create();t.ConvexPolyhedron.prototype.pointIsInside=function(t){var e=this.vertices.length,i=this.vertices,a=this.faces,r=this.faceNormals,o=null,s=this.faces.length,n=C;this.getAveragePointLocal(n);for(var c=0;s>c;c++){this.faces[c].length;var e=r[c],h=i[a[c][0]],v=I;vec3.subtract(v,t,h);var l=vec3.dot(e,v),u=B;vec3.subtract(u,n,h);var p=vec3.dot(e,u);if(0>l&&p>0||l>0&&0>p)return!1}return o?1:-1},t.Cylinder=function(e,i,a,r){var o=r,s=[],n=[],c=[],h=[],v=[],l=Math.cos,u=Math.sin;s.push(vec3.fromValues(i*l(0),i*u(0),.5*-a)),h.push(0),s.push(vec3.fromValues(e*l(0),e*u(0),.5*a)),v.push(1);for(var p=0;o>p;p++){var d=2*Math.PI/o*(p+1),f=2*Math.PI/o*(p+.5);o-1>p?(s.push(vec3.fromValues(i*l(d),i*u(d),.5*-a)),h.push(2*p+2),s.push(vec3.fromValues(e*l(d),e*u(d),.5*a)),v.push(2*p+3),n.push(vec3.fromValues(l(f),u(f),0)),c.push([2*p+2,2*p+3,2*p+1,2*p])):(c.push([0,1,2*p+1,2*p]),n.push(vec3.fromValues(l(f),u(f),0)))}c.push(v),n.push(vec3.fromValues(0,0,1));for(var m=[],p=0;h.length>p;p++)m.push(h[h.length-p-1]);c.push(m),n.push(vec3.fromValues(0,0,-1)),this.type=t.Shape.types.CONVEXPOLYHEDRON,t.ConvexPolyhedron.call(this,s,c,n)},t.Cylinder.prototype=new t.ConvexPolyhedron,t.Ray=function(e,i){function a(t,e,i){return i.vsub(t,E),u=E.dot(e),e.mult(u,S),S.vadd(t,S),p=i.distanceTo(S)}function r(t,e,i,a){return a.vsub(e,E),i.vsub(e,M),t.vsub(e,N),d=E.dot(E),f=E.dot(M),m=E.dot(N),y=M.dot(M),b=M.dot(N),g=1/(d*y-f*f),x=(y*m-f*b)*g,w=(d*b-f*m)*g,x>=0&&w>=0&&1>x+w}this.origin=e||new t.Vec3,this.direction=i||new t.Vec3;var o=1e-4;
this.setPrecision=function(t){o=t};var s=new t.Vec3,n=new t.Vec3,c=new t.Vec3;new t.Vec3,new t.Vec3;var h=new t.Vec3,v=new t.Vec3,l=new t.Vec3;this.intersectBody=function(e){return e.shape instanceof t.ConvexPolyhedron?this.intersectShape(e.shape,e.quaternion,e.position,e):e.shape instanceof t.Box?this.intersectShape(e.shape.convexPolyhedronRepresentation,e.quaternion,e.position,e):(console.warn("Ray intersection is this far only implemented for ConvexPolyhedron and Box shapes."),void 0)},this.intersectShape=function(e,i,u,p){var d,f=[];if(e instanceof t.ConvexPolyhedron){var m=a(this.origin,this.direction,u);if(m>e.getBoundingSphereRadius())return f;for(var y,b,g=e.faces,x=e.vertices,w=e.faceNormals,E=0;g.length>E;E++){var S=g[E],M=w[E],N=i,q=u;if(x[S[0]].copy(h),N.vmult(h,h),h.vadd(q,h),h.vsub(this.origin,h),N.vmult(M,v),y=this.direction.dot(v),!(o>Math.abs(y))&&(b=v.dot(h)/y,!(0>b)&&0>y)){this.direction.mult(b,l),l.vadd(this.origin,l),x[S[0]].copy(s),N.vmult(s,s),q.vadd(s,s);for(var V=1;S.length-1>V;V++)if(x[S[V]].copy(n),x[S[V+1]].copy(c),N.vmult(n,n),N.vmult(c,c),q.vadd(n,n),q.vadd(c,c),r(l,s,n,c)){d={distance:this.origin.distanceTo(l),point:l.copy(),face:S,body:p},f.push(d);break}}}}return f},this.intersectBodies=function(t){for(var e=[],i=0,a=t.length;a>i;i++){var r=this.intersectBody(t[i]);Array.prototype.push.apply(e,r)}return e.sort(function(t,e){return t.distance-e.distance}),e};var u,p,d,f,m,y,b,g,x,w,E=new t.Vec3,S=new t.Vec3,M=new t.Vec3,N=new t.Vec3},t.Ray.prototype.constructor=t.Ray,t.Broadphase=function(){this.world=null,this.useBoundingBoxes=!1},t.Broadphase.prototype.constructor=t.BroadPhase,t.Broadphase.prototype.collisionPairs=function(){throw Error("collisionPairs not implemented for this BroadPhase class!")};var R=t.Body.STATIC|t.Body.KINEMATIC;t.Broadphase.prototype.needBroadphaseCollision=function(e,i){return 0===(e.collisionFilterGroup&i.collisionFilterMask)||0===(i.collisionFilterGroup&e.collisionFilterMask)?!1:0===(e.motionstate&R)&&!e.isSleeping()||0===(i.motionstate&R)&&!i.isSleeping()?e.shape||i.shape?e.shape instanceof t.Plane&&i.shape instanceof t.Plane?!1:!0:!1:!1},t.Broadphase.prototype.intersectionTest=function(t,e,i,a){this.useBoundingBoxes?this.doBoundingBoxBroadphase(t,e,i,a):this.doBoundingSphereBroadphase(t,e,i,a)};var O=vec3.create(),A=vec3.create(),T=(quat.create(),vec3.create());t.Broadphase.prototype.doBoundingSphereBroadphase=function(e,i,a,r){var o=t.Shape.types,s=o.SPHERE|o.BOX|o.COMPOUND|o.CONVEXPOLYHEDRON,n=o.PLANE;t.Body.STATIC|t.Body.KINEMATIC;var c=O,h=A,v=T,l=e.shape,u=i.shape;if(l&&u){var p=l.type,d=u.type;if(p&s&&d&s){vec3.subtract(c,i.position,e.position),l.boundingSphereRadiusNeedsUpdate&&l.computeBoundingSphereRadius(),u.boundingSphereRadiusNeedsUpdate&&u.computeBoundingSphereRadius();var f=l.boundingSphereRadius+u.boundingSphereRadius;f*f>vec3.squaredLength(c)&&(a.push(e),r.push(i))}else if(p&s&&d&o.PLANE||d&s&&p&o.PLANE){var m=p===n?e:i,y=p!==n?e:i,b=y.shape,g=m.shape;vec3.subtract(c,y.position,m.position),g.worldNormalNeedsUpdate&&g.computeWorldNormal(m.quaternion),h=g.worldNormal,b.boundingSphereRadiusNeedsUpdate&&b.computeBoundingSphereRadius();var x=vec3.dot(c,h)-b.boundingSphereRadius;0>x&&(a.push(e),r.push(i))}}else if(l||u){var w=l?i:e,E=l?e:i,b=E.shape,S=b.type;if(S&s){if(S===o.SPHERE)vec3.subtract(v,w.position,E.position),b.radius*b.radius>=vec3.squaredLength(v)&&(a.push(w),r.push(E));else if(S===o.CONVEXPOLYHEDRON||S===o.BOX||S===o.COMPOUND){b.boundingSphereRadiusNeedsUpdate&&b.computeBoundingSphereRadius();var M=b.boundingSphereRadius;vec3.subtract(v,w.position,E.position),M*M>=vec3.squaredLength(v)&&(a.push(w),r.push(E))}}else if(S===o.PLANE){var N=E;h.set(0,0,1),N.quaternion.vmult(h,h),vec3.subtract(v,w.position,N.position),0>=vec3.dot(h,v)&&(a.push(w),r.push(E))}}else;},t.Broadphase.prototype.doBoundingBoxBroadphase=function(e,i,a,r){var o=e.shape,s=i.shape;if(e.aabbNeedsUpdate&&e.computeAABB(),i.aabbNeedsUpdate&&i.computeAABB(),o&&s)e.aabbmax.x<i.aabbmin.x||e.aabbmax.y<i.aabbmin.y||e.aabbmax.z<i.aabbmin.z||e.aabbmin.x>i.aabbmax.x||e.aabbmin.y>i.aabbmax.y||e.aabbmin.z>i.aabbmax.z||(a.push(e),r.push(i));else if(o||s){var n=o?i:e,c=o?e:i;c.shape instanceof t.Plane,n.position.x<c.aabbmin.x||n.position.y<c.aabbmin.y||n.position.z<c.aabbmin.z||n.position.x>c.aabbmax.x||n.position.y>c.aabbmax.y||n.position.z>c.aabbmax.z||(a.push(e),r.push(i))}else;};var F={},L=[],k=[];t.Broadphase.prototype.makePairsUnique=function(t,e){for(var i=F,a=L,r=k,o=t.length,s=0;s!==o;s++)a[s]=t[s],r[s]=e[s];t.length=0,e.length=0;for(var s=0;s!==o;s++){var n=a[s].id,c=r[s].id,h=c>n?n+","+c:c+","+n;i[h]=s}for(var h in i){var s=i[h];t.push(a[s]),e.push(r[s]),delete i[h]}},t.NaiveBroadphase=function(){t.Broadphase.apply(this)},t.NaiveBroadphase.prototype=new t.Broadphase,t.NaiveBroadphase.prototype.constructor=t.NaiveBroadphase,t.NaiveBroadphase.prototype.collisionPairs=function(t,e,i){var a,r,o,s,n=t.bodies,c=n.length;for(a=0;a!==c;a++)for(r=0;r!==a;r++)o=n[a],s=n[r],this.needBroadphaseCollision(o,s)&&this.intersectionTest(o,s,e,i)},t.GridBroadphase=function(e,i,a,r,o){t.Broadphase.apply(this),this.nx=a||10,this.ny=r||10,this.nz=o||10,this.aabbMin=e||new t.Vec3(100,100,100),this.aabbMax=i||new t.Vec3(-100,-100,-100),this.bins=[]},t.GridBroadphase.prototype=new t.Broadphase,t.GridBroadphase.prototype.constructor=t.GridBroadphase;var U=new t.Vec3,W=new t.Vec3;t.GridBroadphase.prototype.collisionPairs=function(e,i,a){var r=e.numObjects(),o=e.bodies,s=this.aabbMax,n=this.aabbMin,c=this.nx,h=this.ny,v=this.nz,l=s.x,u=s.y,p=s.z,d=n.x,f=n.y,m=n.z,y=c/(l-d),b=h/(u-f),g=v/(p-m),x=(l-d)/c,w=(u-f)/h,E=(p-m)/v,S=t.Shape.types,M=S.SPHERE,N=S.PLANE;S.BOX,S.COMPOUND,S.CONVEXPOLYHEDRON;for(var q=this.bins,V=c*h*v,P=q.length-1;P!==V;P++)q.push([]);for(var P=0;P!==V;P++)q[P].length=0;for(var z=Math.floor,P=0;P!==r;P++){var j=o[P],C=j.shape;switch(C.type){case M:for(var I=j.position.x,B=j.position.y,R=j.position.z,O=C.radius,A=z(y*(I-O-d)),T=z(b*(B-O-f)),F=z(g*(R-O-m)),L=z(y*(I+O-d)),k=z(b*(B+O-f)),Q=z(g*(R+O-m)),D=A;D!==L+1;D++)for(var H=T;H!==k+1;H++)for(var X=F;X!==Q+1;X++){var G=D,Y=H,_=X,Z=G*(h-1)*(v-1)+Y*(v-1)+_;Z>=0&&V>Z&&q[Z].push(j)}break;case N:var K=U,J=W,$=.25*(x*x+w*w+E*E),te=C.worldNormal;C.worldNormalNeedsUpdate&&C.computeWorldNormal(j.quaternion);for(var D=0;D!==c;D++)for(var H=0;H!==h;H++)for(var X=0;X!==v;X++){var G=D,Y=H,_=X;if(J.set(G*x+d,Y*w+f,_*E+m),J.vsub(j.position,K),$>K.dot(te)){var Z=G*(h-1)*(v-1)+Y*(v-1)+_;q[Z].push(j)}}break;default:console.warn("Shape "+C.type+" not supported in GridBroadphase!")}}for(var P=0;P!==V;P++)for(var ee=q[P],D=0,ie=ee.length;D!==ie;D++)for(var j=ee[D],H=0;H!==D;H++){var ae=ee[H];this.needBroadphaseCollision(j,ae)&&this.intersectionTest(j,ae,i,a)}this.makePairsUnique(i,a)},t.Solver=function(){this.equations=[]},t.Solver.prototype.solve=function(){return 0},t.Solver.prototype.addEquation=function(t){this.equations.push(t)},t.Solver.prototype.removeEquation=function(t){var e=this.equations,i=e.indexOf(t);-1!==i&&e.splice(i,1)},t.Solver.prototype.removeAllEquations=function(){this.equations.length=0},t.GSSolver=function(){t.Solver.call(this),this.iterations=10,this.tolerance=0},t.GSSolver.prototype=new t.Solver;var Q=[],D=[],H=[];t.GSSolver.prototype.solve=function(t,e){var i,a,r,o,s,n,c=(this.d,this.k,0),h=this.iterations,v=this.tolerance*this.tolerance,l=(this.a,this.b),u=this.equations,p=u.length,d=e.bodies,f=d.length,m=t,y=D,b=H,g=Q;y.length=0,b.length=0,g.length=0;for(var x=0;x!==p;x++){var w=u[x];w.spookParamsNeedsUpdate&&(w.updateSpookParams(m),w.spookParamsNeedsUpdate=!1),g[x]=0,b[x]=w.computeB(m),y[x]=1/w.computeC()}if(0!==p){for(var x=0;x!==f;x++){var l=d[x],E=l.vlambda,S=l.wlambda;vec3.set(E,0,0,0),S&&vec3.set(S,0,0,0)}for(c=0;c!==h;c++){o=0;for(var M=0;M!==p;M++){var w=u[M];i=b[M],a=y[M],n=g[M],s=w.computeGWlambda(),r=a*(i-s-w.eps*n),w.minForce>n+r?r=w.minForce-n:n+r>w.maxForce&&(r=w.maxForce-n),g[M]+=r,o+=r>0?r:-r,w.addToWlambda(r)}if(v>o*o)break}for(var x=0;x!==f;x++){var l=d[x],N=l.velocity,q=l.angularVelocity;vec3.add(N,N,l.vlambda),q&&vec3.add(q,q,l.wlambda)}}return c},t.SplitSolver=function(e){t.Solver.call(this),this.subsolver=e},t.SplitSolver.prototype=new t.Solver;var X=[],G=[],Y=[],_={bodies:null};t.SplitSolver.prototype.solve=function(e,i){function a(t){for(var e=t.length,i=0;i!==e;i++){var a=t[i];if(!(a.visited||a.body.motionstate&x))return a}return!1}function r(t,e){var i=[];for(i.push(t),t.visited=!0,e(t);i.length;)for(var r,o=i.pop();r=a(o.children);)r.visited=!0,e(r),i.push(r)}function o(t){S.push(t.body);for(var e=t.eqs.length,i=0;i!==e;i++){var a=t.eqs[i];-1===E.indexOf(a)&&E.push(a)}}for(var s=X,n=i.bodies,c=this.equations,h=c.length,v=n.length,l=this.subsolver,u=s.length;u!==v;u++)s.push({body:n[u],children:[],eqs:[],visited:!1});for(var u=0;u!==v;u++){var p=s[u];p.body=n[u],p.children.length=0,p.eqs.length=0,p.visited=!1}for(var d=0;d!==h;d++){var f=c[d],u=n.indexOf(f.bi),m=n.indexOf(f.bj),y=s[u],b=s[m];y.children.push(b),y.eqs.push(f),b.children.push(y),b.eqs.push(f)}for(var g,x=t.Body.STATIC,w=0,E=G,S=Y,M=_;g=a(s);){E.length=0,S.length=0,r(g,o);for(var N=E.length,u=0;u!==N;u++)l.addEquation(E[u]);M.bodies=S,l.solve(e,M),l.removeAllEquations(),w++}return w},t.Material=function(t){this.name=t,this.id=-1},t.ContactMaterial=function(t,e,i,a){this.id=-1,this.materials=[t,e],this.friction=void 0!==i?Number(i):.3,this.restitution=void 0!==a?Number(a):.3,this.contactEquationStiffness=1e7,this.contactEquationRegularizationTime=3,this.frictionEquationStiffness=1e7,this.frictionEquationRegularizationTime=3},t.World=function(){t.EventTarget.apply(this),this.allowSleep=!1,this.contacts=[],this.frictionEquations=[],this.quatNormalizeSkip=0,this.quatNormalizeFast=!1,this.time=0,this.stepnumber=0,this.default_dt=1/60,this.last_dt=this.default_dt,this.nextId=0,this.gravity=vec3.create(),this.broadphase=null,this.bodies=[],this.solver=new t.GSSolver,this.constraints=[],this.contactgen=new t.ContactGenerator,this.collisionMatrix=[],this.collisionMatrixPrevious=[],this.materials=[],this.contactmaterials=[],this.mats2cmat=[],this.defaultMaterial=new t.Material("default"),this.defaultContactMaterial=new t.ContactMaterial(this.defaultMaterial,this.defaultMaterial,.3,0),this.doProfiling=!1,this.profile={solve:0,makeContactConstraints:0,broadphase:0,integrate:0,nearphase:0},this.subsystems=[]},t.World.prototype.getContactMaterial=function(e,i){if(e instanceof t.Material&&i instanceof t.Material){var a=e.id,r=i.id;if(r>a){var o=a;a=r,r=o}return this.contactmaterials[this.mats2cmat[a+r*this.materials.length]]}},t.World.prototype.numObjects=function(){return this.bodies.length},t.World.prototype.collisionMatrixGet=function(t,e,i){if(e>t){var a=e;e=t,t=a}return t=(t*(t+1)>>1)+e-1,i===void 0||i?this.collisionMatrix[t]:this.collisionMatrixPrevious[t]},t.World.prototype.collisionMatrixSet=function(t,e,i,a){if(e>t){var r=e;e=t,t=r}t=(t*(t+1)>>1)+e-1,a===void 0||a?this.collisionMatrix[t]=i:this.collisionMatrixPrevious[t]=i},t.World.prototype.collisionMatrixTick=function(){var t=this.collisionMatrixPrevious;this.collisionMatrixPrevious=this.collisionMatrix,this.collisionMatrix=t;for(var e=0,i=this.collisionMatrix.length;e!==i;e++)this.collisionMatrix[e]=0},t.World.prototype.add=function(e){e.id=this.id(),e.index=this.bodies.length,this.bodies.push(e),e.world=this,vec3.copy(e.initPosition,e.position),vec3.copy(e.initVelocity,e.velocity),e.timeLastSleepy=this.time,e instanceof t.RigidBody&&(vec3.copy(e.initAngularVelocity,e.angularVelocity),quat.copy(e.initQuaternion,e.quaternion));var i=this.numObjects();this.collisionMatrix.length=i*(i-1)>>1},t.World.prototype.addConstraint=function(t){this.constraints.push(t),t.id=this.id()},t.World.prototype.removeConstraint=function(t){var e=this.constraints.indexOf(t);-1!==e&&this.constraints.splice(e,1)},t.World.prototype.id=function(){return this.nextId++},t.World.prototype.remove=function(t){t.world=null;var e=this.numObjects()-1,i=this.bodies;i.splice(t.index,1);for(var a=t.index;e>a;a++)i[a].index=a;this.collisionMatrixPrevious.length=this.collisionMatrix.length=e*(e-1)>>1},t.World.prototype.addMaterial=function(t){if(-1===t.id){var e=this.materials.length;this.materials.push(t),t.id=this.materials.length-1;for(var i=0;i!==2*e+1;i++)this.mats2cmat.push(-1)}},t.World.prototype.addContactMaterial=function(t){this.addMaterial(t.materials[0]),this.addMaterial(t.materials[1]);var e,i;t.materials[0].id>t.materials[1].id?(e=t.materials[0].id,i=t.materials[1].id):(i=t.materials[0].id,e=t.materials[1].id),this.contactmaterials.push(t),t.id=this.contactmaterials.length-1,this.mats2cmat[e+this.materials.length*i]=t.id},t.World.prototype._now=function(){return window.performance.webkitNow?window.performance.webkitNow():Date.now()};var Z={type:"postStep"},K={type:"collide","with":null,contact:null},J=[],$=[],te=[],ee=[],ie=vec3.create(),ae=(vec3.create(),vec3.create(),vec3.create(),vec3.create(),vec3.create(),vec3.create(),vec3.create(),vec3.create(),vec3.create(),quat.create(),quat.create()),re=quat.create();t.World.prototype.step=function(e){var i,a=this.contacts,r=te,o=ee,s=this.numObjects(),n=this.bodies,c=this.solver,h=this.gravity,v=this.doProfiling,l=this.profile,u=t.Body.DYNAMIC,p=this._now,d=this.constraints,f=t.FrictionEquation,m=$,y=vec3.length(h),b=0;for(v&&(i=p()),void 0===e&&(e=this.last_dt||this.default_dt),b=0;b!==s;b++){var g=n[b];if(g.motionstate&u){var x=g.force,w=g.mass;vec3.scaleAndAdd(x,x,h,w)}}for(var b=0,E=this.subsystems.length;b!==E;b++)this.subsystems[b].update();v&&(i=p()),r.length=0,o.length=0,this.broadphase.collisionPairs(this,r,o),v&&(l.broadphase=p()-i),this.collisionMatrixTick(),v&&(i=p());var S=J,M=a.length;for(b=0;b!==M;b++)S.push(a[b]);a.length=0,this.contactgen.getContacts(r,o,this,a,S),v&&(l.nearphase=p()-i),v&&(i=p());var N=a.length,q=this.frictionEquations.length;for(b=0;b!==q;b++)m.push(this.frictionEquations[b]);this.frictionEquations.length=0;for(var V=0;V!==N;V++){var P=a[V],g=P.bi,z=P.bj,b=n.indexOf(g),j=n.indexOf(z),C=this.getContactMaterial(g.material,z.material)||this.defaultContactMaterial,I=C.friction;C.restitution;var B=ie;vec3.set(B,0,0,0),vec3.add(B,B,z.position),vec3.add(B,B,P.rj),vec3.subtract(B,B,g.position),vec3.subtract(B,B,P.ri);var R=vec3.dot(B,P.ni);if(0>R){if(P.restitution=C.restitution,P.penetration=R,P.stiffness=C.contactEquationStiffness,P.regularizationTime=C.contactEquationRegularizationTime,c.addEquation(P),I>0){var O=g.invMass+z.invMass;O>0&&(O=1/O);var A=I*y,T=m,F=T.length?T.pop():new f(g,z,A*O),L=T.length?T.pop():new f(g,z,A*O);this.frictionEquations.push(F),this.frictionEquations.push(L),F.bi=L.bi=g,F.bj=L.bj=z,F.minForce=L.minForce=-A*O,F.maxForce=L.maxForce=A*O,vec3.copy(F.ri,P.ri),vec3.copy(F.rj,P.rj),vec3.copy(L.ri,P.ri),vec3.copy(L.rj,P.rj),vec3.tangents(F.t,L.t,P.ni),c.addEquation(F),c.addEquation(L)}this.collisionMatrixSet(b,j,1,!0),this.collisionMatrixGet(b,j,!0)!==this.collisionMatrixGet(b,j,!1)&&(K.with=z,K.contact=P,g.dispatchEvent(K),K.with=g,z.dispatchEvent(K),g.wakeUp(),z.wakeUp())}}v&&(l.makeContactConstraints=p()-i),v&&(i=p());var k=d.length;for(b=0;b!==k;b++){var P=d[b];P.update();for(var j=0,U=P.equations.length;j!==U;j++){var W=P.equations[j];c.addEquation(W)}}c.solve(e,this),v&&(l.solve=p()-i),c.removeAllEquations();var Q=Math.pow;for(b=0;b!==s;b++){var g=n[b];if(g.motionstate&u){var D=Q(1-g.linearDamping,e),H=g.velocity;vec3.scale(H,H,D);var X=g.angularVelocity;if(X){var G=Q(1-g.angularDamping,e);vec3.scale(X,X,G)}}}for(this.dispatchEvent(Z),b=0;b!==s;b++){var g=n[b];g.preStep&&g.preStep.call(g)}v&&(i=p());var Y=ae,_=re,oe=this.stepnumber,se=t.Body.DYNAMIC|t.Body.KINEMATIC,ne=0===oe%(this.quatNormalizeSkip+1),ce=this.quatNormalizeFast,he=.5*e,ve=t.Shape.types.PLANE,le=t.Shape.types.CONVEXPOLYHEDRON;for(b=0;b!==s;b++){var ue=n[b],pe=ue.shape,de=ue.force,fe=ue.tau;if(ue.motionstate&se){var me=ue.velocity,ye=ue.angularVelocity,be=ue.position,ge=ue.quaternion,xe=ue.invMass,we=ue.invInertia;if(vec3.scaleAndAdd(me,me,de,xe*e),ue.angularVelocity&&(ye[0]+=fe[0]*we[0]*e,ye[1]+=fe[1]*we[1]*e,ye[2]+=fe[2]*we[2]*e),ue.isSleeping()||(vec3.scaleAndAdd(be,be,me,e),ue.angularVelocity&&(quat.set(Y,ye[0],ye[1],ye[2],0),quat.mul(_,Y,ge),quat.scale(_,_,he),quat.add(ge,ge,_),ne&&(ce?quat.normalize(ge,ge):quat.normalize(ge,ge))),ue.aabbmin&&(ue.aabbNeedsUpdate=!0)),pe)switch(pe.type){case ve:pe.worldNormalNeedsUpdate=!0;break;case le:pe.worldFaceNormalsNeedsUpdate=!0,pe.worldVerticesNeedsUpdate=!0}}vec3.set(ue.force,0,0,0),ue.tau&&vec3.set(ue.tau,0,0,0)}for(v&&(l.integrate=p()-i),this.time+=e,this.stepnumber+=1,this.dispatchEvent(Z),b=0;b!==s;b++){var g=n[b],Ee=g.postStep;Ee&&Ee.call(g)}for(b=0;b!==s;b++){var ue=n[b];ue.inertiaWorldAutoUpdate&&ue.quaternion.vmult(ue.inertia,ue.inertiaWorld),ue.invInertiaWorldAutoUpdate&&ue.quaternion.vmult(ue.invInertia,ue.invInertiaWorld)}if(this.allowSleep)for(b=0;b!==s;b++)n[b].sleepTick(this.time)},t.ContactGenerator=function(){function e(e,i){if(m.length){var a=m.pop();return a.bi=e,a.bj=i,a}return new t.ContactEquation(e,i)}function i(t){var e;e=t.ri,t.ri=t.rj,t.rj=e,vec3.negate(t.ni,t.ni),e=t.bi,t.bi=t.bj,t.bj=e}function a(t,i,a,r,o,s,n,c,h){var v=e(c,h);vec3.subtract(v.ni,h.position,r),vec3.normalize(v.ni,v.ni),vec3.copy(v.ri,v.ni),vec3.copy(v.rj,v.ni),vec3.scale(v.ri,v.ri,i.radius),vec3.scale(v.rj,v.rj,-a.radius),t.push(v)}function r(t,i,a,r,o,s,n,c,h){var v=e(c,h);vec3.set(v.ni,0,0,1),vec3.transformQuat(v.ni,v.ni,n),vec3.scale(v.ni,v.ni,-1),vec3.normalize(v.ni,v.ni),vec3.scale(v.ri,v.ni,i.radius),vec3.subtract(b,r,o),vec3.scale(g,v.ni,vec3.dot(v.ni,b)),vec3.subtract(v.rj,b,g),vec3.squaredLength(g)<=i.radius*i.radius&&t.push(v)}function o(t,e,i){for(var a=null,r=t.length,o=0;o!==r;o++){var s=t[o],n=x;vec3.subtract(n,t[(o+1)%r],s);var c=w;vec3.cross(c,n,e);var h=E;vec3.subtract(h,i,s);var v=vec3.dot(c,h);if(!(null===a||v>0&&a===!0||0>=v&&a===!1))return!1;null===a&&(a=v>0)}return!0}function s(t,i,a,r,o,s,n,c,h){var v=V;vec3.subtract(S,r,o),a.getSideNormals(v,n);for(var l=i.radius,u=!1,p=z,d=j,f=C,m=null,b=0,g=0,x=0,w=null,E=0,I=v.length;E!==I&&u===!1;E++){var B=M;vec3.copy(B,v[E]);var R=vec3.length(B);vec3.normalize(B,B);var O=vec3.dot(S,B);if(R+l>O&&O>0){var A=N,T=q;vec3.copy(A,v[(E+1)%3]),vec3.copy(T,v[(E+2)%3]);var F=vec3.length(A),L=vec3.length(T);vec3.normalize(A,A),vec3.normalize(T,T);var k=vec3.dot(S,A),U=vec3.dot(S,T);if(F>k&&k>-F&&L>U&&U>-L){var W=Math.abs(O-R-l);(null===w||w>W)&&(w=W,g=k,x=U,m=R,vec3.copy(p,B),vec3.copy(d,A),vec3.copy(f,T),b++)}}}if(b){u=!0;var Q=e(c,h);vec3.scale(Q.ri,p,-l),vec3.copy(Q.ni,p),vec3.negate(Q.ni,Q.ni),vec3.scale(p,p,m),vec3.scale(d,d,g),vec3.add(p,p,d),vec3.scale(f,f,x),vec3.add(Q.rj,p,f),t.push(Q)}for(var D=y.get(),H=P,X=0;2!==X&&!u;X++)for(var G=0;2!==G&&!u;G++)for(var Y=0;2!==Y&&!u;Y++)if(vec3.set(D,0,0,0),X?vec3.add(D,D,v[0]):vec3.subtract(D,D,v[0]),G?vec3.add(D,D,v[1]):vec3.subtract(D,D,v[1]),Y?vec3.add(D,D,v[2]):vec3.subtract(D,D,v[2]),vec3.add(H,o,D),vec3.subtract(H,H,r),l*l>vec3.squaredLength(H)){u=!0;var Q=e(c,h);vec3.copy(Q.ri,H),vec3.normalize(Q.ri,Q.ri),vec3.copy(Q.ni,Q.ri),vec3.scale(Q.ri,Q.ri,l),vec3.copy(Q.rj,D),t.push(Q)}y.release(D),D=null;for(var _=y.get(),Z=y.get(),Q=y.get(),K=y.get(),W=y.get(),J=v.length,X=0;X!==J&&!u;X++)for(var G=0;G!==J&&!u;G++)if(X%3!==G%3){vec3.cross(_,v[G],v[X]),vec3.normalize(_,_),vec3.add(Z,v[X],v[G]),vec3.copy(Q,r),vec3.subtract(Q,Q,Z),vec3.subtract(Q,Q,o);var $=vec3.dot(Q,_);vec3.scale(K,_,$);for(var Y=0;Y===X%3||Y===G%3;)Y++;vec3.copy(W,r),vec3.subtract(W,W,K),vec3.subtract(W,W,Z),vec3.subtract(W,W,o);var te=Math.abs($),ee=vec3.length(W);if(vec3.length(v[Y])>te&&l>ee){u=!0;var ie=e(c,h);vec3.add(ie.rj,Z,K),vec3.copy(ie.rj,ie.rj),vec3.negate(ie.ni,W),vec3.normalize(ie.ni,ie.ni),vec3.copy(ie.ri,ie.rj),vec3.add(ie.ri,ie.ri,o),vec3.subtract(ie.ri,ie.ri,r),vec3.normalize(ie.ri,ie.ri),vec3.scale(ie.ri,ie.ri,l),t.push(ie)}}y.release(_,Z,Q,K,W)}function n(t,i,a,r,s,n,c,h,v){vec3.subtract(I,r,s);for(var l=a.faceNormals,u=a.faces,p=a.vertices,d=i.radius,f=0;f!==p.length;f++){var m=p[f],b=A;vec3.transformQuat(b,m,c),vec3.add(b,s,b);var g=O;if(vec3.subtract(g,b,r),d*d>vec3.squaredLength(g)){w=!0;var x=e(h,v);return vec3.copy(x.ri,g),vec3.normalize(x.ri,x.ri),vec3.copy(x.ni,x.ri),vec3.scale(x.ri,x.ri,d),vec3.subtract(x.rj,b,s),t.push(x),void 0}}for(var w=!1,f=0,E=u.length;f!==E&&w===!1;f++){var S=l[f],M=u[f],N=T;vec3.transformQuat(N,S,c);var q=F;vec3.transformQuat(q,p[M[0]],c),vec3.add(q,q,s);var V=L;vec3.scale(V,N,-d),vec3.add(V,r,V);var P=k;vec3.subtract(P,V,q);var z=vec3.dot(P,N),j=U;if(vec3.subtract(j,r,q),0>z&&vec3.dot(j,N)>0){for(var C=[],W=0,Q=M.length;W!==Q;W++){var D=y.get();vec3.transformQuat(D,p[M[W]],c),vec3.add(D,s,D),C.push(D)}if(o(C,N,r)){w=!0;var x=e(h,v);vec3.scale(x.ri,N,-d),vec3.negate(x.ni,N);var H=y.get();vec3.scale(H,N,-z);var X=y.get();vec3.scale(X,N,-d),vec3.subtract(x.rj,r,s),vec3.add(x.rj,x.rj,X),vec3.add(x.rj,x.rj,H),y.release(H),y.release(X),t.push(x);for(var W=0,G=C.length;W!==G;W++)y.release(C[W]);return}for(var W=0;W!==M.length;W++){var Y=y.get(),_=y.get();vec3.transformQuat(Y,p[M[(W+1)%M.length]],c),vec3.transformQuat(_,p[M[(W+2)%M.length]],c),vec3.add(Y,s,Y),vec3.add(_,s,_);var Z=B;vec3.subtract(Z,_,Y);var K=R;vec3.normalize(K,Z);var J=y.get(),$=y.get();vec3.subtract($,r,Y);var te=vec3.dot($,K);vec3.scale(J,K,te),vec3.add(J,J,Y);var ee=y.get();if(vec3.subtract(ee,J,r),te>0&&vec3.squaredLength(Z)>te*te&&d*d>vec3.squaredLength(ee)){var x=e(h,v);vec3.subtract(x.rj,J,s),vec3.subtract(x.ni,J,r),vec3.normalize(x.ni,x.ni),vec3.scale(x.ri,x.ni,d),t.push(x);for(var W=0,G=C.length;W!==G;W++)y.release(C[W]);return y.release(Y),y.release(_),y.release(J),y.release(ee),y.release($),void 0}y.release(Y),y.release(_),y.release(J),y.release(ee),y.release($)}for(var W=0,G=C.length;W!==G;W++)y.release(C[W])}}}function c(t,e,i,a,r,o,s,n,c){v(t,e,i.convexPolyhedronRepresentation,a,r,o,s,n,c)}function h(e,i,a,r,o,s,n,c,h){for(var v=W,l=Q,u=0,p=0,d=a.childShapes.length;p!==d;p++){var m=[],y=l.pop()||new t.Quaternion,b=v.pop()||vec3.create();quat.multiply(y,n,a.childOrientations[p]),quat.normalize(y,y),vec3.transformQuat(b,a.childOffsets[p],n),vec3.add(b,o,b),f(m,i,a.childShapes[p],r,b,s,y,c,h),l.push(y);var g=b;i||(u+=m.length);for(var x=0;x!==m.length;x++)vec3.transformQuat(g,a.childOffsets[p],n),vec3.add(m[x].rj,m[x].rj,g),e.push(m[x]);v.push(b)}}function v(t,i,a,r,o,s,n,c,h){var v=D,l=H;vec3.set(l,0,0,1),vec3.transformQuat(l,l,s);for(var u=X,p=0;p!==a.vertices.length;p++){vec3.copy(v,a.vertices[p]),vec3.transformQuat(v,v,n),vec3.add(v,o,v),vec3.subtract(u,v,r);var d=vec3.dot(l,u);if(0>=d){var f=G;vec3.scale(f,l,vec3.dot(l,v)),vec3.subtract(f,v,f);var m=e(c,h);vec3.copy(m.ni,l),vec3.copy(m.ri,f),vec3.subtract(m.rj,v,o),t.push(m)}}}function l(t,i,a,r,o,s,n,c,h){var v=Y;if(i.findSeparatingAxis(a,r,s,o,n,v)){var l=[],u=_;i.clipAgainstHull(r,s,a,o,n,v,-100,100,l);for(var p=0;p!==l.length;p++){var d=e(c,h);vec3.negate(d.ni,v),vec3.negate(u,l[p].normal),u.mult(l[p].depth,u),vec3.add(d.ri,l[p].point,u),vec3.copy(d.rj,l[p].point),vec3.subtract(d.rj,d.rj,o),vec3.subtract(d.ri,d.ri,r),t.push(d)}}}function u(t,i,a,r,o,s,n,c,h){var v=Z;vec3.set(v,0,0,1),h.quaternion.vmult(v,v);var l=K;vec3.subtract(l,r,h.position);var u=vec3.dot(v,l);if(0>=u){var p=e(c,h);vec3.copy(p.ni,v),vec3.negate(p.ni,p.ni),vec3.set(p.ri,0,0,0);var d=J;v.mult(vec3.dot(v,r),d),vec3.subtract(d,r,d),vec3.copy(p.rj,d),t.push(p)}}function p(t,i,a,r,o,s,n,c,h){var v=$;vec3.set(v,0,0,1),vec3.subtract(v,r,o);var l=vec3.squaredLength(v);if(a.radius*a.radius>=l){var u=e(c,h);vec3.normalize(v,v),vec3.copy(u.rj,v),vec3.scale(u.rj,u.rj,a.radius),vec3.copy(u.ni,v),vec3.negate(u.ni,u.ni),vec3.set(u.ri,0,0,0),t.push(u)}}function d(t,i,a,r,o,s,n,c,h){var v=-1,l=ie,u=re,p=null,d=0,f=ee;if(vec3.copy(f,r),vec3.subtract(f,f,o),n.conjugate(te),vec3.transformQuat(f,f,te),a.pointIsInside(f)){a.worldVerticesNeedsUpdate&&a.computeWorldVertices(o,n),a.worldFaceNormalsNeedsUpdate&&a.computeWorldFaceNormals(n);for(var m=0,y=a.faces.length;m!==y;m++){var b=[a.worldVertices[a.faces[m][0]]],g=a.worldFaceNormals[m];vec3.subtract(ae,r,b[0]);var x=-vec3.dot(g,ae);(null===p||Math.abs(x)<Math.abs(p))&&(p=x,v=m,vec3.copy(l,g),d++)}if(-1!==v){var w=e(c,h);vec3.scale(u,l,p),vec3.add(u,u,r),vec3.subtract(u,u,o),vec3.copy(w.rj,u),vec3.negate(w.ni,l),vec3.set(w.ri,0,0,0),t.push(w)}else console.warn("Point found inside convex, but did not find penetrating face!")}}function f(e,o,m,y,b,g,x,w,E){var S=!1,M=t.Shape.types,N=M.SPHERE,q=M.PLANE,V=M.BOX,P=M.COMPOUND,z=M.CONVEXPOLYHEDRON;if(o&&m){if(o.type>m.type){var j;j=m,m=o,o=j,j=b,b=y,y=j,j=x,x=g,g=j,j=E,E=w,w=j,S=!0}}else if(o&&!m){var j;j=m,m=o,o=j,j=b,b=y,y=j,j=x,x=g,g=j,j=E,E=w,w=j,S=!0}if(o&&m){if(o.type===N)switch(m.type){case N:a(e,o,m,y,b,g,x,w,E);break;case q:r(e,o,m,y,b,g,x,w,E);break;case V:s(e,o,m,y,b,g,x,w,E);break;case P:h(e,o,m,y,b,g,x,w,E);break;case z:n(e,o,m,y,b,g,x,w,E);break;default:console.warn("Collision between CANNON.Shape.types.SPHERE and "+m.type+" not implemented yet.")}else if(o.type===M.PLANE)switch(m.type){case M.PLANE:throw Error("Plane-plane collision... wait, you did WHAT?");case M.BOX:c(e,o,m,y,b,g,x,w,E);break;case M.COMPOUND:h(e,o,m,y,b,g,x,w,E);break;case M.CONVEXPOLYHEDRON:v(e,o,m,y,b,g,x,w,E);break;default:console.warn("Collision between CANNON.Shape.types.PLANE and "+m.type+" not implemented yet.")}else if(o.type===M.BOX)switch(m.type){case M.BOX:f(e,o.convexPolyhedronRepresentation,m.convexPolyhedronRepresentation,y,b,g,x,w,E);break;case M.COMPOUND:h(e,o,m,y,b,g,x,w,E);break;case M.CONVEXPOLYHEDRON:f(e,o.convexPolyhedronRepresentation,m,y,b,g,x,w,E);break;default:console.warn("Collision between CANNON.Shape.types.BOX and "+m.type+" not implemented yet.")}else if(o.type===M.COMPOUND)switch(m.type){case M.COMPOUND:h(e,o,m,y,b,g,x,w,E);break;case M.CONVEXPOLYHEDRON:var C=[];h(C,m,o,b,y,x,g,E,w);for(var I=0;I!==C.length;I++)i(C[I]),e.push(C[I]);break;default:console.warn("Collision between CANNON.Shape.types.COMPOUND and "+m.type+" not implemented yet.")}else if(o.type===M.CONVEXPOLYHEDRON)switch(m.type){case M.CONVEXPOLYHEDRON:l(e,o,m,y,b,g,x,w,E);break;default:console.warn("Collision between CANNON.Shape.types.CONVEXPOLYHEDRON and "+m.type+" not implemented yet.")}}else switch(m.type){case M.PLANE:u(e,o,m,y,b,g,x,w,E);break;case M.SPHERE:p(e,o,m,y,b,g,x,w,E);break;case M.BOX:d(e,o,m.convexPolyhedronRepresentation,y,b,g,x,w,E);break;case M.CONVEXPOLYHEDRON:d(e,o,m,y,b,g,x,w,E);break;case M.COMPOUND:h(e,o,m,y,b,g,x,w,E);break;default:console.warn("Collision between CANNON.Particle and "+m.type+" not implemented yet.")}for(var B=0,R=e.length;S&&B!==R;B++)i(e[B])}this.contactReduction=!1;var m=[],y=new t.Vec3Pool,b=vec3.create(),g=vec3.create(),x=vec3.create(),w=vec3.create(),E=vec3.create(),S=vec3.create(),M=vec3.create(),N=vec3.create(),q=vec3.create(),V=[vec3.create(),vec3.create(),vec3.create(),vec3.create(),vec3.create(),vec3.create()],P=vec3.create(),z=vec3.create(),j=vec3.create(),C=vec3.create(),I=vec3.create(),B=vec3.create(),R=vec3.create(),O=vec3.create(),A=vec3.create(),T=vec3.create(),F=vec3.create(),L=vec3.create(),k=vec3.create(),U=vec3.create();vec3.create(),vec3.create();var W=[],Q=[],D=vec3.create(),H=vec3.create(),X=vec3.create(),G=vec3.create(),Y=vec3.create(),_=vec3.create(),Z=vec3.create(),K=vec3.create(),J=vec3.create(),$=vec3.create(),te=new t.Quaternion,ee=vec3.create();vec3.create();var ie=vec3.create(),ae=vec3.create(),re=vec3.create();this.reduceContacts=function(){},this.getContacts=function(t,e,i,a,r){m=r;for(var o=0,s=t.length;o!==s;o++){var n=t[o],c=e[o];f(a,n.shape,c.shape,n.position,c.position,n.quaternion,c.quaternion,n,c)}}},t.Equation=function(t,e,i,a){this.id=-1,this.minForce=i===void 0?-1e6:i,this.maxForce=a===void 0?1e6:a,this.bi=t,this.bj=e,this.stiffness=1e7,this.regularizationTime=5,this.a=0,this.b=0,this.eps=0,this.spookParamsNeedsUpdate=!0},t.Equation.prototype.constructor=t.Equation,t.Equation.prototype.updateSpookParams=function(t){var e=this.regularizationTime,i=this.stiffness;this.a=4/(t*(1+4*e)),this.b=4*e/(1+4*e),this.eps=4/(t*t*i*(1+4*e))},t.ContactEquation=function(e,i){t.Equation.call(this,e,i,0,1e6),this.restitution=0,this.ri=vec3.create(),this.rj=vec3.create(),this.penetrationVec=vec3.create(),this.ni=vec3.create(),this.rixn=vec3.create(),this.rjxn=vec3.create(),this.invIi=mat3.create(),this.invIj=mat3.create(),this.biInvInertiaTimesRixn=vec3.create(),this.bjInvInertiaTimesRjxn=vec3.create()},t.ContactEquation.prototype=new t.Equation,t.ContactEquation.prototype.constructor=t.ContactEquation,t.ContactEquation.prototype.reset=function(){this.invInertiaTimesRxnNeedsUpdate=!0};var oe=vec3.create(),se=vec3.create(),ne=vec3.create();t.ContactEquation.prototype.computeB=function(t){var e=this.a,i=this.b,a=this.bi,r=this.bj,o=this.ri,s=this.rj,n=this.rixn,c=this.rjxn,h=ne,v=a.velocity,l=a.angularVelocity?a.angularVelocity:h,u=a.force,p=a.tau?a.tau:h,d=r.velocity,f=r.angularVelocity?r.angularVelocity:h,m=r.force,y=r.tau?r.tau:h,b=this.penetrationVec,g=a.invMass,x=r.invMass,w=this.invIi,E=this.invIj;a.invInertia?mat3.setTrace(w,a.invInertia):mat3.identity(w),r.invInertia?mat3.setTrace(E,r.invInertia):mat3.identity(E);var S=this.ni;vec3.cross(n,o,S),vec3.cross(c,s,S);var b=this.penetrationVec;vec3.set(b,0,0,0),vec3.add(b,b,r.position),vec3.add(b,b,s),vec3.subtract(b,b,a.position),vec3.subtract(b,b,o);var M=vec3.dot(S,b),N=oe,q=se;vec3.transformMat3(N,p,w),vec3.transformMat3(q,y,E);var V=this.restitution+1,P=V*vec3.dot(d,S)-V*vec3.dot(v,S)+vec3.dot(f,c)-vec3.dot(l,n),z=vec3.dot(m,S)*x-vec3.dot(u,S)*g+vec3.dot(c,q)-vec3.dot(n,N),j=-M*e-P*i-t*z;return j},vec3.create(),vec3.create(),t.ContactEquation.prototype.computeC=function(){var t=this.bi,e=this.bj,i=this.rixn,a=this.rjxn,r=t.invMass,o=e.invMass,s=r+o+this.eps,n=this.invIi,c=this.invIj;return t.invInertia?mat3.setTrace(n,t.invInertia):mat3.identity(n),e.invInertia?mat3.setTrace(c,e.invInertia):mat3.identity(c),vec3.transformMat3(this.biInvInertiaTimesRixn,i,n),vec3.transformMat3(this.bjInvInertiaTimesRjxn,a,c),s+=vec3.dot(this.biInvInertiaTimesRixn,i),s+=vec3.dot(this.bjInvInertiaTimesRjxn,a)};var ce=vec3.create();t.ContactEquation.prototype.computeGWlambda=function(){var t=this.bi,e=this.bj,i=ce,a=0;return vec3.subtract(i,e.vlambda,t.vlambda),a+=vec3.dot(i,this.ni),t.wlambda&&(a-=vec3.dot(t.wlambda,this.rixn)),e.wlambda&&(a+=vec3.dot(e.wlambda,this.rjxn)),a};var he=vec3.create(),ve=vec3.create();t.ContactEquation.prototype.addToWlambda=function(t){var e=this.bi,i=this.bj,a=(this.rixn,this.rjxn,e.invMass),r=i.invMass,o=this.ni,s=he,n=ve,c=e.wlambda,h=i.wlambda;vec3.scale(n,o,a*t),vec3.subtract(e.vlambda,e.vlambda,n),vec3.scale(n,o,r*t),vec3.add(i.vlambda,i.vlambda,n),c&&(vec3.scale(s,this.biInvInertiaTimesRixn,t),vec3.subtract(c,c,s)),h&&(vec3.scale(s,this.bjInvInertiaTimesRjxn,t),vec3.add(h,h,s))},t.FrictionEquation=function(e,i,a){t.Equation.call(this,e,i,-a,a),this.ri=vec3.create(),this.rj=vec3.create(),this.t=vec3.create(),this.rixt=vec3.create(),this.rjxt=vec3.create(),this.wixri=vec3.create(),this.wjxrj=vec3.create(),this.invIi=mat3.create(),this.invIj=mat3.create(),this.relVel=vec3.create(),this.relForce=vec3.create(),this.biInvInertiaTimesRixt=vec3.create(),this.bjInvInertiaTimesRjxt=vec3.create()},t.FrictionEquation.prototype=new t.Equation,t.FrictionEquation.prototype.constructor=t.FrictionEquation;var le=vec3.create(),ue=vec3.create(),pe=vec3.create();t.FrictionEquation.prototype.computeB=function(t){var e=this.a,i=this.b,a=this.bi,r=this.bj,o=this.ri,s=this.rj,n=this.rixt,c=this.rjxt,h=this.wixri,v=this.wjxrj,l=pe,u=a.velocity,p=a.angularVelocity?a.angularVelocity:l,d=a.force,f=a.tau?a.tau:l,m=r.velocity,y=r.angularVelocity?r.angularVelocity:l,b=r.force,g=r.tau?r.tau:l,x=(this.relVel,this.relForce,a.invMass),w=r.invMass,E=this.invIi,S=this.invIj,M=this.t,N=le,q=ue;a.invInertia&&mat3.setTrace(E,a.invInertia),r.invInertia&&mat3.setTrace(S,r.invInertia),vec3.cross(n,o,M),vec3.cross(c,s,M),vec3.cross(h,p,o),vec3.cross(v,y,s),vec3.transformMat3(N,f,E),vec3.transformMat3(q,g,S);
var V=0,P=vec3.dot(m,M)-vec3.dot(u,M)+vec3.dot(v,M)-vec3.dot(h,M),z=vec3.dot(b,M)*w-vec3.dot(d,M)*x+vec3.dot(c,q)-vec3.dot(n,N),j=-V*e-P*i-t*z;return j},t.FrictionEquation.prototype.computeC=function(){var t=this.bi,e=this.bj,i=this.rixt,a=this.rjxt,r=t.invMass,o=e.invMass,s=r+o+this.eps,n=this.invIi,c=this.invIj;return t.invInertia&&mat3.setTrace(n,t.invInertia),e.invInertia&&mat3.setTrace(c,e.invInertia),vec3.transformMat3(this.biInvInertiaTimesRixt,i,n),vec3.transformMat3(this.bjInvInertiaTimesRjxt,a,c),s+=vec3.dot(this.biInvInertiaTimesRixt,i),s+=vec3.dot(this.bjInvInertiaTimesRjxt,a)};var de=vec3.create();t.FrictionEquation.prototype.computeGWlambda=function(){var t=this.bi,e=this.bj,i=0,a=de;return vec3.subtract(a,e.vlambda,t.vlambda),i+=vec3.dot(a,this.t),t.wlambda&&(i-=vec3.dot(t.wlambda,this.rixt)),e.wlambda&&(i+=vec3.dot(e.wlambda,this.rjxt)),i};var fe=vec3.create();t.FrictionEquation.prototype.addToWlambda=function(t){var e=this.bi,i=this.bj,a=(this.rixt,this.rjxt,e.invMass),r=i.invMass,o=this.t,s=fe,n=e.wlambda,c=i.wlambda;vec3.scale(s,o,a*t),vec3.subtract(e.vlambda,e.vlambda,s),vec3.scale(s,o,r*t),vec3.add(i.vlambda,i.vlambda,s),n&&(vec3.scale(s,this.biInvInertiaTimesRixt,t),vec3.subtract(n,n,s)),c&&(vec3.scale(s,this.bjInvInertiaTimesRjxt,t),vec3.add(c,c,s))},t.RotationalEquation=function(e,i){t.Equation.call(this,e,i,-1e6,1e6),this.ni=new t.Vec3,this.nj=new t.Vec3,this.nixnj=new t.Vec3,this.njxni=new t.Vec3,this.invIi=new t.Mat3,this.invIj=new t.Mat3,this.relVel=new t.Vec3,this.relForce=new t.Vec3},t.RotationalEquation.prototype=new t.Equation,t.RotationalEquation.prototype.constructor=t.RotationalEquation,t.RotationalEquation.prototype.computeB=function(e){var i=this.a,a=this.b,r=this.bi,o=this.bj,s=this.ni,n=this.nj,c=this.nixnj,h=this.njxni;r.velocity;var v=r.angularVelocity?r.angularVelocity:new t.Vec3;r.force,r.tau?r.tau:new t.Vec3,o.velocity;var l=o.angularVelocity?o.angularVelocity:new t.Vec3;o.force,o.tau?o.tau:new t.Vec3,r.invMass,o.invMass;var u=this.invIi,p=this.invIj;r.invInertia?u.setTrace(r.invInertia):u.identity(),o.invInertia?p.setTrace(o.invInertia):p.identity(),s.cross(n,c),n.cross(s,h);var d=-s.dot(n),f=h.dot(v)+c.dot(l),m=0,y=-d*i-f*a-e*m;return y},t.RotationalEquation.prototype.computeC=function(){var t=this.bi,e=this.bj,i=this.nixnj,a=this.njxni;t.invMass,e.invMass;var r=this.eps,o=this.invIi,s=this.invIj;return t.invInertia?o.setTrace(t.invInertia):o.identity(),e.invInertia?s.setTrace(e.invInertia):s.identity(),r+=o.vmult(a).dot(a),r+=s.vmult(i).dot(i)};var ce=new t.Vec3;t.RotationalEquation.prototype.computeGWlambda=function(){var t=this.bi,e=this.bj,i=0;return t.wlambda&&(i+=t.wlambda.dot(this.njxni)),e.wlambda&&(i+=e.wlambda.dot(this.nixnj)),i},t.RotationalEquation.prototype.addToWlambda=function(t){var e=this.bi,i=this.bj,a=this.nixnj;if(this.njxni,e.invMass,i.invMass,e.wlambda){var r=this.invIi;e.wlambda.vsub(r.vmult(a).mult(t),e.wlambda)}if(i.wlambda){var r=this.invIj;i.wlambda.vadd(r.vmult(a).mult(t),i.wlambda)}},t.Constraint=function(t,e){this.equations=[],this.bodyA=t,this.bodyB=e},t.Constraint.prototype.update=function(){throw Error("method update() not implmemented in this Constraint subclass!")},t.DistanceConstraint=function(e,i,a,r){t.Constraint.call(this,e,i),r===void 0&&(r=1e6);var o=this.equations=[new t.ContactEquation(e,i)],s=o[0];s.minForce=-r,s.maxForce=r,this.update=function(){i.position.vsub(e.position,s.ni),s.ni.normalize(),s.ni.mult(.5*a,s.ri),s.ni.mult(.5*-a,s.rj)}},t.DistanceConstraint.prototype=new t.Constraint,t.RotationalMotorEquation=function(e,i,a){a=a||1e6,t.Equation.call(this,e,i,-a,a),this.axisA=new t.Vec3,this.axisB=new t.Vec3,this.invIi=new t.Mat3,this.invIj=new t.Mat3,this.targetVelocity=0},t.RotationalMotorEquation.prototype=new t.Equation,t.RotationalMotorEquation.prototype.constructor=t.RotationalMotorEquation,t.RotationalMotorEquation.prototype.computeB=function(e){var i=this.a,a=this.b,r=this.bi,o=this.bj,s=this.axisA,n=this.axisB;r.velocity;var c=r.angularVelocity?r.angularVelocity:new t.Vec3;r.force,r.tau?r.tau:new t.Vec3,o.velocity;var h=o.angularVelocity?o.angularVelocity:new t.Vec3;o.force,o.tau?o.tau:new t.Vec3,r.invMass,o.invMass;var v=this.invIi,l=this.invIj;r.invInertia?v.setTrace(r.invInertia):v.identity(),o.invInertia?l.setTrace(o.invInertia):l.identity();var u=0,p=s.dot(c)+n.dot(h)+this.targetVelocity,d=0,f=-u*i-p*a-e*d;return f},t.RotationalMotorEquation.prototype.computeC=function(){var t=this.bi,e=this.bj,i=this.axisA,a=this.axisB;t.invMass,e.invMass;var r=this.eps,o=this.invIi,s=this.invIj;return t.invInertia?o.setTrace(t.invInertia):o.identity(),e.invInertia?s.setTrace(e.invInertia):s.identity(),r+=o.vmult(i).dot(a),r+=s.vmult(a).dot(a)};var ce=new t.Vec3;t.RotationalMotorEquation.prototype.computeGWlambda=function(){var t=this.bi,e=this.bj,i=this.axisA,a=this.axisB,r=0;return t.wlambda&&(r+=t.wlambda.dot(i)),e.wlambda&&(r+=e.wlambda.dot(a)),r},t.RotationalMotorEquation.prototype.addToWlambda=function(t){var e=this.bi,i=this.bj,a=this.axisA,r=this.axisB;if(e.invMass,i.invMass,e.wlambda){var o=this.invIi;e.wlambda.vsub(o.vmult(a).mult(t),e.wlambda)}if(i.wlambda){var o=this.invIj;i.wlambda.vadd(o.vmult(r).mult(t),i.wlambda)}},t.HingeConstraint=function(e,i,a,r,o,s,n){t.Constraint.call(this,e,r),n=n||1e6;var c=this,h=this.equations=[new t.RotationalEquation(e,r),new t.RotationalEquation(e,r),new t.ContactEquation(e,r),new t.ContactEquation(e,r),new t.ContactEquation(e,r)];this.getRotationalEquation1=function(){return h[0]},this.getRotationalEquation2=function(){return h[1]},this.getPointToPointEquation1=function(){return h[2]},this.getPointToPointEquation2=function(){return h[3]},this.getPointToPointEquation3=function(){return h[4]};var v,l=this.getRotationalEquation1(),u=this.getRotationalEquation2(),p=this.getPointToPointEquation1(),d=this.getPointToPointEquation2(),f=this.getPointToPointEquation3();d.minForce=f.minForce=p.minForce=-n,d.maxForce=f.maxForce=p.maxForce=n;var m=i.unit(),y=o.unit(),b=new t.Vec3,g=new t.Vec3,x=new t.Vec3;a.cross(m,b),a.cross(b,g),s.cross(y,x),b.normalize(),x.normalize();var w=!1;this.motorTargetVelocity=0,this.motorMinForce=-n,this.motorMaxForce=n,this.enableMotor=function(){w||(v=new t.RotationalMotorEquation(e,r,n),h.push(v),w=!0)},this.disableMotor=function(){w&&(w=!1,v=null,h.pop())},this.update=function(){p.ni.set(1,0,0),d.ni.set(0,1,0),f.ni.set(0,0,1),e.quaternion.vmult(i,p.ri),r.quaternion.vmult(o,p.rj),p.ri.copy(d.ri),p.rj.copy(d.rj),p.ri.copy(f.ri),p.rj.copy(f.rj),e.quaternion.vmult(b,l.ni),r.quaternion.vmult(s,l.nj),e.quaternion.vmult(g,u.ni),r.quaternion.vmult(s,u.nj),w&&(e.quaternion.vmult(a,v.axisA),r.quaternion.vmult(s,v.axisB),v.targetVelocity=c.motorTargetVelocity,v.maxForce=c.motorMaxForce,v.minForce=c.motorMinForce)}},t.HingeConstraint.prototype=new t.Constraint,t.PointToPointConstraint=function(e,i,a,r,o){t.Constraint.call(this,e,a);var s=this.equations=[new t.ContactEquation(e,a),new t.ContactEquation(e,a),new t.ContactEquation(e,a)],n=s[0],c=s[1],h=s[2];c.minForce=h.minForce=n.minForce=-o,c.maxForce=h.maxForce=n.maxForce=o,this.update=function(){vec3.subtract(n.ni,a.position,e.position),vec3.normalize(n.ni,n.ni),vec3.transformQuat(n.ri,i,e.quaternion),vec3.transformQuat(n.rj,r,a.quaternion),vec3.tangents(c.ni,h.ni,n.ni),vec3.copy(c.ri,n.ri),vec3.copy(c.rj,n.rj),vec3.copy(h.ri,n.ri),vec3.copy(h.rj,n.rj)}},t.PointToPointConstraint.prototype=new t.Constraint,"undefined"!=typeof module?module.exports=t:this.CANNON=t}).apply(this);