/**
 * Copyright (c) 2012 cannon.js Authors
 * 
 * Permission is hereby granted, free of charge, to any person
 * obtaining a copy of this software and associated documentation
 * files (the "Software"), to deal in the Software without
 * restriction, including without limitation the rights to use, copy,
 * modify, merge, publish, distribute, sublicense, and/or sell copies
 * of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be
 * included in all copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
 * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
 * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
 * LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
 * OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
 * WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 */(function(){var e=e||{};this.Int32Array||(this.Int32Array=Array,this.Float32Array=Array),e.Broadphase=function(){this.world=null},e.Broadphase.prototype.constructor=e.BroadPhase,e.Broadphase.prototype.collisionPairs=function(a){throw"collisionPairs not implemented for this BroadPhase class!"},e.NaiveBroadphase=function(){this.temp={r:new e.Vec3,normal:new e.Vec3,quat:new e.Quaternion}},e.NaiveBroadphase.prototype=new e.Broadphase,e.NaiveBroadphase.prototype.constructor=e.NaiveBroadphase,e.NaiveBroadphase.prototype.collisionPairs=function(a){var b=[],c=[],d=a.numObjects(),f=a.bodies,g=e.Shape.types,h=g.SPHERE|g.BOX|g.COMPOUND|g.CONVEXPOLYHEDRON,i=g.PLANE,j=e.RigidBody.STATIC|e.RigidBody.KINEMATIC,k=this.temp.r,l=this.temp.normal,m=this.temp.quat;for(var n=0;n<d;n++)for(var o=0;o<n;o++){var p=f[n],q=f[o],r=p.shape.type,s=q.shape.type;if(!((p.motionstate&j)===0&&!p.isSleeping()||(q.motionstate&j)===0&&!q.isSleeping()))continue;if(r&h&&s&h){q.position.vsub(p.position,k);var t=p.shape.boundingSphereRadius()+q.shape.boundingSphereRadius();k.norm2()<t*t&&(b.push(p),c.push(q))}else if(r&h&&s&g.PLANE||s&h&&r&g.PLANE){var u=r===i?n:o,v=r!==i?n:o;f[v].position.vsub(f[u].position,k),f[u].quaternion.vmult(f[u].shape.normal,l);var w=k.dot(l)-f[v].shape.boundingSphereRadius();w<0&&(b.push(p),c.push(q))}}return[b,c]},e.Ray=function(a,b){function q(a,b,c){return c.vsub(a,m),o=m.dot(b),b.mult(o,n),n.vadd(a,n),p=c.distanceTo(n),p}function B(a,b,c,d){return d.vsub(b,m),c.vsub(b,z),a.vsub(b,A),r=m.dot(m),s=m.dot(z),t=m.dot(A),u=z.dot(z),v=z.dot(A),w=1/(r*u-s*s),x=(u*t-s*v)*w,y=(r*v-s*t)*w,x>=0&&y>=0&&x+y<1}this.origin=a||new e.Vec3,this.direction=b||new e.Vec3;var c=1e-4;this.setPrecision=function(a){c=a};var d=new e.Vec3,f=new e.Vec3,g=new e.Vec3,h=new e.Vec3,i=new e.Vec3,j=new e.Vec3,k=new e.Vec3,l=new e.Vec3;this.intersectBody=function(a){if(a.shape instanceof e.ConvexPolyhedron)return this.intersectShape(a.shape,a.quaternion,a.position,a);if(a.shape instanceof e.Box)return this.intersectShape(a.shape.convexPolyhedronRepresentation,a.quaternion,a.position,a);console.warn("Ray intersection is this far only implemented for ConvexPolyhedron and Box shapes.")},this.intersectShape=function(a,b,h,i){var j,k=[];if(a instanceof e.ConvexPolyhedron){var m=q(this.origin,this.direction,h);if(m>a.boundingSphereRadius())return k;var n,o,p=a.faces,r=a.vertices,s=a.faceNormals;for(fi=0;fi<p.length;fi++){var t=p[fi],u=s[fi],v=b,w=h,x=new e.Vec3;r[t[0]].copy(x),x.vsub(this.origin,x),v.vmult(x,x),x.vadd(w,x);var y=new e.Vec3;v.vmult(u,y),n=this.direction.dot(y);if(Math.abs(n)<c)continue;o=y.dot(x)/n;if(o<0)continue;if(n<0){this.direction.mult(o,l),l.vadd(this.origin,l),r[t[0]].copy(d),v.vmult(d,d),w.vadd(d,d);for(var z=1;z<t.length-1;z++){r[t[z]].copy(f),r[t[z+1]].copy(g),v.vmult(f,f),v.vmult(g,g),w.vadd(f,f),w.vadd(g,g);if(B(l,d,f,g)){j={distance:this.origin.distanceTo(l),point:l.copy(),face:t,body:i},k.push(j);break}}}}}return k},this.intersectBodies=function(a){var b=[];for(var c=0,d=a.length;c<d;c++){var e=this.intersectBody(a[c]);Array.prototype.push.apply(b,e)}return b.sort(function(a,b){return a.distance-b.distance}),b};var m=new e.Vec3,n=new e.Vec3,o,p,r,s,t,u,v,w,x,y,z=new e.Vec3,A=new e.Vec3},e.Ray.prototype.constructor=e.Ray,e.Mat3=function(a){a?this.elements=new Float32Array(a):this.elements=new Float32Array(9)},e.Mat3.prototype.identity=function(){this.elements[0]=1,this.elements[1]=0,this.elements[2]=0,this.elements[3]=0,this.elements[4]=1,this.elements[5]=0,this.elements[6]=0,this.elements[7]=0,this.elements[8]=1},e.Mat3.prototype.vmult=function(a,b){b===undefined&&(b=new e.Vec3);var c=[a.x,a.y,a.z],d=[0,0,0];for(var f=0;f<3;f++)for(var g=0;g<3;g++)d[f]+=this.elements[f+3*g]*c[f];return b.x=d[0],b.y=d[1],b.z=d[2],b},e.Mat3.prototype.smult=function(a){for(var b=0;b<this.elements.length;b++)this.elements[b]*=a},e.Mat3.prototype.mmult=function(a){var b=new e.Mat3;for(var c=0;c<3;c++)for(var d=0;d<3;d++){var f=0;for(var g=0;g<3;g++)f+=this.elements[c+g]*a.elements[g+d*3];b.elements[c+d*3]=f}return b},e.Mat3.prototype.solve=function(a,b){b=b||new e.Vec3;var c=3,d=4,f=new Float32Array(c*d),g,h;for(g=0;g<3;g++)for(h=0;h<3;h++)f[g+d*h]=this.elements[g+3*h];f[3]=a.x,f[7]=a.y,f[11]=a.z;var i=3,j=i,k,l=4,m,n;do{g=j-i;if(f[g+d*g]===0)for(h=g+1;h<j;h++)if(f[g+d*h]!==0){n=[],k=l;do m=l-k,n.push(f[m+d*g]+f[m+d*h]);while(--k);f[g+d*0]=n[0],f[g+d*1]=n[1],f[g+d*2]=n[2];break}if(f[g+d*g]!==0)for(h=g+1;h<j;h++){var o=f[g+d*h]/f[g+d*g];n=[],k=l;do m=l-k,n.push(m<=g?0:f[m+d*h]-f[m+d*g]*o);while(--k);f[h+d*0]=n[0],f[h+d*1]=n[1],f[h+d*2]=n[2]}}while(--i);b.z=f[2*d+3]/f[2*d+2],b.y=(f[1*d+3]-f[1*d+2]*b.z)/f[1*d+1],b.x=(f[0*d+3]-f[0*d+2]*b.z-f[0*d+1]*b.y)/f[0*d+0];if(isNaN(b.x)||isNaN(b.y)||isNaN(b.z)||b.x===Infinity||b.y===Infinity||b.z===Infinity)throw"Could not solve equation! Got x=["+b.toString()+"], b=["+a.toString()+"], A=["+this.toString()+"]";return b},e.Mat3.prototype.e=function(a,b,c){if(c===undefined)return this.elements[a+3*b];this.elements[a+3*b]=c},e.Mat3.prototype.copy=function(a){a=a||new e.Mat3;for(var b=0;b<this.elements.length;b++)a.elements[b]=this.elements[b];return a},e.Mat3.prototype.toString=function(){var a="",b=",";for(var c=0;c<9;c++)a+=this.elements[c]+b;return a},e.Vec3=function(a,b,c){this.x=a||0,this.y=b||0,this.z=c||0},e.Vec3.prototype.cross=function(a,b){b=b||new e.Vec3;var c=[this.x,this.y,this.z],d=[a.x,a.y,a.z];return b.x=c[1]*d[2]-c[2]*d[1],b.y=c[2]*d[0]-c[0]*d[2],b.z=c[0]*d[1]-c[1]*d[0],b},e.Vec3.prototype.set=function(a,b,c){return this.x=a,this.y=b,this.z=c,this},e.Vec3.prototype.vadd=function(a,b){if(!b)return new e.Vec3(this.x+a.x,this.y+a.y,this.z+a.z);b.x=a.x+this.x,b.y=a.y+this.y,b.z=a.z+this.z},e.Vec3.prototype.vsub=function(a,b){if(!b)return new e.Vec3(this.x-a.x,this.y-a.y,this.z-a.z);b.x=this.x-a.x,b.y=this.y-a.y,b.z=this.z-a.z},e.Vec3.prototype.crossmat=function(){return new e.Mat3([0,-this.z,this.y,this.z,0,-this.x,-this.y,this.x,0])},e.Vec3.prototype.normalize=function(){var a=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z);return a>0?(this.x/=a,this.y/=a,this.z/=a):(this.x=0,this.y=0,this.z=0),a},e.Vec3.prototype.unit=function(a){a=a||new e.Vec3;var b=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z);return b>0?(b=1/b,a.x=this.x*b,a.y=this.y*b,a.z=this.z*b):(a.x=0,a.y=0,a.z=0),a},e.Vec3.prototype.norm=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},e.Vec3.prototype.norm2=function(){return this.dot(this)},e.Vec3.prototype.distanceTo=function(a){return Math.sqrt((a.x-this.x)*(a.x-this.x)+(a.y-this.y)*(a.y-this.y)+(a.z-this.z)*(a.z-this.z))},e.Vec3.prototype.mult=function(a,b){return b||(b=new e.Vec3),b.x=a*this.x,b.y=a*this.y,b.z=a*this.z,b},e.Vec3.prototype.dot=function(a){return this.x*a.x+this.y*a.y+this.z*a.z},e.Vec3.prototype.isZero=function(){return this.x===0&&this.y===0&&this.z===0},e.Vec3.prototype.negate=function(a){return a=a||new e.Vec3,a.x=-this.x,a.y=-this.y,a.z=-this.z,a},e.Vec3.prototype.tangents=function(a,b){var c=this.norm();if(c>0){var d=new e.Vec3(this.x/c,this.y/c,this.z/c);if(d.x<.9){var f=Math.random();d.cross((new e.Vec3(f,1e-7,0)).unit(),a)}else d.cross((new e.Vec3(1e-7,f,0)).unit(),a);d.cross(a,b)}else a.set(1,0,0).normalize(),b.set(0,1,0).normalize()},e.Vec3.prototype.toString=function(){return this.x+","+this.y+","+this.z},e.Vec3.prototype.copy=function(a){return a=a||new e.Vec3,a.x=this.x,a.y=this.y,a.z=this.z,a},e.Vec3.prototype.lerp=function(a,b,c){c.x=this.x+(a.x-this.x)*b,c.y=this.y+(a.y-this.y)*b,c.z=this.z+(a.z-this.z)*b},e.Vec3.prototype.almostEquals=function(a,b){return b===undefined&&(b=1e-6),Math.abs(this.x-a.x)>b||Math.abs(this.y-a.y)>b||Math.abs(this.z-a.z)>b?!1:!0},e.Vec3.prototype.almostZero=function(a){return a===undefined&&(a=1e-6),Math.abs(this.x)>a||Math.abs(this.y)>a||Math.abs(this.z)>a?!1:!0},e.Quaternion=function(a,b,c,d){this.x=a!=undefined?a:0,this.y=b!=undefined?b:0,this.z=c!=undefined?c:0,this.w=d!=undefined?d:1},e.Quaternion.prototype.set=function(a,b,c,d){this.x=a,this.y=b,this.z=c,this.w=d},e.Quaternion.prototype.toString=function(){return this.x+","+this.y+","+this.z+","+this.w},e.Quaternion.prototype.setFromAxisAngle=function(a,b){var c=Math.sin(b*.5);this.x=a.x*c,this.y=a.y*c,this.z=a.z*c,this.w=Math.cos(b*.5)},e.Quaternion.prototype.setFromVectors=function(a,b){var c=a.cross(b);this.x=c.x,this.y=c.y,this.z=c.z,this.w=Math.sqrt(Math.pow(a.norm(),2)*Math.pow(b.norm(),2))+a.dot(b),this.normalize()},e.Quaternion.prototype.mult=function(a,b){b==undefined&&(b=new e.Quaternion);var c=new e.Vec3(this.x,this.y,this.z),d=new e.Vec3(a.x,a.y,a.z);return b.w=this.w*a.w-c.dot(d),vaxvb=c.cross(d),b.x=this.w*d.x+a.w*c.x+vaxvb.x,b.y=this.w*d.y+a.w*c.y+vaxvb.y,b.z=this.w*d.z+a.w*c.z+vaxvb.z,b},e.Quaternion.prototype.inverse=function(a){a==undefined&&(a=new e.Quaternion),this.conjugate(a);var b=1/(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);return a.x*=b,a.y*=b,a.z*=b,a.w*=b,a},e.Quaternion.prototype.conjugate=function(a){return a==undefined&&(a=new e.Quaternion),a.x=-this.x,a.y=-this.y,a.z=-this.z,a.w=this.w,a},e.Quaternion.prototype.normalize=function(){var a=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);a===0?(this.x=0,this.y=0,this.z=0,this.w=0):(a=1/a,this.x*=a,this.y*=a,this.z*=a,this.w*=a)},e.Quaternion.prototype.normalizeFast=function(){var a=(3-(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w))/2;a===0?(this.x=0,this.y=0,this.z=0,this.w=0):(this.x*=a,this.y*=a,this.z*=a,this.w*=a)},e.Quaternion.prototype.vmult=function(a,b){b=b||new e.Vec3;if(this.w==0)b.x=a.x,b.y=a.y,b.z=a.z;else{var c=a.x,d=a.y,f=a.z,g=this.x,h=this.y,i=this.z,j=this.w,k=j*c+h*f-i*d,l=j*d+i*c-g*f,m=j*f+g*d-h*c,n=-g*c-h*d-i*f;b.x=k*j+n*-g+l*-i-m*-h,b.y=l*j+n*-h+m*-g-k*-i,b.z=m*j+n*-i+k*-h-l*-g}return b},e.Quaternion.prototype.copy=function(a){a.x=this.x,a.y=this.y,a.z=this.z,a.w=this.w},e.Quaternion.prototype.toEuler=function(a,b){b=b||"YZX";var c,d,e,f=this.x,g=this.y,h=this.z,i=this.w;switch(b){case"YZX":var j=f*g+h*i;j>.499&&(c=2*Math.atan2(f,i),d=Math.PI/2,e=0),j<-0.499&&(c=-2*Math.atan2(f,i),d=-Math.PI/2,e=0);if(isNaN(c)){var k=f*f,l=g*g,m=h*h;c=Math.atan2(2*g*i-2*f*h,1-2*l-2*m),d=Math.asin(2*j),e=Math.atan2(2*f*i-2*g*h,1-2*k-2*m)}break;default:throw new Error("Euler order "+b+" not supported yet.")}a.y=c,a.z=d,a.x=e},e.Shape=function(){this.type=0,this.aabbmin=new e.Vec3,this.aabbmax=new e.Vec3},e.Shape.prototype.constructor=e.Shape,e.Shape.prototype.boundingSphereRadius=function(){throw"boundingSphereRadius() not implemented for shape type "+this.type},e.Shape.prototype.volume=function(){throw"volume() not implemented for shape type "+this.type},e.Shape.prototype.calculateLocalInertia=function(a,b){throw"calculateLocalInertia() not implemented for shape type "+this.type},e.Shape.prototype.calculateTransformedInertia=function(a,b,c){c==undefined&&(c=new e.Vec3),b.normalize();var d=this.calculateLocalInertia(a),f=b.vmult(d);return c.x=Math.abs(f.x),c.y=Math.abs(f.y),c.z=Math.abs(f.z),c},e.Shape.types={SPHERE:1,PLANE:2,BOX:4,COMPOUND:8,CONVEXPOLYHEDRON:16},e.RigidBody=function(a,b,c){if(typeof a!="number")throw new Error("Argument 1 (mass) must be a number.");if(!(typeof b=="object"&&b instanceof e.Shape))throw new Error("Argument 2 (shape) must be an instance of CANNON.Shape.");if(!(typeof c=="undefined"||c instanceof e.Material))throw new Error("Argument 3 (material) must be an instance of CANNON.Material.");e.EventTarget.apply(this);var d=this;this.position=new e.Vec3,this.initPosition=new e.Vec3,this.velocity=new e.Vec3,this.initVelocity=new e.Vec3,this.force=new e.Vec3,this.tau=new e.Vec3,this.quaternion=new e.Quaternion,this.initQuaternion=new e.Quaternion,this.angularVelocity=new e.Vec3,this.initAngularVelocity=new e.Vec3,this.mass=a,this.invMass=a>0?1/a:0,this.shape=b,this.inertia=new e.Vec3,b.calculateLocalInertia(a,this.inertia),this.invInertia=new e.Vec3(this.inertia.x>0?1/this.inertia.x:0,this.inertia.y>0?1/this.inertia.y:0,this.inertia.z>0?1/this.inertia.z:0),this.material=c,this.linearDamping=.01,this.angularDamping=.01,this.motionstate=a<=0?e.RigidBody.STATIC:e.RigidBody.DYNAMIC,this.world=null,this.preStep=null,this.postStep=null,this.allowSleep=!0;var f=0;this.isAwake=function(){return f==0},this.isSleepy=function(){return f==1},this.isSleeping=function(){return f==2},this.sleepSpeedLimit=.1,this.sleepTimeLimit=1e3;var g=(new Date).getTime();this.wakeUp=function(){f=0,d.dispatchEvent({type:"wakeup"})},this.sleep=function(){f=2},this.sleepTick=function(){d.allowSleep&&(f==0&&d.velocity.norm()<d.sleepSpeedLimit?(f=1,g=(new Date).getTime(),d.dispatchEvent({type:"sleepy"})):f==1&&d.velocity.norm()>d.sleepSpeedLimit?d.wakeUp():f==1&&(new Date).getTime()-g>d.sleepTimeLimit&&(f=2,d.dispatchEvent({type:"sleep"})))}},e.RigidBody.DYNAMIC=1,e.RigidBody.STATIC=2,e.RigidBody.KINEMATIC=4,e.Sphere=function(a){e.Shape.call(this),this.radius=a!=undefined?Number(a):1,this.type=e.Shape.types.SPHERE},e.Sphere.prototype=new e.Shape,e.Sphere.prototype.constructor=e.Sphere,e.Sphere.prototype.calculateLocalInertia=function(a,b){b=b||new e.Vec3;var c=2*a*this.radius*this.radius/5;return b.x=c,b.y=c,b.z=c,b},e.Sphere.prototype.volume=function(){return 4*Math.PI*this.radius/3},e.Sphere.prototype.boundingSphereRadius=function(){return this.radius},e.Box=function(a){e.Shape.call(this),this.halfExtents=a,this.type=e.Shape.types.BOX,this.convexPolyhedronRepresentation=null,this.updateConvexPolyhedronRepresentation()},e.Box.prototype=new e.Shape,e.Box.prototype.constructor=e.Box,e.Box.prototype.updateConvexPolyhedronRepresentation=function(){var a=this.halfExtents.x,b=this.halfExtents.y,c=this.halfExtents.z,d=e.Vec3,f=new e.ConvexPolyhedron([new d(-a,-b,-c),new d(a,-b,-c),new d(a,b,-c),new d(-a,b,-c),new d(-a,-b,c),new d(a,-b,c),new d(a,b,c),new d(-a,b,c)],[[0,1,2,3],[4,5,6,7],[0,1,4,5],[2,3,6,7],[0,3,4,7],[1,2,5,6]],[new d(0,0,-1),new d(0,0,1),new d(0,-1,0),new d(0,1,0),new d(-1,0,0),new d(1,0,0)]);this.convexPolyhedronRepresentation=f},e.Box.prototype.calculateLocalInertia=function(a,b){return b=b||new e.Vec3,b.x=1/12*a*(2*this.halfExtents.y*2*this.halfExtents.y+2*this.halfExtents.z*2*this.halfExtents.z),b.y=1/12*a*(2*this.halfExtents.x*2*this.halfExtents.x+2*this.halfExtents.z*2*this.halfExtents.z),b.z=1/12*a*(2*this.halfExtents.y*2*this.halfExtents.y+2*this.halfExtents.x*2*this.halfExtents.x),b},e.Box.prototype.getCorners=function(a){var b=[],c=this.halfExtents;b.push(new e.Vec3(c.x,c.y,c.z)),b.push(new e.Vec3(-c.x,c.y,c.z)),b.push(new e.Vec3(-c.x,-c.y,c.z)),b.push(new e.Vec3(-c.x,-c.y,-c.z)),b.push(new e.Vec3(c.x,-c.y,-c.z)),b.push(new e.Vec3(c.x,c.y,-c.z)),b.push(new e.Vec3(-c.x,c.y,-c.z)),b.push(new e.Vec3(c.x,-c.y,c.z));for(var d=0;a!=undefined&&d<b.length;d++)a.vmult(b[d],b[d]);return b},e.Box.prototype.getSideNormals=function(a,b){var c=[],d=this.halfExtents;c.push(new e.Vec3(d.x,0,0)),c.push(new e.Vec3(0,d.y,0)),c.push(new e.Vec3(0,0,d.z)),a!=undefined&&a&&(c.push(new e.Vec3(-d.x,0,0)),c.push(new e.Vec3(0,-d.y,0)),c.push(new e.Vec3(0,0,-d.z)));for(var f=0;b!=undefined&&f<c.length;f++)b.vmult(c[f],c[f]);return c},e.Box.prototype.volume=function(){return 8*this.halfExtents.x*this.halfExtents.y*this.halfExtents.z},e.Box.prototype.boundingSphereRadius=function(){return this.halfExtents.norm()},e.Plane=function(a){e.Shape.call(this),a.normalize(),this.normal=a,this.type=e.Shape.types.PLANE},e.Plane.prototype=new e.Shape,e.Plane.prototype.constructor=e.Plane,e.Plane.prototype.calculateLocalInertia=function(a,b){return b=b||new e.Vec3,b},e.Plane.prototype.volume=function(){return Infinity},e.Compound=function(){e.Shape.call(this),this.type=e.Shape.types.COMPOUND,this.childShapes=[],this.childOffsets=[],this.childOrientations=[]},e.Compound.prototype=new e.Shape,e.Compound.prototype.constructor=e.Compound,e.Compound.prototype.addChild=function(a,b,c){b=b||new e.Vec3,c=c||new e.Quaternion,this.childShapes.push(a),this.childOffsets.push(b),this.childOrientations.push(c)},e.Compound.prototype.volume=function(){var a=0;for(var b=0;b<this.childShapes.length;b++)a+=this.childShapes[b].volume();return a},e.Compound.prototype.calculateLocalInertia=function(a,b){b=b||new e.Vec3;var c=this.volume();for(var d=0;d<this.childShapes.length;d++){var f=this.childShapes[d],g=this.childOffsets[d],h=this.childOrientations[d],i=f.volume()/c*a,j=f.calculateTransformedInertia(i,h);b.vadd(j,b);var k=new e.Vec3(i*g.x*g.x,i*g.y*g.y,i*g.z*g.z);b.vadd(k,b)}return b},e.Compound.prototype.boundingSphereRadius=function(){var a=0;for(var b=0;b<this.childShapes.length;b++){var c=this.childOffsets[b].norm()+this.childShapes[b].boundingSphereRadius();a<c&&(a=c)}return a},e.ConvexPolyhedron=function(a,b,c){function o(a,b,c,d,f){var g=a.vertices.length,h=null,i=null,j=a.vertices,k=new e.Vec3;for(var l=0;l<g;l++){j[l].copy(k),d.vmult(k,k),k.vadd(c,k);var m=k.dot(b);if(h===null||m>h)h=m;if(i===null||m<i)i=m}if(i>h){var n=i;i=h,h=n}f[0]=h,f[1]=i}function p(a,b){var c=d.vertices[a[0]],f=d.vertices[a[1]],g=d.vertices[a[2]],h=new e.Vec3;s(c,f,g,h);var i=h.dot(c);return h.dot(b)>=i}function q(a,b){var c=d.faces[a],e=d.vertices[c[0]],f=d.vertices[c[1]],g=d.vertices[c[2]];return s(e,f,g,b)}function r(a,b){var c=d.faces[a],e=d.faceNormals[a],f=d.vertices[c[0]],g=-e.dot(f);return g}function s(a,b,c,d){var f=new e.Vec3,g=new e.Vec3;b.vsub(a,g),c.vsub(b,f),f.cross(g,d),d.isZero()||d.normalize()}function t(a){var b=d.faces[a],c="";for(var e=0;e<b.length;e++)c+=" ("+d.vertices[b[e]]+")";return c}function u(a,b){return a[0]===b[1]&&a[1]===b[0]}function v(){return(Math.random()-.5)*2*1e-6}var d=this;e.Shape.call(this),this.type=e.Shape.types.CONVEXPOLYHEDRON,this.vertices=[],this.faces=b,this.faceNormals=c,this.uniqueEdges=[];for(pi in a){var f=a[pi];if(!(f instanceof e.Vec3))throw"Argument 1 must be instance of CANNON.Vec3";this.vertices.push(f)}for(var g=0;g<b.length;g++){var h=b[g].length,i=h;for(var j=0;j<i;j++){var k=(j+1)%h,l=new e.Vec3;this.vertices[b[g][j]].vsub(this.vertices[b[g][k]],l),l.normalize();var m=!1;for(var f=0;f<this.uniqueEdges.length;f++)if(this.uniqueEdges[f].almostEquals(l)||this.uniqueEdges[f].almostEquals(l)){m=!0;break}m||this.uniqueEdges.push(l);if(l)l.face1=g;else{var n;n.m_face0=g,edges.insert(vp,n)}}}this.testSepAxis=function(a,b,c,d,e,f){var g=[],h=[],i=this;o(i,a,c,d,g),o(b,a,e,f,h);var j=g[0],k=g[1],l=h[0],m=h[1];if(j<m||l<k)return!1;var n=j-m,p=l-k;return depth=n<p?n:p,depth},this.findSeparatingAxis=function(a,b,c,d,f,g){var h=Infinity,i=this,j=0,k=i.faces.length,l=new e.Vec3;for(var m=0;m<k;m++){i.faceNormals[m].copy(l),c.vmult(l,l);var n=i.testSepAxis(l,a,b,c,d,f);if(n===!1)return!1;n<h&&(h=n,l.copy(g))}var o=new e.Vec3,p=a.faces.length;for(var m=0;m<p;m++){a.faceNormals[m].copy(o),f.vmult(o,o),j++;var n=i.testSepAxis(o,a,b,c,d,f);if(n===!1)return!1;n<h&&(h=n,o.copy(g))}var q,r,s,t,u=0,v=new e.Vec3,w=new e.Vec3,x=new e.Vec3;for(var y=0;y<i.uniqueEdges.length;y++){i.uniqueEdges[y].copy(v),c.vmult(v,v);for(var z=0;z<a.uniqueEdges.length;z++){a.uniqueEdges[z].copy(w),f.vmult(w,w),v.cross(w,x),u++;if(!x.almostZero()){x.normalize();var A=i.testSepAxis(x,a,b,c,d,f);if(A===!1)return!1;A<h&&(h=A,x.copy(g))}}}var B=new e.Vec3;return d.vsub(b,B),B.dot(g)>0&&g.negate(g),!0},this.clipAgainstHull=function(a,b,c,d,f,g,h,i,j){if(!(a instanceof e.Vec3))throw new Error("posA must be Vec3");if(!(b instanceof e.Quaternion))throw new Error("quatA must be Quaternion");var k=this,l=i,m=-1,n=-Infinity,o=new e.Vec3;for(var p=0;p<c.faces.length;p++){c.faceNormals[p].copy(o),f.vmult(o,o),d.vadd(o,o);var q=o.dot(g);q>n&&(n=q,m=p)}var r=[];polyB=c.faces[m];var s=polyB.length;for(var t=0;t<s;t++){var u=c.vertices[polyB[t]],v=new e.Vec3;u.copy(v),f.vmult(v,v),d.vadd(v,v),r.push(v)}m>=0&&this.clipFaceAgainstHull(g,a,b,r,h,i,j)},this.clipFaceAgainstHull=function(a,b,c,d,f,g,h){if(!(a instanceof e.Vec3))throw new Error("sep normal must be vector");if(!(d instanceof Array))throw new Error("world verts must be array");f=Number(f),g=Number(g);var i=this,j=[],k=d,l=j,m=-1,n=Infinity,o=new e.Vec3;for(var p=0;p<i.faces.length;p++){i.faceNormals[p].copy(o),c.vmult(o,o),b.vadd(o,o);var q=o.dot(a);q<n&&(n=q,m=p)}if(m<0){console.log("--- did not find any closest face... ---");return}var s=i.faces[m];s.connectedFaces=[];for(var t=0;t<i.faces.length;t++)for(var u=0;u<i.faces[t].length;u++)s.indexOf(i.faces[t][u])!==-1&&t!==m&&s.connectedFaces.indexOf(t)===-1&&s.connectedFaces.push(t);var v=k.length,w=s.length,x=new e.Vec3,y=new e.Vec3,z=new e.Vec3,A=new e.Vec3,B=[];for(var C=0;C<w;C++){var D=i.vertices[s[C]],E=i.vertices[s[(C+1)%w]];D.vsub(E,x),x.copy(y),c.vmult(y,y),b.vadd(y,y),this.faceNormals[m].copy(z),c.vmult(z,z),b.vadd(z,z),y.cross(z,A),A.negate(A);var F=new e.Vec3;D.copy(F),c.vmult(F,F),b.vadd(F,F);var G=-F.dot(A),H=s.connectedFaces[C],I=new e.Vec3;this.faceNormals[H].copy(I);var J=r(H),K=new e.Vec3;I.copy(K),c.vmult(K,K);var L=J-K.dot(b);this.clipFaceAgainstPlane(k,l,K,L);while(k.length)k.shift();while(l.length)k.push(l.shift())}var I=new e.Vec3;this.faceNormals[m].copy(I);var J=r(m),K=new e.Vec3;I.copy(K),c.vmult(K,K);var L=J-K.dot(b);for(var t=0;t<k.length;t++){var M=K.dot(k[t])+L;M<=f&&(console.log("clamped: depth="+M+" to minDist="+(f+"")),M=f);if(M<=g){var N=k[t],O={point:N,normal:K,depth:M};h.push(O)}}},this.clipFaceAgainstPlane=function(a,b,c,d){if(c instanceof e.Vec3){if(a instanceof Array){if(b instanceof Array){var f,g,h=a.length;if(h<2)return b;var i=a[a.length-1],j=a[0];f=c.dot(i)+d;for(var k=0;k<h;k++){j=a[k],g=c.dot(j)+d;if(f<0)if(g<0){var l=new e.Vec3;j.copy(l),b.push(l)}else{var l=new e.Vec3;i.lerp(j,f/(f-g),l),b.push(l)}else if(g<0){var l=new e.Vec3;i.lerp(j,f/(f-g),l),b.push(l),b.push(j)}i=j,f=g}return b}throw new Error("outvertices must be Array, "+b+" given")}throw new Error("invertices must be Array, "+a+" given")}throw new Error("planeNormal must be Vec3, "+c+" given")};var d=this;this.calculateLocalInertia=function(a,b){var c=this.aabbmax.x-this.aabbmin.x,d=this.aabbmax.y-this.aabbmin.y,e=this.aabbmax.z-this.aabbmin.z;b.x=1/12*a*(2*d*2*d+2*e*2*e),b.y=1/12*a*(2*c*2*c+2*e*2*e),b.z=1/12*a*(2*d*2*d+2*c*2*c)},this.computeAABB=function(){var a=this.vertices.length,b=this.aabbmin,c=this.aabbmax,d=this.vertices;b.set(Infinity,Infinity,Infinity),c.set(-Infinity,-Infinity,-Infinity);for(var e=0;e<a;e++){var f=d[e];f.x<b.x?b.x=f.x:f.x>c.x&&(c.x=f.x),f.y<b.y?b.y=f.y:f.y>c.y&&(c.y=f.y),f.z<b.z?b.z=f.z:f.z>c.z&&(c.z=f.z)}},this.boundingSphereRadius=function(){var a=0;for(var b=0;b<this.vertices.length;b++){var c=this.vertices[b].norm2();c>a&&(a=c)}return Math.sqrt(a)},this.computeAABB()},e.ConvexPolyhedron.prototype=new e.Shape,e.ConvexPolyhedron.prototype.constructor=e.ConvexPolyhedron,e.Solver=function(){this.iterations=10,this.h=1/60,this.k=1e3,this.d=4,this.a=0,this.b=0,this.eps=0,this.setSpookParams(this.k,this.d),this.reset(0),this.debug=!1,this.debug&&console.log("a:",a,"b",b,"eps",eps,"k",k,"d",d)},e.Solver.prototype.setSpookParams=function(a,b){var c=this.h;this.k=a,this.d=b,this.a=4/(c*(1+4*b)),this.b=4*b/(1+4*b),this.eps=4/(c*c*a*(1+4*b))},e.Solver.prototype.reset=function(a){this.G=[],this.MinvTrace=[],this.Fext=[],this.q=[],this.qdot=[],this.n=0,this.upper=[],this.lower=[],this.hasupper=[],this.haslower=[],this.i=[],this.j=[],this.vxlambda=[],this.vylambda=[],this.vzlambda=[],this.wxlambda=[],this.wylambda=[],this.wzlambda=[];for(var b=0;b<a;b++)this.vxlambda.push(0),this.vylambda.push(0),this.vzlambda.push(0),this.wxlambda.push(0),this.wylambda.push(0),this.wzlambda.push(0)},e.Solver.prototype.addConstraint=function(a,b,c,d,e,f,g,h,i){this.debug&&(console.log("Adding constraint ",this.n," between body ",h," and ",i),console.log("G:",a),console.log("q:",c),console.log("qdot:",d),console.log("Fext:",e),console.log("lower:",f),console.log("upper:",g));for(var j=0;j<12;j++)this.q.push(c[j]),this.qdot.push(d[j]),this.MinvTrace.push(b[j]),this.G.push(a[j]),this.Fext.push(e[j]);return this.upper.push(g),this.hasupper.push(!isNaN(g)),this.lower.push(f),this.haslower.push(!isNaN(f)),this.i.push(h),this.j.push(i),this.n+=1,this.n-1},e.Solver.prototype.addConstraint2=function(a,b,c){a.update();for(var d=0;d<a.equations.length;d++){var e=a.equations[d];this.addConstraint([e.G1.x,e.G1.y,e.G1.z,e.G2.x,e.G2.y,e.G2.z,e.G3.x,e.G3.y,e.G3.z,e.G4.x,e.G4.y,e.G4.z],[e.iM1.x,e.iM1.y,e.iM1.z,e.iM2.x,e.iM2.y,e.iM2.z,e.iM3.x,e.iM3.y,e.iM3.z,e.iM4.x,e.iM4.y,e.iM4.z],[e.g1.x,e.g1.y,e.g1.z,e.g2.x,e.g2.y,e.g2.z,e.g3.x,e.g3.y,e.g3.z,e.g4.x,e.g4.y,e.g4.z],[e.W1.x,e.W1.y,e.W1.z,e.W2.x,e.W2.y,e.W2.z,e.W3.x,e.W3.y,e.W3.z,e.W4.x,e.W4.y,e.W4.z],[e.f1.x,e.f1.y,e.f1.z,e.f2.x,e.f2.y,e.f2.z,e.f3.x,e.f3.y,e.f3.z,e.f4.x,e.f4.y,e.f4.z],e.lambdamin,e.lambdamax,b,c)}},e.Solver.prototype.addNonPenetrationConstraint=function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s){var t=f.cross(e),u=m.vsub(l),v=d.vadd(g).vsub(c.vadd(f)),w=v.dot(e);w<0&&(this.debug&&(console.log("i:",a,"j",b,"xi",c.toString(),"xj",d.toString()),console.log("ni",e.toString(),"ri",f.toString(),"rj",g.toString()),console.log("iMi",h.toString(),"iMj",i.toString(),"iIi",j.toString(),"iIj",k.toString(),"vi",l.toString(),"vj",m.toString(),"wi",n.toString(),"wj",o.toString(),"fi",p.toString(),"fj",q.toString(),"taui",r.toString(),"tauj",s.toString())),this.addConstraint([-e.x,-e.y,-e.z,-t.x,-t.y,-t.z,e.x,e.y,e.z,t.x,t.y,t.z],[h.x,h.y,h.z,j.z,j.y,j.z,i.x,i.y,i.z,k.z,k.y,k.z],[-v.x,-v.y,-v.z,0,0,0,v.x,v.y,v.z,0,0,0],[-u.x,-u.y,-u.z,0,0,0,u.x,u.y,u.z,0,0,0],[p.x,p.y,p.z,r.x,r.y,r.z,q.x,q.y,q.z,s.x,s.y,s.z],0,"inf",a,b))},e.Solver.prototype.solve=function(){var a=this.n,b=[],c=[],d=[],e=[],f=[],g=[],h=this.iterations,i=this.G,j=this.debug,k=this.a,l=this.eps,m=this.lower,n=this.haslower,o=this.upper,p=this.hasupper,q=this.vxlambda,r=this.vylambda,s=this.vzlambda,t=this.wxlambda,u=this.wylambda,v=this.wzlambda,w=this.MinvTrace;for(var x=0;x<a;x++){b.push(0),c.push(0),e.push(0),f.push(0),g.push(0);for(var y=0;y<12;y++)c.push(0)}for(var z=0;z<h;z++)for(var A=0;A<a;A++){var B=this.i[A],C=this.j[A],D=12*A;if(!g[A]){var E=0,F=0,G=0,H=0;for(var x=0;x<12;x++){var I=D+x;E+=i[I]*w[I]*i[I],F+=i[I]*this.q[I],G+=i[I]*this.qdot[I],H+=i[I]*w[I]*this.Fext[I]}f[A]=1/(E+l),e[A]=-k*F-this.b*G-this.h*H,g[A]=1,j&&(console.log("G_Minv_Gt["+A+"]:",E),console.log("Gq["+A+"]:",F),console.log("GW["+A+"]:",G),console.log("GMinvf["+A+"]:",H))}var J=0;B>=0&&(J+=i[0+D]*q[B],J+=i[1+D]*r[B],J+=i[2+D]*s[B],J+=i[3+D]*t[B],J+=i[4+D]*u[B],J+=i[5+D]*v[B],j&&isNaN(J)&&console.log("found NaN Gulambda",q)),C!==-1&&(J+=i[6+D]*q[C],J+=i[7+D]*r[C],J+=i[8+D]*s[C],J+=i[9+D]*t[C],J+=i[10+D]*u[C],J+=i[11+D]*v[C]),c[A]=f[A]*(e[A]-J-l*b[A]),j&&console.log("dlambda["+A+"]=",c[A],"rest = ",f[A],e[A],J,l,b[A],A,B,C),b[A]=b[A]+c[A],n[A]&&b[A]<m[A]&&(j&&console.log("hit lower bound for constraint "+A+", truncating "+b[A]+" to the bound "+m[A]),b[A]=m[A],c[A]=m[A]-b[A]),p&&b[A]>o[A]&&(j&&console.log("hit upper bound for constraint "+A+", truncating "+b[A]+" to the bound "+o[A]),b[A]=o[A],c[A]=o[A]-b[A]),B!==-1&&(q[B]+=c[A]*w[D+0]*i[D+0],r[B]+=c[A]*w[D+1]*i[D+1],s[B]+=c[A]*w[D+2]*i[D+2],t[B]+=c[A]*w[D+3]*i[D+3],u[B]+=c[A]*w[D+4]*i[D+4],v[B]+=c[A]*w[D+5]*i[D+5]),C!==-1&&(q[C]+=c[A]*w[D+6]*i[D+6],r[C]+=c[A]*w[D+7]*i[D+7],s[C]+=c[A]*w[D+8]*i[D+8],t[C]+=c[A]*w[D+9]*i[D+9],u[C]+=c[A]*w[D+10]*i[D+10],v[C]+=c[A]*w[D+11]*i[D+11])}if(j)for(var x=0;x<this.vxlambda.length;x++)console.log("dv["+x+"]=",q[x],r[x],s[x],t[x],u[x],v[x])},e.EventTarget=function(){var a={};this.addEventListener=function(b,c){a[b]==undefined&&(a[b]=[]),a[b].indexOf(c)===-1&&a[b].push(c)},this.dispatchEvent=function(b){for(var c in a[b.type])a[b.type][c](b)},this.removeEventListener=function(b,c){var d=a[b].indexOf(c);d!==-1&&a[b].splice(d,1)}},e.ObjectPool=function(){this.objects=[],this.type=Object},e.ObjectPool.prototype.release=function(){for(var a in arguments)this.objects.push(arguments[a])},e.ObjectPool.prototype.get=function(){return this.objects.length===0?this.constructObject():this.objects.pop()},e.ObjectPool.prototype.constructObject=function(){throw new Error("constructObject() not implemented in this ObjectPool subclass yet!")},e.Vec3Pool=function(){e.ObjectPool.call(this),this.type=e.Vec3},e.Vec3Pool.prototype=new e.ObjectPool,e.Vec3Pool.prototype.constructObject=function(){return new e.Vec3},e.Material=function(a){this.name=a,this.id=-1},e.ContactMaterial=function(a,b,c,d){this.id=-1,this.materials=[a,b],this.friction=c!=undefined?Number(c):.3,this.restitution=d!=undefined?Number(d):.3},e.World=function(){this.allowSleep=!1,this.time=0,this.stepnumber=0,this.default_dt=1/60,this.last_dt=this.default_dt,this.nextId=0,this.gravity=new e.Vec3,this.broadphase=null,this.bodies=[];var a=this;this.solver=new e.Solver,this.constraints=[],this.contactgen=new e.ContactGenerator,this.materials=[],this.contactmaterials=[],this.mats2cmat=[],this.temp={gvec:new e.Vec3,vi:new e.Vec3,vj:new e.Vec3,wi:new e.Vec3,wj:new e.Vec3,t1:new e.Vec3,t2:new e.Vec3,rixn:new e.Vec3,rjxn:new e.Vec3,step_q:new e.Quaternion,step_w:new e.Quaternion,step_wq:new e.Quaternion}},e.World.prototype.getContactMaterial=function(a,b){if(a instanceof e.Material&&b instanceof e.Material){var c=a.id,d=b.id;if(c<d){var f=c;c=d,d=f}return this.contactmaterials[this.mats2cmat[c+d*this.materials.length]]}},e.World.prototype._addImpulse=function(a,b,c,d,f,g,h,i){var j=c.crossmat(),k=d.crossmat(),l=this.inertiax[a]>0?1/this.inertiax[a]:0,m=new e.Mat3([l,0,0,0,l,0,0,0,l]);l=this.inertiax[b]>0?1/this.inertiax[b]:0;var n=new e.Mat3([l,0,0,0,l,0,0,0,l]),o=this.invm[a]+this.invm[b],p=new e.Mat3([o,0,0,0,o,0,0,0,o]),q=j.mmult(m.mmult(j)),r=k.mmult(n.mmult(k)),s=g.mult(-h*f.dot(g)),t=p.solve(s.vsub(f)),i=0;if(i>0){var u=g.mult(t.dot(g)),v=t.vsub(u);if(v.norm()>u.mult(i).norm()){var w=f.vsub(g.mult(f.dot(g))),x=w.mult(1/(w.norm()+1e-4)),y=-(1+h)*f.dot(g)/g.dot(p.vmult(g.vsub(x.mult(i))));t=g.mult(y).vsub(x.mult(i*y))}}var z=this.invm[a],A=this.invm[b];this.vx[a]+=t.x*z-(this.vx[b]-f.x),this.vy[a]+=t.y*z-(this.vy[b]-f.y),this.vz[a]+=t.z*z-(this.vz[b]-f.z),this.vx[b]-=t.x*A+(this.vx[a]+f.x),this.vy[b]-=t.y*A+(this.vy[a]+f.y),this.vz[b]-=t.z*A+(this.vz[a]+f.z);var B=c.cross(t),C=B.mult(1/this.inertiax[a])},e.World.prototype.numObjects=function(){return this.bodies.length},e.World.prototype.clearCollisionState=function(a){var b=this.numObjects(),c=a.id;for(var d=0;d<b;d++){var e=d;c>e?this.collision_matrix[e+c*b]=0:this.collision_matrix[c+e*b]=0}},e.World.prototype.add=function(a){if(a instanceof e.RigidBody){var b=this.numObjects();this.bodies.push(a),a.id=this.id(),a.world=this,a.position.copy(a.initPosition),a.velocity.copy(a.initVelocity),a.angularVelocity.copy(a.initAngularVelocity),a.quaternion.copy(a.initQuaternion),this.collision_matrix=new Int16Array((b+1)*(b+1))}},e.World.prototype.addConstraint=function(a){a instanceof e.Constraint&&(this.constraints.push(a),a.id=this.id())},e.World.prototype.id=function(){return this.nextId++},e.World.prototype.remove=function(a){if(a instanceof e.RigidBody){a.world=null;var b=this.numObjects(),c=this.bodies;for(var d in c)c[d].id==a.id&&c.splice(d,1);this.collision_matrix=new Int16Array((b-1)*(b-1))}},e.World.prototype.addMaterial=function(a){if(a.id==-1){this.materials.push(a),a.id=this.materials.length-1;var b=new Int16Array(this.materials.length*this.materials.length);for(var c=0;c<b.length;c++)b[c]=-1;for(var c=0;c<this.materials.length-1;c++)for(var d=0;d<this.materials.length-1;d++)b[c+this.materials.length*d]=this.mats2cmat[c+(this.materials.length-1)*d];this.mats2cmat=b}},e.World.prototype.addContactMaterial=function(a){this.addMaterial(a.materials[0]),this.addMaterial(a.materials[1]),a.materials[0].id>a.materials[1].id?(i=a.materials[0].id,j=a.materials
[1].id):(j=a.materials[0].id,i=a.materials[1].id),this.contactmaterials.push(a),a.id=this.contactmaterials.length-1,this.mats2cmat[i+this.materials.length*j]=a.id},e.World.prototype._id2index=function(a){for(var b=0;b<this.bodies.length;b++)if(this.bodies[b].id===a)return b;return-1},e.World.prototype.step=function(a){function r(a,b,e){typeof e=="undefined"&&(e=!0);if(e&&a<b||!e&&a>b){var f=b;b=a,a=f}return c.collision_matrix[a+b*d]}function s(a,b,e,f){typeof f=="undefined"&&(f=!0);if(f&&a<b||!f&&a>b){var g=b;b=a,a=g}c.collision_matrix[a+b*d]=parseInt(e)}function t(){for(var a=0;a<f.length;a++)for(var b=0;b<a;b++){var c=r(a,b,!0);s(a,b,c,!1),s(a,b,0,!0)}}var b=this,c=this,d=this.numObjects(),f=this.bodies;a==undefined&&(this.last_dt?a=this.last_dt:a=this.default_dt);for(var g in f){var h=f[g];if(h.motionstate&e.RigidBody.DYNAMIC){var i=f[g].force,j=f[g].mass;i.x+=b.gravity.x*j,i.y+=b.gravity.y*j,i.z+=b.gravity.z*j}}var k=this.broadphase.collisionPairs(this),l=k[0],m=k[1],n=e.Shape.types.SPHERE,o=e.Shape.types.PLANE,p=e.Shape.types.BOX,q=e.Shape.types.COMPOUND;t(),this.solver.reset(d);var u=this.contacts;this.contacts=[],this.contactgen.getContacts(l,m,this,this.contacts,u);var v=this.temp;for(var w=0;w<this.contacts.length;w++){var x=this.contacts[w],h=x.bi,y=x.bj,g=this._id2index(h.id),z=this._id2index(y.id),A=r(g,z,!1),B=.3,C=.2,D=this.getContactMaterial(h.material,y.material);D&&(B=D.friction,C=D.restitution);var E=v.gvec;E.set(y.position.x+x.rj.x-h.position.x-x.ri.x,y.position.y+x.rj.y-h.position.y-x.ri.y,y.position.z+x.rj.z-h.position.z-x.ri.z);var F=E.dot(x.ni);if(F<0){s(g,z,1,!0),r(g,z,true)!=r(g,z,false)&&(h.dispatchEvent({type:"collide","with":y}),y.dispatchEvent({type:"collide","with":h}),h.wakeUp(),y.wakeUp());var G=h.velocity,H=h.angularVelocity,I=y.velocity,J=y.angularVelocity,K=x.ni,L=[v.t1,v.t2];K.tangents(L[0],L[1]);var M=G.vadd(H.cross(x.ri)),N=I.vadd(J.cross(x.rj)),O=N.vsub(M),P=J.cross(x.rj).vsub(H.cross(x.ri)),Q=I.vsub(G),R=x.rj.cross(J).vsub(x.ri.cross(H));Q.vsub(R,Q);var S=h.invMass,T=y.invMass,U=h.invInertia.x,V=h.invInertia.y,W=h.invInertia.z,X=y.invInertia.x,Y=y.invInertia.y,Z=y.invInertia.z,$=v.rixn,_=v.rjxn;x.ri.cross(K,$),x.rj.cross(K,_);var ab=K.mult(O.dot(K)*.5),bb=$.unit().mult(P.dot($.unit())),cb=_.unit().mult(-P.dot(_.unit())),db=x.ni.mult(F);this.solver.addConstraint([-K.x,-K.y,-K.z,-$.x,-$.y,-$.z,K.x,K.y,K.z,_.x,_.y,_.z],[S,S,S,U,V,W,T,T,T,X,Y,Z],[-db.x,-db.y,-db.z,0,0,0,db.x,db.y,db.z,0,0,0],[-ab.x,-ab.y,-ab.z,0,0,0,ab.x,ab.y,ab.z,0,0,0],[h.force.x,h.force.y,h.force.z,h.tau.x,h.tau.y,h.tau.z,-y.force.x,-y.force.y,-y.force.z,-y.tau.x,-y.tau.y,-y.tau.z],0,"inf",g,z);if(B>0){var F=c.gravity.norm();for(var eb=0;eb<L.length;eb++){var fb=L[eb],gb=x.ri.cross(fb),hb=x.rj.cross(fb),ib=fb.mult(O.dot(fb)),jb=gb.unit().mult(O.dot(gb.unit())),kb=hb.unit().mult(-O.dot(hb.unit()));this.solver.addConstraint([-fb.x,-fb.y,-fb.z,-gb.x,-gb.y,-gb.z,fb.x,fb.y,fb.z,hb.x,hb.y,hb.z],[S,S,S,U,V,W,T,T,T,X,Y,Z],[0,0,0,0,0,0,0,0,0,0,0,0],[-ib.x,-ib.y,-ib.z,0,0,0,ib.x,ib.y,ib.z,0,0,0],[h.force.x,h.force.y,h.force.z,h.tau.x,h.tau.y,h.tau.z,y.force.x,y.force.y,y.force.z,y.tau.x,y.tau.y,y.tau.z],-B*100*(h.mass+y.mass),B*100*(h.mass+y.mass),g,z)}}}}for(var g=0;g<this.constraints.length;g++){var y=-1,h=-1;for(var z=0;z<this.bodies.length;z++)this.bodies[z].id===this.constraints[g].body_i.id?h=z:this.bodies[z].id===this.constraints[g].body_j.id&&(y=z);this.solver.addConstraint2(this.constraints[g],h,y)}var h;if(this.solver.n){this.solver.h=a,this.solver.solve();for(var g in f){h=f[g];if(h.motionstate&e.RigidBody.DYNAMIC){var lb=f[g];lb.velocity.x+=this.solver.vxlambda[g],lb.velocity.y+=this.solver.vylambda[g],lb.velocity.z+=this.solver.vzlambda[g],lb.angularVelocity.x+=this.solver.wxlambda[g],lb.angularVelocity.y+=this.solver.wylambda[g],lb.angularVelocity.z+=this.solver.wzlambda[g]}}}for(var g in f){h=f[g];if(h.motionstate&e.RigidBody.DYNAMIC){var mb=1-h.linearDamping,nb=1-h.angularDamping;h.velocity.mult(mb,h.velocity),h.angularVelocity.mult(nb,h.angularVelocity)}}for(var g in f){var h=f[g];h.preStep&&h.preStep.call(h)}var ob=v.step_q,pb=v.step_w,qb=v.step_wq,rb=e.RigidBody.DYNAMIC|e.RigidBody.KINEMATIC;for(var g in f){var lb=f[g];lb.motionstate&rb&&(lb.velocity.x+=lb.force.x*lb.invMass*a,lb.velocity.y+=lb.force.y*lb.invMass*a,lb.velocity.z+=lb.force.z*lb.invMass*a,lb.angularVelocity.x+=lb.tau.x*lb.invInertia.x*a,lb.angularVelocity.y+=lb.tau.y*lb.invInertia.y*a,lb.angularVelocity.z+=lb.tau.z*lb.invInertia.z*a,lb.isSleeping()||(lb.position.x+=lb.velocity.x*a,lb.position.y+=lb.velocity.y*a,lb.position.z+=lb.velocity.z*a,pb.set(lb.angularVelocity.x,lb.angularVelocity.y,lb.angularVelocity.z,0),pb.mult(lb.quaternion,qb),lb.quaternion.x+=a*.5*qb.x,lb.quaternion.y+=a*.5*qb.y,lb.quaternion.z+=a*.5*qb.z,lb.quaternion.w+=a*.5*qb.w,b.stepnumber%3===0&&lb.quaternion.normalizeFast())),lb.force.set(0,0,0),lb.tau.set(0,0,0)}b.time+=a,b.stepnumber+=1;for(var g in f){var h=f[g];h.postStep&&h.postStep.call(h)}if(b.allowSleep)for(var g=0;g<d;g++){var h=f[g];h.sleepTick()}},e.ContactPoint=function(a,b,c,d,f){if(!(a instanceof e.RigidBody&&b instanceof e.RigidBody))throw new Error("Arguments 1 and 2 must be instances of CANNON.RigidBody.");this.ri=new e.Vec3,this.rj=new e.Vec3,this.ni=new e.Vec3,c&&c.copy(this.ri),d&&d.copy(this.rj),f&&f.copy(this.ni),this.bi=a,this.bj=b},e.ContactGenerator=function(){function c(d,f,g,h,i,j,k,l,m){function p(b,c){if(a.length){var d=a.pop();return d.bi=b,d.bj=c,d}return new e.ContactPoint(b,c)}function q(a){var b;b=a.ri,a.ri=a.rj,a.rj=b,a.ni.negate(a.ni),b=a.bi,a.bi=a.bj,a.bj=b}function r(a,b,d,e,f,g,h,i,j){for(var k=0;k<d.childShapes.length;k++){var l=[];c(l,b,d.childShapes[k],e,f.vadd(h.vmult(d.childOffsets[k])),g,h.mult(d.childOrientations[k]),i,j);for(var m=0;m<l.length;m++)l[m].rj.vadd(h.vmult(d.childOffsets[k]),l[m].rj),a.push(l[m])}}var n=!1;if(f.type>g.type){var o;o=g,g=f,f=o,o=i,i=h,h=o,o=k,k=j,j=o,o=m,m=l,l=o,n=!0}if(f.type==e.Shape.types.SPHERE){if(g.type==e.Shape.types.SPHERE){var s=p(l,m);i.vsub(h,s.ni),s.ni.normalize(),s.ni.copy(s.ri),s.ni.copy(s.rj),s.ri.mult(f.radius,s.ri),s.rj.mult(-g.radius,s.rj),d.push(s)}else if(g.type==e.Shape.types.PLANE){var s=p(l,m);g.normal.copy(s.ni),k.vmult(s.ni,s.ni),s.ni.negate(s.ni),s.ni.normalize(),s.ni.mult(f.radius,s.ri);var t=h.vsub(i),u=s.ni.mult(s.ni.dot(t));s.rj=t.vsub(u),u.norm()<=f.radius&&d.push(s)}else if(g.type==e.Shape.types.BOX){var v=h.vsub(i),w=g.getSideNormals(!0,k),x=f.radius,y=[],z=!1;for(var A=0;A<w.length&&!z;A++){var B=w[A].copy(),C=B.norm();B.normalize();var D=v.dot(B);if(D<C+x&&D>0){var E=w[(A+1)%3].copy(),F=w[(A+2)%3].copy(),G=E.norm(),H=F.norm();E.normalize(),F.normalize();var I=v.dot(E),J=v.dot(F);if(I<G&&I>-G&&J<H&&J>-H){z=!0;var s=p(l,m);B.mult(-x,s.ri),B.copy(s.ni),s.ni.negate(s.ni),B.mult(C).vadd(E.mult(I)).vadd(F.mult(J),s.rj),d.push(s)}}}var K=b.get();for(var L=0;L<2&&!z;L++)for(var M=0;M<2&&!z;M++)for(var N=0;N<2&&!z;N++){K.set(0,0,0),L?K.vadd(w[0],K):K.vsub(w[0],K),M?K.vadd(w[1],K):K.vsub(w[1],K),N?K.vadd(w[2],K):K.vsub(w[2],K);var O=i.vadd(K).vsub(h);if(O.norm()<x){z=!0;var s=p(l,m);O.copy(s.ri),s.ri.normalize(),s.ri.copy(s.ni),s.ri.mult(x,s.ri),K.copy(s.rj),d.push(s)}}b.release(K),K=null;var P=b.get(),Q=b.get(),s=b.get(),R=b.get(),S=b.get();for(var L=0;L<w.length&&!z;L++)for(var M=0;M<w.length&&!z;M++)if(L%3!=M%3){w[M].cross(w[L],P),P.normalize(),w[L].vadd(w[M],Q),h.copy(s),s.vsub(Q,s),s.vsub(i,s);var T=s.dot(P);P.mult(T,R);var N=0;while(N==L%3||N==M%3)N++;h.copy(S),S.vsub(R,S),S.vsub(Q,S),S.vsub(i,S);var U=Math.abs(T),V=S.norm();if(U<w[N].norm()&&V<x){z=!0;var W=p(l,m);Q.vadd(R,W.rj),W.rj.copy(W.rj),S.negate(W.ni),W.ni.normalize(),W.rj.copy(W.ri),W.ri.vadd(i,W.ri),W.ri.vsub(h,W.ri),W.ri.normalize(),W.ri.mult(x,W.ri),d.push(W)}}b.release(P,Q,s,R,S)}else if(g.type==e.Shape.types.COMPOUND)r(d,f,g,h,i,j,k,l,m);else if(g.type==e.Shape.types.CONVEXPOLYHEDRON)throw new Error("sphere/convexpolyhedron contacts not implemented yet.")}else if(f.type==e.Shape.types.PLANE){if(g.type==e.Shape.types.PLANE)throw"Plane-plane collision... wait, you did WHAT?";if(g.type==e.Shape.types.BOX){var X=f.normal.copy(),Y=0,Z=g.getCorners(k);for(var A=0;A<Z.length&&Y<=4;A++){var s=p(l,m),$=Z[A].vadd(i);Z[A].copy(s.rj);var _=$.vsub(h),ab=X.dot(_);if(ab<=0){Y++;var bb=X.mult(ab);_.vsub(bb,s.ri),X.copy(s.ni),d.push(s)}}}else if(g.type==e.Shape.types.COMPOUND)r(d,f,g,h,i,j,k,l,m);else if(g.type==e.Shape.types.CONVEXPOLYHEDRON){var cb=b.get(),db=b.get();f.normal.tangents(cb,db),cb.mult(1e5,cb),db.mult(1e5,db);var X=b.get();f.normal.copy(X);var eb=[new e.Vec3(-cb.x-db.x-X.x,-cb.y-db.y-X.y,-cb.z-db.z-X.z),new e.Vec3(cb.x-db.x+0*X.x,cb.y-db.y+0*X.y,cb.z-db.z+0*X.z),new e.Vec3(cb.x+db.x-X.x,cb.y+db.y-X.y,cb.z+db.z-X.z),new e.Vec3(-cb.x+db.x-X.x,-cb.y+db.y-X.y,-cb.z+db.z-X.z),new e.Vec3(-cb.x-db.x+0*X.x,-cb.y-db.y+0*X.y,-cb.z-db.z+0*X.z),new e.Vec3(+cb.x-db.x+0*X.x,cb.y-db.y+0*X.y,cb.z-db.z+0*X.z),new e.Vec3(+cb.x+db.x+0*X.x,+cb.y+db.y+0*X.y,cb.z+db.z+0*X.z),new e.Vec3(-cb.x+db.x+0*X.x,-cb.y+db.y+0*X.y,-cb.z+db.z+0*X.z)];cb.normalize(),db.normalize();var fb=new e.ConvexPolyhedron(eb,[[0,1,2,3],[4,5,6,7],[0,1,4,5],[2,3,6,7],[0,3,4,7],[1,2,5,6]],[new e.Vec3(-X.x,-X.y,-X.z),new e.Vec3(X.x,X.y,X.z),new e.Vec3(-db.x,-db.y,-db.z),new e.Vec3(db.x,db.y,db.z),new e.Vec3(-cb.x,-cb.y,-cb.z),new e.Vec3(cb.x,cb.y,cb.z)]),gb=b.get();X.negate(gb);var hb=b.get();if(g.testSepAxis(gb,fb,i,k,h,j)!==!1){var W=[];fb.clipAgainstHull(h,j,g,i,k,gb,-100,100,W);for(var L=0;L<W.length;L++){var s=p(l,m);gb.negate(s.ni),W[L].normal.negate(hb),hb.mult(W[L].depth,hb),s.ri.set(W[L].point.x+hb.x,W[L].point.y+hb.y,W[L].point.z+hb.z),s.rj.set(W[L].point.x,W[L].point.y,W[L].point.z),s.rj.vsub(i,s.rj),s.ri.vsub(h,s.ri),d.push(s)}}b.release(hb,cb,db,gb,X)}}else if(f.type==e.Shape.types.BOX)g.type==e.Shape.types.BOX?c(d,f.convexPolyhedronRepresentation,g.convexPolyhedronRepresentation,h,i,j,k,l,m):g.type==e.Shape.types.COMPOUND?r(d,f,g,h,i,j,k,l,m):g.type==e.Shape.types.CONVEXPOLYHEDRON&&c(d,f.convexPolyhedronRepresentation,g,h,i,j,k,l,m);else if(f.type==e.Shape.types.COMPOUND)g.type==e.Shape.types.COMPOUND?r(d,f,g,h,i,j,k,l,m):g.type==e.Shape.types.CONVEXPOLYHEDRON&&r(d,g,f,i,h,k,j,m,l);else if(f.type==e.Shape.types.CONVEXPOLYHEDRON&&g.type==e.Shape.types.CONVEXPOLYHEDRON){var gb=new e.Vec3;if(f.findSeparatingAxis(g,h,j,i,k,gb)){var W=[],hb=new e.Vec3;f.clipAgainstHull(h,j,g,i,k,gb,-100,100,W);for(var L=0;L<W.length;L++){var s=p(l,m);gb.negate(s.ni),W[L].normal.negate(hb),hb.mult(W[L].depth,hb),s.ri.set(W[L].point.x+hb.x,W[L].point.y+hb.y,W[L].point.z+hb.z),s.rj.set(W[L].point.x,W[L].point.y,W[L].point.z),s.rj.vsub(i,s.rj),s.ri.vsub(h,s.ri),d.push(s)}}}for(var ib=0;n&&ib<d.length;ib++)q(d[ib])}this.contactReduction=!0;var a=[],b=new e.Vec3Pool;this.reduceContacts=function(a){},this.getContacts=function(b,d,e,f,g){for(var h=0;g&&h<g.length;h++)a.push(g[h]);for(var i=0;i<b.length;i++){var j=b[i],k=d[i];c(f,j.shape,k.shape,j.position,k.position,j.quaternion,k.quaternion,j,k)}}},e.Constraint=function(){this.equations=[],this.id=-1},e.Constraint.prototype.constructor=e.Constraint,e.Constraint.prototype.update=function(){throw"update() not implemented in this Constraint subclass!"},e.ContactConstraint=function(a,b,c){e.Constraint.call(this),this.body_i=a,this.body_j=b,this.contact=contact,this.slipForce=c,this.unused_equations=[],this.temp={rixn:new e.Vec3,rjxn:new e.Vec3,t1:new e.Vec3,t2:new e.Vec3}},e.ContactConstraint.prototype=new e.Constraint,e.ContactConstraint.prototype.constructor=e.ContactConstraint,e.ContactConstraint.prototype.update=function(){var a=this.body_i,b=this.body_j,d=a.velocity,e=a.angularVelocity,f=b.velocity,h=b.angularVelocity,i=[this.temp.t1,this.temp.t2];for(var j in a.contacts)for(var k in b.contacts)if(a.contacts[j].to.id==b.id&&b.contacts[k].to.id==a.id){var l=a.contacts[j].r,m=b.contacts[k].r,o=a.contacts[j].n;n.tangents(i[0],i[1]);var p=d.vadd(e.cross(c.ri)),q=f.vadd(h.cross(c.rj)),r=q.vsub(p),s=h.cross(c.rj).vsub(e.cross(c.ri)),t=f.vsub(d),u=c.rj.cross(h).vsub(c.ri.cross(e));t.vsub(u,t);var v=a.invMass,w=b.invMass,x=a.invInertia.x,y=a.invInertia.y,z=a.invInertia.z,A=b.invInertia.x,B=b.invInertia.y,C=b.invInertia.z,D=this.temp.rixn,E=this.temp.rjxn;c.ri.cross(n,D),c.rj.cross(n,E);var F=n.mult(r.dot(n)),G=D.unit().mult(s.dot(D.unit())),H=E.unit().mult(-s.dot(E.unit())),I=c.ni.mult(g);n.negate(eq.G1),D.negate(eq.G2),n.copy(eq.G3),E.copy(eq.G4),eq.setDefaultMassProps(),I.negate(eq.g1),I.copy(eq.g3),F.negate(eq.W1),F.copy(eq.W3),a.force.copy(eq.f1),a.tau.copy(eq.f2),b.force.copy(eq.f3),b.tau.copy(eq.f4),eq.lambdamin=0,eq.lambdamax="inf"}},e.DistanceConstraint=function(a,b,c){e.Constraint.call(this),this.body_i=a,this.body_j=b,this.distance=Number(c);var d=new e.Equation(a,b instanceof e.RigidBody?b:null);this.equations.push(d)},e.DistanceConstraint.prototype=new e.Constraint,e.DistanceConstraint.prototype.constructor=e.DistanceConstraint,e.DistanceConstraint.prototype.update=function(){var a=this.equations[0],b=this.body_i,c=this.body_j,d=c instanceof e.RigidBody;d?c.position.vsub(b.position,a.G1):b.position.vsub(c,a.G1),a.G1.normalize(),a.G1.isZero()&&a.G1.set(1,0,0),a.G1.negate(a.G3),a.setDefaultMassProps(),a.setDefaultForce(),a.g1.set((d?c.position.x:c.x)-b.position.x-a.G1.x*this.distance,(d?c.position.y:c.y)-b.position.y-a.G1.y*this.distance,(d?c.position.z:c.z)-b.position.z-a.G1.z*this.distance),a.g1.negate(a.g1),a.g1.negate(a.g3)},e.DistanceConstraint.prototype.setMaxForce=function(a){this.equations[0].lambdamax=Math.abs(a),this.equations[0].lambdamin=-this.equations[0].lambdamax},e.Equation=function(a,b){this.G1=new e.Vec3,this.G2=new e.Vec3,this.G3=new e.Vec3,this.G4=new e.Vec3,this.iM1=new e.Vec3,this.iM2=new e.Vec3,this.iM3=new e.Vec3,this.iM4=new e.Vec3,this.g1=new e.Vec3,this.g2=new e.Vec3,this.g3=new e.Vec3,this.g4=new e.Vec3,this.W1=new e.Vec3,this.W2=new e.Vec3,this.W3=new e.Vec3,this.W4=new e.Vec3,this.f1=new e.Vec3,this.f2=new e.Vec3,this.f3=new e.Vec3,this.f4=new e.Vec3,this.lambdamax=1e6,this.lambdamin=-1e6,this.body_i=a,this.body_j=b},e.Equation.prototype.setDefaultMassProps=function(){var a=this.body_i,b=this.body_j;a&&(this.iM1.set(a.invMass,a.invMass,a.invMass),a.invInertia.copy(this.iM2)),b&&(this.iM3.set(b.invMass,b.invMass,b.invMass),b.invInertia.copy(this.iM4))},e.Equation.prototype.setDefaultForce=function(){var a=this.body_i,b=this.body_j;a&&(a.force.copy(this.f1),a.tau.copy(this.f2)),b&&(b.force.copy(this.f3),b.tau.copy(this.f4))},e.PointToPointConstraint=function(a,b,c,d){e.Constraint.call(this),this.body_i=a,this.body_j=c,this.pivot_i=b,this.pivot_j=d;for(var f=0;f<3;f++)this.equations.push(new Equation(a,c))},e.PointToPointConstraint.prototype=new e.Constraint,e.PointToPointConstraint.prototype.constructor=e.PointToPointConstraint,e.PointToPointConstraint.prototype.update=function(){},typeof module!="undefined"?module.exports=e:this.CANNON=e}).apply(this);