/**
 * cannon.js v0.3.9 - A lightweight 3D physics engine for the web
 * 
 * http://github.com/schteppe/cannon.js
 * 
 * Copyright (c) 2012 Stefan Hedman (steffe.se)
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * The Software shall be used for Good, not Evil.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */

var CANNON=CANNON||{};if(!self.Int32Array){self.Int32Array=Array;self.Float32Array=Array;}
CANNON.Broadphase=function(){this.world=null;};CANNON.Broadphase.prototype.constructor=CANNON.BroadPhase;CANNON.Broadphase.prototype.collisionPairs=function(){throw"collisionPairs not implemented for this BroadPhase class!";};CANNON.NaiveBroadphase=function(){};CANNON.NaiveBroadphase.prototype=new CANNON.Broadphase();CANNON.NaiveBroadphase.prototype.constructor=CANNON.NaiveBroadphase;CANNON.NaiveBroadphase.prototype.collisionPairs=function(){var world=this.world;var pairs1=[];var pairs2=[];var n=world.numObjects();var SPHERE=CANNON.Shape.types.SPHERE;var PLANE=CANNON.Shape.types.PLANE;var BOX=CANNON.Shape.types.BOX;var COMPOUND=CANNON.Shape.types.COMPOUND;var x=world.x;var y=world.y;var z=world.z;var type=world.type;var body=world.body;for(var i=0;i<n;i++){for(var j=0;j<i;j++){if((type[i]==BOX&&type[j]==BOX)||(type[i]==BOX&&type[j]==COMPOUND)||(type[i]==BOX&&type[j]==SPHERE)||(type[i]==SPHERE&&type[j]==BOX)||(type[i]==SPHERE&&type[j]==SPHERE)||(type[i]==SPHERE&&type[j]==COMPOUND)||(type[i]==COMPOUND&&type[j]==COMPOUND)||(type[i]==COMPOUND&&type[j]==SPHERE)||(type[i]==COMPOUND&&type[j]==BOX)){var r=new CANNON.Vec3(x[j]-x[i],y[j]-y[i],z[j]-z[i]);var boundingRadius1=body[i]._shape.boundingSphereRadius();var boundingRadius2=body[j]._shape.boundingSphereRadius();if(r.norm()<(boundingRadius1+boundingRadius2)){pairs1.push(i);pairs2.push(j);}}else if((type[i]==SPHERE&&type[j]==PLANE)||(type[i]==PLANE&&type[j]==SPHERE)||(type[i]==BOX&&type[j]==PLANE)||(type[i]==PLANE&&type[j]==BOX)||(type[i]==COMPOUND&&type[j]==PLANE)||(type[i]==PLANE&&type[j]==COMPOUND)){var pi=type[i]==PLANE?i:j;var oi=type[i]!=PLANE?i:j;var r=new CANNON.Vec3(x[oi]-x[pi],y[oi]-y[pi],z[oi]-z[pi]);var normal=body[pi]._shape.normal;var q=r.dot(normal)-body[oi]._shape.boundingSphereRadius();if(q<0.0){pairs1.push(i);pairs2.push(j);}}}}
return[pairs1,pairs2];};CANNON.Mat3=function(elements){if(elements)
this.elements=new Float32Array(elements);else
this.elements=new Float32Array(9);};CANNON.Mat3.prototype.identity=function(){this.elements[0]=1;this.elements[1]=0;this.elements[2]=0;this.elements[3]=0;this.elements[4]=1;this.elements[5]=0;this.elements[6]=0;this.elements[7]=0;this.elements[8]=1;};CANNON.Mat3.prototype.vmult=function(v,target){if(target===undefined)
target=new CANNON.Vec3();var vec=[v.x,v.y,v.z];var targetvec=[0,0,0];for(var i=0;i<3;i++)
for(var j=0;j<3;j++)
targetvec[i]+=this.elements[i+3*j]*vec[i];target.x=targetvec[0];target.y=targetvec[1];target.z=targetvec[2];return target;};CANNON.Mat3.prototype.smult=function(s){for(var i=0;i<this.elements.length;i++)
this.elements[i]*=s;};CANNON.Mat3.prototype.mmult=function(m){var r=new CANNON.Mat3();for(var i=0;i<3;i++)
for(var j=0;j<3;j++){var sum=0.0;for(var k=0;k<3;k++)
sum+=this.elements[i+k]*m.elements[k+j*3];r.elements[i+j*3]=sum;}
return r;};CANNON.Mat3.prototype.solve=function(b,target){target=target||new CANNON.Vec3();var nr=3;var nc=4;var eqns=new Float32Array(nr*nc);for(var i=0;i<3;i++)
for(var j=0;j<3;j++)
eqns[i+nc*j]=this.elements[i+3*j];eqns[3+4*0]=b.x;eqns[3+4*1]=b.y;eqns[3+4*2]=b.z;var n=3;var k=n;var i;var np;var kp=4;var p;var els;do{i=k-n;if(eqns[i+nc*i]==0){for(j=i+1;j<k;j++){if(eqns[i+nc*j]!=0){els=[];np=kp;do{p=kp-np;els.push(eqns[p+nc*i]+eqns[p+nc*j]);}while(--np);eqns[i+nc*0]=els[0];eqns[i+nc*1]=els[1];eqns[i+nc*2]=els[2];break;}}}
if(eqns[i+nc*i]!=0){for(j=i+1;j<k;j++){var multiplier=eqns[i+nc*j]/eqns[i+nc*i];els=[];np=kp;do{p=kp-np;els.push(p<=i?0:eqns[p+nc*j]-eqns[p+nc*i]*multiplier);}while(--np);eqns[j+nc*0]=els[0];eqns[j+nc*1]=els[1];eqns[j+nc*2]=els[2];}}}while(--n);target.z=eqns[2*nc+3]/eqns[2*nc+2];target.y=(eqns[1*nc+3]-eqns[1*nc+2]*target.z)/eqns[1*nc+1];target.x=(eqns[0*nc+3]-eqns[0*nc+2]*target.z-eqns[0*nc+1]*target.y)/eqns[0*nc+0];if(isNaN(target.x)||isNaN(target.y)||isNaN(target.z)||target.x==Infinity||target.y==Infinity||target.z==Infinity)
throw"Could not solve equation! Got x=["+target.toString()+"], b=["+b.toString()+"], A=["+this.toString()+"]";return target;};CANNON.Mat3.prototype.e=function(i,j,value){if(value==undefined)
return this.elements[i+3*j];else{this.elements[i+3*j]=value;}};CANNON.Mat3.prototype.copy=function(target){target=target||new Mat3();for(var i=0;i<this.elements.length;i++)
target.elements[i]=this.elements[i];return target;};CANNON.Mat3.prototype.toString=function(){var r="";var sep=",";for(var i=0;i<9;i++)
r+=this.elements[i]+sep;return r;};CANNON.Vec3=function(x,y,z){this.x=x||0.0;this.y=y||0.0;this.z=z||0.0;};CANNON.Vec3.prototype.cross=function(v,target){if(target==undefined)
target=new CANNON.Vec3();var A=[this.x,this.y,this.z];var B=[v.x,v.y,v.z];target.x=(A[1]*B[2])-(A[2]*B[1]);target.y=(A[2]*B[0])-(A[0]*B[2]);target.z=(A[0]*B[1])-(A[1]*B[0]);return target;};CANNON.Vec3.prototype.set=function(x,y,z){this.x=x;this.y=y;this.z=z;};CANNON.Vec3.prototype.vadd=function(v,target){if(target){target.x+=v.x;target.y+=v.y;target.z+=v.z;}else{return new CANNON.Vec3(this.x+v.x,this.y+v.y,this.z+v.z);}};CANNON.Vec3.prototype.vsub=function(v,target){if(target){target.x=this.x-v.x;target.y=this.y-v.y;target.z=this.z-v.z;}else{return new CANNON.Vec3(this.x-v.x,this.y-v.y,this.z-v.z);}};CANNON.Vec3.prototype.crossmat=function(){return new CANNON.Mat3([0,-this.z,this.y,this.z,0,-this.x,-this.y,this.x,0]);};CANNON.Vec3.prototype.normalize=function(){var n=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z);if(n>0.0){this.x/=n;this.y/=n;this.z/=n;}else{this.x=0;this.y=0;this.z=0;}
return n;};CANNON.Vec3.prototype.norm=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z);};CANNON.Vec3.prototype.mult=function(scalar,saveinme){if(!saveinme)
saveinme=new CANNON.Vec3();saveinme.x=scalar*this.x;saveinme.y=scalar*this.y;saveinme.z=scalar*this.z;return saveinme;};CANNON.Vec3.prototype.dot=function(v){return(this.x*v.x+this.y*v.y+this.z*v.z);};CANNON.Vec3.prototype.negate=function(target){target=target||new CANNON.Vec3();target.x=-this.x;target.y=-this.y;target.z=-this.z;return target;};CANNON.Vec3.prototype.tangents=function(t1,t2){var norm=this.norm();var n=new CANNON.Vec3(this.x/norm,this.y/norm,this.z/norm);if(n.x<0.9)
n.cross(new CANNON.Vec3(1,0,0),t1);else
n.cross(new CANNON.Vec3(0,1,0),t1);n.cross(t1,t2);};CANNON.Vec3.prototype.toString=function(){return this.x+","+this.y+","+this.z;};CANNON.Vec3.prototype.copy=function(target){target=target||new CANNON.Vec3();target.x=this.x;target.y=this.y;target.z=this.z;return target;};CANNON.Quaternion=function(x,y,z,w){this.x=x!=undefined?x:1;this.y=y!=undefined?y:0;this.z=z!=undefined?z:0;this.w=w!=undefined?w:0;};CANNON.Quaternion.prototype.toString=function(){return this.x+","+this.y+","+this.z+","+this.w;};CANNON.Quaternion.prototype.mult=function(q,target){if(target==undefined)
target=new CANNON.Quaternion();var va=new CANNON.Vec3(this.x,this.y,this.z);var vb=new CANNON.Vec3(q.x,q.y,q.z);target.w=this.w*q.w-va.dot(vb);vaxvb=va.cross(vb);target.x=this.w*vb.x+q.w*va.x+vaxvb.x;target.y=this.w*vb.y+q.w*va.y+vaxvb.y;target.z=this.w*vb.z+q.w*va.z+vaxvb.z;return target;};CANNON.Quaternion.prototype.inverse=function(target){if(target==undefined)
target=new CANNON.Quaternion();target.x=-this.x;target.y=-this.y;target.z=-this.z;target.w=this.w;return target;};CANNON.Quaternion.prototype.normalize=function(){var l=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);if(l===0){this.x=0;this.y=0;this.z=0;this.w=0;}else{l=1/l;this.x*=l;this.y*=l;this.z*=l;this.w*=l;}};CANNON.Quaternion.prototype.vmult=function(v,target){target=target||new CANNON.Vec3();var x=v.x,y=v.y,z=v.z;var qx=this.x,qy=this.y,qz=this.z,qw=this.w;var ix=qw*x+qy*z-qz*y,iy=qw*y+qz*x-qx*z,iz=qw*z+qx*y-qy*x,iw=-qx*x-qy*y-qz*z;target.x=ix*qw+iw*-qx+iy*-qz-iz*-qy;target.y=iy*qw+iw*-qy+iz*-qx-ix*-qz;target.z=iz*qw+iw*-qz+ix*-qy-iy*-qx;return target;};CANNON.Shape=function(){this.type=0;};CANNON.Shape.prototype.constructor=CANNON.Shape;CANNON.Shape.prototype.boundingSphereRadius=function(){throw"boundingSphereRadius() not implemented for shape type "+this.type;};CANNON.Shape.prototype.volume=function(){throw"volume() not implemented for shape type "+this.type;};CANNON.Shape.prototype.calculateLocalInertia=function(mass,target){throw"calculateLocalInertia() not implemented for shape type "+this.type;};CANNON.Shape.prototype.calculateTransformedInertia=function(mass,quat,target){if(target==undefined)
target=new CANNON.Vec3();quat.normalize();var localInertia=this.calculateLocalInertia(mass);var worldInertia=quat.vmult(localInertia);target.x=Math.abs(worldInertia.x);target.y=Math.abs(worldInertia.y);target.z=Math.abs(worldInertia.z);return target;};CANNON.Shape.types={SPHERE:1,PLANE:2,BOX:4,COMPOUND:8};CANNON.RigidBody=function(mass,shape,material){this._position=new CANNON.Vec3();this._velocity=new CANNON.Vec3();this._force=new CANNON.Vec3();this._tau=new CANNON.Vec3();this._quaternion=new CANNON.Quaternion(1,0,0,0);this._rotvelo=new CANNON.Vec3();this._mass=mass;this._shape=shape;this._inertia=shape.calculateLocalInertia(mass);this._material=material;this._linearDamping=0.01;this._angularDamping=0.01;this._world=null;this._id=-1;};CANNON.RigidBody.prototype.linearDamping=function(d){if(d==undefined)
return this._linearDamping;else{d=Number(d);if(!isNaN(d)&&d>=0.0&&d<=1.0)
this._linearDamping=d;else
throw"Damping must be a number between 0 and 1";}};CANNON.RigidBody.prototype.angularDamping=function(d){if(d==undefined)
return this._angularDamping;else{d=Number(d);if(!isNaN(d)&&d>=0.0&&d<=1.0)
this._angularDamping=d;else
throw"Damping must be a number between 0 and 1";}};CANNON.RigidBody.prototype.mass=function(m){if(m==undefined){if(this._id!=-1)
return this._world.mass[this._id];else
return this._mass;}else{if(this._id!=-1){this._world.mass[this._id]=m;this._world.invm[this._id]=1.0/m;}else
this._mass=m;}};CANNON.RigidBody.prototype.shape=function(s){if(s==undefined){return this._shape;}else{this._shape=s;if(this._id!=-1){this._world.type[this._id]=shape.type;}}};CANNON.RigidBody.prototype.setPosition=function(x,y,z){if(this._id!=-1){this._world.x[this._id]=x;this._world.y[this._id]=y;this._world.z[this._id]=z;this._world.clearCollisionState(this);}else{this._position.x=x;this._position.y=y;this._position.z=z;}};CANNON.RigidBody.prototype.getPosition=function(target){target=target||new CANNON.Vec3();if(this._id!=-1){target.x=this._world.x[this._id];target.y=this._world.y[this._id];target.z=this._world.z[this._id];}else{target.x=this._position.x;target.y=this._position.y;target.z=this._position.z;}
return target;};CANNON.RigidBody.prototype.setOrientation=function(x,y,z,w){var q=new CANNON.Quaternion(x,y,z,w);q.normalize();if(this._id!=-1){this._world.qx[this._id]=q.x;this._world.qy[this._id]=q.y;this._world.qz[this._id]=q.z;this._world.qw[this._id]=q.w;}else{this._quaternion.x=q.x;this._quaternion.y=q.y;this._quaternion.z=q.z;this._quaternion.w=q.w;}};CANNON.RigidBody.prototype.getOrientation=function(target){target=target||new CANNON.Quaternion();if(this._id!=-1){target.x=this._world.qx[this._id];target.y=this._world.qy[this._id];target.z=this._world.qz[this._id];target.w=this._world.qw[this._id];}else{target.x=this._quaternion.x;target.y=this._quaternion.y;target.z=this._quaternion.z;target.w=this._quaternion.w;}
target.normalize();return target;};CANNON.RigidBody.prototype.setVelocity=function(x,y,z){if(this._id!=-1){this._world.vx[this._id]=x;this._world.vy[this._id]=y;this._world.vz[this._id]=z;}else{this._velocity.x=x;this._velocity.y=y;this._velocity.z=z;}};CANNON.RigidBody.prototype.getVelocity=function(target){target=target||new CANNON.Vec3();if(this._id!=-1){target.x=this._world.x[this._id];target.y=this._world.y[this._id];target.z=this._world.z[this._id];}else{target.x=this._velocity.x;target.y=this._velocity.y;target.z=this._velocity.z;}
return target;};CANNON.RigidBody.prototype.setAngularVelocity=function(x,y,z){if(this._id!=-1){this._world.wx[this._id]=x;this._world.wy[this._id]=y;this._world.wz[this._id]=z;}else{this._rotvelo.x=x;this._rotvelo.y=y;this._rotvelo.z=z;}};CANNON.RigidBody.prototype.getAngularvelocity=function(target){target=target||new CANNON.Vec3();if(this._id!=-1){target.x=this._world.wx[this._id];target.y=this._world.wy[this._id];target.z=this._world.wz[this._id];}else{target.x=this._rotvelo.x;target.y=this._rotvelo.y;target.z=this._rotvelo.z;}
return target;};CANNON.RigidBody.prototype.setForce=function(x,y,z){if(this._id!=-1){this._world.fx[this._id]=x;this._world.fy[this._id]=y;this._world.fz[this._id]=z;}else{this._force.x=x;this._force.y=y;this._force.z=z;}};CANNON.RigidBody.prototype.getForce=function(target){target=target||new CANNON.Vec3();if(this._id!=-1){target.x=this._world.fx[this._id];target.y=this._world.fy[this._id];target.z=this._world.fz[this._id];}else{target.x=this._force.x;target.y=this._force.y;target.z=this._force.z;}
return target;};CANNON.RigidBody.prototype.setTorque=function(x,y,z){if(this._id!=-1){this._world.taux[this._id]=x;this._world.tauy[this._id]=y;this._world.tauz[this._id]=z;}else{this._tau.x=x;this._tau.y=y;this._tau.z=z;}};CANNON.RigidBody.prototype.getTorque=function(target){target=target||new CANNON.Vec3();if(this._id!=-1){target.x=this._world.taux[this._id];target.y=this._world.tauy[this._id];target.z=this._world.tauz[this._id];}else{target.x=this._torque.x;target.y=this._torque.y;target.z=this._torque.z;}
return target;};CANNON.Sphere=function(radius){CANNON.Shape.call(this);this.radius=radius!=undefined?Number(radius):1.0;this.type=CANNON.Shape.types.SPHERE;};CANNON.Sphere.prototype=new CANNON.Shape();CANNON.Sphere.prototype.constructor=CANNON.Sphere;CANNON.Sphere.prototype.calculateLocalInertia=function(mass,target){target=target||new CANNON.Vec3();var I=2.0*mass*this.radius*this.radius/5.0;target.x=I;target.y=I;target.z=I;return target;};CANNON.Sphere.prototype.volume=function(){return 4.0*Math.PI*this.radius/3.0;};CANNON.Sphere.prototype.boundingSphereRadius=function(){return this.radius;};CANNON.Box=function(halfExtents){CANNON.Shape.call(this);this.halfExtents=halfExtents;this.type=CANNON.Shape.types.BOX;};CANNON.Box.prototype=new CANNON.Shape();CANNON.Box.prototype.constructor=CANNON.Box;CANNON.Box.prototype.calculateLocalInertia=function(mass,target){target=target||new CANNON.Vec3();target.x=1.0/12.0*mass*(2*this.halfExtents.y*2*this.halfExtents.y+2*this.halfExtents.z*2*this.halfExtents.z);target.y=1.0/12.0*mass*(2*this.halfExtents.x*2*this.halfExtents.x+2*this.halfExtents.z*2*this.halfExtents.z);target.z=1.0/12.0*mass*(2*this.halfExtents.y*2*this.halfExtents.y+2*this.halfExtents.x*2*this.halfExtents.x);return target;};CANNON.Box.prototype.getCorners=function(quat){var corners=[];var ex=this.halfExtents;corners.push(new CANNON.Vec3(ex.x,ex.y,ex.z));corners.push(new CANNON.Vec3(-ex.x,ex.y,ex.z));corners.push(new CANNON.Vec3(-ex.x,-ex.y,ex.z));corners.push(new CANNON.Vec3(-ex.x,-ex.y,-ex.z));corners.push(new CANNON.Vec3(ex.x,-ex.y,-ex.z));corners.push(new CANNON.Vec3(ex.x,ex.y,-ex.z));corners.push(new CANNON.Vec3(-ex.x,ex.y,-ex.z));corners.push(new CANNON.Vec3(ex.x,-ex.y,ex.z));for(var i=0;quat!=undefined&&i<corners.length;i++)
quat.vmult(corners[i],corners[i]);return corners;};CANNON.Box.prototype.getSideNormals=function(includeNegative,quat){var sides=[];var ex=this.halfExtents;sides.push(new CANNON.Vec3(ex.x,0,0));sides.push(new CANNON.Vec3(0,ex.y,0));sides.push(new CANNON.Vec3(0,0,ex.z));if(includeNegative!=undefined&&includeNegative){sides.push(new CANNON.Vec3(-ex.x,0,0));sides.push(new CANNON.Vec3(0,-ex.y,0));sides.push(new CANNON.Vec3(0,0,-ex.z));}
for(var i=0;quat!=undefined&&i<sides.length;i++)
quat.vmult(sides[i],sides[i]);return sides;};CANNON.Box.prototype.volume=function(){return 2.0*this.halfExtents.x*this.halfExtents.y*this.halfExtents.z;};CANNON.Box.prototype.boundingSphereRadius=function(){return this.halfExtents.norm();};CANNON.Plane=function(normal){CANNON.Shape.call(this);normal.normalize();this.normal=normal;this.type=CANNON.Shape.types.PLANE;};CANNON.Plane.prototype=new CANNON.Shape();CANNON.Plane.prototype.constructor=CANNON.Plane;CANNON.Plane.prototype.calculateLocalInertia=function(mass,target){target=target||new CANNON.Vec3();return target;};CANNON.Plane.prototype.volume=function(){return Infinity;};CANNON.Compound=function(){CANNON.Shape.call(this);this.type=CANNON.Shape.types.COMPOUND;this.childShapes=[];this.childOffsets=[];this.childOrientations=[];};CANNON.Compound.prototype=new CANNON.Shape();CANNON.Compound.prototype.constructor=CANNON.Compound;CANNON.Compound.prototype.addChild=function(shape,offset,orientation){offset=offset||new CANNON.Vec3(0,0,0);orientation=orientation||new CANNON.Quaternion(1,0,0,0);this.childShapes.push(shape);this.childOffsets.push(offset);this.childOrientations.push(orientation);};CANNON.Compound.prototype.volume=function(){var r=0.0;for(var i=0;i<this.childShapes.length;i++)
r+=this.childShapes[i].volume();return r;};CANNON.Compound.prototype.calculateLocalInertia=function(mass,target){target=target||new CANNON.Vec3();var V=this.volume();for(var i=0;i<this.childShapes.length;i++){var b=this.childShapes[i];var o=this.childOffsets[i];var q=this.childOrientations[i];var m=b.volume()/V*mass;var inertia=b.calculateTransformedInertia(m,q);target.vadd(inertia,target);var mr2=new CANNON.Vec3(m*o.x*o.x,m*o.y*o.y,m*o.z*o.z);target.vadd(mr2,target);}
return target;};CANNON.Compound.prototype.boundingSphereRadius=function(){var r=0.0;for(var i=0;i<this.childShapes.length;i++){var candidate=this.childOffsets[i].norm()+this.childShapes[i].boundingSphereRadius();if(r<candidate)
r=candidate;}
return r;};CANNON.Solver=function(a,b,eps,k,d,iter,h){this.iter=iter||10;this.h=h||1.0/60.0;this.a=a;this.b=b;this.eps=eps;this.k=k;this.d=d;this.reset(0);this.debug=false;if(this.debug)
console.log("a:",a,"b",b,"eps",eps,"k",k,"d",d);};CANNON.Solver.prototype.reset=function(numbodies){this.G=[];this.MinvTrace=[];this.Fext=[];this.q=[];this.qdot=[];this.n=0;this.upper=[];this.lower=[];this.hasupper=[];this.haslower=[];this.i=[];this.j=[];if(numbodies&&(this.vxlambda==undefined||this.vxlambda.length!=numbodies)){this.vxlambda=new Float32Array(numbodies);this.vylambda=new Float32Array(numbodies);this.vzlambda=new Float32Array(numbodies);this.wxlambda=new Float32Array(numbodies);this.wylambda=new Float32Array(numbodies);this.wzlambda=new Float32Array(numbodies);}else if(this.vxlambda!=undefined&&this.vxlambda.length==numbodies){for(var i=0;i<this.vxlambda.length;i++){this.vxlambda[i]=0.0;this.vylambda[i]=0.0;this.vzlambda[i]=0.0;this.wxlambda[i]=0.0;this.wylambda[i]=0.0;this.wzlambda[i]=0.0;}}};CANNON.Solver.prototype.addConstraint=function(G,MinvTrace,q,qdot,Fext,lower,upper,body_i,body_j){if(this.debug){console.log("Adding constraint ",this.n);console.log("G:",G);console.log("q:",q);console.log("qdot:",qdot);console.log("Fext:",Fext);}
for(var i=0;i<12;i++){this.q.push(q[i]);this.qdot.push(qdot[i]);this.MinvTrace.push(MinvTrace[i]);this.G.push(G[i]);this.Fext.push(Fext[i]);this.upper.push(upper);this.hasupper.push(!isNaN(upper));this.lower.push(lower);this.haslower.push(!isNaN(lower));}
this.i.push(body_i);this.j.push(body_j);this.n+=1;return this.n-1;};CANNON.Solver.prototype.addNonPenetrationConstraint=function(i,j,xi,xj,ni,ri,rj,iMi,iMj,iIi,iIj,vi,vj,wi,wj,fi,fj,taui,tauj){var rxn=ri.cross(ni);var u=vj.vsub(vi);var qvec=xj.vadd(rj).vsub(xi.vadd(ri));var q=qvec.dot(ni);if(q<0.0){if(this.debug){console.log("i:",i,"j",j,"xi",xi.toString(),"xj",xj.toString());console.log("ni",ni.toString(),"ri",ri.toString(),"rj",rj.toString());console.log("iMi",iMi.toString(),"iMj",iMj.toString(),"iIi",iIi.toString(),"iIj",iIj.toString(),"vi",vi.toString(),"vj",vj.toString(),"wi",wi.toString(),"wj",wj.toString(),"fi",fi.toString(),"fj",fj.toString(),"taui",taui.toString(),"tauj",tauj.toString());}
this.addConstraint([-ni.x,-ni.y,-ni.z,-rxn.x,-rxn.y,-rxn.z,ni.x,ni.y,ni.z,rxn.x,rxn.y,rxn.z],[iMi.x,iMi.y,iMi.z,iIi.z,iIi.y,iIi.z,iMj.x,iMj.y,iMj.z,iIj.z,iIj.y,iIj.z],[-qvec.x,-qvec.y,-qvec.z,0,0,0,qvec.x,qvec.y,qvec.z,0,0,0],[-u.x,-u.y,-u.z,0,0,0,u.x,u.y,u.z,0,0,0],[fi.x,fi.y,fi.z,taui.x,taui.y,taui.z,fj.x,fj.y,fj.z,tauj.x,tauj.y,tauj.z],0,'inf',i,j);}};CANNON.Solver.prototype.solve=function(){this.i=new Int16Array(this.i);var n=this.n;var lambda=new Float32Array(n);var dlambda=new Float32Array(n);var ulambda=new Float32Array(12*n);var B=new Float32Array(n);var c=new Float32Array(n);var precomp=new Int16Array(n);var G=new Float32Array(this.G);for(var k=0;k<this.iter;k++){for(var l=0;l<n;l++){var body_i=this.i[l];var body_j=this.j[l];var l12=12*l;if(!precomp[l]){var G_Minv_Gt=0.0;var Gq=0.0;var GW=0.0;var GMinvf=0.0;for(var i=0;i<12;i++){var addi=l12+i;G_Minv_Gt+=G[addi]*this.MinvTrace[addi]*G[addi];Gq+=G[addi]*this.q[addi];GW+=G[addi]*this.qdot[addi];GMinvf+=G[addi]*this.MinvTrace[addi]*this.Fext[addi];}
c[l]=1.0/ (G_Minv_Gt + this.eps); //1.0/(G*Minv*Gt+eps)
B[l]=(-this.a*Gq
-this.b*GW
-this.h*GMinvf);precomp[l]=1;if(this.debug){console.log("G_Minv_Gt["+l+"]:",G_Minv_Gt);console.log("Gq["+l+"]:",Gq);console.log("GW["+l+"]:",GW);console.log("GMinvf["+l+"]:",GMinvf);}}
var Gulambda=0.0;Gulambda+=G[0+l12]*this.vxlambda[body_i];Gulambda+=G[1+l12]*this.vylambda[body_i];Gulambda+=G[2+l12]*this.vzlambda[body_i];Gulambda+=G[3+l12]*this.wxlambda[body_i];Gulambda+=G[4+l12]*this.wylambda[body_i];Gulambda+=G[5+l12]*this.wzlambda[body_i];Gulambda+=G[6+l12]*this.vxlambda[body_j];Gulambda+=G[7+l12]*this.vylambda[body_j];Gulambda+=G[8+l12]*this.vzlambda[body_j];Gulambda+=G[9+l12]*this.wxlambda[body_j];Gulambda+=G[10+l12]*this.wylambda[body_j];Gulambda+=G[11+l12]*this.wzlambda[body_j];dlambda[l]=c[l]*(B[l]-Gulambda-this.eps*lambda[l]);if(this.debug)
console.log("dlambda["+l+"]=",dlambda[l]);lambda[l]=lambda[l]+dlambda[l];if(this.haslower[l]&&lambda[l]<this.lower[l]){if(this.debug)
console.log("hit lower bound for constraint "+l+", truncating "+lambda[l]+" to "+this.lower[l]);lambda[l]=this.lower[l];dlambda[l]=this.lower[l]-lambda[l];}
if(this.hasupper&&lambda[l]>this.upper[l]){if(this.debug)
console.log("hit upper bound for constraint "+l+", truncating "+lambda[l]+" to "+this.upper[l]);lambda[l]=this.upper[l];dlambda[l]=this.upper[l]-lambda[l];}
this.vxlambda[body_i]+=dlambda[l]*this.MinvTrace[l12+0]*G[l12+0];this.vylambda[body_i]+=dlambda[l]*this.MinvTrace[l12+1]*G[l12+1];this.vzlambda[body_i]+=dlambda[l]*this.MinvTrace[l12+2]*G[l12+2];this.wxlambda[body_i]+=dlambda[l]*this.MinvTrace[l12+3]*G[l12+3];this.wylambda[body_i]+=dlambda[l]*this.MinvTrace[l12+4]*G[l12+4];this.wzlambda[body_i]+=dlambda[l]*this.MinvTrace[l12+5]*G[l12+5];this.vxlambda[body_j]+=dlambda[l]*this.MinvTrace[l12+6]*G[l12+6];this.vylambda[body_j]+=dlambda[l]*this.MinvTrace[l12+7]*G[l12+7];this.vzlambda[body_j]+=dlambda[l]*this.MinvTrace[l12+8]*G[l12+8];this.wxlambda[body_j]+=dlambda[l]*this.MinvTrace[l12+9]*G[l12+9];this.wylambda[body_j]+=dlambda[l]*this.MinvTrace[l12+10]*G[l12+10];this.wzlambda[body_j]+=dlambda[l]*this.MinvTrace[l12+11]*G[l12+11];}}
if(this.debug)
for(var l=0;l<n;l++)
console.log("ulambda["+l+"]=",ulambda[l*12+0],ulambda[l*12+1],ulambda[l*12+2],ulambda[l*12+3],ulambda[l*12+4],ulambda[l*12+5],ulambda[l*12+6],ulambda[l*12+7],ulambda[l*12+8],ulambda[l*12+9],ulambda[l*12+10],ulambda[l*12+11]);this.result=ulambda;};CANNON.Material=function(name){this.name=name;this._id=-1;};CANNON.ContactMaterial=function(m1,m2,static_friction,kinetic_friction,restitution){this._id=-1;this.materials=[m1,m2];this.static_friction=static_friction!=undefined?Number(static_friction):0.3;this.kinetic_friction=kinetic_friction!=undefined?Number(kinetic_friction):0.3;this.restitution=restitution!=undefined?Number(restitution):0.3;};CANNON.World=function(){this.paused=false;this.time=0.0;this.stepnumber=0;this.spook_k=3000.0;this.spook_d=3.0;this.default_dt=1/60;this.last_dt=this.default_dt;var th=this;this.spook_a=function(h){return 4.0/(h*(1+4*th.spook_d));};this.spook_b=(4.0*this.spook_d)/(1+4*this.spook_d);this.spook_eps=function(h){return 4.0/(h*h*th.spook_k*(1+4*th.spook_d));};this.solver=new CANNON.Solver(this.spook_a(1.0/60.0),this.spook_b,this.spook_eps(1.0/60.0),this.spook_k,this.spook_d,5,1.0/60.0);this._materials=[];this._material_contactmaterial_refs=[];this._contactmaterials=[];this._contact_material1=[];this._contact_material2=[];this._contact_friction_k=[];this._contact_friction_s=[];this._contact_restitution=[];};CANNON.World.prototype.togglepause=function(){this.paused=!this.paused;};CANNON.World.prototype._getContactMaterialId=function(bi,bj){if(this.material[bi]>=0&&this.material[bj]>=0){var i=this._materials[this.material[bi]]._id;var j=this._materials[this.material[bj]]._id;if(i<j){var temp=i;i=j;j=temp;}
return this._material_contactmaterial_refs[i+j*this._materials.length];}
return-1;};CANNON.World.prototype._addImpulse=function(i,j,ri,rj,ui,ni,e,mu){var ri_star=ri.crossmat();var rj_star=rj.crossmat();var ii=this.inertiax[i]>0?1.0/this.inertiax[i]:0.0;var Iinv_i=new CANNON.Mat3([ii,0,0,0,ii,0,0,0,ii]);ii=this.inertiax[j]>0?1.0/this.inertiax[j]:0.0;var Iinv_j=new CANNON.Mat3([ii,0,0,0,ii,0,0,0,ii]);var im=this.invm[i]+this.invm[j];var K=new CANNON.Mat3([im,0,0,0,im,0,0,0,im]);var rIr_i=ri_star.mmult(Iinv_i.mmult(ri_star));var rIr_j=rj_star.mmult(Iinv_j.mmult(rj_star));var v_f=ni.mult(-e*ui.dot(ni));var J=K.solve(v_f.vsub(ui));var mu=0.0;if(mu>0){var J_n=ni.mult(J.dot(ni));var J_t=J.vsub(J_n);if(J_t.norm()>J_n.mult(mu).norm()){var v_tang=ui.vsub(ni.mult(ui.dot(ni)));var tangent=v_tang.mult(1.0/(v_tang.norm()+0.0001));var impulse=-(1+e)*(ui.dot(ni))/(ni.dot(K.vmult((ni.vsub(tangent.mult(mu))))));J=ni.mult(impulse).vsub(tangent.mult(mu*impulse));}}
var imi=this.invm[i];var imj=this.invm[j];this.vx[i]+=J.x*imi-(this.vx[j]-ui.x);this.vy[i]+=J.y*imi-(this.vy[j]-ui.y);this.vz[i]+=J.z*imi-(this.vz[j]-ui.z);this.vx[j]-=J.x*imj+(this.vx[i]+ui.x);this.vy[j]-=J.y*imj+(this.vy[i]+ui.y);this.vz[j]-=J.z*imj+(this.vz[i]+ui.z);var cr=ri.cross(J);var wadd=cr.mult(1.0/this.inertiax[i]);};CANNON.World.prototype.numObjects=function(){return this.x?this.x.length:0;};CANNON.World.prototype.clearCollisionState=function(body){var n=this.numObjects();var i=body._id;for(var idx=0;idx<n;idx++){var j=idx;if(i>j)this.collision_matrix[j+i*n]=0;elsethis.collision_matrix[i+j*n]=0;}};CANNON.World.prototype.add=function(body){if(!body)
return;var n=this.numObjects();old_x=this.x;old_y=this.y;old_z=this.z;old_vx=this.vx;old_vy=this.vy;old_vz=this.vz;old_fx=this.fx;old_fy=this.fy;old_fz=this.fz;old_taux=this.taux;old_tauy=this.tauy;old_tauz=this.tauz;old_wx=this.wx;old_wy=this.wy;old_wz=this.wz;old_qx=this.qx;old_qy=this.qy;old_qz=this.qz;old_qw=this.qw;old_type=this.type;old_body=this.body;old_fixed=this.fixed;old_invm=this.invm;old_mass=this.mass;old_material=this.material;old_inertiax=this.inertiax;old_inertiay=this.inertiay;old_inertiaz=this.inertiaz;old_iinertiax=this.iinertiax;old_iinertiay=this.iinertiay;old_iinertiaz=this.iinertiaz;this.x=new Float32Array(n+1);this.y=new Float32Array(n+1);this.z=new Float32Array(n+1);this.vx=new Float32Array(n+1);this.vy=new Float32Array(n+1);this.vz=new Float32Array(n+1);this.fx=new Float32Array(n+1);this.fy=new Float32Array(n+1);this.fz=new Float32Array(n+1);this.taux=new Float32Array(n+1);this.tauy=new Float32Array(n+1);this.tauz=new Float32Array(n+1);this.wx=new Float32Array(n+1);this.wy=new Float32Array(n+1);this.wz=new Float32Array(n+1);this.qx=new Float32Array(n+1);this.qy=new Float32Array(n+1);this.qz=new Float32Array(n+1);this.qw=new Float32Array(n+1);this.type=new Int16Array(n+1);this.body=[];this.fixed=new Int16Array(n+1);this.mass=new Float32Array(n+1);this.material=new Int16Array(n+1);this.inertiax=new Float32Array(n+1);this.inertiay=new Float32Array(n+1);this.inertiaz=new Float32Array(n+1);this.iinertiax=new Float32Array(n+1);this.iinertiay=new Float32Array(n+1);this.iinertiaz=new Float32Array(n+1);this.invm=new Float32Array(n+1);for(var i=0;i<n;i++){this.x[i]=old_x[i];this.y[i]=old_y[i];this.z[i]=old_z[i];this.vx[i]=old_vx[i];this.vy[i]=old_vy[i];this.vz[i]=old_vz[i];this.fx[i]=old_fx[i];this.fy[i]=old_fy[i];this.fz[i]=old_fz[i];this.taux[i]=old_taux[i];this.tauy[i]=old_tauy[i];this.tauz[i]=old_tauz[i];this.wx[i]=old_wx[i];this.wy[i]=old_wy[i];this.wz[i]=old_wz[i];this.qx[i]=old_qx[i];this.qy[i]=old_qy[i];this.qz[i]=old_qz[i];this.qw[i]=old_qw[i];this.type[i]=old_type[i];this.body[i]=old_body[i];this.fixed[i]=old_fixed[i];this.invm[i]=old_invm[i];this.mass[i]=old_mass[i];this.material[i]=old_material[i];this.inertiax[i]=old_inertiax[i];this.inertiay[i]=old_inertiay[i];this.inertiaz[i]=old_inertiaz[i];this.iinertiax[i]=old_iinertiax[i];this.iinertiay[i]=old_iinertiay[i];this.iinertiaz[i]=old_iinertiaz[i];}
this.x[n]=body._position.x;this.y[n]=body._position.y;this.z[n]=body._position.z;this.vx[n]=body._velocity.x;this.vy[n]=body._velocity.y;this.vz[n]=body._velocity.z;this.fx[n]=body._force.x;this.fy[n]=body._force.y;this.fz[n]=body._force.z;this.taux[n]=body._tau.x;this.tauy[n]=body._tau.y;this.tauz[n]=body._tau.z;this.wx[n]=body._rotvelo.x;this.wy[n]=body._rotvelo.y;this.wz[n]=body._rotvelo.z;this.qx[n]=body._quaternion.x;this.qy[n]=body._quaternion.y;this.qz[n]=body._quaternion.z;this.qw[n]=body._quaternion.w;this.type[n]=body._shape.type;this.body[n]=body;this.fixed[n]=body._mass<=0.0?1:0;this.invm[n]=body._mass>0?1.0/body._mass:0;this.mass[n]=body._mass;this.material[n]=body._material!=undefined?body._material._id:-1;this.inertiax[n]=body._inertia.x;this.inertiay[n]=body._inertia.y;this.inertiaz[n]=body._inertia.z;this.iinertiax[n]=body._inertia.x>0?1.0/body._inertia.x:0.0;this.iinertiay[n]=body._inertia.y>0?1.0/body._inertia.y:0.0;this.iinertiaz[n]=body._inertia.z>0?1.0/body._inertia.z:0.0;body._id=n;body._world=this;this.collision_matrix=new Int16Array((n+1)*(n+1));};CANNON.World.prototype.addContactMaterial=function(cmat){var newcm=new Int16Array((this._materials.length+2)
*(this._materials.length+2));for(var i=0;i<newcm.length;i++)
newcm[i]=-1;for(var i=0;i<this._materials.length;i++)
for(var j=0;j<this._materials.length;j++)
newcm[i+this._materials.length*j]=this._material_contactmaterial_refs[i+this._materials.length*j];this._material_contactmaterial_refs=newcm;for(var i=0;i<2;i++){if(cmat.materials[i]._id==-1){this._materials.push(cmat.materials[i]);cmat.materials[i]._id=this._materials.length-1;}}
var i=cmat.materials[0]._id;var j=cmat.materials[1]._id;this._material_contactmaterial_refs[i+this._materials.length*j]=(this._contact_material1.length);this._contactmaterials.push(cmat);this._contact_material1.push(cmat.materials[0]._id);this._contact_material2.push(cmat.materials[1]._id);this._contact_friction_k.push(cmat.kinematic_friction);this._contact_friction_s.push(cmat.static_friction);this._contact_restitution.push(cmat.restitution);};CANNON.World.prototype.broadphase=function(broadphase){if(broadphase){this._broadphase=broadphase;broadphase.world=this;}else
return this._broadphase;};CANNON.World.prototype.iterations=function(n){if(n)
this.solver.iter=parseInt(n);else
return this.solver.iter;};CANNON.World.prototype.gravity=function(g){if(g==undefined)
return this.gravity;else
this.gravity=g;};CANNON.World.prototype.step=function(dt){var world=this;if(dt==undefined){if(this.last_dt)
dt=this.last_dt;else
dt=this.default_dt;}
var pairs=this._broadphase.collisionPairs(this);var p1=pairs[0];var p2=pairs[1];var SPHERE=CANNON.Shape.types.SPHERE;var PLANE=CANNON.Shape.types.PLANE;var BOX=CANNON.Shape.types.BOX;var COMPOUND=CANNON.Shape.types.COMPOUND;var types=world.type;var x=world.x;var y=world.y;var z=world.z;var qx=world.qx;var qy=world.qy;var qz=world.qz;var qw=world.qw;var vx=world.vx;var vy=world.vy;var vz=world.vz;var wx=world.wx;var wy=world.wy;var wz=world.wz;var fx=world.fx;var fy=world.fy;var fz=world.fz;var taux=world.taux;var tauy=world.tauy;var tauz=world.tauz;var invm=world.invm;var vx_lambda=new Float32Array(world.x.length);var vy_lambda=new Float32Array(world.y.length);var vz_lambda=new Float32Array(world.z.length);var wx_lambda=new Float32Array(world.x.length);var wy_lambda=new Float32Array(world.y.length);var wz_lambda=new Float32Array(world.z.length);var lambdas=new Float32Array(p1.length);var lambdas_t1=new Float32Array(p1.length);var lambdas_t2=new Float32Array(p1.length);for(var i=0;i<lambdas.length;i++){lambdas[i]=0;lambdas_t1[i]=0;lambdas_t2[i]=0;vx_lambda[i]=0;vy_lambda[i]=0;vz_lambda[i]=0;wx_lambda[i]=0;wy_lambda[i]=0;wz_lambda[i]=0;}
var that=this;function cmatrix(i,j,which,newval){if((which==0&&i<j)||(which==-1&&i>j)){var temp=j;j=i;i=temp;}
if(newval===undefined)
return that.collision_matrix[i+j*that.numObjects()];else
that.collision_matrix[i+j*that.numObjects()]=parseInt(newval);}
for(var i=0;i<this.numObjects();i++)
for(var j=0;j<i;j++){cmatrix(i,j,-1,cmatrix(i,j,0));cmatrix(i,j,0,0);}
for(var i=0;i<world.numObjects();i++){fx[i]+=world.gravity.x*world.mass[i];fy[i]+=world.gravity.y*world.mass[i];fz[i]+=world.gravity.z*world.mass[i];}
this.solver.reset(world.numObjects());var cid=new Int16Array(p1.length);function nearPhase(result,si,sj,xi,xj,qi,qj){var swapped=false;if(si.type>sj.type){var temp;temp=sj;sj=si;si=temp;temp=xj;xj=xi;xi=temp;temp=qj;qj=qi;qi=temp;swapped=true;}
function makeResult(){return{ri:new CANNON.Vec3(),rj:new CANNON.Vec3(),ni:new CANNON.Vec3()};}
function swapResult(r){var temp=CANNON.Vec3()
temp=r.ri;r.ri=r.rj;r.rj=temp;r.ni.negate(r.ni);}
function recurseCompound(result,si,sj,xi,xj,qi,qj){for(var i=0;i<sj.childShapes.length;i++){var r=[];nearPhase(r,si,sj.childShapes[i],xi,xj.vadd(sj.childOffsets[i]),qi,qj.mult(sj.childOrientations[i]));for(var j=0;j<r.length;j++){r[j].rj.vsub(sj.childOffsets[i],r[j].rj);result.push(r[j]);}}}
if(si.type==CANNON.Shape.types.SPHERE){if(sj.type==CANNON.Shape.types.SPHERE){var r=makeResult();xj.vsub(xi,r.ni);r.ni.normalize();r.ni.copy(r.ri);r.ni.copy(r.rj);r.ri.mult(si.radius,r.ri);r.rj.mult(-sj.radius,r.rj);result.push(r);}else if(sj.type==CANNON.Shape.types.PLANE){var r=makeResult();sj.normal.copy(r.ni);r.ni.negate(r.ni);r.ni.normalize();r.ni.mult(si.radius,r.ri);var point_on_plane_to_sphere=xi.vsub(xj);var plane_to_sphere_ortho=r.ni.mult(r.ni.dot(point_on_plane_to_sphere));r.rj=point_on_plane_to_sphere.vsub(plane_to_sphere_ortho);result.push(r);}else if(sj.type==CANNON.Shape.types.BOX){var xixj=xj.vsub(xi);var sides=sj.getSideNormals(true,qi);var R=si.radius;var penetrating_sides=[];for(var idx=0;idx<sides.length&&penetrating_sides.length<=3;idx++){var ns=sides[idx].copy();var h=ns.norm();var r=xixj.vsub(ns);ns.normalize();var dot=ns.dot(r);if(dot<h+R&&dot>0)
penetrating_sides.push(idx);}
if(penetrating_sides.length==1){var res=makeResult();var axis=penetrating_sides[0];var h=sides[axis];res.ni=h.copy();res.ni.normalize();var r=xj.vsub(xi.vadd(h));var t1=sides[(axis+1)%3];var t2=sides[(axis+2)%3];t1.normalize();t2.normalize();res.ri=h.vsub(t1.mult(r.dot(t1))).vsub(t2.mult(r.dot(t2)));res.rj=res.ni.copy();res.rj.normalize();res.rj.mult(-R,res.rj);result.push(res);}else if(penetrating_sides.length==2){var res=makeResult();var axis1=penetrating_sides[0];var axis2=penetrating_sides[1];var edgeCenter=sides[axis1].vadd(sides[axis2]);var edgeTangent=sides[axis1].cross(sides[axis2]);edgeTangent.normalize();var r=xj.vsub(edgeCenter.vadd(xi));res.ri=edgeCenter.vadd(edgeTangent.mult(r.dot(edgeTangent)));res.rj=xi.vadd(res.ri).vsub(xj);res.rj.normalize();res.rj.mult(R);res.ni=res.rj.copy();res.ni.negate(res.ni);res.ni.normalize();result.push(res);}else if(penetrating_sides.length==3){var res=makeResult();var s1=sides[penetrating_sides[0]];var s2=sides[penetrating_sides[1]];var s3=sides[penetrating_sides[2]];var corner=s1.vadd(s2).vadd(s3);var ri=corner;res.ni=corner.vadd(xi).vsub(xj);res.ni.normalize();res.rj=res.ni.mult(-R);result.push(res);}else{}}else if(sj.type==CANNON.Shape.types.COMPOUND){recurseCompound(result,si,sj,xi,xj,qi,qj);}}else if(si.type==CANNON.Shape.types.PLANE){if(sj.type==CANNON.Shape.types.PLANE){throw"Plane-plane collision... wait, you did WHAT?";}else if(sj.type==CANNON.Shape.types.BOX){var n=si.normal.copy();var numcontacts=0;var corners=sj.getCorners();for(var idx=0;idx<corners.length&&numcontacts<=4;idx++){var r=makeResult();var worldCorner=qj.vmult(corners[idx]);worldCorner.copy(r.rj);worldCorner.vadd(xj,worldCorner);var point_on_plane_to_corner=worldCorner.vsub(xi);var d=n.dot(point_on_plane_to_corner);if(d<=0){var plane_to_corner=n.mult(d);point_on_plane_to_corner.vsub(plane_to_corner,r.ri);n.copy(r.ni);result.push(r);}}}else if(sj.type==CANNON.Shape.types.COMPOUND){recurseCompound(result,si,sj,xi,xj,qi,qj);}}else if(si.type==CANNON.Shape.types.BOX){if(sj.type==CANNON.Shape.types.BOX){throw"box-box collision not implemented yet";}
if(sj.type==CANNON.Shape.types.COMPOUND){recurseCompound(result,si,sj,xi,xj,qi,qj);}}else if(si.type==CANNON.Shape.types.COMPOUND){if(sj.type==CANNON.Shape.types.COMPOUND){recurseCompound(result,si,sj,xi,xj,qi,qj);}}
for(var i=0;swapped&&i<result.length;i++)
swapResult(result[i]);}
for(var k=0;k<p1.length;k++){var i=p1[k];var j=p2[k];var lastCollisionState=cmatrix(i,j,-1);var mu_s=0.3,mu_k=0.3,e=0.2;var cm=this._getContactMaterialId(i,j);if(cm!=-1){mu_s=this._contact_friction_s[cm];mu_k=this._contact_friction_k[cm];e=this._contact_restitution[cm];}
var contacts=[];nearPhase(contacts,world.body[i]._shape,world.body[j]._shape,new CANNON.Vec3(x[i],y[i],z[i]),new CANNON.Vec3(x[j],y[j],z[j]),new CANNON.Quaternion(qx[i],qy[i],qz[i],qw[i]),new CANNON.Quaternion(qx[j],qy[j],qz[j],qw[j]));for(var ci=0;ci<contacts.length;ci++){var c=contacts[ci];var gvec=new CANNON.Vec3(x[j]+c.rj.x-x[i]-c.ri.x,y[j]+c.rj.y-y[i]-c.ri.y,z[j]+c.rj.z-z[i]-c.ri.z);var g=gvec.dot(c.ni);if(g<0.0){var vi=new CANNON.Vec3(vx[i],vy[i],vz[i]);var wi=new CANNON.Vec3(wx[i],wy[i],wz[i]);var vj=new CANNON.Vec3(vx[j],vy[j],vz[j]);var wj=new CANNON.Vec3(wx[j],wy[j],wz[j]);var u=(vj.vsub(vi));var uw=(c.rj.cross(wj)).vsub(c.ri.cross(wi));u.vsub(uw,u);var iMi=world.invm[i];var iMj=world.invm[j];var iIxi=world.inertiax[i]>0?1.0/world.inertiax[i]:0;var iIyi=world.inertiay[i]>0?1.0/world.inertiay[i]:0;var iIzi=world.inertiaz[i]>0?1.0/world.inertiaz[i]:0;var iIxj=world.inertiax[j]>0?1.0/world.inertiax[j]:0;var iIyj=world.inertiay[j]>0?1.0/world.inertiay[j]:0;var iIzj=world.inertiaz[j]>0?1.0/world.inertiaz[j]:0;var n=c.ni;var rixn=c.ri.cross(n);var rjxn=c.rj.cross(n);var gdot=n.mult(u.dot(n));cid[k]=this.solver.addConstraint([-n.x,-n.y,-n.z,-rixn.x,-rixn.y,-rixn.z,n.x,n.y,n.z,rjxn.x,rjxn.y,rjxn.z],[iMi,iMi,iMi,iIxi,iIyi,iIzi,iMj,iMj,iMj,iIxj,iIyj,iIzj],[-gvec.x,-gvec.y,-gvec.z,0,0,0,gvec.x,gvec.y,gvec.z,0,0,0],[-u.x,-u.y,-u.z,0,0,0,u.x,u.y,u.z,0,0,0],[fx[i],fy[i],fz[i],taux[i],tauy[i],tauz[i],fx[j],fy[j],fz[j],taux[j],tauy[j],tauz[j]],0,'inf',i,j);}}}
if(this.solver.n){this.solver.solve();for(var i=0;i<world.numObjects();i++){vx[i]+=this.solver.vxlambda[i];vy[i]+=this.solver.vylambda[i];vz[i]+=this.solver.vzlambda[i];wx[i]+=this.solver.wxlambda[i];wy[i]+=this.solver.wylambda[i];wz[i]+=this.solver.wzlambda[i];}}
for(var i=0;i<world.numObjects();i++){var ld=1.0-this.body[i].linearDamping();var ad=1.0-this.body[i].angularDamping();vx[i]*=ld;vy[i]*=ld;vz[i]*=ld;wx[i]*=ad;wy[i]*=ad;wz[i]*=ad;}
for(var i=0;i<world.numObjects();i++){if(!world.fixed[i]){vx[i]+=fx[i]*world.invm[i]*dt;vy[i]+=fy[i]*world.invm[i]*dt;vz[i]+=fz[i]*world.invm[i]*dt;wx[i]+=taux[i]*1.0/world.inertiax[i]*dt;wy[i]+=tauy[i]*1.0/world.inertiay[i]*dt;wz[i]+=tauz[i]*1.0/world.inertiaz[i]*dt;x[i]+=vx[i]*dt;y[i]+=vy[i]*dt;z[i]+=vz[i]*dt;var q=new CANNON.Quaternion(qx[i],qy[i],qz[i],qw[i]);var w=new CANNON.Quaternion(wx[i],wy[i],wz[i],0);var wq=w.mult(q);qx[i]+=dt*0.5*wq.x;qy[i]+=dt*0.5*wq.y;qz[i]+=dt*0.5*wq.z;qw[i]+=dt*0.5*wq.w;q.x=qx[i];q.y=qy[i];q.z=qz[i];q.w=qw[i];q.normalize();qx[i]=q.x;qy[i]=q.y;qz[i]=q.z;qw[i]=q.w;}}
for(var i=0;i<world.numObjects();i++){fx[i]=0.0;fy[i]=0.0;fz[i]=0.0;taux[i]=0.0;tauy[i]=0.0;tauz[i]=0.0;}
world.time+=dt;world.stepnumber+=1;};