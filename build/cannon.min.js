(function(){var t=t||{};this.Int32Array||(this.Int32Array=Array,this.Float32Array=Array),t.Mat3=function(t){this.elements=t?t:[0,0,0,0,0,0,0,0,0]},t.Mat3.prototype.identity=function(){this.elements[0]=1,this.elements[1]=0,this.elements[2]=0,this.elements[3]=0,this.elements[4]=1,this.elements[5]=0,this.elements[6]=0,this.elements[7]=0,this.elements[8]=1},t.Mat3.prototype.setZero=function(){var t=this.elements;t[0]=0,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=0,t[6]=0,t[7]=0,t[8]=0},t.Mat3.prototype.setTrace=function(t){var e=this.elements;e[0]=t.x,e[4]=t.y,e[8]=t.z},mat3.setTrace=function(t,e){t[0]=e[0],t[4]=e[1],t[8]=e[2]},t.Mat3.prototype.vmult=function(e,i){i=i||new t.Vec3;var a=this.elements,r=e.x,o=e.y,s=e.z;return i.x=a[0]*r+a[1]*o+a[2]*s,i.y=a[3]*r+a[4]*o+a[5]*s,i.z=a[6]*r+a[7]*o+a[8]*s,i},t.Mat3.prototype.smult=function(t){for(var e=0;this.elements.length>e;e++)this.elements[e]*=t},t.Mat3.prototype.mmult=function(e){for(var i=new t.Mat3,a=0;3>a;a++)for(var r=0;3>r;r++){for(var o=0,s=0;3>s;s++)o+=e.elements[a+3*s]*this.elements[s+3*r];i.elements[a+3*r]=o}return i},t.Mat3.prototype.solve=function(e,i){i=i||new t.Vec3;for(var a=3,r=4,o=[],s=0;a*r>s;s++)o.push(0);var s,n;for(s=0;3>s;s++)for(n=0;3>n;n++)o[s+r*n]=this.elements[s+3*n];o[3]=e.x,o[7]=e.y,o[11]=e.z;var c,v,h=3,l=h,u=4;do{if(s=l-h,0===o[s+r*s])for(n=s+1;l>n;n++)if(0!==o[s+r*n]){c=u;do v=u-c,o[v+r*s]+=o[v+r*n];while(--c);break}if(0!==o[s+r*s])for(n=s+1;l>n;n++){var p=o[s+r*n]/o[s+r*s];c=u;do v=u-c,o[v+r*n]=s>=v?0:o[v+r*n]-o[v+r*s]*p;while(--c)}}while(--h);if(i.z=o[2*r+3]/o[2*r+2],i.y=(o[1*r+3]-o[1*r+2]*i.z)/o[1*r+1],i.x=(o[0*r+3]-o[0*r+2]*i.z-o[0*r+1]*i.y)/o[0*r+0],isNaN(i.x)||isNaN(i.y)||isNaN(i.z)||1/0===i.x||1/0===i.y||1/0===i.z)throw"Could not solve equation! Got x=["+(""+i)+"], b=["+(""+e)+"], A=["+(""+this)+"]";return i},t.Mat3.prototype.e=function(t,e,i){return void 0===i?this.elements[e+3*t]:(this.elements[e+3*t]=i,void 0)},t.Mat3.prototype.copy=function(e){e=e||new t.Mat3;for(var i=0;this.elements.length>i;i++)e.elements[i]=this.elements[i];return e},t.Mat3.prototype.toString=function(){for(var t="",e=",",i=0;9>i;i++)t+=this.elements[i]+e;return t},t.Mat3.prototype.reverse=function(e){e=e||new t.Mat3;for(var i=3,a=6,r=[],o=0;i*a>o;o++)r.push(0);var o,s;for(o=0;3>o;o++)for(s=0;3>s;s++)r[o+a*s]=this.elements[o+3*s];r[3]=1,r[9]=0,r[15]=0,r[4]=0,r[10]=1,r[16]=0,r[5]=0,r[11]=0,r[17]=1;var n,c,v=3,h=v,l=a;do{if(o=h-v,0===r[o+a*o])for(s=o+1;h>s;s++)if(0!==r[o+a*s]){n=l;do c=l-n,r[c+a*o]+=r[c+a*s];while(--n);break}if(0!==r[o+a*o])for(s=o+1;h>s;s++){var u=r[o+a*s]/r[o+a*o];n=l;do c=l-n,r[c+a*s]=o>=c?0:r[c+a*s]-r[c+a*o]*u;while(--n)}}while(--v);o=2;do{s=o-1;do{var u=r[o+a*s]/r[o+a*o];n=a;do c=a-n,r[c+a*s]=r[c+a*s]-r[c+a*o]*u;while(--n)}while(s--)}while(--o);o=2;do{var u=1/r[o+a*o];n=a;do c=a-n,r[c+a*o]=r[c+a*o]*u;while(--n)}while(o--);o=2;do{s=2;do{if(c=r[i+s+a*o],isNaN(c)||1/0===c)throw"Could not reverse! A=["+(""+this)+"]";e.e(o,s,c)}while(s--)}while(o--);return e},t.Vec3=function(t,e,i){this.x=t||0,this.y=e||0,this.z=i||0},t.Vec3.prototype.cross=function(e,i){var a=e.x,r=e.y,o=e.z,s=this.x,n=this.y,c=this.z;return i=i||new t.Vec3,i.x=n*o-c*r,i.y=c*a-s*o,i.z=s*r-n*a,i},t.Vec3.prototype.set=function(t,e,i){return this.x=t,this.y=e,this.z=i,this},t.Vec3.prototype.vadd=function(e,i){return i?(i.x=e.x+this.x,i.y=e.y+this.y,i.z=e.z+this.z,void 0):new t.Vec3(this.x+e.x,this.y+e.y,this.z+e.z)},t.Vec3.prototype.vsub=function(e,i){return i?(i.x=this.x-e.x,i.y=this.y-e.y,i.z=this.z-e.z,void 0):new t.Vec3(this.x-e.x,this.y-e.y,this.z-e.z)},t.Vec3.prototype.crossmat=function(){return new t.Mat3([0,-this.z,this.y,this.z,0,-this.x,-this.y,this.x,0])},t.Vec3.prototype.normalize=function(){var t=this.x,e=this.y,i=this.z,a=Math.sqrt(t*t+e*e+i*i);if(a>0){var r=1/a;this.x*=r,this.y*=r,this.z*=r}else this.x=0,this.y=0,this.z=0;return a},t.Vec3.prototype.unit=function(e){e=e||new t.Vec3;var i=this.x,a=this.y,r=this.z,o=Math.sqrt(i*i+a*a+r*r);return o>0?(o=1/o,e.x=i*o,e.y=a*o,e.z=r*o):(e.x=1,e.y=0,e.z=0),e},t.Vec3.prototype.norm=function(){var t=this.x,e=this.y,i=this.z;return Math.sqrt(t*t+e*e+i*i)},t.Vec3.prototype.norm2=function(){return this.dot(this)},t.Vec3.prototype.distanceTo=function(t){var e=this.x,i=this.y,a=this.z,r=t.x,o=t.y,s=t.z;return Math.sqrt((r-e)*(r-e)+(o-i)*(o-i)+(s-a)*(s-a))},t.Vec3.prototype.mult=function(e,i){i=i||new t.Vec3;var a=this.x,r=this.y,o=this.z;return i.x=e*a,i.y=e*r,i.z=e*o,i},t.Vec3.prototype.dot=function(t){return this.x*t.x+this.y*t.y+this.z*t.z},t.Vec3.prototype.isZero=function(){return 0===this.x&&0===this.y&&0===this.z},t.Vec3.prototype.negate=function(e){return e=e||new t.Vec3,e.x=-this.x,e.y=-this.y,e.z=-this.z,e};var e=new t.Vec3,i=new t.Vec3;t.Vec3.prototype.tangents=function(t,a){var r=this.norm();if(r>0){var o=e,s=1/r;o.set(this.x*s,this.y*s,this.z*s);var n=i;.9>Math.abs(o.x)?(n.set(1,0,0),o.cross(n,t)):(n.set(0,1,0),o.cross(n,t)),o.cross(t,a)}else t.set(1,0,0).normalize(),a.set(0,1,0).normalize()};var a=vec3.create(),r=vec3.create();vec3.tangents=function(t,e,i){var o=vec3.length(i);if(o>0){var s=a,n=1/o;vec3.set(s,i[0]*n,i[1]*n,i[2]*n);var c=r;.9>Math.abs(s[0])?(vec3.set(c,1,0,0),vec3.cross(t,s,c)):(vec3.set(c,0,1,0),vec3.cross(t,s,c)),vec3.cross(e,s,t)}else vec3.set(t,1,0,0),vec3.set(e,0,1,0)},t.Vec3.prototype.toString=function(){return this.x+","+this.y+","+this.z},t.Vec3.prototype.copy=function(e){return e=e||new t.Vec3,e.x=this.x,e.y=this.y,e.z=this.z,e},vec3.copyToXYZObject=function(t,e){t.x=e[0],t.y=e[1],t.z=e[2]},t.Vec3.prototype.lerp=function(t,e,i){var a=this.x,r=this.y,o=this.z;i.x=a+(t.x-a)*e,i.y=r+(t.y-r)*e,i.z=o+(t.z-o)*e},t.Vec3.prototype.almostEquals=function(t,e){return void 0===e&&(e=1e-6),Math.abs(this.x-t.x)>e||Math.abs(this.y-t.y)>e||Math.abs(this.z-t.z)>e?!1:!0},vec3.almostEquals=function(t,e,i){return void 0===i&&(i=1e-6),Math.abs(t[0]-e[0])>i||Math.abs(t[1]-e[1])>i||Math.abs(t[2]-e[2])>i?!1:!0},t.Vec3.prototype.almostZero=function(t){return void 0===t&&(t=1e-6),Math.abs(this.x)>t||Math.abs(this.y)>t||Math.abs(this.z)>t?!1:!0},vec3.almostZero=function(t,e){return e=e||1e-6,Math.abs(t[0])>e||Math.abs(t[1])>e||Math.abs(t[2])>e?!1:!0},vec3.clamp=function(t,e,i,a){return vec3.copy(t,e),e[0]<i[0]&&(t[0]=i[0]),e[1]<i[1]&&(t[1]=i[1]),e[2]<i[2]&&(t[2]=i[2]),e[0]>a[0]&&(t[0]=a[0]),e[1]>a[1]&&(t[1]=a[1]),e[2]>a[2]&&(t[2]=a[2]),t},t.Quaternion=function(t,e,i,a){this.x=void 0!==t?t:0,this.y=void 0!==e?e:0,this.z=void 0!==i?i:0,this.w=void 0!==a?a:1},t.Quaternion.prototype.set=function(t,e,i,a){this.x=t,this.y=e,this.z=i,this.w=a},t.Quaternion.prototype.toString=function(){return this.x+","+this.y+","+this.z+","+this.w},t.Quaternion.prototype.setFromAxisAngle=function(t,e){var i=Math.sin(.5*e);this.x=t.x*i,this.y=t.y*i,this.z=t.z*i,this.w=Math.cos(.5*e)},t.Quaternion.prototype.toAxisAngle=function(e){e=e||new t.Vec3,this.normalize();var i=2*Math.acos(this.w),a=Math.sqrt(1-this.w*this.w);return.001>a?(e.x=this.x,e.y=this.y,e.z=this.z):(e.x=this.x/a,e.y=this.y/a,e.z=this.z/a),[e,i]},quat.toAxisAngle=function(t,e){var i=e[3],a=2*Math.acos(i),r=Math.sqrt(1-i*i);return.001>r?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=e[0]/r,t[1]=e[1]/r,t[2]=e[2]/r),a},t.Quaternion.prototype.setFromVectors=function(t,e){var i=t.cross(e);this.x=i.x,this.y=i.y,this.z=i.z,this.w=Math.sqrt(Math.pow(t.norm(),2)*Math.pow(e.norm(),2))+t.dot(e),this.normalize()};var o=new t.Vec3,s=new t.Vec3,n=new t.Vec3;t.Quaternion.prototype.mult=function(e,i){i=i||new t.Quaternion;var a=this.w,r=o,c=s,v=n;return r.set(this.x,this.y,this.z),c.set(e.x,e.y,e.z),i.w=a*e.w-r.dot(c),r.cross(c,v),i.x=a*c.x+e.w*r.x+v.x,i.y=a*c.y+e.w*r.y+v.y,i.z=a*c.z+e.w*r.z+v.z,i},t.Quaternion.prototype.inverse=function(e){var i=this.x,a=this.y,r=this.z,o=this.w;e=e||new t.Quaternion,this.conjugate(e);var s=1/(i*i+a*a+r*r+o*o);return e.x*=s,e.y*=s,e.z*=s,e.w*=s,e},t.Quaternion.prototype.conjugate=function(e){return e=e||new t.Quaternion,e.x=-this.x,e.y=-this.y,e.z=-this.z,e.w=this.w,e},t.Quaternion.prototype.normalize=function(){var t=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);0===t?(this.x=0,this.y=0,this.z=0,this.w=0):(t=1/t,this.x*=t,this.y*=t,this.z*=t,this.w*=t)},t.Quaternion.prototype.normalizeFast=function(){var t=(3-(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w))/2;0===t?(this.x=0,this.y=0,this.z=0,this.w=0):(this.x*=t,this.y*=t,this.z*=t,this.w*=t)},t.Quaternion.prototype.vmult=function(e,i){if(i=i||new t.Vec3,0===this.w)i.x=e.x,i.y=e.y,i.z=e.z;else{var a=e.x,r=e.y,o=e.z,s=this.x,n=this.y,c=this.z,v=this.w,h=v*a+n*o-c*r,l=v*r+c*a-s*o,u=v*o+s*r-n*a,p=-s*a-n*r-c*o;i.x=h*v+p*-s+l*-c-u*-n,i.y=l*v+p*-n+u*-s-h*-c,i.z=u*v+p*-c+h*-n-l*-s}return i},t.Quaternion.prototype.copy=function(t){t.x=this.x,t.y=this.y,t.z=this.z,t.w=this.w},quat.copyToXYZWObject=function(t,e){t.x=e[0],t.y=e[1],t.z=e[2],t.w=e[3]},t.Quaternion.prototype.toEuler=function(t,e){e=e||"YZX";var i,a,r,o=this.x,s=this.y,n=this.z,c=this.w;switch(e){case"YZX":var v=o*s+n*c;if(v>.499&&(i=2*Math.atan2(o,c),a=Math.PI/2,r=0),-.499>v&&(i=-2*Math.atan2(o,c),a=-Math.PI/2,r=0),isNaN(i)){var h=o*o,l=s*s,u=n*n;i=Math.atan2(2*s*c-2*o*n,1-2*l-2*u),a=Math.asin(2*v),r=Math.atan2(2*o*c-2*s*n,1-2*h-2*u)}break;default:throw Error("Euler order "+e+" not supported yet.")}t.y=i,t.z=a,t.x=r},t.EventTarget=function(){var t={};this.addEventListener=function(e,i){void 0===t[e]&&(t[e]=[]),-1===t[e].indexOf(i)&&t[e].push(i)},this.dispatchEvent=function(e){for(var i in t[e.type])t[e.type][i](e)},this.removeEventListener=function(e,i){var a=t[e].indexOf(i);-1!==a&&t[e].splice(a,1)}},t.ObjectPool=function(){this.objects=[],this.type=Object},t.ObjectPool.prototype.release=function(){for(var t=arguments.length,e=0;e!==t;e++)this.objects.push(arguments[e])},t.ObjectPool.prototype.get=function(){return 0===this.objects.length?this.constructObject():this.objects.pop()},t.ObjectPool.prototype.constructObject=function(){throw Error("constructObject() not implemented in this ObjectPool subclass yet!")},t.Vec3Pool=function(){t.ObjectPool.call(this),this.type=vec3},t.Vec3Pool.prototype=new t.ObjectPool,t.Vec3Pool.prototype.constructObject=function(){return vec3.create()},t.Shape=function(){this.type=0,this.aabbmin=vec3.create(),this.aabbmax=vec3.create(),this.boundingSphereRadius=0,this.boundingSphereRadiusNeedsUpdate=!0},t.Shape.prototype.constructor=t.Shape,t.Shape.prototype.computeBoundingSphereRadius=function(){throw"computeBoundingSphereRadius() not implemented for shape type "+this.type},t.Shape.prototype.getBoundingSphereRadius=function(){return this.boundingSphereRadiusNeedsUpdate&&this.computeBoundingSphereRadius(),this.boundingSphereRadius},t.Shape.prototype.volume=function(){throw"volume() not implemented for shape type "+this.type},t.Shape.prototype.calculateLocalInertia=function(){throw"calculateLocalInertia() not implemented for shape type "+this.type};var c=vec3.create(),v=vec3.create();t.Shape.prototype.calculateTransformedInertia=function(t,e,i){i=i||vec3.create();var a=c,r=v;return this.calculateLocalInertia(t,a),e.vmult(a,r),i.x=Math.abs(r.x),i.y=Math.abs(r.y),i.z=Math.abs(r.z),i},t.Shape.calculateLocalAABB=function(){throw Error(".calculateLocalAABB is not implemented for this Shape yet!")},t.Shape.types={SPHERE:1,PLANE:2,BOX:4,COMPOUND:8,CONVEXPOLYHEDRON:16},t.Body=function(e){t.EventTarget.apply(this),this.type=e,this.world=null,this.preStep=null,this.postStep=null,this.vlambda=vec3.create(),this.collisionFilterGroup=1,this.collisionFilterMask=1},t.Body.DYNAMIC=1,t.Body.STATIC=2,t.Body.KINEMATIC=4,t.Particle=function(e,i){if("number"!=typeof e)throw Error("Argument 1 (mass) must be a number.");if(i!==void 0&&!(i instanceof t.Material))throw Error("Argument 3 (material) must be an instance of CANNON.Material.");t.Body.call(this,"particle"),this.position=vec3.create(),this.initPosition=vec3.create(),this.velocity=vec3.create(),this.initVelocity=vec3.create(),this.force=vec3.create(),this.mass=e,this.invMass=e>0?1/e:0,this.material=i,this.linearDamping=.01,this.motionstate=0>=e?t.Body.STATIC:t.Body.DYNAMIC,this.allowSleep=!0,this.sleepState=0,this.sleepSpeedLimit=.1,this.sleepTimeLimit=1,this.timeLastSleepy=0},t.Particle.prototype=new t.Body,t.Particle.prototype.constructor=t.Particle,t.Particle.prototype.isAwake=function(){return 0===this.sleepState},t.Particle.prototype.isSleepy=function(){return 1===this.sleepState},t.Particle.prototype.isSleeping=function(){return 2===this.sleepState},t.Particle.prototype.wakeUp=function(){var t=this.sleepState;this.sleepState=0,2===t&&this.dispatchEvent({type:"wakeup"})},t.Particle.prototype.sleep=function(){this.sleepState=2},t.Particle.prototype.sleepTick=function(t){if(this.allowSleep){var e=this.sleepState,i=vec3.squaredLength(this.velocity),a=Math.pow(this.sleepSpeedLimit,2);0===e&&a>i?(this.sleepState=1,this.timeLastSleepy=t,this.dispatchEvent({type:"sleepy"})):1===e&&i>a?this.wakeUp():1===e&&t-this.timeLastSleepy>this.sleepTimeLimit&&(this.sleepState=2,this.dispatchEvent({type:"sleep"}))}},t.RigidBody=function(e,i,a){if("number"!=typeof e)throw Error("Argument 1 (mass) must be a number.");if(a!==void 0&&!(a instanceof t.Material))throw Error("Argument 3 (material) must be an instance of CANNON.Material.");t.Particle.call(this,e,a),this.tau=vec3.create(),this.quaternion=quat.create(),this.initQuaternion=quat.create(),this.angularVelocity=vec3.create(),this.initAngularVelocity=vec3.create(),this.shape=i,this.inertia=vec3.create(),i.calculateLocalInertia(e,this.inertia),this.inertiaWorld=vec3.create(),vec3.copy(this.inertiaWorld,this.inertia),this.inertiaWorldAutoUpdate=!1,this.invInertia=vec3.fromValues(this.inertia[0]>0?1/this.inertia[0]:0,this.inertia[1]>0?1/this.inertia[1]:0,this.inertia[2]>0?1/this.inertia[2]:0),this.invInertiaWorld=vec3.create(),vec3.copy(this.invInertiaWorld,this.invInertia),this.invInertiaWorldAutoUpdate=!1,this.angularDamping=.01,this.aabbmin=vec3.create(),this.aabbmax=vec3.create(),this.aabbNeedsUpdate=!0,this.wlambda=vec3.create()},t.RigidBody.prototype=new t.Particle(0),t.RigidBody.prototype.constructor=t.RigidBody,t.RigidBody.prototype.computeAABB=function(){this.shape.calculateWorldAABB(this.position,this.quaternion,this.aabbmin,this.aabbmax),this.aabbNeedsUpdate=!1};var l=vec3.create(),u=vec3.create();t.RigidBody.prototype.applyForce=function(t,e){var i=l;vec3.subtract(i,e,this.position);var a=u;vec3.cross(a,i,t),vec3.add(this.force,this.force,t),vec3.add(this.tau,a,this.tau)};var p=vec3.create(),d=vec3.create(),f=vec3.create();t.RigidBody.prototype.applyImpulse=function(t,e){var i=p;vec3.subtract(i,e,this.position);var a=d;vec3.copy(a,t),vec3.scale(a,a,this.invMass),vec3.add(this.velocity,this.velocity,a);var r=f;vec3.cross(r,i,t),r[0]*=this.invInertia[0],r[1]*=this.invInertia[1],r[2]*=this.invInertia[2],vec3.add(this.angularVelocity,this.angularVelocity,r)},t.Sphere=function(e){t.Shape.call(this),this.radius=void 0!==e?Number(e):1,this.type=t.Shape.types.SPHERE},t.Sphere.prototype=new t.Shape,t.Sphere.prototype.constructor=t.Sphere,t.Sphere.prototype.calculateLocalInertia=function(t,e){e=e||vec3.create();var i=2*t*this.radius*this.radius/5;return vec3.set(e,i,i,i),e},t.Sphere.prototype.volume=function(){return 4*Math.PI*this.radius/3},t.Sphere.prototype.computeBoundingSphereRadius=function(){this.boundingSphereRadiusNeedsUpdate=!1,this.boundingSphereRadius=this.radius},t.Sphere.prototype.calculateWorldAABB=function(t,e,i,a){for(var r=this.radius,o=["x","y","z"],s=0;o.length>s;s++){var n=o[s];i[n]=t[n]-r,a[n]=t[n]+r}},t.SPHSystem=function(){this.particles=[],this.density=1,this.smoothingRadius=1,this.speedOfSound=1,this.viscosity=.01,this.eps=1e-6,this.pressures=[],this.densities=[],this.neighbors=[]},t.SPHSystem.prototype.add=function(t){this.particles.push(t),this.neighbors.length<this.particles.length&&this.neighbors.push([])},t.SPHSystem.prototype.remove=function(t){var e=this.particles.indexOf(t);-1!==e&&(this.particles.splice(e,1),this.neighbors.length>this.particles.length&&this.neighbors.pop())};var m=vec3.create();t.SPHSystem.prototype.getNeighbors=function(t,e){for(var i=this.particles.length,a=t.id,r=this.smoothingRadius*this.smoothingRadius,o=m,s=0;s!==i;s++){var n=this.particles[s];vec3.subtract(o,n.position,t.position),a!==n.id&&r>vec3.squaredLength(o)&&e.push(n)}};var y=vec3.create(),b=vec3.create(),g=vec3.create(),x=vec3.create(),w=vec3.create(),M=vec3.create();t.SPHSystem.prototype.update=function(){for(var t=this.particles.length,e=y,i=this.speedOfSound,a=this.eps,r=0;r!==t;r++){var o=this.particles[r],s=this.neighbors[r];s.length=0,this.getNeighbors(o,s),s.push(this.particles[r]);for(var n=s.length,c=0,v=0;v!==n;v++){vec3.subtract(e,o.position,s[v].position);var h=vec3.length(e),l=this.w(h);c+=s[v].mass*l}this.densities[r]=c,this.pressures[r]=i*i*(this.densities[r]-this.density)}for(var u=b,p=g,d=x,f=w,m=M,r=0;r!==t;r++){var E=this.particles[r];vec3.set(u,0,0,0),vec3.set(p,0,0,0);for(var S,q,s=this.neighbors[r],n=s.length,v=0;v!==n;v++){var N=s[v];vec3.subtract(f,E.position,N.position);var P=vec3.length(f);S=-N.mass*(this.pressures[r]/(this.densities[r]*this.densities[r]+a)+this.pressures[v]/(this.densities[v]*this.densities[v]+a)),this.gradw(f,d),vec3.scale(d,d,S),vec3.add(u,u,d),vec3.subtract(m,N.velocity,E.velocity),vec3.scale(m,m,1/(1e-4+this.densities[r]*this.densities[v])*this.viscosity*N.mass),q=this.nablaw(P),vec3.scale(m,m,q),vec3.add(p,p,m)}vec3.scale(p,p,E.mass),vec3.scale(u,u,E.mass),vec3.add(E.force,E.force,p),vec3.add(E.force,E.force,u)}},t.SPHSystem.prototype.w=function(t){var e=this.smoothingRadius;return 315/(64*Math.PI*Math.pow(e,9))*Math.pow(e*e-t*t,3)},t.SPHSystem.prototype.gradw=function(t,e){var i=vec3.length(t);h=this.smoothingRadius,vec3.scale(e,t,945/(32*Math.PI*Math.pow(h,9))*Math.pow(h*h-i*i,2))},t.SPHSystem.prototype.nablaw=function(t){var e=this.smoothingRadius,i=945/(32*Math.PI*Math.pow(e,9))*(e*e-t*t)*(7*t*t-3*e*e);return i},t.Box=function(e){t.Shape.call(this),this.halfExtents=e,this.type=t.Shape.types.BOX,this.convexPolyhedronRepresentation=null,this.updateConvexPolyhedronRepresentation()},t.Box.prototype=new t.Shape,t.Box.prototype.constructor=t.Box,t.Box.prototype.updateConvexPolyhedronRepresentation=function(){var e=this.halfExtents[0],i=this.halfExtents[1],a=this.halfExtents[2],r=new t.ConvexPolyhedron([vec3.fromValues(-e,-i,-a),vec3.fromValues(e,-i,-a),vec3.fromValues(e,i,-a),vec3.fromValues(-e,i,-a),vec3.fromValues(-e,-i,a),vec3.fromValues(e,-i,a),vec3.fromValues(e,i,a),vec3.fromValues(-e,i,a)],[[3,2,1,0],[4,5,6,7],[5,4,1,0],[2,3,6,7],[0,4,7,3],[1,2,5,6]],[vec3.fromValues(0,0,-1),vec3.fromValues(0,0,1),vec3.fromValues(0,-1,0),vec3.fromValues(0,1,0),vec3.fromValues(-1,0,0),vec3.fromValues(1,0,0)]);this.convexPolyhedronRepresentation=r},t.Box.prototype.calculateLocalInertia=function(t,e){e=e||vec3.create();var i=this.halfExtents;return vec3.set(e,1/12*t*(2*2*i[1]*i[1]+2*2*i[2]*i[2]),1/12*t*(2*2*i[0]*i[0]+2*2*i[2]*i[2]),1/12*t*(2*2*i[1]*i[1]+2*2*i[0]*i[0])),e},t.Box.prototype.getSideNormals=function(t,e){var i=t,a=this.halfExtents;if(vec3.set(i[0],a[0],0,0),vec3.set(i[1],0,a[1],0),vec3.set(i[2],0,0,a[2]),vec3.set(i[3],-a[0],0,0),vec3.set(i[4],0,-a[1],0),vec3.set(i[5],0,0,-a[2]),void 0!==e)for(var r=0;r!==i.length;r++)vec3.transformQuat(i[r],i[r],e);return i},t.Box.prototype.volume=function(){return 8*this.halfExtents[0]*this.halfExtents[1]*this.halfExtents[2]},t.Box.prototype.computeBoundingSphereRadius=function(){this.boundingSphereRadius=vec3.length(this.halfExtents),this.boundingSphereRadiusNeedsUpdate=!1};var E=vec3.create();vec3.create();var S=[vec3.create(),vec3.create(),vec3.create(),vec3.create(),vec3.create(),vec3.create(),vec3.create(),vec3.create()];t.Box.prototype.forEachWorldCorner=function(t,e,i){var a=this.halfExtents,r=S;vec3.set(r[0],a[0],a[1],a[2]),vec3.set(r[1],-a[0],a[1],a[2]),vec3.set(r[2],-a[0],-a[1],a[2]),vec3.set(r[3],-a[0],-a[1],-a[2]),vec3.set(r[4],a[0],-a[1],-a[2]),vec3.set(r[5],a[0],a[1],-a[2]),vec3.set(r[6],-a[0],a[1],-a[2]),vec3.set(r[7],a[0],-a[1],a[2]);for(var o=0;o!==r.length;o++)vec3.transformQuat(E,r[o],e),vec3.add(E,E,t),i(E[0],E[1],E[2])},t.Box.prototype.calculateWorldAABB=function(t,e,i,a){vec3.set(i,1/0,1/0,1/0),vec3.set(a,-1/0,-1/0,-1/0),this.forEachWorldCorner(t,e,function(t,e,r){t>a[0]&&(a[0]=t),e>a[1]&&(a[1]=e),r>a[2]&&(a[2]=r),i[0]>t&&(i[0]=t),i[1]>e&&(i[1]=e),i[2]>r&&(i[2]=r)})},t.Plane=function(){t.Shape.call(this),this.type=t.Shape.types.PLANE,this.worldNormal=vec3.create(),this.worldNormalNeedsUpdate=!0},t.Plane.prototype=new t.Shape,t.Plane.prototype.constructor=t.Plane,t.Plane.prototype.computeWorldNormal=function(t){var e=this.worldNormal;vec3.set(e,0,0,1),vec3.transformQuat(e,e,t),this.worldNormalNeedsUpdate=!1},t.Plane.prototype.calculateLocalInertia=function(t,e){return e=e||vec3.create()},t.Plane.prototype.volume=function(){return 1/0};var q=vec3.create();t.Plane.prototype.calculateWorldAABB=function(t,e,i,a){vec3.set(q,0,0,1),vec3.transformQuat(q,q,e),vec3.set(i,-1/0,-1/0,-1/0),vec3.set(a,1/0,1/0,1/0),1===q[0]&&(a[0]=t[0]),1===q[1]&&(a[1]=t[1]),1===q[2]&&(a[2]=t[2]),-1===q[0]&&(i[0]=t[0]),-1===q[1]&&(i[1]=t[1]),-1===q[2]&&(i[2]=t[2])},t.Compound=function(){t.Shape.call(this),this.type=t.Shape.types.COMPOUND,this.childShapes=[],this.childOffsets=[],this.childOrientations=[]},t.Compound.prototype=new t.Shape,t.Compound.prototype.constructor=t.Compound,t.Compound.prototype.addChild=function(t,e,i){e=e||vec3.create(),i=i||quat.create(),this.childShapes.push(t),this.childOffsets.push(e),this.childOrientations.push(i)},t.Compound.prototype.volume=function(){for(var t=0,e=this.childShapes.length,i=0;i!==e;i++)t+=this.childShapes[i].volume();return t};var N=vec3.create(),P=vec3.create();t.Compound.prototype.calculateLocalInertia=function(t,e){e=e||vec3.create();for(var i=this.volume(),a=P,r=0,o=this.childShapes.length;r!==o;r++){var s=this.childShapes[r],n=this.childOffsets[r];this.childOrientations[r];var c=s.volume()/i*t;s.calculateLocalInertia(c,a),vec3.add(e,e,a);var v=N;vec3.set(v,c*n[0]*n[0],c*n[1]*n[1],c*n[2]*n[2]),vec3.add(e,e,v)}return e},t.Compound.prototype.computeBoundingSphereRadius=function(){for(var t=0,e=0;this.childShapes.length>e;e++){var i=this.childShapes[e];i.boundingSphereRadiusNeedsUpdate&&i.computeBoundingSphereRadius();var a=vec3.length(this.childOffsets[e])+i.boundingSphereRadius;a>t&&(t=a)}this.boundingSphereRadius=t,this.boundingSphereRadiusNeedsUpdate=!1};var j=vec3.create(),z=vec3.create(),C=vec3.create(),I=new t.Quaternion;t.Compound.prototype.calculateWorldAABB=function(t,e,i,a){var r=this.childShapes.length;vec3.set(i,1/0,1/0,1/0),vec3.set(a,-1/0,-1/0,-1/0);for(var o=0;o!==r;o++)vec3.copy(C,this.childOffsets[o]),vec3.transformQuaternion(C,C,e),vec3.add(C,C,t),vec3.transformQuaternion(I,this.childOrientations[o],e),this.childShapes[o].calculateWorldAABB(C,I,z,j),z[0]<i[0]&&(i[0]=z[0]),z[1]<i[1]&&(i[1]=z[1]),z[2]<i[2]&&(i[2]=z[2]),j[0]>a[0]&&(a[0]=j[0]),j[1]>a[1]&&(a[1]=j[1]),j[2]>a[2]&&(a[2]=j[2])},t.ConvexPolyhedron=function(e,i){function a(t,e,i,a){vec3.subtract(v,e,t),vec3.subtract(c,i,e),vec3.cross(a,c,v),vec3.normalize(a,a)}function r(t,e,i,a,r){for(var o=t.vertices.length,s=null,n=null,c=t.vertices,v=0;o>v;v++){vec3.copy(M,c[v]),vec3.transformQuat(M,M,a),vec3.add(M,M,i);var h=vec3.dot(M,e);(null===s||h>s)&&(s=h),(null===n||n>h)&&(n=h)}if(n>s){var l=n;n=s,s=l}r[0]=s,r[1]=n}function o(t,e){var i=n.faces[t],r=n.vertices[i[0]],o=n.vertices[i[1]],s=n.vertices[i[2]];return a(r,o,s,e)}function s(t){var e=n.faces[t],i=n.faceNormals[t],a=n.vertices[e[0]],r=-vec3.dot(i,a);return r}var n=this;t.Shape.call(this),this.type=t.Shape.types.CONVEXPOLYHEDRON;var c=vec3.create(),v=vec3.create();this.vertices=e||[],this.worldVertices=[],this.worldVerticesNeedsUpdate=!0,this.faces=i||[],this.faceNormals=[];for(var h=0;this.faces.length>h;h++){for(var l=0;this.faces[h].length>l;l++)if(!this.vertices[this.faces[h][l]])throw Error("Vertex "+this.faces[h][l]+" not found!");var u=vec3.create();o(h,u),vec3.negate(u,u),this.faceNormals.push(u);var p=this.vertices[this.faces[h][0]];if(0>vec3.dot(u,p)){console.warn("Face normal "+h+" ("+(""+u)+") looks like it points into the shape? The vertices follow. Make sure they are ordered CCW around the normal, using the right hand rule.");for(var l=0;this.faces[h].length>l;l++)console.warn("Vertex "+this.faces[h][l]+": ("+(""+this.vertices[i[h][l]])+")")}}this.worldFaceNormalsNeedsUpdate=!0,this.worldFaceNormals=[],this.uniqueEdges=[];for(var d=this.vertices.length,f=0;d>f;f++){var m=this.vertices[f];this.uniqueEdges.push(m)}for(var h=0;this.faces.length>h;h++)for(var y=this.faces[h].length,b=y,l=0;b>l;l++){var g=(l+1)%y,x=vec3.create();vec3.subtract(x,this.vertices[this.faces[h][l]],this.vertices[this.faces[h][g]]),vec3.normalize(x,x);for(var w=!1,m=0;this.uniqueEdges.length>m;m++)if(vec3.almostEquals(this.uniqueEdges[m],x)||vec3.almostEquals(this.uniqueEdges[m],x)){w=!0;break}w||this.uniqueEdges.push(x),x&&(x.face1=h)}var M=vec3.create();this.testSepAxis=function(t,e,i,a,o,s){var n=[],c=[],v=this;r(v,t,i,a,n),r(e,t,o,s,c);var h=n[0],l=n[1],u=c[0],p=c[1];if(p>h||l>u)return!1;var d=h-p,f=u-l,m=f>d?d:f;return m};var E=vec3.create(),S=vec3.create(),q=vec3.create(),N=vec3.create(),P=vec3.create(),j=vec3.create();this.findSeparatingAxis=function(t,e,i,a,r,o){for(var s=1/0,n=this,c=0,v=n.faces.length,h=0;v>h;h++){vec3.copy(E,n.faceNormals[h]),vec3.transformQuat(E,E,i);var l=n.testSepAxis(E,t,e,i,a,r);if(l===!1)return!1;s>l&&(s=l,vec3.copy(o,E))}for(var u=t.faces.length,h=0;u>h;h++){vec3.copy(S,t.faceNormals[h]),vec3.transformQuat(S,S,r),c++;var l=n.testSepAxis(S,t,e,i,a,r);if(l===!1)return!1;s>l&&(s=l,vec3.copy(o,S))}for(var p=0,d=0;n.uniqueEdges.length>d;d++){vec3.copy(N,n.uniqueEdges[d]),vec3.transformQuat(N,N,i);for(var f=0;t.uniqueEdges.length>f;f++)if(vec3.copy(P,t.uniqueEdges[f]),vec3.transformQuat(P,P,r),vec3.cross(j,N,P),p++,!vec3.almostZero(j)){vec3.normalize(j,j);var m=n.testSepAxis(j,t,e,i,a,r);if(m===!1)return!1;s>m&&(s=m,vec3.copy(o,j))}}return vec3.subtract(q,a,e),vec3.dot(q,o)>0&&vec3.negate(o,o),!0};var z=vec3.create();this.clipAgainstHull=function(t,e,i,a,r,o,s,n,c){for(var v=-1,h=-1/0,l=0;i.faces.length>l;l++){vec3.copy(z,i.faceNormals[l]),vec3.transformQuat(z,z,r);var u=vec3.dot(z,o);u>h&&(h=u,v=l)}for(var p=[],d=i.faces[v],f=d.length,m=0;f>m;m++){var y=i.vertices[d[m]],b=vec3.create();vec3.copy(b,y),vec3.transformQuat(b,b,r),vec3.add(b,a,b),p.push(b)}v>=0&&this.clipFaceAgainstHull(o,t,e,p,s,n,c)};var C=vec3.create(),I=vec3.create(),V=vec3.create(),B=vec3.create(),R=vec3.create(),O=vec3.create(),A=vec3.create(),T=vec3.create();this.clipFaceAgainstHull=function(t,e,i,a,r,o,n){r=Number(r),o=Number(o);for(var c=this,v=[],h=a,l=v,u=-1,p=1/0,d=0;c.faces.length>d;d++){vec3.copy(C,c.faceNormals[d]),vec3.transformQuat(C,C,i);var f=vec3.dot(C,t);p>f&&(p=f,u=d)}if(0>u)return console.log("--- did not find any closest face... ---"),void 0;var m=c.faces[u];m.connectedFaces=[];for(var y=0;c.faces.length>y;y++)for(var b=0;c.faces[y].length>b;b++)-1!==m.indexOf(c.faces[y][b])&&y!==u&&-1===m.connectedFaces.indexOf(y)&&m.connectedFaces.push(y);h.length;for(var g=m.length,x=0;g>x;x++){var w=c.vertices[m[x]],M=c.vertices[m[(x+1)%g]];vec3.subtract(I,w,M),vec3.copy(V,I),vec3.transformQuat(V,V,i),vec3.add(V,e,V),vec3.copy(B,this.faceNormals[u]),vec3.transformQuat(B,B,i),vec3.add(B,e,B),vec3.cross(R,V,B),vec3.negate(R,R),vec3.copy(O,w),vec3.transformQuat(O,O,i),vec3.add(O,e,O);var E,S=(-vec3.dot(O,R),m.connectedFaces[x]);vec3.copy(A,this.faceNormals[S]);var q=s(S);vec3.copy(T,A),vec3.transformQuat(T,T,i);var E=q-vec3.dot(T,e);for(this.clipFaceAgainstPlane(h,l,T,E);h.length;)h.shift();for(;l.length;)h.push(l.shift())}vec3.copy(A,this.faceNormals[u]);var q=s(u);vec3.copy(T,A),vec3.transformQuat(T,T,i);for(var E=q-vec3.dot(T,e),y=0;h.length>y;y++){var N=vec3.dot(T,h[y])+E;if(r>=N&&(console.log("clamped: depth="+N+" to minDist="+(r+"")),N=r),o>=N){var P=h[y];if(0>=N){var j={point:P,normal:T,depth:N};n.push(j)}}}},this.clipFaceAgainstPlane=function(t,e,i,a){var r,o,s=t.length;if(2>s)return e;var n=t[t.length-1],c=t[0];r=vec3.dot(i,n)+a;for(var v=0;s>v;v++){if(c=t[v],o=vec3.dot(i,c)+a,0>r)if(0>o){var h=vec3.create();vec3.copy(h,c),e.push(h)}else{var h=vec3.create();vec3.lerp(h,n,c,r/(r-o)),e.push(h)}else if(0>o){var h=vec3.create();vec3.lerp(h,n,c,r/(r-o)),e.push(h),e.push(c)}n=c,r=o}return e};var n=this;this.calculateLocalInertia=function(t,e){n.computeAABB();var i=this.aabbmax[0]-this.aabbmin[0],a=this.aabbmax[1]-this.aabbmin[1],r=this.aabbmax[2]-this.aabbmin[2];e[0]=1/12*t*(2*2*a*a+2*2*r*r),e[1]=1/12*t*(2*2*i*i+2*2*r*r),e[2]=1/12*t*(2*2*a*a+2*2*i*i)},vec3.create(),this.computeAABB=function(){var t=this.vertices.length,e=this.aabbmin,i=this.aabbmax,a=this.vertices;vec3.set(e,1/0,1/0,1/0),vec3.set(i,-1/0,-1/0,-1/0);for(var r=0;r!==t;r++){var o=a[r];o[0]<e[0]?e[0]=o[0]:o[0]>i[0]&&(i[0]=o[0]),o[1]<e[1]?e[1]=o[1]:o[1]>i[1]&&(i[1]=o[1]),o[2]<e[2]?e[2]=o[2]:o[2]>i[2]&&(i[2]=o[2])}}},t.ConvexPolyhedron.prototype=new t.Shape,t.ConvexPolyhedron.prototype.constructor=t.ConvexPolyhedron,t.ConvexPolyhedron.prototype.computeWorldVertices=function(t,e){for(var i=this.vertices.length;i>this.worldVertices.length;)this.worldVertices.push(vec3.create());for(var a=this.vertices,r=this.worldVertices,o=0;o!==i;o++)vec3.transformQuat(r[o],a[o],e),vec3.add(r[o],t,r[o]);this.worldVerticesNeedsUpdate=!1},t.ConvexPolyhedron.prototype.computeWorldFaceNormals=function(t){for(var e=this.faceNormals.length;e>this.worldFaceNormals.length;)this.worldFaceNormals.push(vec3.create());for(var i=this.faceNormals,a=this.worldFaceNormals,r=0;r!==e;r++)vec3.transformQuat(a[r],i[r],t);this.worldFaceNormalsNeedsUpdate=!1},t.ConvexPolyhedron.prototype.computeBoundingSphereRadius=function(){for(var t=0,e=this.vertices,i=0,a=e.length;i!==a;i++){var r=vec3.squaredLength(e[i]);r>t&&(t=r)}this.boundingSphereRadius=Math.sqrt(t),this.boundingSphereRadiusNeedsUpdate=!1};var V=vec3.create();t.ConvexPolyhedron.prototype.calculateWorldAABB=function(t,e,i,a){for(var r,o,s,n,c,v,h=this.vertices.length,l=this.vertices,u=0;h>u;u++){vec3.copy(V,l[u]),vec3.transformQuat(V,V,e),vec3.add(V,t,V);var p=V;r>p.x||void 0===r?r=p.x:(p.x>n||void 0===n)&&(n=p.x),o>p.y||void 0===o?o=p.y:(p.y>c||void 0===c)&&(c=p.y),s>p.z||void 0===s?s=p.z:(p.z>v||void 0===v)&&(v=p.z)}vec3.set(i,r,o,s),vec3.set(a,n,c,v)},t.ConvexPolyhedron.prototype.volume=function(){return this.boundingSphereRadiusNeedsUpdate&&this.computeBoundingSphereRadius(),4*Math.PI*this.boundingSphereRadius/3},t.ConvexPolyhedron.prototype.getAveragePointLocal=function(t){t=t||vec3.create();for(var e=this.vertices.length,i=this.vertices,a=0;e>a;a++)vec3.add(t,t,i[a]);return vec3.scale(t,t,1/e),t},t.ConvexPolyhedron.prototype.transformAllPoints=function(t,e){var i=this.vertices.length,a=this.vertices;if(e){for(var r=0;i>r;r++){var o=a[r];vec3.transformQuat(o,o,e)}for(var r=0;this.faceNormals.length>r;r++){var o=this.faceNormals[r];vec3.transformQuat(o,o,e)}}if(t)for(var r=0;i>r;r++){var o=a[r];vec3.add(o,o,t)}};var B=vec3.create(),R=vec3.create(),O=vec3.create();t.ConvexPolyhedron.prototype.pointIsInside=function(t){var e=this.vertices.length,i=this.vertices,a=this.faces,r=this.faceNormals,o=null,s=this.faces.length,n=B;this.getAveragePointLocal(n);for(var c=0;s>c;c++){this.faces[c].length;var e=r[c],v=i[a[c][0]],h=R;vec3.subtract(h,t,v);var l=vec3.dot(e,h),u=O;vec3.subtract(u,n,v);var p=vec3.dot(e,u);if(0>l&&p>0||l>0&&0>p)return!1}return o?1:-1},t.Cylinder=function(e,i,a,r){var o=r,s=[],n=[],c=[],v=[],h=[],l=Math.cos,u=Math.sin;s.push(vec3.fromValues(i*l(0),i*u(0),.5*-a)),v.push(0),s.push(vec3.fromValues(e*l(0),e*u(0),.5*a)),h.push(1);for(var p=0;o>p;p++){var d=2*Math.PI/o*(p+1),f=2*Math.PI/o*(p+.5);o-1>p?(s.push(vec3.fromValues(i*l(d),i*u(d),.5*-a)),v.push(2*p+2),s.push(vec3.fromValues(e*l(d),e*u(d),.5*a)),h.push(2*p+3),n.push(vec3.fromValues(l(f),u(f),0)),c.push([2*p+2,2*p+3,2*p+1,2*p])):(c.push([0,1,2*p+1,2*p]),n.push(vec3.fromValues(l(f),u(f),0)))}c.push(h),n.push(vec3.fromValues(0,0,1));
for(var m=[],p=0;v.length>p;p++)m.push(v[v.length-p-1]);c.push(m),n.push(vec3.fromValues(0,0,-1)),this.type=t.Shape.types.CONVEXPOLYHEDRON,t.ConvexPolyhedron.call(this,s,c,n)},t.Cylinder.prototype=new t.ConvexPolyhedron,t.Ray=function(e,i){function a(t,e,i){return i.vsub(t,d),u=d.dot(e),e.mult(u,f),f.vadd(t,f),p=i.distanceTo(f)}function r(t,e,i,a){a.vsub(e,d),i.vsub(e,m),t.vsub(e,y);var r,o,s=d.dot(d),n=d.dot(m),c=d.dot(y),v=m.dot(m),h=m.dot(y);return(r=v*c-n*h)>=0&&(o=s*h-n*c)>=0&&s*v-n*n>r+o}this.origin=e||new t.Vec3,this.direction=i||new t.Vec3;var o=1e-4;this.setPrecision=function(t){o=t};var s=new t.Vec3,n=new t.Vec3,c=new t.Vec3;new t.Vec3,new t.Vec3;var v=new t.Vec3,h=new t.Vec3,l=new t.Vec3;this.intersectBody=function(e){return e.shape instanceof t.ConvexPolyhedron?this.intersectShape(e.shape,e.quaternion,e.position,e):e.shape instanceof t.Box?this.intersectShape(e.shape.convexPolyhedronRepresentation,e.quaternion,e.position,e):(console.warn("Ray intersection is this far only implemented for ConvexPolyhedron and Box shapes."),void 0)},this.intersectShape=function(e,i,u,p){var d,f=[];if(e instanceof t.ConvexPolyhedron){var m=a(this.origin,this.direction,u);if(m>e.getBoundingSphereRadius())return f;for(var y,b,g=e.faces,x=e.vertices,w=e.faceNormals,M=0;g.length>M;M++){var E=g[M],S=w[M],q=i,N=u;if(x[E[0]].copy(v),q.vmult(v,v),v.vadd(N,v),v.vsub(this.origin,v),q.vmult(S,h),y=this.direction.dot(h),!(o>Math.abs(y))&&(b=h.dot(v)/y,!(0>b)&&0>y)){this.direction.mult(b,l),l.vadd(this.origin,l),x[E[0]].copy(s),q.vmult(s,s),N.vadd(s,s);for(var P=1;E.length-1>P;P++)if(x[E[P]].copy(n),x[E[P+1]].copy(c),q.vmult(n,n),q.vmult(c,c),N.vadd(n,n),N.vadd(c,c),r(l,s,n,c)){d={distance:this.origin.distanceTo(l),point:l.copy(),face:E,body:p},f.push(d);break}}}}return f},this.intersectBodies=function(t){for(var e=[],i=0,a=t.length;a>i;i++){var r=this.intersectBody(t[i]);Array.prototype.push.apply(e,r)}return e.sort(function(t,e){return t.distance-e.distance}),e};var u,p,d=new t.Vec3,f=new t.Vec3,m=new t.Vec3,y=new t.Vec3},t.Ray.prototype.constructor=t.Ray,t.Broadphase=function(){this.world=null,this.useBoundingBoxes=!1},t.Broadphase.prototype.constructor=t.BroadPhase,t.Broadphase.prototype.collisionPairs=function(){throw Error("collisionPairs not implemented for this BroadPhase class!")};var A=t.Body.STATIC|t.Body.KINEMATIC;t.Broadphase.prototype.needBroadphaseCollision=function(e,i){return 0===(e.collisionFilterGroup&i.collisionFilterMask)||0===(i.collisionFilterGroup&e.collisionFilterMask)?!1:0===(e.motionstate&A)&&!e.isSleeping()||0===(i.motionstate&A)&&!i.isSleeping()?e.shape||i.shape?e.shape instanceof t.Plane&&i.shape instanceof t.Plane?!1:!0:!1:!1},t.Broadphase.prototype.intersectionTest=function(t,e,i,a){this.useBoundingBoxes?this.doBoundingBoxBroadphase(t,e,i,a):this.doBoundingSphereBroadphase(t,e,i,a)};var T=vec3.create(),F=vec3.create(),Q=(quat.create(),vec3.create());t.Broadphase.prototype.doBoundingSphereBroadphase=function(e,i,a,r){var o=t.Shape.types,s=o.SPHERE|o.BOX|o.COMPOUND|o.CONVEXPOLYHEDRON,n=o.PLANE;t.Body.STATIC|t.Body.KINEMATIC;var c=T,v=F,h=Q,l=e.shape,u=i.shape;if(l&&u){var p=l.type,d=u.type;if(p&s&&d&s){vec3.subtract(c,i.position,e.position),l.boundingSphereRadiusNeedsUpdate&&l.computeBoundingSphereRadius(),u.boundingSphereRadiusNeedsUpdate&&u.computeBoundingSphereRadius();var f=l.boundingSphereRadius+u.boundingSphereRadius;f*f>vec3.squaredLength(c)&&(a.push(e),r.push(i))}else if(p&s&&d&o.PLANE||d&s&&p&o.PLANE){var m=p===n?e:i,y=p!==n?e:i,b=y.shape,g=m.shape;vec3.subtract(c,y.position,m.position),g.worldNormalNeedsUpdate&&g.computeWorldNormal(m.quaternion),v=g.worldNormal,b.boundingSphereRadiusNeedsUpdate&&b.computeBoundingSphereRadius();var x=vec3.dot(c,v)-b.boundingSphereRadius;0>x&&(a.push(e),r.push(i))}}else if(l||u){var w=l?i:e,M=l?e:i,b=M.shape,E=b.type;if(E&s){if(E===o.SPHERE)vec3.subtract(h,w.position,M.position),b.radius*b.radius>=vec3.squaredLength(h)&&(a.push(w),r.push(M));else if(E===o.CONVEXPOLYHEDRON||E===o.BOX||E===o.COMPOUND){b.boundingSphereRadiusNeedsUpdate&&b.computeBoundingSphereRadius();var S=b.boundingSphereRadius;vec3.subtract(h,w.position,M.position),S*S>=vec3.squaredLength(h)&&(a.push(w),r.push(M))}}else if(E===o.PLANE){var q=M;vec3.set(v,0,0,1),vec3.transformQuat(v,v,q.quaternion),vec3.subtract(h,w.position,q.position),0>=vec3.dot(v,h)&&(a.push(w),r.push(M))}}else;},t.Broadphase.prototype.doBoundingBoxBroadphase=function(e,i,a,r){var o=e.shape,s=i.shape;if(e.aabbNeedsUpdate&&e.computeAABB(),i.aabbNeedsUpdate&&i.computeAABB(),o&&s)e.aabbmax.x<i.aabbmin.x||e.aabbmax.y<i.aabbmin.y||e.aabbmax.z<i.aabbmin.z||e.aabbmin.x>i.aabbmax.x||e.aabbmin.y>i.aabbmax.y||e.aabbmin.z>i.aabbmax.z||(a.push(e),r.push(i));else if(o||s){var n=o?i:e,c=o?e:i;c.shape instanceof t.Plane,n.position.x<c.aabbmin.x||n.position.y<c.aabbmin.y||n.position.z<c.aabbmin.z||n.position.x>c.aabbmax.x||n.position.y>c.aabbmax.y||n.position.z>c.aabbmax.z||(a.push(e),r.push(i))}else;};var L={},k=[],U=[];t.Broadphase.prototype.makePairsUnique=function(t,e){for(var i=L,a=k,r=U,o=t.length,s=0;s!==o;s++)a[s]=t[s],r[s]=e[s];t.length=0,e.length=0;for(var s=0;s!==o;s++){var n=a[s].id,c=r[s].id,v=c>n?n+","+c:c+","+n;i[v]=s}for(var v in i){var s=i[v];t.push(a[s]),e.push(r[s]),delete i[v]}},t.NaiveBroadphase=function(){t.Broadphase.apply(this)},t.NaiveBroadphase.prototype=new t.Broadphase,t.NaiveBroadphase.prototype.constructor=t.NaiveBroadphase,t.NaiveBroadphase.prototype.collisionPairs=function(t,e,i){var a,r,o,s,n=t.bodies,c=n.length;for(a=0;a!==c;a++)for(r=0;r!==a;r++)o=n[a],s=n[r],this.needBroadphaseCollision(o,s)&&this.intersectionTest(o,s,e,i)},t.GridBroadphase=function(e,i,a,r,o){t.Broadphase.apply(this),this.nx=a||10,this.ny=r||10,this.nz=o||10,this.aabbMin=e||new t.Vec3(100,100,100),this.aabbMax=i||new t.Vec3(-100,-100,-100),this.bins=[]},t.GridBroadphase.prototype=new t.Broadphase,t.GridBroadphase.prototype.constructor=t.GridBroadphase;var W=new t.Vec3,D=new t.Vec3;t.GridBroadphase.prototype.collisionPairs=function(e,i,a){var r=e.numObjects(),o=e.bodies,s=this.aabbMax,n=this.aabbMin,c=this.nx,v=this.ny,h=this.nz,l=s.x,u=s.y,p=s.z,d=n.x,f=n.y,m=n.z,y=c/(l-d),b=v/(u-f),g=h/(p-m),x=(l-d)/c,w=(u-f)/v,M=(p-m)/h,E=t.Shape.types,S=E.SPHERE,q=E.PLANE;E.BOX,E.COMPOUND,E.CONVEXPOLYHEDRON;for(var N=this.bins,P=c*v*h,j=N.length-1;j!==P;j++)N.push([]);for(var j=0;j!==P;j++)N[j].length=0;for(var z=Math.floor,j=0;j!==r;j++){var C=o[j],I=C.shape;switch(I.type){case S:for(var V=C.position.x,B=C.position.y,R=C.position.z,O=I.radius,A=z(y*(V-O-d)),T=z(b*(B-O-f)),F=z(g*(R-O-m)),Q=z(y*(V+O-d)),L=z(b*(B+O-f)),k=z(g*(R+O-m)),U=A;U!==Q+1;U++)for(var H=T;H!==L+1;H++)for(var X=F;X!==k+1;X++){var G=U,Y=H,_=X,Z=G*(v-1)*(h-1)+Y*(h-1)+_;Z>=0&&P>Z&&N[Z].push(C)}break;case q:var K=W,J=D,$=.25*(x*x+w*w+M*M),te=I.worldNormal;I.worldNormalNeedsUpdate&&I.computeWorldNormal(C.quaternion);for(var U=0;U!==c;U++)for(var H=0;H!==v;H++)for(var X=0;X!==h;X++){var G=U,Y=H,_=X;if(J.set(G*x+d,Y*w+f,_*M+m),J.vsub(C.position,K),$>K.dot(te)){var Z=G*(v-1)*(h-1)+Y*(h-1)+_;N[Z].push(C)}}break;default:console.warn("Shape "+I.type+" not supported in GridBroadphase!")}}for(var j=0;j!==P;j++)for(var ee=N[j],U=0,ie=ee.length;U!==ie;U++)for(var C=ee[U],H=0;H!==U;H++){var ae=ee[H];this.needBroadphaseCollision(C,ae)&&this.intersectionTest(C,ae,i,a)}this.makePairsUnique(i,a)},t.Solver=function(){this.equations=[]},t.Solver.prototype.solve=function(){return 0},t.Solver.prototype.addEquation=function(t){this.equations.push(t)},t.Solver.prototype.removeEquation=function(t){var e=this.equations,i=e.indexOf(t);-1!==i&&e.splice(i,1)},t.Solver.prototype.removeAllEquations=function(){this.equations.length=0},t.GSSolver=function(){t.Solver.call(this),this.iterations=10,this.tolerance=0},t.GSSolver.prototype=new t.Solver;var H=[],X=[],G=[];t.GSSolver.prototype.solve=function(t,e){var i,a,r,o,s,n,c=(this.d,this.k,0),v=this.iterations,h=this.tolerance*this.tolerance,l=(this.a,this.b),u=this.equations,p=u.length,d=e.bodies,f=d.length,m=t,y=X,b=G,g=H;y.length=0,b.length=0,g.length=0;for(var x=0;x!==p;x++){var w=u[x];w.spookParamsNeedsUpdate&&(w.updateSpookParams(m),w.spookParamsNeedsUpdate=!1),g[x]=0,b[x]=w.computeB(m),y[x]=1/w.computeC()}if(0!==p){for(var x=0;x!==f;x++){var l=d[x],M=l.vlambda,E=l.wlambda;vec3.set(M,0,0,0),E&&vec3.set(E,0,0,0)}for(c=0;c!==v;c++){o=0;for(var S=0;S!==p;S++){var w=u[S];i=b[S],a=y[S],n=g[S],s=w.computeGWlambda(),r=a*(i-s-w.eps*n),w.minForce>n+r?r=w.minForce-n:n+r>w.maxForce&&(r=w.maxForce-n),g[S]+=r,o+=r>0?r:-r,w.addToWlambda(r)}if(h>o*o)break}for(var x=0;x!==f;x++){var l=d[x],q=l.velocity,N=l.angularVelocity;vec3.add(q,q,l.vlambda),N&&vec3.add(N,N,l.wlambda)}}return c},t.SplitSolver=function(e){t.Solver.call(this),this.subsolver=e},t.SplitSolver.prototype=new t.Solver;var Y=[],_=[],Z=[],K={bodies:null};t.SplitSolver.prototype.solve=function(e,i){function a(t){for(var e=t.length,i=0;i!==e;i++){var a=t[i];if(!(a.visited||a.body.motionstate&x))return a}return!1}function r(t,e){var i=[];for(i.push(t),t.visited=!0,e(t);i.length;)for(var r,o=i.pop();r=a(o.children);)r.visited=!0,e(r),i.push(r)}function o(t){E.push(t.body);for(var e=t.eqs.length,i=0;i!==e;i++){var a=t.eqs[i];-1===M.indexOf(a)&&M.push(a)}}for(var s=Y,n=i.bodies,c=this.equations,v=c.length,h=n.length,l=this.subsolver,u=s.length;u!==h;u++)s.push({body:n[u],children:[],eqs:[],visited:!1});for(var u=0;u!==h;u++){var p=s[u];p.body=n[u],p.children.length=0,p.eqs.length=0,p.visited=!1}for(var d=0;d!==v;d++){var f=c[d],u=n.indexOf(f.bi),m=n.indexOf(f.bj),y=s[u],b=s[m];y.children.push(b),y.eqs.push(f),b.children.push(y),b.eqs.push(f)}for(var g,x=t.Body.STATIC,w=0,M=_,E=Z,S=K;g=a(s);){M.length=0,E.length=0,r(g,o);for(var q=M.length,u=0;u!==q;u++)l.addEquation(M[u]);S.bodies=E,l.solve(e,S),l.removeAllEquations(),w++}return w},t.Material=function(t){this.name=t,this.id=-1},t.ContactMaterial=function(t,e,i,a){this.id=-1,this.materials=[t,e],this.friction=void 0!==i?Number(i):.3,this.restitution=void 0!==a?Number(a):.3,this.contactEquationStiffness=1e7,this.contactEquationRegularizationTime=3,this.frictionEquationStiffness=1e7,this.frictionEquationRegularizationTime=3},t.World=function(){t.EventTarget.apply(this),this.allowSleep=!1,this.contacts=[],this.frictionEquations=[],this.quatNormalizeSkip=0,this.quatNormalizeFast=!1,this.time=0,this.stepnumber=0,this.default_dt=1/60,this.last_dt=this.default_dt,this.nextId=0,this.gravity=vec3.create(),this.broadphase=null,this.bodies=[],this.solver=new t.GSSolver,this.constraints=[],this.contactgen=new t.ContactGenerator,this.collisionMatrix=[],this.collisionMatrixPrevious=[],this.materials=[],this.contactmaterials=[],this.mats2cmat=[],this.defaultMaterial=new t.Material("default"),this.defaultContactMaterial=new t.ContactMaterial(this.defaultMaterial,this.defaultMaterial,.3,0),this.doProfiling=!1,this.profile={solve:0,makeContactConstraints:0,broadphase:0,integrate:0,nearphase:0},this.subsystems=[]},t.World.prototype.getContactMaterial=function(e,i){if(e instanceof t.Material&&i instanceof t.Material){var a=e.id,r=i.id;if(r>a){var o=a;a=r,r=o}return this.contactmaterials[this.mats2cmat[a+r*this.materials.length]]}},t.World.prototype.numObjects=function(){return this.bodies.length},t.World.prototype.collisionMatrixGet=function(t,e,i){if(e>t){var a=e;e=t,t=a}return t=(t*(t+1)>>1)+e-1,i===void 0||i?this.collisionMatrix[t]:this.collisionMatrixPrevious[t]},t.World.prototype.collisionMatrixSet=function(t,e,i,a){if(e>t){var r=e;e=t,t=r}t=(t*(t+1)>>1)+e-1,a===void 0||a?this.collisionMatrix[t]=i:this.collisionMatrixPrevious[t]=i},t.World.prototype.collisionMatrixTick=function(){var t=this.collisionMatrixPrevious;this.collisionMatrixPrevious=this.collisionMatrix,this.collisionMatrix=t;for(var e=0,i=this.collisionMatrix.length;e!==i;e++)this.collisionMatrix[e]=0},t.World.prototype.add=function(e){e.id=this.id(),e.index=this.bodies.length,this.bodies.push(e),e.world=this,vec3.copy(e.initPosition,e.position),vec3.copy(e.initVelocity,e.velocity),e.timeLastSleepy=this.time,e instanceof t.RigidBody&&(vec3.copy(e.initAngularVelocity,e.angularVelocity),quat.copy(e.initQuaternion,e.quaternion));var i=this.numObjects();this.collisionMatrix.length=i*(i-1)>>1},t.World.prototype.addConstraint=function(t){this.constraints.push(t),t.id=this.id()},t.World.prototype.removeConstraint=function(t){var e=this.constraints.indexOf(t);-1!==e&&this.constraints.splice(e,1)},t.World.prototype.id=function(){return this.nextId++},t.World.prototype.remove=function(t){t.world=null;var e=this.numObjects()-1,i=this.bodies;i.splice(t.index,1);for(var a=t.index;e>a;a++)i[a].index=a;this.collisionMatrixPrevious.length=this.collisionMatrix.length=e*(e-1)>>1},t.World.prototype.addMaterial=function(t){if(-1===t.id){var e=this.materials.length;this.materials.push(t),t.id=this.materials.length-1;for(var i=0;i!==2*e+1;i++)this.mats2cmat.push(-1)}},t.World.prototype.addContactMaterial=function(t){this.addMaterial(t.materials[0]),this.addMaterial(t.materials[1]);var e,i;t.materials[0].id>t.materials[1].id?(e=t.materials[0].id,i=t.materials[1].id):(i=t.materials[0].id,e=t.materials[1].id),this.contactmaterials.push(t),t.id=this.contactmaterials.length-1,this.mats2cmat[e+this.materials.length*i]=t.id},t.World.prototype._now=function(){return window.performance.webkitNow?window.performance.webkitNow():Date.now()};var J={type:"postStep"},$={type:"collide","with":null,contact:null},te=[],ee=[],ie=[],ae=[],re=vec3.create(),oe=(vec3.create(),vec3.create(),vec3.create(),vec3.create(),vec3.create(),vec3.create(),vec3.create(),vec3.create(),vec3.create(),quat.create(),quat.create()),se=quat.create();t.World.prototype.step=function(e){var i,a=this.contacts,r=ie,o=ae,s=this.numObjects(),n=this.bodies,c=this.solver,v=this.gravity,h=this.doProfiling,l=this.profile,u=t.Body.DYNAMIC,p=this._now,d=this.constraints,f=t.FrictionEquation,m=ee,y=vec3.length(v),b=0;for(h&&(i=p()),void 0===e&&(e=this.last_dt||this.default_dt),b=0;b!==s;b++){var g=n[b];if(g.motionstate&u){var x=g.force,w=g.mass;vec3.scaleAndAdd(x,x,v,w)}}for(var b=0,M=this.subsystems.length;b!==M;b++)this.subsystems[b].update();h&&(i=p()),r.length=0,o.length=0,this.broadphase.collisionPairs(this,r,o),h&&(l.broadphase=p()-i),this.collisionMatrixTick(),h&&(i=p());var E=te,S=a.length;for(b=0;b!==S;b++)E.push(a[b]);a.length=0,this.contactgen.getContacts(r,o,this,a,E),h&&(l.nearphase=p()-i),h&&(i=p());var q=a.length,N=this.frictionEquations.length;for(b=0;b!==N;b++)m.push(this.frictionEquations[b]);this.frictionEquations.length=0;for(var P=0;P!==q;P++){var j=a[P],g=j.bi,z=j.bj,b=n.indexOf(g),C=n.indexOf(z),I=this.getContactMaterial(g.material,z.material)||this.defaultContactMaterial,V=I.friction;I.restitution;var B=re;vec3.set(B,0,0,0),vec3.add(B,B,z.position),vec3.add(B,B,j.rj),vec3.subtract(B,B,g.position),vec3.subtract(B,B,j.ri);var R=vec3.dot(B,j.ni);if(0>R){if(j.restitution=I.restitution,j.penetration=R,j.stiffness=I.contactEquationStiffness,j.regularizationTime=I.contactEquationRegularizationTime,c.addEquation(j),V>0){var O=g.invMass+z.invMass;O>0&&(O=1/O);var A=V*y,T=m,F=T.length?T.pop():new f(g,z,A*O),Q=T.length?T.pop():new f(g,z,A*O);this.frictionEquations.push(F),this.frictionEquations.push(Q),F.bi=Q.bi=g,F.bj=Q.bj=z,F.minForce=Q.minForce=-A*O,F.maxForce=Q.maxForce=A*O,vec3.copy(F.ri,j.ri),vec3.copy(F.rj,j.rj),vec3.copy(Q.ri,j.ri),vec3.copy(Q.rj,j.rj),vec3.tangents(F.t,Q.t,j.ni),c.addEquation(F),c.addEquation(Q)}this.collisionMatrixSet(b,C,1,!0),this.collisionMatrixGet(b,C,!0)!==this.collisionMatrixGet(b,C,!1)&&($.with=z,$.contact=j,g.dispatchEvent($),$.with=g,z.dispatchEvent($),g.wakeUp(),z.wakeUp())}}h&&(l.makeContactConstraints=p()-i),h&&(i=p());var L=d.length;for(b=0;b!==L;b++){var j=d[b];j.update();for(var C=0,k=j.equations.length;C!==k;C++){var U=j.equations[C];c.addEquation(U)}}c.solve(e,this),h&&(l.solve=p()-i),c.removeAllEquations();var W=Math.pow;for(b=0;b!==s;b++){var g=n[b];if(g.motionstate&u){var D=W(1-g.linearDamping,e),H=g.velocity;vec3.scale(H,H,D);var X=g.angularVelocity;if(X){var G=W(1-g.angularDamping,e);vec3.scale(X,X,G)}}}for(this.dispatchEvent(J),b=0;b!==s;b++){var g=n[b];g.preStep&&g.preStep.call(g)}h&&(i=p());var Y=oe,_=se,Z=this.stepnumber,K=t.Body.DYNAMIC|t.Body.KINEMATIC,ne=0===Z%(this.quatNormalizeSkip+1),ce=this.quatNormalizeFast,ve=.5*e,he=t.Shape.types.PLANE,le=t.Shape.types.CONVEXPOLYHEDRON;for(b=0;b!==s;b++){var ue=n[b],pe=ue.shape,de=ue.force,fe=ue.tau;if(ue.motionstate&K){var me=ue.velocity,ye=ue.angularVelocity,be=ue.position,ge=ue.quaternion,xe=ue.invMass,we=ue.invInertia;if(vec3.scaleAndAdd(me,me,de,xe*e),ue.angularVelocity&&(ye[0]+=fe[0]*we[0]*e,ye[1]+=fe[1]*we[1]*e,ye[2]+=fe[2]*we[2]*e),ue.isSleeping()||(vec3.scaleAndAdd(be,be,me,e),ue.angularVelocity&&(quat.set(Y,ye[0],ye[1],ye[2],0),quat.mul(_,Y,ge),quat.scale(_,_,ve),quat.add(ge,ge,_),ne&&(ce?quat.normalize(ge,ge):quat.normalize(ge,ge))),ue.aabbmin&&(ue.aabbNeedsUpdate=!0)),pe)switch(pe.type){case he:pe.worldNormalNeedsUpdate=!0;break;case le:pe.worldFaceNormalsNeedsUpdate=!0,pe.worldVerticesNeedsUpdate=!0}}vec3.set(ue.force,0,0,0),ue.tau&&vec3.set(ue.tau,0,0,0)}for(h&&(l.integrate=p()-i),this.time+=e,this.stepnumber+=1,this.dispatchEvent(J),b=0;b!==s;b++){var g=n[b],Me=g.postStep;Me&&Me.call(g)}for(b=0;b!==s;b++){var ue=n[b];ue.inertiaWorldAutoUpdate&&ue.quaternion.vmult(ue.inertia,ue.inertiaWorld),ue.invInertiaWorldAutoUpdate&&ue.quaternion.vmult(ue.invInertia,ue.invInertiaWorld)}if(this.allowSleep)for(b=0;b!==s;b++)n[b].sleepTick(this.time)},t.ContactGenerator=function(){function e(e,i){if(m.length){var a=m.pop();return a.bi=e,a.bj=i,a}return new t.ContactEquation(e,i)}function i(t){var e;e=t.ri,t.ri=t.rj,t.rj=e,vec3.negate(t.ni,t.ni),e=t.bi,t.bi=t.bj,t.bj=e}function a(t,i,a,r,o,s,n,c,v){var h=e(c,v);vec3.subtract(h.ni,v.position,r),vec3.normalize(h.ni,h.ni),vec3.copy(h.ri,h.ni),vec3.copy(h.rj,h.ni),vec3.scale(h.ri,h.ri,i.radius),vec3.scale(h.rj,h.rj,-a.radius),t.push(h)}function r(t,i,a,r,o,s,n,c,v){var h=e(c,v);vec3.set(h.ni,0,0,1),vec3.transformQuat(h.ni,h.ni,n),vec3.scale(h.ni,h.ni,-1),vec3.normalize(h.ni,h.ni),vec3.scale(h.ri,h.ni,i.radius),vec3.subtract(b,r,o),vec3.scale(g,h.ni,vec3.dot(h.ni,b)),vec3.subtract(h.rj,b,g),vec3.squaredLength(g)<=i.radius*i.radius&&t.push(h)}function o(t,e,i){for(var a=null,r=t.length,o=0;o!==r;o++){var s=t[o],n=x;vec3.subtract(n,t[(o+1)%r],s);var c=w;vec3.cross(c,n,e);var v=M;vec3.subtract(v,i,s);var h=vec3.dot(c,v);if(!(null===a||h>0&&a===!0||0>=h&&a===!1))return!1;null===a&&(a=h>0)}return!0}function s(t,i,a,r,o,s,n,c,v){var h=P;vec3.subtract(E,r,o),a.getSideNormals(h,n);for(var l=i.radius,u=!1,p=z,d=C,f=I,m=null,b=0,g=0,x=0,w=null,M=0,V=h.length;M!==V&&u===!1;M++){var B=S;vec3.copy(B,h[M]);var R=vec3.length(B);vec3.normalize(B,B);var O=vec3.dot(E,B);if(R+l>O&&O>0){var A=q,T=N;vec3.copy(A,h[(M+1)%3]),vec3.copy(T,h[(M+2)%3]);var F=vec3.length(A),Q=vec3.length(T);vec3.normalize(A,A),vec3.normalize(T,T);var L=vec3.dot(E,A),k=vec3.dot(E,T);if(F>L&&L>-F&&Q>k&&k>-Q){var U=Math.abs(O-R-l);(null===w||w>U)&&(w=U,g=L,x=k,m=R,vec3.copy(p,B),vec3.copy(d,A),vec3.copy(f,T),b++)}}}if(b){u=!0;var W=e(c,v);vec3.scale(W.ri,p,-l),vec3.copy(W.ni,p),vec3.negate(W.ni,W.ni),vec3.scale(p,p,m),vec3.scale(d,d,g),vec3.add(p,p,d),vec3.scale(f,f,x),vec3.add(W.rj,p,f),t.push(W)}for(var D=y.get(),H=j,X=0;2!==X&&!u;X++)for(var G=0;2!==G&&!u;G++)for(var Y=0;2!==Y&&!u;Y++)if(vec3.set(D,0,0,0),X?vec3.add(D,D,h[0]):vec3.subtract(D,D,h[0]),G?vec3.add(D,D,h[1]):vec3.subtract(D,D,h[1]),Y?vec3.add(D,D,h[2]):vec3.subtract(D,D,h[2]),vec3.add(H,o,D),vec3.subtract(H,H,r),l*l>vec3.squaredLength(H)){u=!0;var W=e(c,v);vec3.copy(W.ri,H),vec3.normalize(W.ri,W.ri),vec3.copy(W.ni,W.ri),vec3.scale(W.ri,W.ri,l),vec3.copy(W.rj,D),t.push(W)}y.release(D),D=null;for(var _=y.get(),Z=y.get(),W=y.get(),K=y.get(),U=y.get(),J=h.length,X=0;X!==J&&!u;X++)for(var G=0;G!==J&&!u;G++)if(X%3!==G%3){vec3.cross(_,h[G],h[X]),vec3.normalize(_,_),vec3.add(Z,h[X],h[G]),vec3.copy(W,r),vec3.subtract(W,W,Z),vec3.subtract(W,W,o);var $=vec3.dot(W,_);vec3.scale(K,_,$);for(var Y=0;Y===X%3||Y===G%3;)Y++;vec3.copy(U,r),vec3.subtract(U,U,K),vec3.subtract(U,U,Z),vec3.subtract(U,U,o);var te=Math.abs($),ee=vec3.length(U);if(vec3.length(h[Y])>te&&l>ee){u=!0;var ie=e(c,v);vec3.add(ie.rj,Z,K),vec3.copy(ie.rj,ie.rj),vec3.negate(ie.ni,U),vec3.normalize(ie.ni,ie.ni),vec3.copy(ie.ri,ie.rj),vec3.add(ie.ri,ie.ri,o),vec3.subtract(ie.ri,ie.ri,r),vec3.normalize(ie.ri,ie.ri),vec3.scale(ie.ri,ie.ri,l),t.push(ie)}}y.release(_,Z,W,K,U)}function n(t,i,a,r,s,n,c,v,h){vec3.subtract(V,r,s);for(var l=a.faceNormals,u=a.faces,p=a.vertices,d=i.radius,f=0;f!==p.length;f++){var m=p[f],b=A;vec3.transformQuat(b,m,c),vec3.add(b,s,b);var g=O;if(vec3.subtract(g,b,r),d*d>vec3.squaredLength(g)){w=!0;var x=e(v,h);return vec3.copy(x.ri,g),vec3.normalize(x.ri,x.ri),vec3.copy(x.ni,x.ri),vec3.scale(x.ri,x.ri,d),vec3.subtract(x.rj,b,s),t.push(x),void 0}}for(var w=!1,f=0,M=u.length;f!==M&&w===!1;f++){var E=l[f],S=u[f],q=T;vec3.transformQuat(q,E,c);var N=F;vec3.transformQuat(N,p[S[0]],c),vec3.add(N,N,s);var P=Q;vec3.scale(P,q,-d),vec3.add(P,r,P);var j=L;vec3.subtract(j,P,N);var z=vec3.dot(j,q),C=k;if(vec3.subtract(C,r,N),0>z&&vec3.dot(C,q)>0){for(var I=[],U=0,W=S.length;U!==W;U++){var D=y.get();vec3.transformQuat(D,p[S[U]],c),vec3.add(D,s,D),I.push(D)}if(o(I,q,r)){w=!0;var x=e(v,h);vec3.scale(x.ri,q,-d),vec3.negate(x.ni,q);var H=y.get();vec3.scale(H,q,-z);var X=y.get();vec3.scale(X,q,-d),vec3.subtract(x.rj,r,s),vec3.add(x.rj,x.rj,X),vec3.add(x.rj,x.rj,H),y.release(H),y.release(X),t.push(x);for(var U=0,G=I.length;U!==G;U++)y.release(I[U]);return}for(var U=0;U!==S.length;U++){var Y=y.get(),_=y.get();vec3.transformQuat(Y,p[S[(U+1)%S.length]],c),vec3.transformQuat(_,p[S[(U+2)%S.length]],c),vec3.add(Y,s,Y),vec3.add(_,s,_);var Z=B;vec3.subtract(Z,_,Y);var K=R;vec3.normalize(K,Z);var J=y.get(),$=y.get();vec3.subtract($,r,Y);var te=vec3.dot($,K);vec3.scale(J,K,te),vec3.add(J,J,Y);var ee=y.get();if(vec3.subtract(ee,J,r),te>0&&vec3.squaredLength(Z)>te*te&&d*d>vec3.squaredLength(ee)){var x=e(v,h);vec3.subtract(x.rj,J,s),vec3.subtract(x.ni,J,r),vec3.normalize(x.ni,x.ni),vec3.scale(x.ri,x.ni,d),t.push(x);for(var U=0,G=I.length;U!==G;U++)y.release(I[U]);return y.release(Y),y.release(_),y.release(J),y.release(ee),y.release($),void 0}y.release(Y),y.release(_),y.release(J),y.release(ee),y.release($)}for(var U=0,G=I.length;U!==G;U++)y.release(I[U])}}}function c(t,e,i,a,r,o,s,n,c){h(t,e,i.convexPolyhedronRepresentation,a,r,o,s,n,c)}function v(e,i,a,r,o,s,n,c,v){for(var h=U,l=W,u=0,p=0,d=a.childShapes.length;p!==d;p++){var m=[],y=l.pop()||new t.Quaternion,b=h.pop()||vec3.create();quat.multiply(y,n,a.childOrientations[p]),quat.normalize(y,y),vec3.transformQuat(b,a.childOffsets[p],n),vec3.add(b,o,b),f(m,i,a.childShapes[p],r,b,s,y,c,v),l.push(y);var g=b;i||(u+=m.length);for(var x=0;x!==m.length;x++)vec3.transformQuat(g,a.childOffsets[p],n),vec3.add(m[x].rj,m[x].rj,g),e.push(m[x]);h.push(b)}}function h(t,i,a,r,o,s,n,c,v){var h=D,l=H;vec3.set(l,0,0,1),vec3.transformQuat(l,l,s);for(var u=X,p=0;p!==a.vertices.length;p++){vec3.copy(h,a.vertices[p]),vec3.transformQuat(h,h,n),vec3.add(h,o,h),vec3.subtract(u,h,r);var d=vec3.dot(l,u);if(0>=d){var f=G;vec3.scale(f,l,vec3.dot(l,h)),vec3.subtract(f,h,f);var m=e(c,v);vec3.copy(m.ni,l),vec3.copy(m.ri,f),vec3.subtract(m.rj,h,o),t.push(m)}}}function l(t,i,a,r,o,s,n,c,v){var h=Y;if(i.findSeparatingAxis(a,r,s,o,n,h)){var l=[],u=_;i.clipAgainstHull(r,s,a,o,n,h,-100,100,l);for(var p=0;p!==l.length;p++){var d=e(c,v);vec3.negate(d.ni,h),vec3.negate(u,l[p].normal),vec3.scale(u,u,l[p].depth),vec3.add(d.ri,l[p].point,u),vec3.copy(d.rj,l[p].point),vec3.subtract(d.rj,d.rj,o),vec3.subtract(d.ri,d.ri,r),t.push(d)}}}function u(t,i,a,r,o,s,n,c,v){var h=Z;vec3.set(h,0,0,1),vec3.transformQuat(h,h,v.quaternion);var l=K;vec3.subtract(l,r,v.position);var u=vec3.dot(h,l);if(0>=u){var p=e(c,v);vec3.copy(p.ni,h),vec3.negate(p.ni,p.ni),vec3.set(p.ri,0,0,0);var d=J;vec3.scale(d,h,vec3.dot(h,r)),vec3.subtract(d,r,d),vec3.copy(p.rj,d),t.push(p)}}function p(t,i,a,r,o,s,n,c,v){var h=$;vec3.set(h,0,0,1),vec3.subtract(h,r,o);var l=vec3.squaredLength(h);if(a.radius*a.radius>=l){var u=e(c,v);vec3.normalize(h,h),vec3.copy(u.rj,h),vec3.scale(u.rj,u.rj,a.radius),vec3.copy(u.ni,h),vec3.negate(u.ni,u.ni),vec3.set(u.ri,0,0,0),t.push(u)}}function d(t,i,a,r,o,s,n,c,v){var h=-1,l=ie,u=re,p=null,d=0,f=ee;if(vec3.copy(f,r),vec3.subtract(f,f,o),quat.conjugate(te,n),vec3.transformQuat(f,f,te),a.pointIsInside(f)){a.worldVerticesNeedsUpdate&&a.computeWorldVertices(o,n),a.worldFaceNormalsNeedsUpdate&&a.computeWorldFaceNormals(n);for(var m=0,y=a.faces.length;m!==y;m++){var b=[a.worldVertices[a.faces[m][0]]],g=a.worldFaceNormals[m];vec3.subtract(ae,r,b[0]);var x=-vec3.dot(g,ae);(null===p||Math.abs(x)<Math.abs(p))&&(p=x,h=m,vec3.copy(l,g),d++)}if(-1!==h){var w=e(c,v);vec3.scale(u,l,p),vec3.add(u,u,r),vec3.subtract(u,u,o),vec3.copy(w.rj,u),vec3.negate(w.ni,l),vec3.set(w.ri,0,0,0),t.push(w)}else console.warn("Point found inside convex, but did not find penetrating face!")}}function f(e,o,m,y,b,g,x,w,M){var E=!1,S=t.Shape.types,q=S.SPHERE,N=S.PLANE,P=S.BOX,j=S.COMPOUND,z=S.CONVEXPOLYHEDRON;if(o&&m){if(o.type>m.type){var C;C=m,m=o,o=C,C=b,b=y,y=C,C=x,x=g,g=C,C=M,M=w,w=C,E=!0}}else if(o&&!m){var C;C=m,m=o,o=C,C=b,b=y,y=C,C=x,x=g,g=C,C=M,M=w,w=C,E=!0}if(o&&m){if(o.type===q)switch(m.type){case q:a(e,o,m,y,b,g,x,w,M);break;case N:r(e,o,m,y,b,g,x,w,M);break;case P:s(e,o,m,y,b,g,x,w,M);break;case j:v(e,o,m,y,b,g,x,w,M);break;case z:n(e,o,m,y,b,g,x,w,M);break;default:console.warn("Collision between CANNON.Shape.types.SPHERE and "+m.type+" not implemented yet.")}else if(o.type===S.PLANE)switch(m.type){case S.PLANE:throw Error("Plane-plane collision... wait, you did WHAT?");case S.BOX:c(e,o,m,y,b,g,x,w,M);break;case S.COMPOUND:v(e,o,m,y,b,g,x,w,M);break;case S.CONVEXPOLYHEDRON:h(e,o,m,y,b,g,x,w,M);break;default:console.warn("Collision between CANNON.Shape.types.PLANE and "+m.type+" not implemented yet.")}else if(o.type===S.BOX)switch(m.type){case S.BOX:f(e,o.convexPolyhedronRepresentation,m.convexPolyhedronRepresentation,y,b,g,x,w,M);break;case S.COMPOUND:v(e,o,m,y,b,g,x,w,M);break;case S.CONVEXPOLYHEDRON:f(e,o.convexPolyhedronRepresentation,m,y,b,g,x,w,M);break;default:console.warn("Collision between CANNON.Shape.types.BOX and "+m.type+" not implemented yet.")}else if(o.type===S.COMPOUND)switch(m.type){case S.COMPOUND:v(e,o,m,y,b,g,x,w,M);break;case S.CONVEXPOLYHEDRON:var I=[];v(I,m,o,b,y,x,g,M,w);for(var V=0;V!==I.length;V++)i(I[V]),e.push(I[V]);break;default:console.warn("Collision between CANNON.Shape.types.COMPOUND and "+m.type+" not implemented yet.")}else if(o.type===S.CONVEXPOLYHEDRON)switch(m.type){case S.CONVEXPOLYHEDRON:l(e,o,m,y,b,g,x,w,M);break;default:console.warn("Collision between CANNON.Shape.types.CONVEXPOLYHEDRON and "+m.type+" not implemented yet.")}}else switch(m.type){case S.PLANE:u(e,o,m,y,b,g,x,w,M);break;case S.SPHERE:p(e,o,m,y,b,g,x,w,M);break;case S.BOX:d(e,o,m.convexPolyhedronRepresentation,y,b,g,x,w,M);break;case S.CONVEXPOLYHEDRON:d(e,o,m,y,b,g,x,w,M);break;case S.COMPOUND:v(e,o,m,y,b,g,x,w,M);break;default:console.warn("Collision between CANNON.Particle and "+m.type+" not implemented yet.")}for(var B=0,R=e.length;E&&B!==R;B++)i(e[B])}this.contactReduction=!1;var m=[],y=new t.Vec3Pool,b=vec3.create(),g=vec3.create(),x=vec3.create(),w=vec3.create(),M=vec3.create(),E=vec3.create(),S=vec3.create(),q=vec3.create(),N=vec3.create(),P=[vec3.create(),vec3.create(),vec3.create(),vec3.create(),vec3.create(),vec3.create()],j=vec3.create(),z=vec3.create(),C=vec3.create(),I=vec3.create(),V=vec3.create(),B=vec3.create(),R=vec3.create(),O=vec3.create(),A=vec3.create(),T=vec3.create(),F=vec3.create(),Q=vec3.create(),L=vec3.create(),k=vec3.create();vec3.create(),vec3.create();var U=[],W=[],D=vec3.create(),H=vec3.create(),X=vec3.create(),G=vec3.create(),Y=vec3.create(),_=vec3.create(),Z=vec3.create(),K=vec3.create(),J=vec3.create(),$=vec3.create(),te=new t.Quaternion,ee=vec3.create();vec3.create();var ie=vec3.create(),ae=vec3.create(),re=vec3.create();this.reduceContacts=function(){},this.getContacts=function(t,e,i,a,r){m=r;for(var o=0,s=t.length;o!==s;o++){var n=t[o],c=e[o];f(a,n.shape,c.shape,n.position,c.position,n.quaternion,c.quaternion,n,c)}}},t.Equation=function(t,e,i,a){this.id=-1,this.minForce=i===void 0?-1e6:i,this.maxForce=a===void 0?1e6:a,this.bi=t,this.bj=e,this.stiffness=1e7,this.regularizationTime=5,this.a=0,this.b=0,this.eps=0,this.spookParamsNeedsUpdate=!0},t.Equation.prototype.constructor=t.Equation,t.Equation.prototype.updateSpookParams=function(t){var e=this.regularizationTime,i=this.stiffness;this.a=4/(t*(1+4*e)),this.b=4*e/(1+4*e),this.eps=4/(t*t*i*(1+4*e))},t.ContactEquation=function(e,i){t.Equation.call(this,e,i,0,1e6),this.restitution=0,this.ri=vec3.create(),this.rj=vec3.create(),this.penetrationVec=vec3.create(),this.ni=vec3.create(),this.rixn=vec3.create(),this.rjxn=vec3.create(),this.invIi=mat3.create(),this.invIj=mat3.create(),this.biInvInertiaTimesRixn=vec3.create(),this.bjInvInertiaTimesRjxn=vec3.create()},t.ContactEquation.prototype=new t.Equation,t.ContactEquation.prototype.constructor=t.ContactEquation,t.ContactEquation.prototype.reset=function(){this.invInertiaTimesRxnNeedsUpdate=!0};var ne=vec3.create(),ce=vec3.create(),ve=vec3.create();t.ContactEquation.prototype.computeB=function(t){var e=this.a,i=this.b,a=this.bi,r=this.bj,o=this.ri,s=this.rj,n=this.rixn,c=this.rjxn,v=ve,h=a.velocity,l=a.angularVelocity?a.angularVelocity:v,u=a.force,p=a.tau?a.tau:v,d=r.velocity,f=r.angularVelocity?r.angularVelocity:v,m=r.force,y=r.tau?r.tau:v,b=this.penetrationVec,g=a.invMass,x=r.invMass,w=this.invIi,M=this.invIj;a.invInertia?mat3.setTrace(w,a.invInertia):mat3.identity(w),r.invInertia?mat3.setTrace(M,r.invInertia):mat3.identity(M);var E=this.ni;vec3.cross(n,o,E),vec3.cross(c,s,E);var b=this.penetrationVec;vec3.set(b,0,0,0),vec3.add(b,b,r.position),vec3.add(b,b,s),vec3.subtract(b,b,a.position),vec3.subtract(b,b,o);var S=vec3.dot(E,b),q=ne,N=ce;vec3.transformMat3(q,p,w),vec3.transformMat3(N,y,M);var P=this.restitution+1,j=P*vec3.dot(d,E)-P*vec3.dot(h,E)+vec3.dot(f,c)-vec3.dot(l,n),z=vec3.dot(m,E)*x-vec3.dot(u,E)*g+vec3.dot(c,N)-vec3.dot(n,q),C=-S*e-j*i-t*z;return C},vec3.create(),vec3.create(),t.ContactEquation.prototype.computeC=function(){var t=this.bi,e=this.bj,i=this.rixn,a=this.rjxn,r=t.invMass,o=e.invMass,s=r+o+this.eps,n=this.invIi,c=this.invIj;return t.invInertia?mat3.setTrace(n,t.invInertia):mat3.identity(n),e.invInertia?mat3.setTrace(c,e.invInertia):mat3.identity(c),vec3.transformMat3(this.biInvInertiaTimesRixn,i,n),vec3.transformMat3(this.bjInvInertiaTimesRjxn,a,c),s+=vec3.dot(this.biInvInertiaTimesRixn,i),s+=vec3.dot(this.bjInvInertiaTimesRjxn,a)};var he=vec3.create();t.ContactEquation.prototype.computeGWlambda=function(){var t=this.bi,e=this.bj,i=he,a=0;return vec3.subtract(i,e.vlambda,t.vlambda),a+=vec3.dot(i,this.ni),t.wlambda&&(a-=vec3.dot(t.wlambda,this.rixn)),e.wlambda&&(a+=vec3.dot(e.wlambda,this.rjxn)),a};var le=vec3.create(),ue=vec3.create();t.ContactEquation.prototype.addToWlambda=function(t){var e=this.bi,i=this.bj,a=(this.rixn,this.rjxn,e.invMass),r=i.invMass,o=this.ni,s=le,n=ue,c=e.wlambda,v=i.wlambda;vec3.scale(n,o,a*t),vec3.subtract(e.vlambda,e.vlambda,n),vec3.scale(n,o,r*t),vec3.add(i.vlambda,i.vlambda,n),c&&(vec3.scale(s,this.biInvInertiaTimesRixn,t),vec3.subtract(c,c,s)),v&&(vec3.scale(s,this.bjInvInertiaTimesRjxn,t),vec3.add(v,v,s))},t.FrictionEquation=function(e,i,a){t.Equation.call(this,e,i,-a,a),this.ri=vec3.create(),this.rj=vec3.create(),this.t=vec3.create(),this.rixt=vec3.create(),this.rjxt=vec3.create(),this.wixri=vec3.create(),this.wjxrj=vec3.create(),this.invIi=mat3.create(),this.invIj=mat3.create(),this.relVel=vec3.create(),this.relForce=vec3.create(),this.biInvInertiaTimesRixt=vec3.create(),this.bjInvInertiaTimesRjxt=vec3.create()},t.FrictionEquation.prototype=new t.Equation,t.FrictionEquation.prototype.constructor=t.FrictionEquation;
var pe=vec3.create(),de=vec3.create(),fe=vec3.create();t.FrictionEquation.prototype.computeB=function(t){var e=this.a,i=this.b,a=this.bi,r=this.bj,o=this.ri,s=this.rj,n=this.rixt,c=this.rjxt,v=this.wixri,h=this.wjxrj,l=fe,u=a.velocity,p=a.angularVelocity?a.angularVelocity:l,d=a.force,f=a.tau?a.tau:l,m=r.velocity,y=r.angularVelocity?r.angularVelocity:l,b=r.force,g=r.tau?r.tau:l,x=(this.relVel,this.relForce,a.invMass),w=r.invMass,M=this.invIi,E=this.invIj,S=this.t,q=pe,N=de;a.invInertia&&mat3.setTrace(M,a.invInertia),r.invInertia&&mat3.setTrace(E,r.invInertia),vec3.cross(n,o,S),vec3.cross(c,s,S),vec3.cross(v,p,o),vec3.cross(h,y,s),vec3.transformMat3(q,f,M),vec3.transformMat3(N,g,E);var P=0,j=vec3.dot(m,S)-vec3.dot(u,S)+vec3.dot(h,S)-vec3.dot(v,S),z=vec3.dot(b,S)*w-vec3.dot(d,S)*x+vec3.dot(c,N)-vec3.dot(n,q),C=-P*e-j*i-t*z;return C},t.FrictionEquation.prototype.computeC=function(){var t=this.bi,e=this.bj,i=this.rixt,a=this.rjxt,r=t.invMass,o=e.invMass,s=r+o+this.eps,n=this.invIi,c=this.invIj;return t.invInertia&&mat3.setTrace(n,t.invInertia),e.invInertia&&mat3.setTrace(c,e.invInertia),vec3.transformMat3(this.biInvInertiaTimesRixt,i,n),vec3.transformMat3(this.bjInvInertiaTimesRjxt,a,c),s+=vec3.dot(this.biInvInertiaTimesRixt,i),s+=vec3.dot(this.bjInvInertiaTimesRjxt,a)};var me=vec3.create();t.FrictionEquation.prototype.computeGWlambda=function(){var t=this.bi,e=this.bj,i=0,a=me;return vec3.subtract(a,e.vlambda,t.vlambda),i+=vec3.dot(a,this.t),t.wlambda&&(i-=vec3.dot(t.wlambda,this.rixt)),e.wlambda&&(i+=vec3.dot(e.wlambda,this.rjxt)),i};var ye=vec3.create();t.FrictionEquation.prototype.addToWlambda=function(t){var e=this.bi,i=this.bj,a=(this.rixt,this.rjxt,e.invMass),r=i.invMass,o=this.t,s=ye,n=e.wlambda,c=i.wlambda;vec3.scale(s,o,a*t),vec3.subtract(e.vlambda,e.vlambda,s),vec3.scale(s,o,r*t),vec3.add(i.vlambda,i.vlambda,s),n&&(vec3.scale(s,this.biInvInertiaTimesRixt,t),vec3.subtract(n,n,s)),c&&(vec3.scale(s,this.bjInvInertiaTimesRjxt,t),vec3.add(c,c,s))},t.RotationalEquation=function(e,i){t.Equation.call(this,e,i,-1e6,1e6),this.ni=vec3.create(),this.nj=vec3.create(),this.nixnj=vec3.create(),this.njxni=vec3.create(),this.invIi=mat3.create(),this.invIj=mat3.create(),this.relVel=vec3.create(),this.relForce=vec3.create()},t.RotationalEquation.prototype=new t.Equation,t.RotationalEquation.prototype.constructor=t.RotationalEquation,t.RotationalEquation.prototype.computeB=function(t){var e=this.a,i=this.b,a=this.bi,r=this.bj,o=this.ni,s=this.nj,n=this.nixnj,c=this.njxni;a.velocity;var v=a.angularVelocity?a.angularVelocity:vec3.create();a.force,a.tau?a.tau:vec3.create(),r.velocity;var h=r.angularVelocity?r.angularVelocity:vec3.create();r.force,r.tau?r.tau:vec3.create(),a.invMass,r.invMass;var l=this.invIi,u=this.invIj;a.invInertia?mat3.setTrace(l,a.invInertia):mat3.identity(l),r.invInertia?mat3.setTrace(u,r.invInertia):mat3.identity(u),vec3.cross(n,o,s),vec3.cross(c,s,o);var p=-vec3.dot(o,s),d=vec3.dot(c,v)+vec3.dot(n,h),f=0,m=-p*e-d*i-t*f;return m},RotationalEquation_computeC_temp=vec3.create(),t.RotationalEquation.prototype.computeC=function(){var t=this.bi,e=this.bj,i=this.nixnj,a=this.njxni;t.invMass,e.invMass;var r=RotationalEquation_computeC_temp,o=this.eps,s=this.invIi,n=this.invIj;return t.invInertia?mat3.setTrace(s,t.invInertia):mat3.identity(s),e.invInertia?mat3.setTrace(n,e.invInertia):mat3.identity(n),vec3.transformMat3(r,a,s),o+=vec3.dot(r,a),vec3.transformMat3(r,i,n),o+=vec3.dot(r,i)};var he=vec3.create();t.RotationalEquation.prototype.computeGWlambda=function(){var t=this.bi,e=this.bj,i=0;return t.wlambda&&(i+=vec3.dot(t.wlambda,this.njxni)),e.wlambda&&(i+=vec3.dot(e.wlambda,this.nixnj)),i};var be=vec3.create();t.RotationalEquation.prototype.addToWlambda=function(t){var e=this.bi,i=this.bj,a=this.nixnj;this.njxni,e.invMass,i.invMass;var r=be;if(e.wlambda){var o=this.invIi;vec3.transformMat3(r,a,o),vec3.scale(r,r,t),vec3.subtract(e.wlambda,e.wlambda,r)}if(i.wlambda){var o=this.invIj;vec3.transformMat3(r,a,o),vec3.scale(r,r,t),vec3.add(i.wlambda,i.wlambda,r)}},t.Constraint=function(t,e){this.equations=[],this.bodyA=t,this.bodyB=e},t.Constraint.prototype.update=function(){throw Error("method update() not implmemented in this Constraint subclass!")},t.DistanceConstraint=function(e,i,a,r){t.Constraint.call(this,e,i),r===void 0&&(r=1e6);var o=this.equations=[new t.ContactEquation(e,i)],s=o[0];s.minForce=-r,s.maxForce=r,this.update=function(){vec3.subtract(s.ni,i.position,e.position),vec3.normalize(s.ni,s.ni),vec3.scale(s.ri,s.ni,.5*a),vec3.scale(s.rj,s.ni,.5*-a)}},t.DistanceConstraint.prototype=new t.Constraint,t.RotationalMotorEquation=function(e,i,a){a=a||1e6,t.Equation.call(this,e,i,-a,a),this.axisA=vec3.create(),this.axisB=vec3.create(),this.invIi=mat3.create(),this.invIj=mat3.create(),this.targetVelocity=0},t.RotationalMotorEquation.prototype=new t.Equation,t.RotationalMotorEquation.prototype.constructor=t.RotationalMotorEquation,t.RotationalMotorEquation.prototype.computeB=function(t){var e=this.a,i=this.b,a=this.bi,r=this.bj,o=this.axisA,s=this.axisB;a.velocity;var n=a.angularVelocity?a.angularVelocity:vec3.create();a.force,a.tau?a.tau:vec3.create(),r.velocity;var c=r.angularVelocity?r.angularVelocity:vec3.create();r.force,r.tau?r.tau:vec3.create(),a.invMass,r.invMass;var v=this.invIi,h=this.invIj;a.invInertia?mat3.setTrace(v,a.invInertia):mat3.identity(v),r.invInertia?mat3.setTrace(h,r.invInertia):mat3.identity(h);var l=0,u=vec3.dot(o,n)+vec3.dot(s,c)+this.targetVelocity,p=0,d=-l*e-u*i-t*p;return d};var ge=vec3.create();t.RotationalMotorEquation.prototype.computeC=function(){var t=this.bi,e=this.bj,i=this.axisA,a=this.axisB;t.invMass,e.invMass;var r=ge,o=this.eps,s=this.invIi,n=this.invIj;return t.invInertia?mat3.setTrace(s,t.invInertia):mat3.identity(s),e.invInertia?mat3.setTrace(n,e.invInertia):mat3.identity(n),vec3.transformMat3(r,i,s),o+=vec3.dot(r,a),vec3.transformMat3(r,a,n),o+=vec3.dot(r,a)};var he=vec3.create();t.RotationalMotorEquation.prototype.computeGWlambda=function(){var t=this.bi,e=this.bj,i=this.axisA,a=this.axisB,r=0;return t.wlambda&&(r+=vec3.dot(t.wlambda,i)),e.wlambda&&(r+=vec3.dot(e.wlambda,a)),r};var xe=vec3.create();t.RotationalMotorEquation.prototype.addToWlambda=function(t){var e=this.bi,i=this.bj,a=this.axisA,r=this.axisB;e.invMass,i.invMass;var o=xe;if(e.wlambda){var s=this.invIi;vec3.transformMat3(o,a,s),vec3.scale(o,o,t),vec3.subtract(e.wlambda,e.wlambda,o)}if(i.wlambda){var s=this.invIj;vec3.transformMat3(o,r,s),vec3.scale(o,o,t),vec3.add(i.wlambda,i.wlambda,o)}},t.HingeConstraint=function(e,i,a,r,o,s,n){t.Constraint.call(this,e,r),n=n||1e6;var c=this,v=this.equations=[new t.RotationalEquation(e,r),new t.RotationalEquation(e,r),new t.ContactEquation(e,r),new t.ContactEquation(e,r),new t.ContactEquation(e,r)];this.getRotationalEquation1=function(){return v[0]},this.getRotationalEquation2=function(){return v[1]},this.getPointToPointEquation1=function(){return v[2]},this.getPointToPointEquation2=function(){return v[3]},this.getPointToPointEquation3=function(){return v[4]};var h,l=this.getRotationalEquation1(),u=this.getRotationalEquation2(),p=this.getPointToPointEquation1(),d=this.getPointToPointEquation2(),f=this.getPointToPointEquation3();d.minForce=f.minForce=p.minForce=-n,d.maxForce=f.maxForce=p.maxForce=n;var m=vec3.create();vec3.normalize(m,i);var y=vec3.create();vec3.normalize(y,o);var b=vec3.create(),g=vec3.create(),x=vec3.create();vec3.cross(b,a,m),vec3.cross(g,a,b),vec3.cross(x,s,y),vec3.normalize(b,b),vec3.normalize(x,x);var w=!1;this.motorTargetVelocity=0,this.motorMinForce=-n,this.motorMaxForce=n,this.enableMotor=function(){w||(h=new t.RotationalMotorEquation(e,r,n),v.push(h),w=!0)},this.disableMotor=function(){w&&(w=!1,h=null,v.pop())},this.update=function(){vec3.set(p.ni,1,0,0),vec3.set(d.ni,0,1,0),vec3.set(f.ni,0,0,1),vec3.transformQuat(p.ri,i,e.quaternion),vec3.transformQuat(p.rj,o,r.quaternion),vec3.copy(d.ri,p.ri),vec3.copy(d.rj,p.rj),vec3.copy(f.ri,p.ri),vec3.copy(f.rj,p.rj),vec3.transformQuat(l.ni,b,e.quaternion),vec3.transformQuat(l.nj,s,r.quaternion),vec3.transformQuat(u.ni,g,e.quaternion),vec3.transformQuat(u.nj,s,r.quaternion),w&&(vec3.transformQuat(h.axisA,a,e.quaternion),vec3.transformQuat(h.axisB,s,r.quaternion),h.targetVelocity=c.motorTargetVelocity,h.maxForce=c.motorMaxForce,h.minForce=c.motorMinForce)}},t.HingeConstraint.prototype=new t.Constraint,t.PointToPointConstraint=function(e,i,a,r,o){t.Constraint.call(this,e,a);var s=this.equations=[new t.ContactEquation(e,a),new t.ContactEquation(e,a),new t.ContactEquation(e,a)],n=s[0],c=s[1],v=s[2];c.minForce=v.minForce=n.minForce=-o,c.maxForce=v.maxForce=n.maxForce=o,this.update=function(){vec3.subtract(n.ni,a.position,e.position),vec3.normalize(n.ni,n.ni),vec3.transformQuat(n.ri,i,e.quaternion),vec3.transformQuat(n.rj,r,a.quaternion),vec3.tangents(c.ni,v.ni,n.ni),vec3.copy(c.ri,n.ri),vec3.copy(c.rj,n.rj),vec3.copy(v.ri,n.ri),vec3.copy(v.rj,n.rj)}},t.PointToPointConstraint.prototype=new t.Constraint,"undefined"!=typeof module?module.exports=t:this.CANNON=t}).apply(this);