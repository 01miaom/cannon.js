<!DOCTYPE html>
<html>
  <head>
    <title>cannon.js - convex hull demo</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="style.css" type="text/css"/>
  </head>
  <body>
    <script src="../libs/gl-matrix.js"></script>
    <script src="../build/cannon.js"></script>
    <script src="../build/cannon.demo.js"></script>
    <script src="../libs/dat.gui.js"></script>
    <script src="../libs/Three.js"></script>
    <script src="../libs/Detector.js"></script>
    <script src="../libs/Stats.js"></script>
    <script src="../libs/smoothie.js"></script>
    <script>

      /**
       * Experiment for testing ConvexPolyhedrons.
       */
      var demo = new CANNON.Demo();
      
      function createTetra(){
            var verts = [vec3.fromValues(0,0,0),
                         vec3.fromValues(2,0,0),
                         vec3.fromValues(0,2,0),
                         vec3.fromValues(0,0,2)];
            var offset = -0.35;
            for(var i=0; i<verts.length; i++){
                var v = verts[i];
                v.x += offset;
                v.y += offset;
                v.z += offset;
            }
            return new CANNON.ConvexPolyhedron(verts,
                                                [
                                                    [0,3,2], // -x
                                                    [0,1,3], // -y
                                                    [0,2,1], // -z
                                                    [1,2,3], // +xyz
                                                ],
                                                [vec3.fromValues(-1, 0, 0),
                                                 vec3.fromValues( 0,-1, 0),
                                                 vec3.fromValues( 0, 0,-1),
                                                 vec3.fromValues( 1, 1, 1)]);
      }

      function createBoxPolyhedron(size){
        size = size || 1;
        var box = new CANNON.Box(vec3.fromValues(size*0.5, size*0.5, size*0.5));
        return box.convexPolyhedronRepresentation;
        /*
          size = size || 1;
          var vertices = [vec3.fromValues(-size,-size,-size),
                          vec3.fromValues( size,-size,-size),
                          vec3.fromValues( size, size,-size),
                          vec3.fromValues(-size, size,-size),
                          vec3.fromValues(-size,-size, size),
                          vec3.fromValues( size,-size, size),
                          vec3.fromValues( size, size, size),
                          vec3.fromValues(-size, size, size)];
          var faces =[[3,2,1,0], // -z
                      [4,5,6,7], // +z
                      [5,4,1,0], // -y
                      [2,3,6,7], // +y
                      [0,4,7,3 ], // -x
                      [1,2,5,6], // +x
                      ];
          var faceNormals =   [vec3.fromValues( 0, 0,-1),
                               vec3.fromValues( 0, 0, 1),
                               vec3.fromValues( 0,-1, 0),
                               vec3.fromValues( 0, 1, 0),
                               vec3.fromValues(-1, 0, 0),
                               vec3.fromValues( 1, 0, 0)];
          var boxShape = new CANNON.ConvexPolyhedron(vertices,
                                                     faces,
                                                     faceNormals);
          return boxShape;
          */
      }

      // Just 1 box on a plane
      demo.addScene("Hull on plane",function(){
          var world = setupWorld(demo);
          // ConvexPolyhedron box shape
          var size = 4;
          var hullShape = createBoxPolyhedron(size);
          // At the moment one must provide vertices, faces and normals..
          var mass = 10;
          var boxbody1 = new CANNON.RigidBody(mass,hullShape);
          vec3.set(boxbody1.position,0,0,size*2);
          quat.setAxisAngle(boxbody1.quaternion, quat.fromValues(0,1,0), Math.PI/4); //boxbody1.quaternion.setFromAxisAngle(vec3.fromValues(0,1,0),Math.PI/4);
          world.add(boxbody1);
          demo.addVisual(boxbody1);
        });

      // Various shapes
      demo.addScene("various",function(){
          var world = setupWorld(demo);
          // ConvexPolyhedron box shape
          var size = 2;
          var hullShape = createBoxPolyhedron(2);
          var mass = 10;
          var boxbody = new CANNON.RigidBody(mass,hullShape);
          vec3.set(boxbody.position,1,0,size+1);
          world.add(boxbody);
          demo.addVisual(boxbody);
      
          // ConvexPolyhedron tetra shape
          var tetraShape = createTetra();
          var tetraBody = new CANNON.RigidBody(mass,tetraShape);
          vec3.set(tetraBody.position,5,-3,size+1);
          world.add(tetraBody);
          demo.addVisual(tetraBody);
      
          // ConvexPolyhedron cylinder shape
          // Yes, the Cylinder is actually a ConvexPolyhedron.
          var num = 20;
          var verts = [];
          var normals = [];
          var faces = [];
          var bottomface = [];
          var topface = [];
          var L = 2, R = 0.5;
          var cylinderShape = new CANNON.Cylinder(R,R,L,num);
          var cylinderBody = new CANNON.RigidBody(mass,cylinderShape);

          vec3.set(cylinderBody.position,0,0,size*4+1);
          quat.setAxisAngle(cylinderBody.quaternion,vec3.fromValues(0,1,0),Math.PI/3);
          world.add(cylinderBody);
          demo.addVisual(cylinderBody);
      
        });


      // Box on box tilting over
      demo.addScene("Hull on hull",function(){
          var world = setupWorld(demo);
          // ConvexPolyhedron box shape
          var size = 2;
          var hullShape = createBoxPolyhedron(size*2);
          var mass = 10;
          var boxbody1 = new CANNON.RigidBody(mass,hullShape);
          var boxbody2 = new CANNON.RigidBody(mass,hullShape);
          vec3.set(boxbody1.position,0,0,size+1);
          vec3.set(boxbody2.position,1.5,0,4*size+1);
          world.add(boxbody1);
          world.add(boxbody2);
          demo.addVisual(boxbody1);
          demo.addVisual(boxbody2);
        });
      
      // Pile of boxes
      demo.addScene("Hull wall",function(){
          var world = setupWorld(demo);
          // ConvexPolyhedron box shape
          var size = 1;
          var hullShape = createBoxPolyhedron(size*2);
          var mass = 10;
          for(var i=0; i<3; i++){
              for(var j=0; j<3; j++){
                  var boxbody = new CANNON.RigidBody(mass,hullShape);
                  vec3.set(boxbody.position,2*size*i+0.01,0,2*size*j + size*1.2);
                  world.add(boxbody);
                  demo.addVisual(boxbody);
              }
          }
        });
            
      function setupWorld(demo){
        var world = demo.getWorld();
        vec3.set(world.gravity,0,0,-30);
        world.broadphase = new CANNON.NaiveBroadphase();
        world.solver.iterations = 10;

        world.defaultContactMaterial.contactEquationStiffness = 5e6;
        world.defaultContactMaterial.contactEquationRegularizationTime = 3;

        // ground plane
        var n = vec3.fromValues(0,0,1);
        var groundShape = new CANNON.Plane();
        var groundBody = new CANNON.RigidBody(0,groundShape);
        vec3.set(groundBody,-10,0,0);
        world.add(groundBody);
        demo.addVisual(groundBody);
      
        return world;
      };
      
      demo.start();
      
    </script>
  </body>
</html>
